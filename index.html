<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AuraAI ‚Äî All‚ÄëIn‚ÄëOne</title>

<!-- TF.js + MobileNet (client will fetch these from CDN at runtime) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

<style>
  /* ========== macOS Tahoe - inspired glass UI ========== */
  :root{
    --glass-bg: rgba(255,255,255,0.18);
    --glass-border: rgba(255,255,255,0.28);
    --accent: #1e88e5;
    --radius: 22px;
    --pad: 18px;
    --muted: #6b7a90;
    --text: #07203a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "SF Pro Text", "San Francisco", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,#e6f0ff 0%, #f7eef7 100%);
    display:flex;align-items:center;justify-content:center;
    padding:28px;color:var(--text);-webkit-font-smoothing:antialiased;
  }
  /* Root container keeps your original three-app layout */
  .app-shell{ width:min(1160px,96vw); height:min(820px,92vh); position:relative; border-radius:28px; overflow:hidden; box-shadow:0 20px 60px rgba(9,30,66,.18); display:grid; grid-template-columns: 1fr; grid-auto-rows:1fr; }

  /* Top navigation area */
  .topbar{ height:84px; display:flex; align-items:center; gap:12px; padding:14px 20px; background:linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)); border-bottom:1px solid rgba(255,255,255,0.12); backdrop-filter: blur(10px); }
  .brand{ font-weight:800; font-size:20px; letter-spacing:0.6px; display:flex; gap:12px; align-items:center; }
  .brand .logo{ width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#ffffff,#e6f0ff);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent); box-shadow:0 6px 18px rgba(30,136,229,.12) }
  .nav{ margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* Main content area with three 'apps' stacked like before (keeps original screens) */
  .main{ position:relative; height:calc(100% - 84px); background:transparent; display:grid; place-items:center; }

  .screen{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; padding:var(--pad); }
  .screen.active{ display:flex; }
  .glass{
    background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius);
    padding:18px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  }

  /* Hello card */
  .hello-card{ width:100%; max-width:980px; text-align:center; border-radius:20px; padding:28px; }
  .hello-title{ font-size:44px; font-weight:900; margin:6px 0; background:linear-gradient(90deg,#fff,#fde7f0,#dff0ff); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .hello-sub{ font-size:16px; margin-bottom:18px; color:var(--muted) }

  .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap }
  .btn{ background:linear-gradient(90deg,#eaf5ff,#fff0f6); padding:12px 18px; border-radius:12px; border:0; cursor:pointer; font-weight:800; box-shadow:0 6px 18px rgba(15,80,170,.08); color:var(--text) }
  .btn:active{ transform:translateY(1px) }

  /* Game UI ‚Äî keep the same proportions as your original */
  .game-wrap{ width:min(1000px,96%); height:min(680px,74vh); display:flex; flex-direction:column; gap:12px; }
  .bar{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .title{ font-weight:900 }
  canvas#gameCanvas{ width:100%; height:100%; border-radius:14px; display:block; background:linear-gradient(135deg,#eaf6ff,#f6f0ff); outline:2px solid rgba(255,255,255,.5) }

  .game-stats{ display:flex; gap:10px; align-items:center; }
  .stat{ background:rgba(255,255,255,.6); padding:8px 12px; border-radius:12px; font-weight:800; }

  /* Level UI */
  .level-panel{ display:flex; gap:8px; align-items:center }
  .badge{ background:linear-gradient(90deg,#ffefc7,#ffd9a8); padding:8px 12px;border-radius:10px;font-weight:800 }

  /* Drawing UI */
  .draw-wrap{ width:min(1100px,96%); height:min(740px,80vh); display:flex; flex-direction:column; gap:12px; }
  .draw-toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .draw-canvas{ flex:1; border-radius:14px; background:rgba(255,255,255,.92); outline:2px solid rgba(0,0,0,.06); }
  .draw-bottom{ display:flex; justify-content:space-between; gap:8px; align-items:center }

  /* Challenge card integrated into UI (no bottom-left hack) */
  .challenge-card{
    display:flex; gap:12px; align-items:center; padding:12px; border-radius:14px; background:rgba(255,255,255,.6);
    box-shadow:0 8px 24px rgba(17,24,39,.06); min-width:360px;
  }
  .challenge-title{ font-weight:900; font-size:14px }
  .chips{ display:flex; gap:8px }
  .chip{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.9); font-weight:800; border:1px solid rgba(0,0,0,.04); cursor:pointer }

  /* Chat UI ‚Äî app-like bubble card */
  .chat-wrap{ width:min(980px,96%); height:min(740px,80vh); display:flex; flex-direction:column; gap:12px; border-radius:18px; overflow:hidden }
  .chat-top{ display:flex; align-items:center; gap:10px; padding:10px; background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,.12)); }
  .mood-dock{ display:flex; gap:8px; align-items:center }
  .mood-btn{ border-radius:12px; padding:8px 10px; border:0; cursor:pointer; font-weight:800 }
  .chat-body{ flex:1; padding:14px; overflow:auto; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); }
  .bubble{ max-width:76%; padding:12px 14px; border-radius:14px; margin:8px 0; display:inline-block; line-height:1.35; box-shadow: 0 8px 20px rgba(6,18,38,.06) }
  .bubble.bot{ background: linear-gradient(90deg,#f6f9ff,#eaf6ff); color:#052239; border-radius:16px 16px 16px 4px; }
  .bubble.user{ background:linear-gradient(90deg,#1e88e5,#1358a6); color:white; align-self:flex-end; border-radius:16px 16px 4px 16px; }
  .bubble.fade-in{ animation:fadeIn .28s ease both }
  @keyframes fadeIn{ from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:none } }

  .chat-input-row{ display:flex; gap:8px; padding:12px; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) }
  .text-field{ flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:white }

  /* Mini player */
  .mini-player{ position:fixed; right:20px; bottom:20px; z-index:2400; display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:14px; background:rgba(255,255,255,.88); box-shadow:0 18px 40px rgba(10,20,40,.08) }
  .progress{ width:220px; appearance:none; height:6px; border-radius:6px; background:linear-gradient(90deg,#e6f0ff,#ffdede) }

  /* Themes panel (system preferences style) */
  .themes-panel{ position:fixed; left:20px; top:20px; width:320px; max-height:84vh; overflow:auto; padding:12px; border-radius:14px; background:rgba(255,255,255,.8); box-shadow:0 20px 60px rgba(7,20,40,.12) }
  .theme-group{ margin-bottom:12px }
  .theme-grid{ display:flex; gap:8px; flex-wrap:wrap }
  .theme-swatch{ width:64px; height:48px; border-radius:10px; cursor:pointer; border:1px solid rgba(0,0,0,.04); box-shadow:0 8px 20px rgba(0,0,0,.04); display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; font-size:12px }

  /* Misc */
  .small{ font-size:13px; color:var(--muted) }
  .hidden{ display:none }

  @media (max-width:980px){
    .app-shell{ width:96vw; height:92vh }
    .themes-panel{ display:none }
  }
</style>
</head>
<body>
  <div class="app-shell">

    <!-- top bar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <div style="font-size:13px;color:var(--muted)">Project</div>
          <div style="font-weight:900">AuraAI</div>
        </div>
      </div>
      <div class="nav">
        <div class="small">macOS Tahoe ‚Ä¢ Self-contained</div>
      </div>
    </div>

    <!-- main area -->
    <div class="main">
      <!-- HELLO -->
      <section id="hello" class="screen active">
        <div class="glass hello-card">
          <div class="hello-title">Hello ‚Äî AuraAI</div>
          <div class="hello-sub">Welcome. Pick an app: Bubble Pop (game), Draw (canvas challenge), or Talk (support bot).</div>
          <div class="actions">
            <button class="btn" id="btnPlay">üéÆ Bubble Pop</button>
            <button class="btn" id="btnDraw">üé® Drawing Pad</button>
            <button class="btn" id="btnChat">üí¨ Talk to Aura</button>
          </div>
        </div>
      </section>

      <!-- GAME -->
      <section id="game" class="screen">
        <div class="glass game-wrap">
          <div class="bar">
            <div class="title">ü´ß Bubble Pop ‚Äî Level Mode</div>
            <div class="game-stats">
              <div class="stat">Level: <span id="levelTxt">1</span></div>
              <div class="stat">Score: <span id="scoreTxt">0</span></div>
              <div class="stat">Bubbles Popped: <span id="poppedTxt">0</span></div>
              <div class="stat"><button class="btn" id="btnBackGame">‚¨Ö Back</button></div>
            </div>
          </div>
          <canvas id="gameCanvas"></canvas>

          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;justify-content:space-between">
            <div class="small">Milestones: 25, 50, 100, 200, 500, 1000 ‚Äî earn cheers & level unlocks</div>
            <div>
              <button class="btn" id="resetGame">Reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DRAW -->
      <section id="draw" class="screen">
        <div class="glass draw-wrap">
          <div class="draw-toolbar">
            <div style="display:flex;gap:10px;align-items:center">
              <div class="title">üé® Drawing Pad ‚Äî Challenges</div>
              <div class="small">Choose "Try" or FreeStyle anytime</div>
            </div>

            <!-- integrated challenge card -->
            <div style="margin-left:auto">
              <div id="challengeCard" class="challenge-card" title="Try/No/Later controls">
                <div style="display:flex;flex-direction:column;gap:6px">
                  <div class="challenge-title" id="challengeText">Try drawing a cat</div>
                  <div class="small">Auto-check: <span id="autoCheckState">ON</span></div>
                </div>
                <div class="chips" style="margin-left:12px">
                  <button class="chip" id="btnOk">‚úÖ OK</button>
                  <button class="chip" id="btnNo">‚ùå No</button>
                  <button class="chip" id="btnLater">‚è≠ Later</button>
                </div>
              </div>
            </div>
          </div>

          <canvas id="drawCanvas" class="draw-canvas"></canvas>

          <div class="draw-bottom">
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="clearDraw">Clear</button>
              <button class="btn" id="saveDraw">Save</button>
              <button class="btn" id="newChallenge">üîÑ New</button>
              <label style="display:flex;align-items:center;gap:8px;margin-left:10px"><input type="checkbox" id="autoCheck" checked/> Auto‚ÄëCheck</label>
            </div>
            <div class="small">Tip: Press OK to auto-check your drawing against the challenge</div>
          </div>
        </div>
      </section>

      <!-- CHAT -->
      <section id="chat" class="screen">
        <div class="glass chat-wrap">
          <div class="chat-top">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,#fff,#e6f0ff);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent)">A</div>
              <div>
                <div style="font-weight:900">AuraAI</div>
                <div class="small">Support buddy ‚Ä¢ quick coping tools</div>
              </div>
            </div>
            <div style="margin-left:auto" class="mood-dock">
              <!-- Four emotions always present -->
              <button class="mood-btn" id="mHappy">üòä</button>
              <button class="mood-btn" id="mSad">üò¢</button>
              <button class="mood-btn" id="mAngry">üò†</button>
              <button class="mood-btn" id="mNerv">üò∞</button>
              <button class="btn" id="btnBackChat">‚¨Ö Back</button>
            </div>
          </div>

          <div id="chatBody" class="chat-body"></div>

          <div class="chat-input-row">
            <input id="chatInput" class="text-field" placeholder="Type to Aura ‚Äî or choose a mood" />
            <button class="btn" id="sendChat">Send</button>
          </div>
        </div>
      </section>

      <!-- Themes panel -->
      <div class="themes-panel glass" id="themesPanel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:900">Themes</div>
          <div class="small">macOS Tahoe picker</div>
        </div>

        <!-- grouped themes -->
        <div class="theme-group">
          <div style="font-weight:800;margin-bottom:8px">Glassy</div>
          <div class="theme-grid" id="themeGridGlassy"></div>
        </div>
        <div class="theme-group">
          <div style="font-weight:800;margin-bottom:8px">Metallic</div>
          <div class="theme-grid" id="themeGridMetallic"></div>
        </div>
        <div class="theme-group">
          <div style="font-weight:800;margin-bottom:8px">Pastels</div>
          <div class="theme-grid" id="themeGridPastel"></div>
        </div>
        <div class="theme-group">
          <div style="font-weight:800;margin-bottom:8px">Poster & Gradient</div>
          <div class="theme-grid" id="themeGridPoster"></div>
        </div>
        <div class="small">Hover for tooltip. Click to apply.</div>
      </div>

      <!-- Mini Player -->
      <div class="mini-player" id="miniPlayer">
        <button class="btn" id="playPause">‚ñ∂Ô∏è</button>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="font-weight:900">Background music</div>
          <input id="prog" class="progress" type="range" min="0" max="100" value="0" />
        </div>
      </div>

    </div>
  </div>

<!-- Scripts: All logic in-page -->
<script>
/* ---------------------------
  Util & sound (simple beeps)
--------------------------- */
const Sound = (() => {
  let ctx, muted=false;
  const ensure = ()=>{ if(!ctx){ const AC = window.AudioContext || window.webkitAudioContext; if(AC) ctx=new AC(); } };
  function tone(f=440,t=0.06,type='sine',g=0.04){ if(muted) return; ensure(); if(!ctx) return; const o=ctx.createOscillator(); const gg=ctx.createGain(); o.type=type; o.frequency.value=f; gg.gain.value=g; o.connect(gg).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+t); }
  return { click:()=>tone(600,0.04,'triangle',0.04), pop:()=>tone(900,0.06,'sine',0.06), scribble:()=>tone(260,0.02,'square',0.02), toggle:()=>tone(420,0.06,'sawtooth',0.05), setMuted:(v)=>muted=v, isMuted:()=>muted };
})();

/* ---------------------------
  Simple screen router
--------------------------- */
const screens = { hello:document.getElementById('hello'), game:document.getElementById('game'), draw:document.getElementById('draw'), chat:document.getElementById('chat') };
function show(screen){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[screen].classList.add('active'); }

/* wire top buttons */
document.getElementById('btnPlay').onclick = ()=>{ Sound.click(); show('game'); initGameIfNeeded(); };
document.getElementById('btnDraw').onclick = ()=>{ Sound.click(); show('draw'); initDrawIfNeeded(); nextChallengeIfFirst(); };
document.getElementById('btnChat').onclick = ()=>{ Sound.click(); show('chat'); initChatIfNeeded(); };

document.getElementById('btnBackGame').onclick = ()=>{ Sound.click(); show('hello'); };
document.getElementById('btnBackChat').onclick = ()=>{ Sound.click(); show('hello'); };

/* ---------------------------
  Themes ‚Äî many swatches, tooltips
--------------------------- */
const glassy = [
  {name:'Tahoe Glass', bg:'linear-gradient(135deg,#f8fbff,#eef6ff)'},
  {name:'Aurora Mist', bg:'linear-gradient(135deg,#e6f8ff,#e6f0ff)'},
  {name:'Calm Sky', bg:'linear-gradient(135deg,#dff1ff,#f7eefc)'},
  {name:'Frost', bg:'linear-gradient(135deg,#ffffff,#e6f1ff)'},
  {name:'Peach Glass', bg:'linear-gradient(135deg,#fff7f6,#fff2f0)'}
];
const metallic = [
  {name:'Space Gray', bg:'#0f1720'}, {name:'Brushed Steel', bg:'linear-gradient(135deg,#bfc8d6,#8d98a6)'}, {name:'Chrome', bg:'linear-gradient(135deg,#e6eef6,#d7dfe9)'}
];
const pastels = [
  {name:'Mint', bg:'linear-gradient(135deg,#dffaf1,#e6fff7)'}, {name:'Lavender', bg:'linear-gradient(135deg,#f2e9ff,#efe7ff)'}, {name:'Peach', bg:'linear-gradient(135deg,#fff0e6,#fff8f2)'}
];
const poster = [
  {name:'Poster Red', bg:'#E53935'}, {name:'Sunset', bg:'linear-gradient(135deg,#FF8008,#FFC837)'}, {name:'Rainbow Loop', bg:'linear-gradient(135deg,#ff0000,#ff8000,#ffff00,#008000,#0000ff,#4b0082,#9400d3)'}
];

function buildThemeGrid(containerId, list){
  const cont = document.getElementById(containerId);
  list.forEach(t=>{
    const sw = document.createElement('div');
    sw.className='theme-swatch';
    sw.title=t.name;
    sw.style.background=t.bg;
    sw.textContent=''; // no name overlay
    sw.onclick=()=>{
      document.body.style.background=t.bg;
      Sound.click();
    };
    cont.appendChild(sw);
  });
}
buildThemeGrid('themeGridGlassy', glassy);
buildThemeGrid('themeGridMetallic', metallic);
buildThemeGrid('themeGridPastel', pastels);
buildThemeGrid('themeGridPoster', poster);

/* ---------------------------
  Mini BGM player (local files in repo)
--------------------------- */
const tracks = ['bgm.mp3','bgm2.mp3','bgm3.mp3'];
let trackIdx = 0;
const audio = new Audio();
audio.loop=false; audio.preload='auto';
audio.src = tracks[trackIdx];
const playPauseBtn = document.getElementById('playPause');
const prog = document.getElementById('prog');
playPauseBtn.onclick = ()=>{
  if(audio.paused){ audio.play().catch(()=>{}); playPauseBtn.textContent='‚è∏'; } else { audio.pause(); playPauseBtn.textContent='‚ñ∂Ô∏è'; }
};
audio.addEventListener('timeupdate', ()=>{ if(audio.duration){ prog.value = (audio.currentTime/audio.duration)*100; } });
prog.addEventListener('input', ()=>{ if(audio.duration) audio.currentTime = (prog.value/100)*audio.duration; });
audio.addEventListener('ended', ()=>{ trackIdx = (trackIdx+1)%tracks.length; audio.src=tracks[trackIdx]; audio.play().catch(()=>{}); });

/* ---------------------------
  Bubble Pop ‚Äî level based (30 levels)
--------------------------- */
let gameInited=false;
function initGameIfNeeded(){
  if(gameInited) return;
  gameInited=true;
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let dpr = devicePixelRatio || 1;
  function resize(){ canvas.width = Math.floor(canvas.clientWidth*dpr); canvas.height = Math.floor(canvas.clientHeight*dpr); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
  new ResizeObserver(resize).observe(canvas); setTimeout(resize,50);

  let bubbles=[],score=0,popped=0,level=1,spawnRate=900,lastSpawn=0, lastT=performance.now();

  function spawn(){
    const r = 16 + Math.random()*30;
    const x = r + Math.random()*(canvas.clientWidth - r*2);
    const y = canvas.clientHeight + r + 10;
    const vy = (0.6 + Math.random()*1.1) * (1 + level*0.02);
    const hue = Math.floor(160 + Math.random()*160);
    bubbles.push({x,y,r,vy,hue,alpha:1,popped:false});
  }
  function drawBubble(b){
    ctx.save();
    ctx.globalAlpha = b.alpha;
    ctx.shadowColor = `rgba(255,255,255,0.9)`; ctx.shadowBlur=12; ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,0.18)';
    const cx=b.x, cy=b.y, r=b.r;
    const grad = ctx.createRadialGradient(cx-r*0.3,cy-r*0.3,r*0.2,cx,cy,r);
    grad.addColorStop(0,`hsla(${b.hue},90%,95%,.95)`); grad.addColorStop(1,`hsla(${b.hue},70%,60%,.65)`);
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(cx-r*0.38, cy-r*0.38, r*0.22, 0, Math.PI*2); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fill();
    ctx.restore();
  }

  function levelForScore(s){
    // simple: every 50 score + small boost
    return Math.min(30, 1 + Math.floor(s / 50));
  }

  function loop(t){
    const dt = t-lastT; lastT=t;
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    // soft background
    let g = ctx.createLinearGradient(0,0,canvas.clientWidth,canvas.clientHeight); g.addColorStop(0,'rgba(255,255,255,.28)'); g.addColorStop(1,'rgba(255,255,255,.18)');
    ctx.fillStyle=g; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

    if(t - lastSpawn > Math.max(200, spawnRate - level*10)){ spawn(); lastSpawn=t; }
    bubbles = bubbles.filter(b=>b.alpha>0.02);
    for(let b of bubbles){
      if(!b.popped){ b.y -= b.vy * dt * 0.06; if(b.y < -b.r){ b.popped=true; b.alpha=0; } }
      else b.alpha -= 0.02;
      drawBubble(b);
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  canvas.addEventListener('click', (ev)=>{
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left, y = ev.clientY - rect.top;
    for(let b of bubbles){
      const dx = x-b.x, dy = y-b.y;
      if(!b.popped && dx*dx + dy*dy <= b.r*b.r){
        b.popped=true; b.alpha=1; score+=1; popped+=1; Sound.pop();
        document.getElementById('scoreTxt').textContent=score;
        document.getElementById('poppedTxt').textContent=popped;
        const newLevel = levelForScore(score);
        if(newLevel>level){
          level=newLevel; document.getElementById('levelTxt').textContent=level;
          celebrateLevel(level);
        }
        checkMilestones(score);
        break;
      }
    }
  });

  document.getElementById('resetGame').onclick = ()=>{ Sound.click(); bubbles=[]; score=0; popped=0; level=1; document.getElementById('scoreTxt').textContent=0; document.getElementById('poppedTxt').textContent=0; document.getElementById('levelTxt').textContent=1; };

  function celebrateLevel(lvl){
    addChatBotTip('Game','Level up! You reached level '+lvl+' ‚Äî awesome! üéâ');
  }
  const milestones = [25,50,100,150,250,400,600,1000];
  function checkMilestones(s){
    for(let m of milestones){ if(s===m){ addChatBotTip('Game','Milestone: '+m+' popped! Keep going ‚Äî you rock! üåü'); } }
  }
}

/* ---------------------------
  Drawing pad + 100 challenge list + TF auto-check
--------------------------- */
let drawInited=false;
const challenges = [
  "cat","dog","house","tree","sun","moon","star","car","bicycle","cup",
  "mug","apple","banana","chair","table","key","lock","book","open book",
  "castle","rocket","boat","fish","butterfly","flower","mountain","cloud","rain","umbrella",
  "hat","glasses","mask","shoe","sock","cake","ice cream","cookie","ball","leaf",
  "penguin","owl","lion","tiger","elephant","giraffe","panda","horse","sheep","cow",
  "duck","chicken","piano","guitar","violin","drum","camera","phone","computer","lamp",
  "clock","watch","map","train","bus","truck","plane","kite","flag","ring",
  "gift","heart","diamond","starfish","shell","anchor","crown","torch","keycard","laptop",
  "microphone","telescope","binoculars","sword","shield","hammer","wrench","spoon","fork","knife",
  "umbrella","basket","paintbrush","palette","scissors","leaf","pear","orange","grapes","strawberry",
  "saxophone","radio","teapot","lantern","nest","owl mask","mask","wizard hat","potion","scroll"
];
// shuffle utility
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* MobileNet model variable */
let mobilenetModel = null;
async function loadMobileNet(){
  if(mobilenetModel) return mobilenetModel;
  try{
    mobilenetModel = await mobilenet.load({version:2,alpha:1.0});
  }catch(e){
    console.warn('MobileNet load failed',e);
  }
  return mobilenetModel;
}

function initDrawIfNeeded(){
  if(drawInited) return;
  drawInited=true;
  // canvas setup
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  let dpr = devicePixelRatio || 1;
  function resize(){
    const rect = canvas.getBoundingClientRect();
    const prev = ctx.getImageData(0,0,canvas.width||1,canvas.height||1);
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    try{ ctx.putImageData(prev,0,0); }catch(e){}
  }
  new ResizeObserver(resize).observe(canvas); setTimeout(resize,50);
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=10; ctx.strokeStyle='#1e88e5';

  let painting=false, lastX=0, lastY=0, brush=8;
  canvas.addEventListener('pointerdown', (e)=>{ painting=true; const r=canvas.getBoundingClientRect(); lastX=e.clientX-r.left; lastY=e.clientY-r.top; Sound.scribble(); });
  canvas.addEventListener('pointermove', (e)=>{ if(!painting) return; const r=canvas.getBoundingClientRect(); const x = e.clientX-r.left, y=e.clientY-r.top; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.lineWidth=brush; ctx.stroke(); lastX=x; lastY=y; });
  canvas.addEventListener('pointerup', ()=>{ painting=false; });
  canvas.addEventListener('pointerleave', ()=>{ painting=false; });

  // toolbar wiring
  document.getElementById('clearDraw').onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); Sound.click(); };
  document.getElementById('saveDraw').onclick = ()=>{
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='drawing.png'; a.click(); Sound.click();
  };

  // challenge logic
  let currentChallenge=null;
  const challengeText = document.getElementById('challengeText');
  const autoCheckBox = document.getElementById('autoCheck');

  function pickRandomChallenge(){
    const ch = randChoice(challenges);
    currentChallenge = ch;
    challengeText.textContent = `Try drawing a ${ch}`;
    return ch;
  }

  document.getElementById('newChallenge').onclick = ()=>{ pickRandomChallenge(); Sound.click(); };

  document.getElementById('btnOk').onclick = async ()=>{
    Sound.click();
    if(!currentChallenge) pickRandomChallenge();
    const shouldAuto = autoCheckBox.checked;
    if(shouldAuto){
      await ensureModelAndCheck();
    } else {
      addChatBotTip('Draw','OK pressed ‚Äî you can choose to auto-check in settings.');
    }
  };
  document.getElementById('btnNo').onclick = ()=>{
    Sound.click();
    // if no, give another challenge
    const alt = pickRandomChallenge();
    addChatBotTip('Draw','Cool ‚Äî new challenge: '+alt);
  };
  document.getElementById('btnLater').onclick = ()=>{
    Sound.click();
    challengeText.textContent = 'FreeStyle mode ‚Äî draw anything';
    currentChallenge = null;
    addChatBotTip('Draw','No problem ‚Äî freedraw mode active.');
  };

  // first challenge on open
  function nextChallengeIfFirst(){ if(!currentChallenge) pickRandomChallenge(); }
  window.nextChallengeIfFirst = nextChallengeIfFirst;

  async function ensureModelAndCheck(){
    const model = await loadMobileNet();
    if(!model){ addChatBotTip('Draw','Auto-check failed to load model ‚Äî try again later'); return; }
    // capture a smaller thumbnail of canvas for classification
    const thumbW = 224, thumbH = 224;
    const temp = document.createElement('canvas'); temp.width = thumbW; temp.height = thumbH;
    const tctx = temp.getContext('2d');
    // draw original canvas scaled to thumb
    tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,thumbW,thumbH);
    tctx.drawImage(canvas, 0, 0, thumbW, thumbH);
    // classify
    addChatBotTip('Draw','Checking your drawing‚Ä¶');
    const predictions = await model.classify(temp);
    // predictions array: {className,probability}
    console.log('preds',predictions);
    handlePredictions(predictions);
  }

  // synonyms map to match common labels to challenges
  const synonyms = {
    'cat':['cat','kitten','tabby','persian'], 'dog':['dog','puppy'], 'car':['car','vehicle'], 'bicycle':['bicycle','bike'], 'cup':['cup','mug'],
    'apple':['apple','fruit'], 'tree':['tree','oak','pine','fir'], 'house':['house','home','cabin'], 'boat':['boat','ship'],
    'bird':['bird','sparrow','parrot','penguin','owl'], 'flower':['flower','daisy','rose','tulip'], 'fish':['fish','goldfish']
    // extend as needed
  };
  function matchesChallenge(preds, challenge){
    const target = (challenge||'').toLowerCase().replace(/[^a-z0-9 ]/g,'').split(' ')[0];
    // check direct substring in predictions
    for(let p of preds){
      const label = p.className.toLowerCase();
      if(label.includes(target)) return true;
      // synonyms
      if(synonyms[target]){
        for(let s of synonyms[target]) if(label.includes(s)) return true;
      }
    }
    return false;
  }

  function handlePredictions(predictions){
    const ok = matchesChallenge(predictions, currentChallenge);
    if(ok){
      // success
      const tips = ["Wow! That looks great! üéâ","Nice job ‚Äî that looks like a match! ‚ú®","Amazing ‚Äî you nailed it!"];
      addChatBotTip('Draw', tips[Math.floor(Math.random()*tips.length)]);
    } else {
      // gentle retry message with playful tone
      const tips = [
        "So close ‚Äî it's got the vibe! Want to try again or keep going?",
        "Omg that's lovely ‚Äî maybe a little tweak? Try emphasizing the shape!",
        "Nice strokes! Wanna try once more for a perfect match, or free-draw?"
      ];
      addChatBotTip('Draw', tips[Math.floor(Math.random()*tips.length)]);
    }
  }
}

/* ---------------------------
  Chatbot ‚Äî improved rule-based with varied responses
--------------------------- */
let chatInited=false;
function initChatIfNeeded(){
  if(chatInited) return;
  chatInited=true;
  const chatBody = document.getElementById('chatBody');
  const input = document.getElementById('chatInput');
  const send = document.getElementById('sendChat');

  function pushBubble(text,who='bot'){
    const b = document.createElement('div');
    b.className = 'bubble '+who+' fade-in';
    b.textContent = text;
    chatBody.appendChild(b);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // initial friendly lines
  pushBubble("Hi! üëã How was your day? üòä",'bot');

  // mood quick conversations (10 lines-ish)
  function moodConversation(mood){
    const lines = {
      sad:[
        "I‚Äôm really sorry you‚Äôre feeling low ‚Äî I‚Äôm here. üíô",
        "Want to tell me what happened, or would you prefer a calming exercise?",
        "If it helps, try naming three small good things around you‚ÄîI'll wait.",
        "You're brave for sharing. Should we try a 4‚Äë4‚Äë6 breathing now?",
        "Sometimes tiny steps stack into big change. Do you want a suggestion?"
      ],
      nervous:[
        "Feeling nervous is valid ‚Äî you‚Äôre not alone. üíô",
        "Would a grounding game help? Name 5 things you can see.",
        "Try breathing with me: in 4, hold 4, out 6. Want me to pace you?",
        "We can practice a short script if you have to talk to someone.",
        "Okay ‚Äî want tips to reduce sensory overload right now?"
      ],
      happy:[
        "Yay! I love hearing that ‚ú® What made you smile today?",
        "Share the good vibes ‚Äî tell me one tiny win from today!",
        "That's wonderful. Hold onto that feeling ‚Äî want a celebratory GIF idea?"
      ],
      angry:[
        "It's okay to be angry ‚Äî your feelings matter. Want to vent?",
        "Let's do a 60‚Äësecond cool-down: stomp, breathe, count, release.",
        "If you want, we can plan a calm response together."
      ]
    };
    const seq = lines[mood] || ["I'm here if you want to share."];
    // push a short ~5-line exchange with small delays to simulate "live" chat
    seq.slice(0,5).forEach((ln,i)=> setTimeout(()=> pushBubble(ln,'bot'), 300*i + 120));
  }

  // mood buttons
  document.getElementById('mHappy').onclick = ()=>{ Sound.click(); pushBubble("üòä", 'user'); moodConversation('happy'); };
  document.getElementById('mSad').onclick = ()=>{ Sound.click(); pushBubble("üò¢", 'user'); moodConversation('sad'); };
  document.getElementById('mAngry').onclick = ()=>{ Sound.click(); pushBubble("üò†", 'user'); moodConversation('angry'); };
  document.getElementById('mNerv').onclick = ()=>{ Sound.click(); pushBubble("üò∞", 'user'); moodConversation('nervous'); };

  // send handler (smarter-ish)
  send.onclick = ()=>{ const txt = input.value.trim(); if(!txt) return; Sound.click(); pushBubble(txt,'user'); input.value=''; respondToUser(txt); };
  input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') send.click(); });

  function respondToUser(text){
    const s = text.toLowerCase();
    // quick intent detection
    const intents = [
      {k:'thanks', pat:/(thanks|thank you|ty|thx)/i, replies:["You're welcome! üòä","Anytime ‚Äî I'm here.","Glad to help."]},
      {k:'help', pat:/(help|support|advice|need help)/i, replies:["Tell me what feels hardest right now.","We can break it into tiny steps ‚Äî wanna try?","Would you like breathing or grounding first?"]},
      {k:'breathe', pat:/(breath|breathe|breathing|relax)/i, replies:["Let's breathe: in 4, hold 4, out 6. Ready?","I'll pace you: inhale... hold... exhale... repeat 3√ó."]},
      {k:'music', pat:/(music|song|play)/i, replies:["You can try soft ambient music. Want me to start a track?","Music can help ‚Äî press the mini player ‚ñ∂Ô∏è to start."]},
      {k:'draw', pat:/(draw|doodle|sketch)/i, replies:["Head to the Draw app ‚Äî try 'Try' to get a challenge, or free style.","When you're done press OK to auto-check your drawing."]}
    ];
    for(let it of intents){
      if(it.pat.test(s)){ const r = it.replies[Math.floor(Math.random()*it.replies.length)]; pushBubble(r,'bot'); return; }
    }
    // fallback: empathetic and probing
    const fallback = [
      "I'm listening. Tell me more ‚Äî small steps are fine.",
      "Thanks for sharing. What's one tiny next step you can do?",
      "I won't rush you. Want a short exercise or to chat more?",
      "I might not be perfect but I'm trying. Want a coping tool suggestion?"
    ];
    pushBubble(fallback[Math.floor(Math.random()*fallback.length)],'bot');
  }
}

/* ---------------------------
  Small helpers / tips
--------------------------- */
function addChatBotTip(area, text){
  // show as bot bubble in chat if chat exists, otherwise quick system hint
  const cb = document.getElementById('chatBody');
  if(cb){
    const b = document.createElement('div');
    b.className='bubble bot fade-in';
    b.textContent = `[${area}] ${text}`;
    cb.appendChild(b); cb.scrollTop = cb.scrollHeight;
  } else {
    // fallback: console + toast (toast not implemented)
    console.log('TIP',area,text);
  }
}

/* ---------------------------
  Init shortcuts
--------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // lazy-load model but do not block UI
  loadMobileNet().then(()=>console.log('mobilenet loaded')).catch(()=>console.log('mobilenet load error'));
  // initial UI state
  // show hello (already active)
});

/* expose a helper to pick challenge on first open */
function nextChallengeIfFirst(){ /* placeholder */ }

</script>
</body>
</html>
