<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AuraOS ‚Äî AuraAI</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0e1116; --glass: rgba(255,255,255,0.12); --glass-2: rgba(255,255,255,0.08);
    --stroke: rgba(255,255,255,0.18); --text:#eef2f6; --muted:#b8c0cc; --accent:#7cc6ff;
    --good:#59e48f; --bad:#ff7373; --trans:320ms cubic-bezier(.2,.9,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:
    radial-gradient(1200px 1200px at 10% -10%, #31405644, transparent 60%),
    radial-gradient(1000px 1000px at 90% -20%, #6245ff33, transparent 60%),
    linear-gradient(180deg,#0b0f14,#0e1116); color:var(--text); -webkit-font-smoothing:antialiased;overflow:hidden}
  body.fade-in{animation:pageIn 420ms ease both} @keyframes pageIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  /* Lock */
  .lock-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(4,6,10,0.6), rgba(4,6,10,0.6));backdrop-filter:blur(6px);z-index:9999}
  .lock-card{width:420px;max-width:94%;padding:28px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);text-align:center;box-shadow:0 12px 40px #0009}
  .lock-avatar{width:120px;height:120px;border-radius:50%;background:#ffffff12;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700}
  .lock-clock{font-size:36px;font-weight:600;margin-bottom:6px}
  .lock-date{color:var(--muted);margin-bottom:12px}
  .lock-input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);background:#ffffff06;color:var(--text);margin-bottom:8px;outline:none}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:linear-gradient(180deg,#ffffff12,#ffffff08);cursor:pointer;color:var(--text);transition:all var(--trans)}
  .btn.primary{background:linear-gradient(180deg,var(--accent)33,#a8a6ff26);border-color:var(--accent)66}
  .hint{color:var(--muted);font-size:13px}
  /* Shell */
  .shell{max-width:1320px;margin:18px auto;padding:18px;border-radius:18px;background:var(--glass);border:1px solid var(--stroke);box-shadow:0 30px 80px #0007,inset 0 1px 0 #fff1;min-height:820px;position:relative;overflow:auto}
  .clock{position:absolute;right:18px;top:14px;padding:8px 12px;border-radius:14px;background:var(--glass-2);border:1px solid var(--stroke);font-variant-numeric:tabular-nums;transition:all var(--trans)}
  .tabs{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#ffffff14,#ffffff08);border:1px solid var(--stroke);cursor:pointer;user-select:none;transition:all var(--trans)}
  .tab.active{background:linear-gradient(180deg,var(--accent)33,#a8a6ff26);border-color:var(--accent)66;transform:translateY(-3px)}
  .bar{display:flex;gap:10px;align-items:center;margin:10px 0 12px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:12px;background:var(--glass-2);border:1px solid var(--stroke);cursor:pointer}
  .spacer{flex:1}
  .side-card,.main-card{background:var(--glass-2);border:1px solid var(--stroke);border-radius:12px;padding:12px;box-shadow:inset 0 1px 0 #fff2,0 10px 30px #0005}
  input.input,select.input,textarea.input{background:#ffffff08;border:1px solid var(--stroke);padding:8px;border-radius:8px;color:var(--text);outline:none}
  .chat-wrap{display:grid;grid-template-columns:300px 1fr;gap:12px}
  .bubble-list{display:flex;gap:8px;flex-wrap:wrap}
  .chat{height:520px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:70%;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#ffffff14,#ffffff08);border:1px solid var(--stroke)}
  .msg.me{margin-left:auto;background:linear-gradient(180deg,var(--accent)33,#a8a6ff26)}
  canvas.doodle{width:100%;aspect-ratio:4/3;background:#081018;border-radius:10px;border:1px solid var(--stroke);touch-action:none;cursor:crosshair}
  .thumb{background:#0b1116;border-radius:10px;padding:8px;border:1px solid var(--stroke);cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:96px}
  .swatch{padding:8px;border-radius:10px;border:1px solid var(--stroke);background:#ffffff12;cursor:pointer;min-height:72px;position:relative;overflow:hidden}
  .tag{position:absolute;left:8px;bottom:8px;background:#0005;padding:4px 6px;border-radius:6px;color:#fff;font-size:12px}
  .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .game-card{background:linear-gradient(180deg,#ffffff07,#ffffff03);border:1px solid var(--stroke);padding:10px;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center}
  .hint.small{font-size:12px;color:var(--muted)}
  .panel{display:none}
  .panel.active{display:block}
  /* responsive */
  @media(max-width:980px){ .chat-wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
<!-- LOCK -->
<div id="lock" class="lock-wrap" aria-hidden="false">
  <div class="lock-card" role="dialog" aria-modal="true">
    <div class="lock-avatar" id="lockAvatar"><div id="lockAvatarPlaceholder">Aura</div></div>
    <div class="lock-clock" id="lockClock">--:--</div>
    <div class="lock-date" id="lockDate">Loading date...</div>

    <input id="lockUser" class="lock-input" placeholder="Username" autocomplete="username">
    <input id="lockPass" class="lock-input" type="password" placeholder="Password" autocomplete="current-password">
    <div style="display:flex;gap:8px;margin-top:6px;justify-content:center">
      <button id="lockLogin" class="btn primary">Sign in</button>
      <button id="lockRegister" class="btn">Register</button>
    </div>
    <div style="height:10px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="hint">Startup login</div>
      <select id="langSelectLock" class="lang-select" aria-label="Language selector"></select>
    </div>
    <div id="lockMsg" class="hint" style="margin-top:10px"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="shell" style="display:none">
  <div class="clock" id="clock">--:--:--</div>
  <div class="tabs" role="tablist" aria-label="Main sections">
    <div class="tab active" data-target="panel-aura">ü´ß AuraAI</div>
    <div class="tab" data-target="panel-draw">üé® Draw</div>
    <div class="tab" data-target="panel-color">üñçÔ∏è Coloring</div>
    <div class="tab" data-target="panel-themes">üé® Themes</div>
    <div class="tab" data-target="panel-music">üéµ Music</div>
    <div class="tab" data-target="panel-games">üéÆ Games</div>
    <div class="tab" data-target="panel-journal">üìñ Journal</div>
    <div class="tab" data-target="panel-account">üë§ Account</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="btn">Log out</button>
  </div>

  <!-- AURA CHAT -->
  <div class="panel active" id="panel-aura">
    <div class="bar"><div class="chip" id="openThemes">üé® Themes</div><div class="spacer"></div><div class="chip" id="assistToggle">ü§ñ Assist: Offline</div></div>
    <div class="chat-wrap">
      <div class="side-card">
        <h3>Quick</h3>
        <div class="bubble-list">
          <div class="chip bubble" data-say="How was your day?">How was your day?</div>
          <div class="chip bubble" data-say="I'm feeling nervous">I'm feeling nervous</div>
          <div class="chip bubble" data-say="Give me a breathing exercise">Breathing</div>
        </div>
        <h3 style="margin-top:12px">Activities</h3>
        <div class="bubble-list">
          <div class="chip bubble" data-action="openDraw">Open Draw</div>
          <div class="chip bubble" data-action="openColor">Open Coloring</div>
          <div class="chip bubble" data-action="openGames">Open Games</div>
        </div>
      </div>

      <div class="main-card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <input id="input" class="input" placeholder="Talk to Aura...">
          <button id="send" class="btn primary">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DRAW -->
  <div class="panel" id="panel-draw">
    <div class="bar">
      <div class="chip" id="clearDraw">üßº Clear</div>
      <div class="chip" id="undoDraw">‚Ü©Ô∏è Undo</div>
      <div class="chip" id="redoDraw">‚Ü™Ô∏è Redo</div>
      <div class="spacer"></div>
      <div class="row">
        <label class="hint" style="margin-right:6px">Brush</label>
        <input id="brushSize" type="range" min="1" max="64" value="10">
        <input id="brushColor" type="color" value="#ffffff" style="margin-left:8px">
        <button id="saveDraw" class="btn">Save</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:280px 1fr;gap:12px">
      <div class="side-card">
        <div class="hint">Freestyle drawing ‚Äî no prompts. Use undo/redo, clear, and save.</div>
        <div style="height:8px"></div>
        <div class="hint">Tip: Use different brush sizes for texture.</div>
      </div>
      <div class="main-card">
        <canvas id="doodle" class="doodle" width="1200" height="900"></canvas>
      </div>
    </div>
  </div>

  <!-- COLORING -->
  <div class="panel" id="panel-color">
    <div class="bar">
      <div class="chip" id="newColor">üñº New</div>
      <div class="chip" id="resetColor">üîÑ Reset</div>
      <div class="spacer"></div>
      <div class="chip" id="colorBrush" aria-pressed="true">‚úèÔ∏è Brush</div>
      <div class="chip" id="colorFill">ü™£ Fill</div>
      <div class="chip" id="colorEraser">üßΩ Eraser</div>
      <div class="chip" id="undoColor">‚Ü©Ô∏è Undo</div>
      <div class="chip" id="redoColor">‚Ü™Ô∏è Redo</div>
      <div class="spacer"></div>
      <label class="hint">Size</label>
      <input id="colorSize" type="range" min="1" max="80" value="16">
      <input id="colorPicker" type="color" value="#ff4b6b" style="margin-left:8px">
      <button id="saveColor" class="btn">Save</button>
    </div>

    <div style="display:grid;grid-template-columns:280px 1fr;gap:12px">
      <div class="side-card">
        <h3>Gallery</h3>
        <div id="colorThumbs" class="color-grid"></div>
        <div style="height:8px"></div>
        <div class="hint">Outlines are thick to make bucket fills reliable.</div>
      </div>
      <div class="main-card">
        <canvas id="colorCanvas" class="colorCanvas" width="1200" height="900"></canvas>
      </div>
    </div>
  </div>

  <!-- THEMES -->
  <div class="panel" id="panel-themes">
    <div class="bar">
      <div class="chip" id="backToAura">‚¨Ö Back</div>
      <div class="chip" id="surpriseThemeTop">üé≤ Surprise Me</div>
      <div class="spacer"></div>
      <div class="hint">100+ unique themes grouped by section (grayscale, poster, gradients, animated).</div>
    </div>
    <div id="themesRoot" class="themes-wrap"></div>
  </div>

  <!-- MUSIC (Spotify kept as requested) -->
  <div class="panel" id="panel-music">
    <div class="bar">
      <div class="chip" id="openSpotify">Open in Spotify</div>
      <div class="spacer"></div>
      <div class="hint">Embedded Spotify album ‚Äî left as-is.</div>
    </div>
    <div class="main-card">
      <div class="spotify-wrap" style="padding:14px">
        <!-- spotify iframe kept; user asked not to change it -->
        <iframe id="spotifyEmbed" src="https://open.spotify.com/embed/album/7shstgp8BAiSrFryJu4K8I" width="100%" height="520" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
      </div>
      <div style="height:8px"></div>
      <a id="openSpotifyLink" href="https://open.spotify.com/album/69AaAkdktFGnk9POmHENkT" target="_blank" class="btn primary">Open in Spotify</a>
    </div>
  </div>

  <!-- GAMES -->
  <div class="panel" id="panel-games">
    <div class="bar"><div class="chip" id="refreshGames">‚Üª Refresh</div><div class="spacer"></div><div class="hint">Gaming Hub ‚Äî click a game to launch.</div></div>
    <div style="display:grid;grid-template-columns:320px 1fr;gap:12px">
      <div class="side-card">
        <h3>Games</h3>
        <div id="gamesList" class="games-grid"></div>
        <div style="height:8px"></div>
        <div class="hint">Each game runs in the right-side play area.</div>
      </div>
      <div class="main-card">
        <div id="gameInfo" style="margin-bottom:8px" class="hint">Select a game to play.</div>
        <div id="gameArea" class="game-area"></div>
      </div>
    </div>
  </div>

  <!-- JOURNAL -->
  <div class="panel" id="panel-journal">
    <div style="display:flex;flex-direction:column;gap:8px">
      <textarea id="journalText" class="journal-textarea" placeholder="Dear journal..." style="height:520px;background:#ffffff08;border:1px solid var(--stroke);padding:12px;border-radius:10px;color:var(--text)"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveJournal" class="btn good">Save</button>
        <button id="downloadJournal" class="btn">Download</button>
        <button id="clearJournal" class="btn bad">Clear</button>
      </div>
    </div>
  </div>

  <!-- ACCOUNT -->
  <div class="panel" id="panel-account">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="side-card" style="min-width:240px;max-width:320px">
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
          <div id="avatarBox" style="width:140px;height:140px;border-radius:50%;overflow:hidden;background:#ffffff12;border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center">
            <img id="avatarImg" src="" style="width:100%;height:100%;object-fit:cover;display:none">
            <div id="avatarPlaceholder" class="hint">No avatar</div>
          </div>
          <input id="avatarInput" type="file" accept="image/*">
          <button id="removeAvatar" class="btn bad">Remove Avatar</button>
        </div>
      </div>

      <div class="main-card">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label class="hint">Name</label>
            <input id="displayName" class="input" placeholder="Your name">
          </div>
          <div>
            <label class="hint">Status</label>
            <select id="statusSelect" class="input"><option value="available">Available</option><option value="busy">Busy</option><option value="offline">Offline</option><option value="custom">Custom</option></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <label class="hint">Bio</label>
        <textarea id="bioInput" class="input" style="height:80px"></textarea>
        <div style="height:8px"></div>
        <label class="hint">Accent</label>
        <div id="colorSwatches" style="display:flex;gap:8px;margin-top:6px"></div>
        <div style="height:8px"></div>
        <label class="hint">Theme & background</label>
        <select id="bgSelect" class="input"><option value="default">Default</option><option value="vintage">Vintage</option><option value="calm">Calm</option><option value="solid">Solid</option></select>
        <input id="bgColor" type="color" value="#0b0f14" style="margin-top:8px">
        <div style="height:10px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="saveProfile" class="btn good">Save</button>
          <button id="resetProfile" class="btn">Reset</button>
          <button id="exportProfile" class="btn">Export</button>
          <input id="importProfile" type="file" style="display:inline-block">
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= Config ================= */
const BACKEND = 'https://tenantable-matt-tactless.ngrok-free.dev/'; // user-specified
const TOKEN_KEY = 'Aura_Token_v1';
const PROFILE_KEY = 'Aura_Profile_v1';
/* ================= Helpers ================= */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $all = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
function tLog(...a){console.log('[AuraOS]',...a)}

/* ============ Lock UI ============ */
function populateLangs(){
  const LANGS = ['en','ta','zh','ms','hi'];
  const sel = $('#langSelectLock');
  if(!sel) return;
  sel.innerHTML='';
  LANGS.forEach(l=>{
    const opt=document.createElement('option'); opt.value=l;
    opt.textContent = (l==='en'?'English': l==='ta'?'‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç': l==='zh'?'‰∏≠Êñá': l==='ms'?'Bahasa Melayu': l==='hi'?'‡§π‡§ø‡§®‡•ç‡§¶‡•Ä':l);
    sel.appendChild(opt);
  });
}
populateLangs();

function tickClock(){
  const d=new Date();
  $('#lockClock').textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  $('#lockDate').textContent = d.toDateString();
}
setInterval(tickClock,1000); tickClock();

/* ============ Auth API ============ */
async function registerUser(username,password,displayName){
  try{
    const r = await fetch(BACKEND + 'register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password, displayName }) });
    return await r.json();
  }catch(e){ return { error:'network' } }
}
async function loginUser(username,password){
  try{
    const r = await fetch(BACKEND + 'login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
    return await r.json();
  }catch(e){ return { error:'network' } }
}
async function whoami(){
  const token = localStorage.getItem(TOKEN_KEY);
  if(!token) return null;
  try{
    const r = await fetch(BACKEND + 'profile', { headers:{ Authorization: 'Bearer ' + token } });
    if(r.status===200){ const j=await r.json(); return j.user; }
    return null;
  }catch(e){ return null; }
}

/* ============ Lock wiring ============ */
$('#lockLogin')?.addEventListener('click', async ()=>{
  $('#lockMsg').textContent='';
  const u = $('#lockUser').value.trim(), p = $('#lockPass').value;
  if(!u||!p){ $('#lockMsg').textContent='Provide username & password'; return; }
  $('#lockLogin').disabled=true; $('#lockLogin').textContent='Signing in...';
  const res = await loginUser(u,p);
  $('#lockLogin').disabled=false; $('#lockLogin').textContent='Sign in';
  if(res && res.ok && res.token){
    localStorage.setItem(TOKEN_KEY, res.token);
    localStorage.setItem(PROFILE_KEY, JSON.stringify(res.user.profile||{}));
    finalizeLogin();
  } else { $('#lockMsg').textContent = (res && res.error) ? JSON.stringify(res) : 'Login failed'; }
});

$('#lockRegister')?.addEventListener('click', async ()=>{
  $('#lockMsg').textContent='';
  const u = $('#lockUser').value.trim(), p = $('#lockPass').value;
  if(!u||!p){ $('#lockMsg').textContent='Provide username & password'; return; }
  $('#lockRegister').disabled=true; $('#lockRegister').textContent='Registering...';
  const res = await registerUser(u,p,u);
  $('#lockRegister').disabled=false; $('#lockRegister').textContent='Register';
  if(res && res.ok && res.token){
    localStorage.setItem(TOKEN_KEY, res.token);
    localStorage.setItem(PROFILE_KEY, JSON.stringify(res.user.profile||{}));
    finalizeLogin();
  } else { $('#lockMsg').textContent = (res && res.error) ? JSON.stringify(res) : 'Register failed'; }
});

async function tryAutoLogin(){
  const who = await whoami();
  if(who){
    // populate profile locally then show app
    try{ const p = JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); Object.assign(p, who.profile||{}); localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }catch(e){}
    finalizeLogin();
  } else {
    $('#lock').style.display='flex';
    $('#app').style.display='none';
  }
}

function finalizeLogin(){
  $('#lock')?.remove();
  $('#app').style.display='block';
  document.body.classList.add('fade-in');
  initApp();
}

/* ============ App Init ============ */
function initApp(){
  loadProfile();
  renderGameList();
  renderColorThumbs();
  renderThemes();
  // wire basic UI
  $all('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=> {
      $all('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-target');
      $all('.panel').forEach(p=>p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
    });
  });
  // quick bubbles
  $all('.bubble').forEach(b=> b.addEventListener('click', e=>{
    const say = e.currentTarget.dataset.say;
    const action = e.currentTarget.dataset.action;
    if(say){ $('#input').value = say; $('#send').click(); }
    if(action){
      if(action==='openDraw') showPanel('panel-draw');
      if(action==='openColor') showPanel('panel-color');
      if(action==='openGames') showPanel('panel-games');
    }
  }));
  $('#send').addEventListener('click', sendChat);
  $('#input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
  $('#assistToggle').addEventListener('click', ()=> { $('#assistToggle').textContent = $('#assistToggle').textContent.includes('Offline') ? 'ü§ñ Assist: API-ready' : 'ü§ñ Assist: Offline'; });
  $('#openThemes')?.addEventListener('click', ()=> showPanel('panel-themes'));
  $('#backToAura')?.addEventListener('click', ()=> showPanel('panel-aura'));
  $('#logoutBtn')?.addEventListener('click', ()=> { if(confirm('Log out of AuraOS?')){ localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(PROFILE_KEY); location.reload(); }});
  updateShellClock(); setInterval(updateShellClock,1000);
}

/* ============ Chat ============ */
function addMsg(html, who='bot'){ const el=document.createElement('div'); el.className='msg'+(who==='me'?' me':''); el.innerHTML = html; $('#chat').appendChild(el); $('#chat').scrollTop = $('#chat').scrollHeight; }
function sendChat(){ const v = $('#input').value.trim(); if(!v) return; addMsg(v,'me'); $('#input').value=''; setTimeout(()=> generateReply(v), 260); }
function generateReply(text){
  const t = text.toLowerCase();
  if(/\b(hi|hello|hey|yo)\b/.test(t)) return addMsg("Hey! I'm Aura ‚Äî I can chat, suggest activities, or open tools.");
  if(t.includes('draw')){ showPanel('panel-draw'); return addMsg("Opening Draw ‚Äî freestyle time!"); }
  if(t.includes('color')){ showPanel('panel-color'); return addMsg("Opening Coloring Book üé®"); }
  if(t.includes('music')){ showPanel('panel-music'); return addMsg("Music tab ready ‚Äî play something nice."); }
  if(t.includes('journal')){ showPanel('panel-journal'); return addMsg("Journal opened ‚Äî tell me about your day."); }
  if(t.includes('breathe')||t.includes('calm')) return addMsg("Try: inhale 4 ‚Äî hold 4 ‚Äî exhale 6. Repeat 3 times.");
  addMsg("Cool. Want to try draw, color, or play a game?");
}

/* ============ DRAW (simple) ============ */
const doodle = $('#doodle'); const dctx = doodle && doodle.getContext && doodle.getContext('2d');
if(doodle && dctx){
  let drawing=false, last=null, drawUndo=[], drawRedo=[];
  function setCanvasSize(canvas){
    const ratio = window.devicePixelRatio||1;
    const w = canvas.clientWidth * ratio, h = canvas.clientHeight * ratio;
    if(canvas.width !== w || canvas.height !== h){
      try{ const img = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height); canvas.width = w; canvas.height = h; canvas.getContext('2d').putImageData(img,0,0); }catch(e){ canvas.width=w; canvas.height=h; }
    }
  }
  setCanvasSize(doodle);
  window.addEventListener('resize', ()=> setCanvasSize(doodle));
  function pointer(e, canvas){ const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const ratio = canvas.width / rect.width; return { x: (clientX - rect.left) * ratio, y: (clientY - rect.top) * ratio }; }
  function saveDrawState(){ try{ drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.height)); if(drawUndo.length>60) drawUndo.shift(); drawRedo=[]; }catch(e){} }
  doodle.addEventListener('pointerdown', e=>{ drawing=true; last = pointer(e,doodle); dctx.lineCap='round'; dctx.lineJoin='round'; dctx.strokeStyle = $('#brushColor').value; dctx.lineWidth = Number($('#brushSize').value) * (doodle.width / doodle.clientWidth); saveDrawState(); });
  doodle.addEventListener('pointermove', e=>{ if(!drawing) return; const p = pointer(e,doodle); dctx.beginPath(); dctx.moveTo(last.x,last.y); dctx.lineTo(p.x,p.y); dctx.stroke(); last = p; });
  window.addEventListener('pointerup', ()=> { if(drawing){ drawing=false; }});
  $('#clearDraw')?.addEventListener('click', ()=> { saveDrawState(); dctx.clearRect(0,0,doodle.width,doodle.height); });
  $('#undoDraw')?.addEventListener('click', ()=> { if(drawUndo.length>0){ const prev = drawUndo.pop(); drawRedo.push(dctx.getImageData(0,0,doodle.width,doodle.height)); dctx.putImageData(prev,0,0); }});
  $('#redoDraw')?.addEventListener('click', ()=> { if(drawRedo.length>0){ const next = drawRedo.pop(); drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.clientHeight)); dctx.putImageData(next,0,0); }});
  $('#saveDraw')?.addEventListener('click', ()=> { const a=document.createElement('a'); a.href = doodle.toDataURL('image/png'); a.download = `draw-${Date.now()}.png`; a.click(); });
}

/* ============ COLORING (thumbnails + simple bucket) ============ */
const SVG_PAGES = (function(){
  const pages=[]; const wrap=(inner,w=800,h=600)=>`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'><rect width='100%' height='100%' fill='white'/><g fill='none' stroke='#000' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'>${inner}</g></svg>`;
  pages.push({name:'Happy Kitty', svg: wrap("<path d='M240 320 q-60 -180 160 -160 q220 -20 160 160 q-40 100 -160 120 q-120 -20 -160 -120z' /><circle cx='330' cy='260' r='12'/><circle cx='470' cy='260' r='12'/><path d='M380 340 q30 20 60 0'/>")});
  pages.push({name:'Zoom Car', svg: wrap("<rect x='120' y='300' width='560' height='80' rx='20'/><circle cx='260' cy='420' r='36'/><circle cx='540' cy='420' r='36'/>")});
  pages.push({name:'Cozy House', svg: wrap("<path d='M140 360 h520 v-180 h-520z' /><path d='M140 360 l260 -200 l260 200' /><rect x='360' y='260' width='80' height='60'/>")});
  return pages;
})();
function renderColorThumbs(){ const root = $('#colorThumbs'); if(!root) return; root.innerHTML=''; SVG_PAGES.forEach((p,i)=>{ const d=document.createElement('div'); d.className='thumb'; d.title=p.name; const img=new Image(); img.src='data:image/svg+xml;utf8,'+encodeURIComponent(p.svg); img.style.maxWidth='100%'; img.style.maxHeight='90px'; d.appendChild(img); d.addEventListener('click', ()=> loadColoring(i)); root.appendChild(d); }); }
function loadColoring(idx){ const svg = SVG_PAGES[idx].svg; const img = new Image(); img.onload = ()=>{ const canvas = $('#colorCanvas'); const cctx = canvas.getContext('2d'); canvas.width = canvas.clientWidth * (window.devicePixelRatio||1); canvas.height = canvas.clientHeight * (window.devicePixelRatio||1); cctx.fillStyle = '#fff'; cctx.fillRect(0,0,canvas.width,canvas.height); const ratio = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.96; const tw = img.width * ratio, th = img.height * ratio; const dx = (canvas.width - tw)/2, dy = (canvas.height - th)/2; cctx.drawImage(img,0,0,img.width,img.height,dx,dy,tw,th); }; img.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg); }
renderColorThumbs();

/* ============ THEMES (simple) ============ */
const THEMES = [{name:'Default',bg:'#0b0f14'},{name:'Calm',bg:'#0b1420'},{name:'Vintage',bg:'#2b1f1f'}];
function renderThemes(){ const root = $('#themesRoot'); if(!root) return; root.innerHTML=''; THEMES.forEach(t=>{ const el=document.createElement('div'); el.className='swatch'; el.title=t.name; const preview=document.createElement('div'); preview.style.height='56px'; preview.style.borderRadius='8px'; preview.style.background = `linear-gradient(90deg, ${t.bg}, ${t.bg})`; el.appendChild(preview); const tag=document.createElement('div'); tag.className='tag'; tag.textContent=t.name; el.appendChild(tag); el.addEventListener('click', ()=> { document.body.style.background = `linear-gradient(180deg, ${t.bg}, ${t.bg})`; localStorage.setItem('Aura_Theme', JSON.stringify(t)); }); root.appendChild(el); }); }

/* ============ GAMES (list only) ============ */
const games = [
  {id:'bubble', title:'Bubble Pop+', desc:'Pop bubbles', run: ()=>{}},
  {id:'snake', title:'Snake+', desc:'Classic snake', run: ()=>{}}
];
function renderGameList(){ const root = $('#gamesList'); if(!root) return; root.innerHTML=''; games.forEach(g=>{ const card=document.createElement('div'); card.className='game-card'; const h=document.createElement('div'); h.style.fontWeight='700'; h.textContent=g.title; const p=document.createElement('div'); p.style.fontSize='13px'; p.style.color='var(--muted)'; p.textContent=g.desc; const btn=document.createElement('button'); btn.className='btn primary'; btn.textContent='Play'; btn.addEventListener('click', ()=> { alert('Launching '+g.title); }); card.appendChild(h); card.appendChild(p); card.appendChild(btn); root.appendChild(card); }); }

/* ============ PROFILE (local UI + avatar) ============ */
const localProfileKey = 'Aura_Profile_v1';
let profile = {name:'Anonymous',bio:'',status:'available',color:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),avatar:'',bg:'default'};
function loadProfile(){ try{ const raw = localStorage.getItem(localProfileKey); if(raw) Object.assign(profile, JSON.parse(raw)); }catch(e){} applyProfileUI(); }
function saveProfile(){ profile.name = $('#displayName').value || 'Anonymous'; profile.bio = $('#bioInput').value || ''; profile.status = $('#statusSelect').value; localStorage.setItem(localProfileKey, JSON.stringify(profile)); alert('Profile saved locally'); applyProfileUI(); }
function applyProfileUI(){ $('#displayName').value = profile.name; $('#bioInput').value = profile.bio; $('#statusSelect').value = profile.status; if(profile.avatar){ $('#avatarImg').src = profile.avatar; $('#avatarImg').style.display='block'; $('#avatarPlaceholder').style.display='none' } else { $('#avatarImg').style.display='none'; $('#avatarPlaceholder').style.display='block' } document.documentElement.style.setProperty('--accent', profile.color); }
$('#saveProfile')?.addEventListener('click', saveProfile);
$('#resetProfile')?.addEventListener('click', ()=> { localStorage.removeItem(localProfileKey); profile = {name:'Anonymous',bio:'',status:'available',color:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),avatar:'',bg:'default'}; applyProfileUI(); });
$('#exportProfile')?.addEventListener('click', ()=> { const blob=new Blob([JSON.stringify(profile)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='aura_profile.json'; a.click(); URL.revokeObjectURL(url); });
$('#importProfile')?.addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ profile=JSON.parse(fr.result); localStorage.setItem(localProfileKey, JSON.stringify(profile)); applyProfileUI(); alert('Profile imported'); }catch(err){ alert('Invalid file'); } }; fr.readAsText(f); });

$('#avatarInput')?.addEventListener('change', (e)=> { const f = e.target.files[0]; if(!f) return; const fr = new FileReader(); fr.onload = ()=> { profile.avatar = fr.result; $('#avatarImg').src = profile.avatar; $('#avatarImg').style.display='block'; $('#avatarPlaceholder').style.display='none'; localStorage.setItem(localProfileKey, JSON.stringify(profile)); }; fr.readAsDataURL(f); });
$('#removeAvatar')?.addEventListener('click', ()=> { profile.avatar=''; $('#avatarImg').style.display='none'; $('#avatarPlaceholder').style.display='block'; localStorage.setItem(localProfileKey, JSON.stringify(profile)); });

/* ============ JOURNAL ============ */
const journalKey='Aura_Journal';
$('#journalText').value = localStorage.getItem(journalKey) || '';
$('#saveJournal')?.addEventListener('click', ()=> { localStorage.setItem(journalKey, $('#journalText').value); alert('Journal saved.'); });
$('#downloadJournal')?.addEventListener('click', ()=> { const blob=new Blob([$('#journalText').value], {type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='journal.txt'; a.click(); URL.revokeObjectURL(url); });
$('#clearJournal')?.addEventListener('click', ()=> { if(confirm('Clear journal?')){ $('#journalText').value=''; localStorage.removeItem(journalKey); } });

/* ============ UTILITIES ============ */
function updateShellClock(){ const d=new Date(); const c = $('#clock'); if(c) c.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function showPanel(id){ $all('.panel').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); $all('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-target')===id)); }

/* ============ BOOT ============ */
tryAutoLogin();

/* ============ page ready polish ============ */
window.addEventListener('load', ()=>{
  // entrance animations
  setTimeout(()=> {
    $all('.pane, .tab, .side-card, .main-card').forEach((el,i)=>{ el.style.opacity=0; setTimeout(()=>{ el.style.transition='opacity .5s ease, transform .5s ease'; el.style.transform='translateY(6px)'; requestAnimationFrame(()=>{ el.style.opacity=1; el.style.transform='none'; }); }, i*40) });
  }, 300);
  tLog('AuraOS ready');
});
</script>
</body>
</html>
