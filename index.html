<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AuraOS ‚Äî AuraAI</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0e1116; --glass: rgba(255,255,255,0.12); --glass-2: rgba(255,255,255,0.08);
    --stroke: rgba(255,255,255,0.18); --text:#eef2f6; --muted:#b8c0cc; --accent:#7cc6ff;
    --good:#59e48f; --bad:#ff7373; --trans:320ms cubic-bezier(.2,.9,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:
    radial-gradient(1200px 1200px at 10% -10%, #31405644, transparent 60%),
    radial-gradient(1000px 1000px at 90% -20%, #6245ff33, transparent 60%),
    linear-gradient(180deg,#0b0f14,#0e1116); color:var(--text); -webkit-font-smoothing:antialiased;overflow:hidden}
  body.fade-in{animation:pageIn 420ms ease both} @keyframes pageIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .lock-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(4,6,10,0.6), rgba(4,6,10,0.6));backdrop-filter:blur(6px);z-index:9999}
  .lock-card{width:420px;max-width:94%;padding:28px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);text-align:center;box-shadow:0 12px 40px #0009}
  .lock-avatar{width:120px;height:120px;border-radius:50%;background:#ffffff12;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700;transition:all 240ms}
  .lock-avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .lock-clock{font-size:36px;font-weight:600;margin-bottom:6px}
  .lock-date{color:var(--muted);margin-bottom:12px}
  .lock-input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);background:#ffffff06;color:var(--text);margin-bottom:8px;outline:none}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:linear-gradient(180deg,#ffffff12,#ffffff08);cursor:pointer;color:var(--text);transition:all var(--trans)}
  .btn.primary{background:linear-gradient(180deg,var(--accent)33,#a8a6ff26);border-color:var(--accent)66}
  .lang-select{border-radius:8px;padding:8px;background:#ffffff08;border:1px solid var(--stroke);color:var(--text)}
  .hint{color:var(--muted);font-size:13px}
  .shell{max-width:1320px;margin:18px auto;padding:18px;border-radius:18px;background:var(--glass);border:1px solid var(--stroke);box-shadow:0 30px 80px #0007,inset 0 1px 0 #fff1;min-height:820px;position:relative;overflow:auto}
  .clock{position:absolute;right:18px;top:14px;padding:8px 12px;border-radius:14px;background:var(--glass-2);border:1px solid var(--stroke);font-variant-numeric:tabular-nums;transition:all var(--trans)}
  .tabs{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#ffffff14,#ffffff08);border:1px solid var(--stroke);cursor:pointer;user-select:none;transition:all var(--trans)}
  .tab.active{background:linear-gradient(180deg,var(--accent)33,#a8a6ff26);border-color:var(--accent)66;transform:translateY(-3px)}
  .bar{display:flex;gap:10px;align-items:center;margin:10px 0 12px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:12px;background:var(--glass-2);border:1px solid var(--stroke);cursor:pointer}
  .spacer{flex:1}
  .side-card,.main-card{background:var(--glass-2);border:1px solid var(--stroke);border-radius:12px;padding:12px;box-shadow:inset 0 1px 0 #fff2,0 10px 30px #0005}
  input.input,select.input,textarea.input{background:#ffffff08;border:1px solid var(--stroke);padding:8px;border-radius:8px;color:var(--text);outline:none}
  .chat-wrap{display:grid;grid-template-columns:300px 1fr;gap:12px}
  .bubble-list{display:flex;gap:8px;flex-wrap:wrap}
  .chat{height:520px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:70%;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#ffffff14,#ffffff08);border:1px solid var(--stroke)}
  .msg.me{margin-left:auto;background:linear-gradient(180deg,var(--accent)33,#a8a6ff26)}
  canvas.doodle{width:100%;aspect-ratio:4/3;background:#081018;border-radius:10px;border:1px solid var(--stroke);touch-action:none;cursor:crosshair}
  .thumb{background:#0b1116;border-radius:10px;padding:8px;border:1px solid var(--stroke);cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:96px}
  .swatch{padding:8px;border-radius:10px;border:1px solid var(--stroke);background:#ffffff12;cursor:pointer;min-height:72px;position:relative;overflow:hidden}
  .tag{position:absolute;left:8px;bottom:8px;background:#0005;padding:4px 6px;border-radius:6px;color:#fff;font-size:12px}
  .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .game-card{background:linear-gradient(180deg,#ffffff07,#ffffff03);border:1px solid var(--stroke);padding:10px;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center}
  .game-area{background:#061218;border-radius:10px;padding:8px;border:1px solid var(--stroke);min-height:420px;display:flex;align-items:center;justify-content:center}
  .panel{display:none}
  .panel.active{display:block}
  @media(max-width:980px){ .chat-wrap{grid-template-columns:1fr} .game-area{min-height:320px} }
</style>
</head>
<body>
<div id="lock" class="lock-wrap" aria-hidden="false">
  <div class="lock-card" role="dialog" aria-modal="true">
    <div class="lock-avatar" id="lockAvatar"><img id="lockAvatarImg" src="" style="display:none"><div id="lockAvatarPlaceholder">Guest</div></div>
    <div class="lock-clock" id="lockClock">--:--</div>
    <div class="lock-date" id="lockDate">Loading date...</div>

    <input id="lockUser" class="lock-input" placeholder="Username" autocomplete="username">
    <input id="lockPass" class="lock-input" type="password" placeholder="Password" autocomplete="current-password">
    <div style="display:flex;gap:8px;margin-top:6px;justify-content:center">
      <button id="lockLogin" class="btn primary">Sign in</button>
      <button id="lockRegister" class="btn">Register</button>
    </div>
    <div style="height:10px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="hint" id="startupLabel">Startup login</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="langSelectLock" class="lang-select" aria-label="Language selector"></select>
        <div class="chip" id="modeChip" title="Chat mode">Mode: Classic</div>
      </div>
    </div>
    <div id="lockMsg" class="hint" style="margin-top:10px"></div>
  </div>
</div>

<div id="app" class="shell" style="display:none">
  <div class="clock" id="clock">--:--:--</div>
  <div class="tabs" role="tablist" aria-label="Main sections">
    <div class="tab active" data-target="panel-aura">ü´ß AuraAI</div>
    <div class="tab" data-target="panel-draw">üé® Draw</div>
    <div class="tab" data-target="panel-color">üñçÔ∏è Coloring</div>
    <div class="tab" data-target="panel-themes">üé® Themes</div>
    <div class="tab" data-target="panel-music">üéµ Music</div>
    <div class="tab" data-target="panel-games">üéÆ Games</div>
    <div class="tab" data-target="panel-journal">üìñ Journal</div>
    <div class="tab" data-target="panel-account">üë§ Account</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="btn">Log out</button>
  </div>

  <div class="panel active" id="panel-aura">
    <div class="bar"><div class="chip" id="openThemes">üé® Themes</div><div class="spacer"></div><div class="chip" id="assistToggle">ü§ñ Assist: Offline</div></div>
    <div class="chat-wrap">
      <div class="side-card">
        <h3 id="quickTitle">Quick</h3>
        <div class="bubble-list">
          <div class="chip bubble" data-say="How was your day?">How was your day?</div>
          <div class="chip bubble" data-say="I'm feeling nervous">I'm feeling nervous</div>
          <div class="chip bubble" data-say="Give me a breathing exercise">Breathing</div>
        </div>
        <h3 style="margin-top:12px" id="activitiesTitle">Activities</h3>
        <div class="bubble-list">
          <div class="chip bubble" data-action="openDraw">Open Draw</div>
          <div class="chip bubble" data-action="openColor">Open Coloring</div>
          <div class="chip bubble" data-action="openGames">Open Games</div>
        </div>
      </div>

      <div class="main-card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <input id="input" class="input" placeholder="Talk to Aura...">
          <button id="send" class="btn primary">Send</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-draw">
    <div class="bar">
      <div class="chip" id="clearDraw">üßº Clear</div>
      <div class="chip" id="undoDraw">‚Ü©Ô∏è Undo</div>
      <div class="chip" id="redoDraw">‚Ü™Ô∏è Redo</div>
      <div class="spacer"></div>
      <div class="row">
        <label class="hint" style="margin-right:6px" id="brushLabel">Brush</label>
        <input id="brushSize" type="range" min="1" max="64" value="10">
        <input id="brushColor" type="color" value="#ffffff" style="margin-left:8px">
        <button id="saveDraw" class="btn">Save</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:280px 1fr;gap:12px">
      <div class="side-card">
        <div class="hint" id="drawHint">Freestyle drawing ‚Äî no prompts. Use undo/redo, clear, and save.</div>
      </div>
      <div class="main-card">
        <canvas id="doodle" class="doodle"></canvas>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-color">
    <div class="bar">
      <div class="chip" id="newColor">üñº New</div>
      <div class="chip" id="resetColor">üîÑ Reset</div>
      <div class="spacer"></div>
      <div class="chip" id="colorBrush" aria-pressed="true">‚úèÔ∏è Brush</div>
      <div class="chip" id="colorFill">ü™£ Fill</div>
      <div class="chip" id="colorEraser">üßΩ Eraser</div>
      <div class="chip" id="undoColor">‚Ü©Ô∏è Undo</div>
      <div class="chip" id="redoColor">‚Ü™Ô∏è Redo</div>
      <div class="spacer"></div>
      <label class="hint" id="sizeLabel">Size</label>
      <input id="colorSize" type="range" min="1" max="80" value="16">
      <input id="colorPicker" type="color" value="#ff4b6b" style="margin-left:8px">
      <button id="saveColor" class="btn">Save</button>
    </div>

    <div style="display:grid;grid-template-columns:280px 1fr;gap:12px">
      <div class="side-card">
        <h3 id="galleryTitle">Gallery</h3>
        <div id="colorThumbs" class="color-grid"></div>
        <div style="height:8px"></div>
        <div class="hint" id="outlineHint">Outlines are thick to make bucket fills reliable.</div>
      </div>
      <div class="main-card">
        <canvas id="colorCanvas" class="colorCanvas"></canvas>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-themes">
    <div class="bar">
      <div class="chip" id="backToAura">‚¨Ö Back</div>
      <div class="chip" id="surpriseThemeTop">üé≤ Surprise Me</div>
      <div class="spacer"></div>
      <div class="hint" id="themesHint">100+ unique themes grouped by section (grayscale, poster, gradients, animated).</div>
    </div>
    <div id="themesRoot" class="themes-wrap"></div>
  </div>

  <div class="panel" id="panel-music">
    <div class="bar">
      <div class="chip" id="openSpotify">Open in Spotify</div>
      <div class="spacer"></div>
      <div class="hint" id="musicHint">Embedded Spotify album ‚Äî left as-is.</div>
    </div>
    <div class="main-card">
      <div class="spotify-wrap" style="padding:14px">
        <iframe id="spotifyEmbed" src="https://open.spotify.com/embed/album/7shstgp8BAiSrFryJu4K8I" width="100%" height="520" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
      </div>
      <div style="height:8px"></div>
      <a id="openSpotifyLink" href="https://open.spotify.com/album/69AaAkdktFGnk9POmHENkT" target="_blank" class="btn primary">Open in Spotify</a>
    </div>
  </div>

  <div class="panel" id="panel-games">
    <div class="bar"><div class="chip" id="refreshGames">‚Üª Refresh</div><div class="spacer"></div><div class="hint" id="gamesHint">Gaming Hub ‚Äî click a game to launch.</div></div>
    <div style="display:grid;grid-template-columns:320px 1fr;gap:12px">
      <div class="side-card">
        <h3 id="gamesTitle">Games</h3>
        <div id="gamesList" class="games-grid"></div>
      </div>
      <div class="main-card">
        <div id="gameInfo" style="margin-bottom:8px" class="hint">Select a game to play.</div>
        <div id="gameArea" class="game-area"></div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-journal">
    <div style="display:flex;flex-direction:column;gap:8px">
      <textarea id="journalText" class="journal-textarea" placeholder="Dear journal..." style="height:520px;background:#ffffff08;border:1px solid var(--stroke);padding:12px;border-radius:10px;color:var(--text)"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveJournal" class="btn good">Save</button>
        <button id="downloadJournal" class="btn">Download</button>
        <button id="clearJournal" class="btn bad">Clear</button>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-account">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="side-card" style="min-width:240px;max-width:320px">
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
          <div id="avatarBox" style="width:140px;height:140px;border-radius:50%;overflow:hidden;background:#ffffff12;border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center">
            <img id="avatarImg" src="" style="width:100%;height:100%;object-fit:cover;display:none">
            <div id="avatarPlaceholder" class="hint">No avatar</div>
          </div>
          <input id="avatarInput" type="file" accept="image/*">
          <button id="removeAvatar" class="btn bad">Remove Avatar</button>
        </div>
      </div>

      <div class="main-card">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label class="hint">Name</label>
            <input id="displayName" class="input" placeholder="Your name">
          </div>
          <div>
            <label class="hint">Status</label>
            <select id="statusSelect" class="input"><option value="available">Available</option><option value="busy">Busy</option><option value="offline">Offline</option><option value="custom">Custom</option></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <label class="hint">Bio</label>
        <textarea id="bioInput" class="input" style="height:80px"></textarea>
        <div style="height:8px"></div>
        <label class="hint">Accent</label>
        <div id="colorSwatches" style="display:flex;gap:8px;margin-top:6px"></div>
        <div style="height:8px"></div>
        <label class="hint">Theme & background</label>
        <select id="bgSelect" class="input"><option value="default">Default</option><option value="vintage">Vintage</option><option value="calm">Calm</option><option value="solid">Solid</option></select>
        <input id="bgColor" type="color" value="#0b0f14" style="margin-top:8px">
        <div style="height:10px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="saveProfile" class="btn good">Save</button>
          <button id="resetProfile" class="btn">Reset</button>
          <button id="exportProfile" class="btn">Export</button>
          <input id="importProfile" type="file" style="display:inline-block">
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* CONFIG */
const BACKEND = 'https://tenantable-matt-tactless.ngrok-free.dev/';
const TOKEN_KEY='Aura_Token_v1', PROFILE_KEY='Aura_Profile_v1';
const TRANSLATE_ENDPOINT = 'https://libretranslate.de/translate';

/* HELPERS */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $all = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
let UI_LANG = 'en';
let CHAT_MODE = 'classic'; // 'classic' or 'genz' only applies for English

/* UI strings (for labels) */
const UI_STRINGS = {
  en: { signIn:'Sign in', register:'Register', username:'Username', password:'Password', startup:'Startup login', loginError:'Login failed', welcome:'Welcome back',
        quick:'Quick', activities:'Activities', brush:'Brush', drawHint:'Freestyle drawing ‚Äî no prompts. Use undo/redo, clear, and save.',
        gallery:'Gallery', outlineHint:'Outlines are thick to make bucket fills reliable.', size:'Size', themesHint:'100+ unique themes grouped by section (grayscale, poster, gradients, animated).',
        musicHint:'Embedded Spotify album ‚Äî left as-is.', gamesHint:'Gaming Hub ‚Äî click a game to launch.', gamesTitle:'Games', modeClassic:'Mode: Classic', modeGenZ:'Mode: Gen Z', send:'Send', logout:'Log out' },
  ta: { signIn:'‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ', register:'‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ', username:'‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç', password:'‡Æï‡Æü‡Æµ‡ØÅ‡Æö‡Øç‡Æö‡Øä‡Æ≤‡Øç', startup:'‡ÆÜ‡Æ∞‡ÆÆ‡Øç‡Æ™ ‡Æ™‡ØÅ‡Æï‡ØÅ‡Æ™‡Æ§‡Æø‡Æï‡Øà', loginError:'‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æµ‡ØÅ ‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø', welcome:'‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™ ‡Æµ‡Æ∞‡ØÅ‡Æï',
        quick:'‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç', activities:'‡Æö‡ØÜ‡ÆØ‡Æ±‡Øç‡Æ™‡Ææ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç', brush:'‡Æ™‡Æø‡Æ∞‡Æ∑‡Øç', drawHint:'‡Æµ‡Æø‡Æ∞‡Øà‡Æµ‡Æø‡Æ≤‡Øç ‡Æµ‡Æ∞‡Øà‡Æµ‡Øã‡ÆÆ‡Øç ‚Äî undo/redo, clear ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç save ‡Æê‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.',
        gallery:'‡Æï‡Øá‡Æ≤‡Æ∞‡Æø', outlineHint:'‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡Æ™‡Æï‡Øç‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ©.', size:'‡ÆÖ‡Æ≥‡Æµ‡ØÅ', themesHint:'100+ ‡Æ§‡Æ©‡Æø‡Æö‡Øç‡Æö‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡Ææ‡Æ© ‡Æ§‡ØÄ‡ÆÆ‡Øç‡Æï‡Æ≥‡Øç.', musicHint:'Spotify ‡ÆÜ‡Æ≤‡Øç ‡Æ™‡Ææ‡Æü‡Æ≤‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ.', gamesHint:'‡Æï‡Øá‡ÆÆ‡Øç‡Æ∏‡Øç ‚Äî ‡Æï‡Æø‡Æ≥‡Æø‡Æï‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.', gamesTitle:'‡Æï‡Øá‡ÆÆ‡Øç‡Æ∏‡Øç', modeClassic:'‡ÆÆ‡ØÅ‡Æ±‡Øà: ‡Æ™‡Ææ‡Æ∞‡ÆÆ‡Øç‡Æ™‡Æ∞‡Æø‡ÆØ‡ÆÆ‡Øç', modeGenZ:'‡ÆÆ‡ØÅ‡Æ±‡Øà: Gen Z', send:'‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà', logout:'‡Æ™‡Æø‡Æ±‡Æï‡Øç‡Æï' },
  hi: { signIn:'‡§∏‡§æ‡§á‡§® ‡§á‡§®', register:'‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞', username:'‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡§æ‡§Æ', password:'‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°', startup:'‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü‡§Ö‡§™ ‡§≤‡•â‡§ó‡§ø‡§®', loginError:'‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§´‡§≤', welcome:'‡§µ‡§æ‡§™‡§∏‡•Ä ‡§™‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§',
        quick:'‡§§‡•Å‡§∞‡§Ç‡§§', activities:'‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡§æ‡§Å', brush:'‡§¨‡•ç‡§∞‡§∂', drawHint:'‡§´‡•ç‡§∞‡•Ä‡§π‡•à‡§Ç‡§° ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó ‚Äî undo/redo, clear ‡§î‡§∞ save ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§',
        gallery:'‡§ó‡•à‡§≤‡§∞‡•Ä', outlineHint:'‡§Ü‡§â‡§ü‡§≤‡§æ‡§á‡§®‡•ç‡§∏ ‡§Æ‡•ã‡§ü‡•Ä ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§≠‡§∞‡§®‡§æ ‡§≠‡§∞‡•ã‡§∏‡•á‡§Æ‡§Ç‡§¶ ‡§∞‡§π‡•á‡•§', size:'‡§Ü‡§ï‡§æ‡§∞', themesHint:'100+ ‡§•‡•Ä‡§Æ‡•§', musicHint:'Spotify ‡§è‡§≤‡§¨‡§Æ ‡§è‡§Æ‡•ç‡§¨‡•á‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§', gamesHint:'‡§ó‡•á‡§Æ‡§ø‡§Ç‡§ó ‡§π‡§¨ ‚Äî ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§≤‡•â‡§®‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§', gamesTitle:'‡§ó‡•á‡§Æ‡•ç‡§∏', modeClassic:'‡§Æ‡•ã‡§°: ‡§ï‡•ç‡§≤‡§æ‡§∏‡§ø‡§ï', modeGenZ:'‡§Æ‡•ã‡§°: Gen Z', send:'‡§≠‡•á‡§ú‡•á‡§Ç', logout:'‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü' },
  ms: { signIn:'Log Masuk', register:'Daftar', username:'Nama Pengguna', password:'Kata Laluan', startup:'Log Masuk Permulaan', loginError:'Gagal log masuk', welcome:'Selamat datang kembali',
        quick:'Pantas', activities:'Aktiviti', brush:'Berus', drawHint:'Melukis bebas ‚Äî guna undo/redo, clear dan save.', gallery:'Galeri', outlineHint:'Garis besar tebal untuk kebolehisian isian.', size:'Saiz', themesHint:'100+ tema unik.', musicHint:'Album Spotify disertakan.', gamesHint:'Pusat permainan ‚Äî klik untuk lancar.', gamesTitle:'Permainan', modeClassic:'Mod: Klasik', modeGenZ:'Mod: Gen Z', send:'Hantar', logout:'Log keluar' },
  zh: { signIn:'ÁôªÂΩï', register:'Ê≥®ÂÜå', username:'Áî®Êà∑Âêç', password:'ÂØÜÁ†Å', startup:'ÂêØÂä®ÁôªÂΩï', loginError:'ÁôªÂΩïÂ§±Ë¥•', welcome:'Ê¨¢ËøéÂõûÊù•',
        quick:'Âø´ÈÄü', activities:'Ê¥ªÂä®', brush:'ÁîªÁ¨î', drawHint:'Ëá™Áî±ÁªòÁîª ‚Äî ‰ΩøÁî® undo/redo„ÄÅclear„ÄÅsave„ÄÇ', gallery:'ÁîªÂªä', outlineHint:'ËΩÆÂªìËæÉÁ≤ó‰ª•Âà©Â°´ÂÖÖ„ÄÇ', size:'Â§ßÂ∞è', themesHint:'100+ ‰∏ªÈ¢ò„ÄÇ', musicHint:'ÂµåÂÖ•ÁöÑ Spotify ‰∏ìËæë„ÄÇ', gamesHint:'Ê∏∏Êàè‰∏≠ÂøÉ ‚Äî ÁÇπÂáªÂêØÂä®„ÄÇ', gamesTitle:'Ê∏∏Êàè', modeClassic:'Ê®°Âºè: ÁªèÂÖ∏', modeGenZ:'Ê®°Âºè: Gen Z', send:'ÂèëÈÄÅ', logout:'ÈÄÄÂá∫' }
};

function applyLangUI(){
  const s = UI_STRINGS[UI_LANG] || UI_STRINGS.en;
  $('#lockLogin').textContent = s.signIn;
  $('#lockRegister').textContent = s.register;
  $('#lockUser').placeholder = s.username;
  $('#lockPass').placeholder = s.password;
  $('#startupLabel').textContent = s.startup;
  $('#quickTitle').textContent = s.quick;
  $('#activitiesTitle').textContent = s.activities;
  $('#brushLabel').textContent = s.brush;
  $('#drawHint').textContent = s.drawHint;
  $('#galleryTitle').textContent = s.gallery;
  $('#outlineHint').textContent = s.outlineHint;
  $('#sizeLabel').textContent = s.size;
  $('#themesHint').textContent = s.themesHint;
  $('#musicHint').textContent = s.musicHint;
  $('#gamesHint').textContent = s.gamesHint;
  $('#gamesTitle').textContent = s.gamesTitle;
  $('#send').textContent = s.send;
  $('#logoutBtn').textContent = s.logout;
  $('#modeChip').textContent = CHAT_MODE==='genz' ? s.modeGenZ : s.modeClassic;
}

/* populate languages */
function populateLangs(){
  const LANGS=['en','ta','zh','ms','hi'];
  const sel = $('#langSelectLock');
  sel.innerHTML='';
  LANGS.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=(l==='en'?'English': l==='ta'?'‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç': l==='zh'?'‰∏≠Êñá': l==='ms'?'Bahasa Melayu': l==='hi'?'‡§π‡§ø‡§®‡•ç‡§¶‡•Ä':l); sel.appendChild(o); });
  const saved = localStorage.getItem('Aura_UI_Lang')||'en';
  sel.value = saved; UI_LANG = saved; applyLangUI();
}
populateLangs();
$('#langSelectLock').addEventListener('change',(e)=>{ UI_LANG = e.target.value; localStorage.setItem('Aura_UI_Lang', UI_LANG); applyLangUI(); });

/* mode toggle: Gen Z only applies when UI_LANG === 'en' */
$('#modeChip').addEventListener('click', ()=>{ if(UI_LANG!=='en'){ alert('Gen Z mode only available for English chat.'); return; } CHAT_MODE = CHAT_MODE==='classic' ? 'genz' : 'classic'; applyLangUI(); });

/* Clock */
function tickClock(){ const d=new Date(); $('#lockClock').textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); $('#lockDate').textContent = d.toDateString(); }
setInterval(tickClock,1000); tickClock();

/* AUTH wrappers */
async function registerUser(username,password,displayName){
  try{ const r=await fetch(BACKEND+'register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,displayName})}); return await r.json(); }catch(e){ return {error:'network'} }
}
async function loginUser(username,password){
  try{ const r=await fetch(BACKEND+'login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})}); return await r.json(); }catch(e){ return {error:'network'} }
}
async function whoami(){ const token=localStorage.getItem(TOKEN_KEY); if(!token) return null; try{ const r=await fetch(BACKEND+'profile',{headers:{Authorization:'Bearer '+token}}); if(r.status===200){ const j=await r.json(); return j.user; } return null; }catch(e){ return null; } }

/* login/register wiring with avatar transition */
$('#lockLogin').addEventListener('click', async ()=>{
  $('#lockMsg').textContent='';
  const u=$('#lockUser').value.trim(), p=$('#lockPass').value;
  if(!u||!p){ $('#lockMsg').textContent = UI_STRINGS[UI_LANG].loginError; return; }
  $('#lockLogin').disabled=true; $('#lockLogin').textContent = UI_STRINGS[UI_LANG].signIn + '...';
  const res = await loginUser(u,p);
  $('#lockLogin').disabled=false; $('#lockLogin').textContent = UI_STRINGS[UI_LANG].signIn;
  if(res && res.ok && res.token){
    localStorage.setItem(TOKEN_KEY, res.token);
    const user = await whoami();
    if(user && user.profile){
      localStorage.setItem(PROFILE_KEY, JSON.stringify(user.profile));
      await showLoginTransition(user.profile);
      finalizeLogin();
    } else finalizeLogin();
  } else { $('#lockMsg').textContent = (res && res.error) ? JSON.stringify(res) : UI_STRINGS[UI_LANG].loginError; }
});
$('#lockRegister').addEventListener('click', async ()=>{
  $('#lockMsg').textContent='';
  const u=$('#lockUser').value.trim(), p=$('#lockPass').value;
  if(!u||!p){ $('#lockMsg').textContent = UI_STRINGS[UI_LANG].loginError; return; }
  $('#lockRegister').disabled=true; $('#lockRegister').textContent = UI_STRINGS[UI_LANG].register + '...';
  const res = await registerUser(u,p,u);
  $('#lockRegister').disabled=false; $('#lockRegister').textContent = UI_STRINGS[UI_LANG].register;
  if(res && res.ok && res.token){
    localStorage.setItem(TOKEN_KEY, res.token);
    const user = await whoami();
    if(user && user.profile){ localStorage.setItem(PROFILE_KEY, JSON.stringify(user.profile)); await showLoginTransition(user.profile); finalizeLogin(); } else finalizeLogin();
  } else { $('#lockMsg').textContent = (res && res.error) ? JSON.stringify(res) : UI_STRINGS[UI_LANG].loginError; }
});

async function showLoginTransition(profile){
  try{
    if(profile.avatar){ $('#lockAvatarImg').src = profile.avatar; $('#lockAvatarImg').style.display='block'; $('#lockAvatarPlaceholder').style.display='none'; }
    else { $('#lockAvatarImg').style.display='none'; $('#lockAvatarPlaceholder').textContent = profile.displayName || profile.username || 'User'; }
  }catch(e){}
  await new Promise(r=>setTimeout(r,300));
}
function finalizeLogin(){ document.getElementById('lock')?.remove(); document.getElementById('app').style.display='block'; document.body.classList.add('fade-in'); initApp(); }

/* try autologin */
async function tryAutoLogin(){ const token = localStorage.getItem(TOKEN_KEY); if(!token) return; const user = await whoami(); if(user && user.profile){ localStorage.setItem(PROFILE_KEY, JSON.stringify(user.profile)); await showLoginTransition(user.profile); finalizeLogin(); } }
tryAutoLogin();

/* APP INIT */
function initApp(){
  loadProfile(); renderGameList(); renderColorThumbs(); renderThemes(); applyLangUI();
  $all('.tab').forEach(tab=> tab.addEventListener('click', ()=>{ $all('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target=tab.getAttribute('data-target'); $all('.panel').forEach(p=>p.classList.remove('active')); document.getElementById(target).classList.add('active'); }));
  $all('.bubble').forEach(b=> b.addEventListener('click', e=>{ const say=e.currentTarget.dataset.say; const action=e.currentTarget.dataset.action; if(say){ $('#input').value=say; $('#send').click(); } if(action){ if(action==='openDraw') showPanel('panel-draw'); if(action==='openColor') showPanel('panel-color'); if(action==='openGames') showPanel('panel-games'); } }));
  $('#send').addEventListener('click', ()=>{ handleUserChat($('#input').value.trim()); $('#input').value=''; });
  $('#input').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#send').click(); });
  $('#assistToggle').addEventListener('click', ()=>{ $('#assistToggle').textContent = $('#assistToggle').textContent.includes('Offline') ? 'ü§ñ Assist: API-ready' : 'ü§ñ Assist: Offline'; });
  $('#openThemes')?.addEventListener('click', ()=> showPanel('panel-themes'));
  $('#backToAura')?.addEventListener('click', ()=> showPanel('panel-aura'));
  $('#logoutBtn')?.addEventListener('click', ()=> { if(confirm('Log out of AuraOS?')){ localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(PROFILE_KEY); location.reload(); }});
  updateShellClock(); setInterval(updateShellClock,1000);
}

/* CHAT: generate reply, then translate (if non-English). Gen Z applied only for English */
function addMsg(html, who='bot'){ const el=document.createElement('div'); el.className='msg'+(who==='me'?' me':''); el.innerHTML = html; $('#chat').appendChild(el); $('#chat').scrollTop = $('#chat').scrollHeight; }
function generateReplyText(text){
  const t=text.toLowerCase();
  if(/\b(hi|hello|hey|yo)\b/.test(t)) return "Hey! I'm Aura ‚Äî I can chat, suggest activities, or open tools.";
  if(t.includes('draw')) return "Opening Draw ‚Äî freestyle time!";
  if(t.includes('color')) return "Opening Coloring Book üé®";
  if(t.includes('music')) return "Music tab ready ‚Äî play something nice.";
  if(t.includes('journal')) return "Journal opened ‚Äî tell me about your day.";
  if(t.includes('breathe')||t.includes('calm')) return "Try: inhale 4 ‚Äî hold 4 ‚Äî exhale 6. Repeat 3 times.";
  return "Cool. Want to try draw, color, or play a game?";
}
function applyGenZ(s){
  const map={ 'you':'u','are':'r','really':'rly','okay':'ok','awesome':'awsm','what':'wut','want':'wanna','because':'cuz','please':'plz' };
  return s.split(/\b/).map(w=>{ const lw=w.toLowerCase(); if(map[lw]) return preserveCase(w,map[lw]) + (/[?.!]$/.test(w)?'':' ü§ô'); return w; }).join('');
}
function preserveCase(orig,repl){ if(orig[0]===orig[0].toUpperCase()) return repl[0].toUpperCase()+repl.slice(1); return repl; }

async function translateText(q, source='en', target='en'){
  try{
    if(source===target) return q;
    const res = await fetch(TRANSLATE_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ q, source, target, format:'text' }) });
    if(!res.ok) return null;
    const j = await res.json();
    return j.translatedText || null;
  }catch(e){
    return null;
  }
}

async function handleUserChat(text){
  if(!text) return;
  addMsg(text,'me');
  const base = generateReplyText(text);
  let reply = base;
  // If English UI and Gen Z mode, apply Gen Z
  if(UI_LANG==='en' && CHAT_MODE==='genz') reply = applyGenZ(base);
  // If UI language is not English, translate reply to selected language (classic tone)
  if(UI_LANG !== 'en'){
    const translated = await translateText(base, 'en', UI_LANG);
    reply = translated || base;
  }
  addMsg(reply,'bot');
}

/* CANVAS fixes: drawing and coloring (resizing preserved) */
function setCanvasResolution(canvas){
  const ratio = window.devicePixelRatio || 1;
  const w = Math.max(300, Math.floor(canvas.clientWidth * ratio));
  const h = Math.max(200, Math.floor((canvas.clientHeight || 600) * ratio));
  if(canvas.width !== w || canvas.height !== h){
    const ctx = canvas.getContext('2d');
    let imgData = null;
    try{ imgData = ctx.getImageData(0,0,canvas.width,canvas.height); }catch(e){}
    canvas.width = w; canvas.height = h;
    if(imgData){
      try{ ctx.putImageData(imgData,0,0); }catch(e){}
    }
  }
}

/* Drawing */
const doodle = $('#doodle'); let dctx=null;
if(doodle){
  function initDoodle(){ doodle.style.width='100%'; doodle.style.height=''; setCanvasResolution(doodle); dctx = doodle.getContext('2d'); dctx.lineCap='round'; dctx.lineJoin='round'; dctx.fillStyle='#081018'; dctx.fillRect(0,0,doodle.width,doodle.height); }
  initDoodle(); window.addEventListener('resize', ()=> setCanvasResolution(doodle));
  let drawing=false, last=null, drawUndo=[], drawRedo=[];
  function pointer(e,canvas){ const rect=canvas.getBoundingClientRect(); const clientX = e.touches?e.touches[0].clientX:e.clientX; const clientY = e.touches?e.touches[0].clientY:e.clientY; const ratio = canvas.width/rect.width; return { x:(clientX-rect.left)*ratio, y:(clientY-rect.top)*ratio }; }
  function saveDrawState(){ try{ drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.height)); if(drawUndo.length>60) drawUndo.shift(); drawRedo=[]; }catch(e){} }
  doodle.addEventListener('pointerdown', e=>{ drawing=true; last=pointer(e,doodle); dctx.strokeStyle=$('#brushColor').value; dctx.lineWidth = Number($('#brushSize').value) * (doodle.width / doodle.clientWidth); saveDrawState(); });
  doodle.addEventListener('pointermove', e=>{ if(!drawing) return; const p=pointer(e,doodle); dctx.beginPath(); dctx.moveTo(last.x,last.y); dctx.lineTo(p.x,p.y); dctx.stroke(); last=p; });
  window.addEventListener('pointerup', ()=>{ drawing=false; });
  $('#clearDraw')?.addEventListener('click', ()=>{ saveDrawState(); dctx.clearRect(0,0,doodle.width,doodle.height); dctx.fillStyle='#081018'; dctx.fillRect(0,0,doodle.width,doodle.height); });
  $('#undoDraw')?.addEventListener('click', ()=>{ if(drawUndo.length>0){ const prev=drawUndo.pop(); drawRedo.push(dctx.getImageData(0,0,doodle.width,doodle.height)); dctx.putImageData(prev,0,0); }});
  $('#redoDraw')?.addEventListener('click', ()=>{ if(drawRedo.length>0){ const next=drawRedo.pop(); drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.height)); dctx.putImageData(next,0,0); }});
  $('#saveDraw')?.addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=doodle.toDataURL('image/png'); a.download=`draw-${Date.now()}.png`; a.click(); });
}

/* Coloring - thumbnails and drawing */
const SVG_PAGES = (function(){ const pages=[]; const wrap=(inner,w=800,h=600)=>`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'><rect width='100%' height='100%' fill='white'/><g fill='none' stroke='#000' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'>${inner}</g></svg>`; pages.push({name:'Happy Kitty', svg: wrap("<path d='M240 320 q-60 -180 160 -160 q220 -20 160 160 q-40 100 -160 120 q-120 -20 -160 -120z' /><circle cx='330' cy='260' r='12'/><circle cx='470' cy='260' r='12'/><path d='M380 340 q30 20 60 0'/>")}); pages.push({name:'Zoom Car', svg: wrap("<rect x='120' y='300' width='560' height='80' rx='20'/><circle cx='260' cy='420' r='36'/><circle cx='540' cy='420' r='36'/>")}); pages.push({name:'Cozy House', svg: wrap("<path d='M140 360 h520 v-180 h-520z' /><path d='M140 360 l260 -200 l260 200' /><rect x='360' y='260' width='80' height='60'/>")}); return pages; })();
function renderColorThumbs(){ const root=$('#colorThumbs'); if(!root) return; root.innerHTML=''; SVG_PAGES.forEach((p,i)=>{ const d=document.createElement('div'); d.className='thumb'; d.title=p.name; const img=new Image(); img.src='data:image/svg+xml;utf8,'+encodeURIComponent(p.svg); img.style.maxWidth='100%'; img.style.maxHeight='90px'; d.appendChild(img); d.addEventListener('click', ()=> loadColoring(i)); root.appendChild(d); }); }
renderColorThumbs();

function loadColoring(idx){
  const svg = SVG_PAGES[idx].svg;
  const img = new Image();
  img.onload = ()=>{
    const canvas = $('#colorCanvas'); const ctx = canvas.getContext('2d');
    canvas.style.width='100%'; canvas.style.height='';
    const ratio = window.devicePixelRatio||1;
    const w = Math.floor(canvas.clientWidth * ratio); const h = Math.floor((canvas.clientHeight||600) * ratio);
    canvas.width = w; canvas.height = h;
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const imgW = img.naturalWidth||img.width, imgH = img.naturalHeight||img.height;
    const scale = Math.min(canvas.width/imgW, canvas.height/imgH)*0.96;
    const tw = imgW*scale, th = imgH*scale; const dx=(canvas.width-tw)/2, dy=(canvas.height-th)/2;
    ctx.drawImage(img,0,0,imgW,imgH,dx,dy,tw,th);
  };
  img.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* bucket fill */
async function bucketFillAt(x,y,fill){
  try{
    const canvas = $('#colorCanvas'); const ctx = canvas.getContext('2d');
    const img = ctx.getImageData(0,0,canvas.width,canvas.height); const w=img.width,h=img.height,data=img.data;
    const idx=(y*w+x)*4; const tr=data[idx],tg=data[idx+1],tb=data[idx+2],ta=data[idx+3];
    const fr=fill.r,fg=fill.g,fb=fill.b,fa=Math.round((fill.a||1)*255);
    if(tr===fr && tg===fg && tb===fb && ta===fa) return;
    const stack=[[x,y]];
    while(stack.length){
      const [cx,cy]=stack.pop();
      if(cx<0||cx>=w||cy<0||cy>=h) continue;
      const i=(cy*w+cx)*4;
      if(data[i]===tr && data[i+1]===tg && data[i+2]===tb && data[i+3]===ta){
        data[i]=fr; data[i+1]=fg; data[i+2]=fb; data[i+3]=fa;
        stack.push([cx+1,cy]); stack.push([cx-1,cy]); stack.push([cx,cy+1]); stack.push([cx,cy-1]);
      }
    }
    ctx.putImageData(img,0,0);
  }catch(e){ console.warn('bucket error',e); }
}

/* color tools */
let colorTool='brush', colorSize=16, colorHex='#ff4b6b';
$('#colorBrush')?.addEventListener('click', ()=> colorTool='brush');
$('#colorFill')?.addEventListener('click', ()=> colorTool='fill');
$('#colorEraser')?.addEventListener('click', ()=> colorTool='eraser');
$('#colorPicker')?.addEventListener('input', e=> colorHex=e.target.value);
$('#colorSize')?.addEventListener('input', e=> colorSize=Number(e.target.value));

const colorCanvas = $('#colorCanvas');
if(colorCanvas){
  function setColorCanvasSize(){ const ratio=window.devicePixelRatio||1; const w=Math.floor(colorCanvas.clientWidth*ratio); const h=Math.floor((colorCanvas.clientHeight||600)*ratio); if(colorCanvas.width!==w||colorCanvas.height!==h){ colorCanvas.width=w;colorCanvas.height=h; } }
  window.addEventListener('resize', setColorCanvasSize);
  setColorCanvasSize();
  let painting=false;
  colorCanvas.addEventListener('pointerdown', async (e)=>{
    const p = pointerEventCoords(e,colorCanvas);
    if(colorTool==='fill'){ const rgba=hexToRgba(colorHex); await bucketFillAt(Math.round(p.x), Math.round(p.y), rgba); return; }
    painting=true; const ctx=colorCanvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle = colorTool==='eraser' ? '#ffffff' : colorHex; ctx.lineWidth = colorSize * (colorCanvas.width / colorCanvas.clientWidth); ctx.beginPath(); ctx.moveTo(p.x,p.y);
  });
  colorCanvas.addEventListener('pointermove', (e)=>{ if(!painting) return; const p=pointerEventCoords(e,colorCanvas); const ctx=colorCanvas.getContext('2d'); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  window.addEventListener('pointerup', ()=> { painting=false; });
}
function pointerEventCoords(e, canvas){ const rect=canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const ratio = canvas.width / rect.width; return { x: (clientX - rect.left) * ratio, y: (clientY - rect.top) * ratio }; }
function hexToRgba(hex){ if(hex[0]==='#') hex=hex.slice(1); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const num=parseInt(hex,16); return {r:(num>>16)&255,g:(num>>8)&255,b:num&255,a:1}; }

/* PROFILE local + avatar sync */
const localProfileKey='Aura_Profile_v1';
let profile = {name:'Guest',bio:'',status:'available',color:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),avatar:''};
function loadProfile(){ try{ const raw=localStorage.getItem(localProfileKey); if(raw) Object.assign(profile, JSON.parse(raw)); }catch(e){} applyProfileUI(); }
function saveProfile(){ profile.name = $('#displayName').value || 'Anonymous'; profile.bio = $('#bioInput').value || ''; profile.status = $('#statusSelect').value; localStorage.setItem(localProfileKey, JSON.stringify(profile)); alert('Profile saved locally'); applyProfileUI(); }
function applyProfileUI(){ $('#displayName').value = profile.name; $('#bioInput').value = profile.bio; $('#statusSelect').value = profile.status; if(profile.avatar){ $('#avatarImg').src = profile.avatar; $('#avatarImg').style.display='block'; $('#avatarPlaceholder').style.display='none'; $('#lockAvatarImg').src = profile.avatar; $('#lockAvatarImg').style.display='block'; $('#lockAvatarPlaceholder').style.display='none'; } else { $('#avatarImg').style.display='none'; $('#avatarPlaceholder').style.display='block'; } document.documentElement.style.setProperty('--accent', profile.color); }
$('#saveProfile')?.addEventListener('click', saveProfile);
$('#resetProfile')?.addEventListener('click', ()=>{ localStorage.removeItem(localProfileKey); profile={name:'Guest',bio:'',status:'available',color:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),avatar:''}; applyProfileUI(); });
$('#exportProfile')?.addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(profile)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='aura_profile.json'; a.click(); URL.revokeObjectURL(url); });
$('#importProfile')?.addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ profile=JSON.parse(fr.result); localStorage.setItem(localProfileKey, JSON.stringify(profile)); applyProfileUI(); alert('Profile imported'); }catch(err){ alert('Invalid file'); } }; fr.readAsText(f); });

$('#avatarInput')?.addEventListener('change', (e)=> { const f = e.target.files[0]; if(!f) return; const fr = new FileReader(); fr.onload = ()=> { profile.avatar = fr.result; $('#avatarImg').src = profile.avatar; $('#avatarImg').style.display='block'; $('#avatarPlaceholder').style.display='none'; localStorage.setItem(localProfileKey, JSON.stringify(profile)); $('#lockAvatarImg').src = profile.avatar; $('#lockAvatarImg').style.display='block'; $('#lockAvatarPlaceholder').style.display='none'; }; fr.readAsDataURL(f); });
$('#removeAvatar')?.addEventListener('click', ()=> { profile.avatar=''; $('#avatarImg').style.display='none'; $('#avatarPlaceholder').style.display='block'; localStorage.setItem(localProfileKey, JSON.stringify(profile)); $('#lockAvatarImg').style.display='none'; $('#lockAvatarPlaceholder').style.display='block'; });

/* JOURNAL */
const journalKey='Aura_Journal';
$('#journalText').value = localStorage.getItem(journalKey) || '';
$('#saveJournal')?.addEventListener('click', ()=> { localStorage.setItem(journalKey, $('#journalText').value); alert('Journal saved.'); });
$('#downloadJournal')?.addEventListener('click', ()=> { const blob=new Blob([$('#journalText').value], {type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='journal.txt'; a.click(); URL.revokeObjectURL(url); });
$('#clearJournal')?.addEventListener('click', ()=> { if(confirm('Clear journal?')){ $('#journalText').value=''; localStorage.removeItem(journalKey); } });

/* THEMES simple */
const THEMES=[{name:'Default',bg:'#0b0f14'},{name:'Calm',bg:'#0b1420'},{name:'Vintage',bg:'#2b1f1f'}];
function renderThemes(){ const root=$('#themesRoot'); if(!root) return; root.innerHTML=''; THEMES.forEach(t=>{ const el=document.createElement('div'); el.className='swatch'; el.title=t.name; const preview=document.createElement('div'); preview.style.height='56px'; preview.style.borderRadius='8px'; preview.style.background=`linear-gradient(90deg, ${t.bg}, ${t.bg})`; el.appendChild(preview); const tag=document.createElement('div'); tag.className='tag'; tag.textContent=t.name; el.appendChild(tag); el.addEventListener('click', ()=>{ document.body.style.background=`linear-gradient(180deg, ${t.bg}, ${t.bg})`; localStorage.setItem('Aura_Theme', JSON.stringify(t)); }); root.appendChild(el); }); }

/* GAMES: Bubble Pop+ (floating clickable bubbles) and Snake (classic) */
/* Bubble Pop+ */
function runBubblePop(container){
  container.innerHTML=''; const canvas=document.createElement('canvas'); canvas.style.width='100%'; canvas.style.height='100%'; container.appendChild(canvas);
  const ctx=canvas.getContext('2d'); const ratio=window.devicePixelRatio||1;
  function resize(){ canvas.width = Math.floor(container.clientWidth*ratio); canvas.height = Math.floor((container.clientHeight-40)*ratio); }
  resize(); window.addEventListener('resize', resize);
  let bubbles=[], particles=[], running=true, score=0, level=1;
  function spawn(){ const r = 18 + Math.random()*50; const x = r + Math.random()*(canvas.width - r*2); const y = -r; const vx = (Math.random()-0.5)*2.4; const vy = 0.8 + Math.random()*2.2; const hue = Math.floor(Math.random()*360); const color = `hsl(${hue} 85% 60%)`; bubbles.push({x,y,r,vx,vy,color,id:Date.now()+Math.random()}); }
  function step(){
    if(!running) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(Math.random() < 0.06 + level*0.01) spawn();
    for(let i=bubbles.length-1;i>=0;i--){
      const b=bubbles[i];
      b.x += b.vx * (1 + level*0.03); b.y += b.vy * (1 + level*0.03);
      const grad = ctx.createRadialGradient(b.x - b.r*0.2, b.y - b.r*0.2, b.r*0.2, b.x, b.y, b.r*1.6);
      grad.addColorStop(0, 'rgba(255,255,255,0.9)'); grad.addColorStop(0.2, b.color); grad.addColorStop(1, 'rgba(0,0,0,0.0)');
      ctx.beginPath(); ctx.fillStyle = grad; ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth = Math.max(2,b.r*0.06); ctx.stroke();
      if(b.y - b.r > canvas.height + 200) bubbles.splice(i,1);
    }
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 1;
      ctx.beginPath(); ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0,p.life/30); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
      if(p.life<=0) particles.splice(i,1);
    }
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font = `${24*ratio}px Inter`; ctx.fillText(`Score: ${score}`, 20*ratio, 34*ratio);
    ctx.fillText(`Level: ${level}`, 220*ratio, 34*ratio);
    requestAnimationFrame(step);
  }
  step();
  canvas.addEventListener('click',(ev)=>{
    const rect = canvas.getBoundingClientRect(); const rx = (ev.clientX-rect.left)*(canvas.width/rect.width), ry = (ev.clientY-rect.top)*(canvas.height/rect.height);
    for(let i=bubbles.length-1;i>=0;i--){
      const b=bubbles[i]; const dx=b.x-rx, dy=b.y-ry;
      if(dx*dx+dy*dy <= b.r*b.r){
        score += Math.round(10 + b.r*0.3);
        for(let k=0;k<18;k++){ particles.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,life:30+Math.random()*20,size:2+Math.random()*3,color:b.color}); }
        bubbles.splice(i,1);
        return;
      }
    }
  });
  return { stop: ()=>{ running=false; } };
}

/* Snake */
function runSnake(container){
  container.innerHTML=''; const canvas=document.createElement('canvas'); canvas.style.width='100%'; canvas.style.height='100%'; container.appendChild(canvas);
  const ctx=canvas.getContext('2d'); const ratio=window.devicePixelRatio||1;
  const COLS=20, ROWS=20;
  function resize(){ canvas.width = Math.floor(container.clientWidth*ratio); canvas.height = Math.floor((container.clientHeight-40)*ratio); cellW = Math.floor(canvas.width/COLS); cellH = Math.floor(canvas.height/ROWS); }
  let cellW=20, cellH=20;
  resize(); window.addEventListener('resize', resize);
  let snake=[{x:10,y:10}], dir={x:0,y:0}, apple={x:15,y:10}, running=true, score=0;
  function placeApple(){ apple.x = Math.floor(Math.random()*COLS); apple.y = Math.floor(Math.random()*ROWS); }
  function step(){
    if(!running) return;
    const head = { x: (snake[0].x + dir.x + COLS)%COLS, y: (snake[0].y + dir.y + ROWS)%ROWS };
    // collision with self
    if(snake.some(s=>s.x===head.x && s.y===head.y)){ // reset
      snake=[{x:10,y:10}]; dir={x:0,y:0}; score=0; placeApple();
    } else {
      snake.unshift(head);
      if(head.x===apple.x && head.y===apple.y){ score+=10; placeApple(); } else snake.pop();
    }
    // draw
    ctx.fillStyle='#061218'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // apple
    ctx.fillStyle='#ff6b6b'; ctx.fillRect(apple.x*cellW, apple.y*cellH, cellW-1, cellH-1);
    // snake
    ctx.fillStyle='#7cc6ff'; snake.forEach((s,i)=>{ ctx.fillRect(s.x*cellW, s.y*cellH, cellW-1, cellH-1); });
    ctx.fillStyle='white'; ctx.font = `${16*ratio}px Inter`; ctx.fillText('Score: '+score, 8*ratio, 20*ratio);
    setTimeout(step, 120);
  }
  step();
  window.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowUp' && dir.y!==1) dir={x:0,y:-1};
    if(e.key==='ArrowDown' && dir.y!==-1) dir={x:0,y:1};
    if(e.key==='ArrowLeft' && dir.x!==1) dir={x:-1,y:0};
    if(e.key==='ArrowRight' && dir.x!==-1) dir={x:1,y:0};
  });
  return { stop: ()=>{ running=false; } };
}

/* Render game list and launch real games */
function renderGameList(){ const root=$('#gamesList'); if(!root) return; root.innerHTML=''; const list=[{id:'bubble',title:'Bubble Pop+',desc:'Pop floating bubbles', run:runBubblePop},{id:'snake',title:'Snake+',desc:'Classic snake', run:runSnake}]; list.forEach(g=>{ const card=document.createElement('div'); card.className='game-card'; const h=document.createElement('div'); h.style.fontWeight='700'; h.textContent=g.title; const p=document.createElement('div'); p.style.fontSize='13px'; p.style.color='var(--muted)'; p.textContent=g.desc; const btn=document.createElement('button'); btn.className='btn primary'; btn.textContent='Play'; btn.addEventListener('click', ()=> { launchGame(g); }); card.appendChild(h); card.appendChild(p); card.appendChild(btn); root.appendChild(card); }); }

let currentGameInstance = null;
function launchGame(game){
  const area = $('#gameArea'); area.innerHTML=''; if(currentGameInstance && currentGameInstance.stop) currentGameInstance.stop(); currentGameInstance = game.run(area); $('#gameInfo').textContent = game.title + ' ‚Äî ' + game.desc;
}

/* UTIL & BOOT */
function updateShellClock(){ const d=new Date(); const c=$('#clock'); if(c) c.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function showPanel(id){ $all('.panel').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); $all('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-target')===id)); }

window.addEventListener('load', ()=>{ loadProfile(); setTimeout(()=>{ $all('.tab,.side-card,.main-card').forEach((el,i)=>{ el.style.opacity=0; setTimeout(()=>{ el.style.transition='opacity .5s ease, transform .45s ease'; el.style.transform='translateY(6px)'; requestAnimationFrame(()=>{ el.style.opacity=1; el.style.transform='none'; }); }, i*30); }); },300); });

</script>
</body>
</html>
