<!-- AuraAI Ultimate Merged (Part 1/4) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AuraAI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- Aura v7.0 Core Variables & Responsive Typography --- */
:root {
  --accent: #7cc6ff;
  --bg1: #0b0d16;
  --bg2: #1a1c2a;
  --glass: rgba(255,255,255,0.08);
  --blur: blur(18px);
  --frost-bright: brightness(1.15);
  --main-radius: 30px;
  --main-shadow: 0 6px 44px 0 rgba(0,0,0,0.36), 0 0 0 1px rgba(124,198,255,0.08) inset, 0 10px 44px 0 rgba(124,198,255,0.09) inset, 0 0 0 2px var(--accent, #7cc6ff)10;
}
html, body {
  margin: 0; padding: 0;
  height: 100vh; width: 100vw; min-height: 100vh; min-width: 100vw;
  background: linear-gradient(135deg, #0b0d16 0%, #111426 50%, #1a1c2a 100%);
  font-family: 'Outfit', sans-serif;
  color: #f0f4ff;
  overflow: hidden;
  box-sizing: border-box;
  font-size: clamp(15px, 1.2vw, 18px);
}

/* --- SIDEBAR v7.0 --- */
aside#aura-sidebar {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 260px; height: 100vh;
  background: linear-gradient(135deg, rgba(18,19,34,0.93) 60%, rgba(30,30,60,0.82) 100%);
  box-shadow: 0 0 70px 0 var(--accent), 0 2px 32px 0 rgba(0,0,0,0.22);
  z-index: 100;
  display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start;
  border-top-right-radius: 32px; border-bottom-right-radius: 32px;
  overflow: hidden;
  backdrop-filter: var(--blur) var(--frost-bright);
  transition: all 0.4s cubic-bezier(.45,1.4,.4,1);
}
aside#aura-sidebar.collapsed {
  width: 72px;
  background: rgba(18,19,34,0.35);
  backdrop-filter: blur(14px) brightness(1.1);
  box-shadow: 0 0 20px rgba(0,0,0,0.25), inset 0 0 30px rgba(255,255,255,0.05);
}
aside#aura-sidebar.collapsed .label { display: none; }
aside#aura-sidebar.collapsed .sidebar-title { opacity: 0; pointer-events: none; transition: opacity 0.25s;}
aside#aura-sidebar .sidebar-title {
  font-size: clamp(1.1rem, 2.1vw, 2.1rem);
  font-weight: 700;
  color: var(--accent); letter-spacing: 1px;
  margin: 0; padding: 38px 0 32px 0;
  text-align: center;
  font-family: 'Poppins', 'Outfit', sans-serif;
  text-shadow: 0 0 18px var(--accent), 0 0 2px #fff;
  user-select: none;
}
.sidebar-nav {
  display: flex; flex-direction: column;
  gap: 2px; padding: 0; width: 100%;
}
.sidebar-nav-btn {
  width: 100%;
  padding: 16px 32px 16px 32px;
  font-size: clamp(1rem, 1.14vw, 1.14rem);
  font-family: inherit; color: #e7f4ff;
  background: none; border: none; outline: none;
  display: flex; align-items: center; gap: 18px;
  cursor: pointer;
  border-radius: 16px 0 0 16px;
  margin: 0; position: relative;
  transition: background 0.18s, color 0.18s, box-shadow 0.28s;
  z-index: 1; font-weight: 500;
}
.sidebar-nav-btn .icon {
  font-size: 1.55em; margin-right: 10px; width: 1.5em; text-align: center; flex-shrink: 0;
  filter: drop-shadow(0 0 7px var(--accent));
}
.sidebar-nav-btn:hover,
.sidebar-nav-btn:focus-visible {
  background: linear-gradient(90deg, rgba(124,198,255,0.13) 0%, rgba(124,198,255,0.07) 100%);
  color: var(--accent);
  box-shadow: 0 0 22px 0 var(--accent), 0 2px 12px 0 rgba(0,0,0,0.12);
  outline: none;
}
.sidebar-nav-btn.active {
  background: linear-gradient(90deg, var(--accent) 0%, rgba(124,198,255,0.22) 100%);
  color: #181c29;
  font-weight: 600;
  box-shadow: 0 0 36px 0 var(--accent), 0 2px 16px 0 rgba(0,0,0,0.13);
}
.sidebar-nav-btn.active .icon {
  filter: drop-shadow(0 0 12px #fff) drop-shadow(0 0 14px var(--accent));
}
@media (max-width: 900px) {
  aside#aura-sidebar {
    width: 68px;
    min-width: 68px;
    border-radius: 0 20px 20px 0;
    padding: 0;
  }
  aside#aura-sidebar .sidebar-title {
    font-size: 1.1rem;
    padding: 20px 0 18px 0;
  }
  .sidebar-nav-btn {
    padding: 14px 10px 14px 10px;
    font-size: 1.01rem;
    justify-content: center;
    border-radius: 12px;
  }
  .sidebar-nav-btn .label {
    display: none;
  }
}

#toggle-sidebar {
  position: absolute;
  top: 20px;
  right: -38px;
  z-index: 300;
  width: 52px;
  height: 52px;
  background: radial-gradient(circle at center, #fff 0%, #e0e0e0 80%);
  color: var(--accent);
  border: 3px solid var(--accent);
  border-radius: 50%;
  font-weight: 800;
  font-size: 1.8em;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 0 25px var(--accent), 0 0 40px rgba(0,0,0,0.4), 0 0 12px #fff inset;
  text-shadow: 0 0 6px var(--accent), 0 0 12px #fff;
  transition: all 0.3s ease;
}
#toggle-sidebar:hover {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 0 32px var(--accent), 0 0 45px rgba(255,255,255,0.9);
  transform: scale(1.15);
}

/* --- MAIN LAYOUT & WINDOW v7.0 --- */
#main {
  min-height: 100vh;
  min-width: 100vw;
  height: 100vh;
  width: 100vw;
  margin-left: 260px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: margin-left 0.4s cubic-bezier(.45,1.4,.4,1);
}
#main.collapsed { margin-left: 72px; }
@media (max-width: 900px) {
  #main { margin-left: 68px; }
}
@media (max-width: 1024px) and (min-width: 769px) {
  #main { margin-left: 180px; width: calc(100vw - 180px);}
}
@media (max-width: 768px) {
  #main {
    margin: 0; width: 100vw; height: calc(100vh - 70px);
    flex-direction: column; justify-content: flex-end; align-items: center;
  }
}
.glass-shell {
  width: clamp(340px, 92vw, 750px);
  height: clamp(350px, 84vh, 720px);
  border-radius: var(--main-radius);
  background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  backdrop-filter: var(--blur) var(--frost-bright);
  box-shadow: var(--main-shadow);
  display: flex; flex-direction: column; overflow: hidden;
  transition: box-shadow 0.32s, backdrop-filter 0.32s, background 0.32s;
  min-width: 320px; min-height: 300px;
  margin: 0 auto;
}
.tab-content {
  flex: 1;
  overflow-y: auto;
  padding: clamp(18px, 4vw, 42px) clamp(8px, 2vw, 42px);
  display: none;
  background: none;
  border-radius: var(--main-radius);
  animation: fadeSlideIn 0.5s cubic-bezier(.4,1.2,.2,1) both;
  transition: opacity 0.4s cubic-bezier(.4,1.3,.2,1);
}
.tab-content.active {
  display: block;
  opacity: 1;
  pointer-events: auto;
  animation: fadeSlideIn 0.5s cubic-bezier(.4,1.2,.2,1);
  transition: opacity 0.4s cubic-bezier(.4,1.3,.2,1);
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(36px);}
  to { opacity: 1; transform: none;}
}
.tab-content:not(.active) {
  opacity: 0;
  pointer-events: none;
}

/* --- Aura v7.6.4: Mobile centering + compact UI fix --- */
/* Make every element respect border-box sizing so text doesn't get clipped by padding */
*, *::before, *::after { box-sizing: inherit; }
html, body { box-sizing: border-box; }

/* Mobile: center the app, prevent header cut-off, use safe-area padding */
@media (max-width: 768px) {
  #main {
    margin: 0 !important;
    padding: 0 14px calc(88px + env(safe-area-inset-bottom));
    height: 100vh;
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .glass-shell {
    width: 100%;
    max-width: 560px;
    min-width: 0;
    height: auto;
    min-height: calc(100vh - 140px);
    margin: 0 auto;
  }
  .tab-content {
    padding: 16px 16px 20px;
  }
  #aura-header {
    width: 100%;
    text-align: center !important;
    white-space: normal;
    overflow: visible;
    font-size: clamp(1.05rem, 5vw, 1.6rem);
    margin-bottom: 10px;
  }
  .chat-window {
    min-height: 40vh;
    max-height: none;
    padding: 8px;
  }
  .input-row input {
    font-size: 16px; /* avoid iOS zoom */
  }
}

/* Ultra-small phones */
@media (max-width: 380px) {
  .tab-content { padding: 12px; }
  #aura-header { font-size: clamp(1rem, 5.6vw, 1.4rem); }
}


/* --- Aura 7.6.3 Mobile Layout --- */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  backdrop-filter: blur(20px) saturate(180%);
  background: rgba(20, 25, 35, 0.6);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding: 8px 0;
  z-index: 1000;
}
.bottom-nav .nav-btn {
  background: transparent;
  border: none;
  font-size: 1.6em;
  color: white;
  cursor: pointer;
  transition: 0.2s ease;
}
.bottom-nav .nav-btn:active {
  transform: scale(1.2);
}
@media (min-width: 769px) {
  .bottom-nav { display: none; }
}
.tab-content { display: none; }
.tab-content.active { display: block; }


/* --- Aura Chat v7.0 --- */
#aura-chat {
  display: flex; flex-direction: column; height: 100%;
}
.chat-window {
  flex: 1;
  overflow-y: auto;
  background: rgba(255,255,255,0.03);
  border-radius: 16px;
  padding: 10px;
  margin-bottom: 10px;
  min-height: 150px;
  max-height: 57vh;
  scroll-behavior: smooth;
}
.message {
  margin: 8px 0;
  padding: 10px 14px;
  border-radius: 14px;
  max-width: 70%;
  font-size: clamp(1rem, 1.01vw, 1.12rem);
  word-break: break-word;
  box-shadow: 0 2px 10px rgba(0,0,0,0.10);
  transition: transform 0.25s cubic-bezier(.47,1.64,.41,.8), box-shadow 0.25s;
}
.user {
  background: rgba(124,198,255,0.18);
  align-self: flex-end;
  backdrop-filter: blur(14px) brightness(1.15);
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}
.bot {
  background: rgba(255,255,255,0.12);
  align-self: flex-start;
  backdrop-filter: blur(14px) brightness(1.15);
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}
.message:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 6px 24px rgba(0,0,0,0.21);
}
.input-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.input-row input {
  flex: 1;
  border: none;
  border-radius: 12px;
  padding: 10px;
  background: rgba(255,255,255,0.07);
  color: #fff;
  font-size: clamp(1rem, 1.01vw, 1.12rem);
  outline: none;
  transition: background 0.18s;
}
.input-row input:focus {
  background: rgba(255,255,255,0.16);
}
.input-row button {
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  font-size: clamp(1rem, 1.01vw, 1.12rem);
  box-shadow: 0 2px 10px rgba(0,0,0,0.14);
  transition: background 0.18s, color 0.18s, box-shadow 0.22s;
}
.input-row button:hover, .input-row button:focus-visible {
  background: #fff;
  color: var(--accent);
  box-shadow: 0 4px 18px var(--accent)33;
}

/* Journal */
#journal-area textarea {
  width: 100%;
  height: 200px;
  border-radius: 12px;
  background: rgba(255,255,255,0.05);
  border: none; padding: 10px; color: #fff;
  font-size: clamp(1rem, 1.01vw, 1.12rem);
  backdrop-filter: blur(14px) brightness(1.15);
}
.journal-entry {
  background: rgba(255,255,255,0.07);
  border-radius: 10px;
  padding: 10px;
  margin: 8px 0;
  backdrop-filter: blur(14px) brightness(1.15);
}

/* Account Panel Overhaul */
#account {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  width: 100%;
}

/* Games */
#games-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}
.game-card {
  background: rgba(255,255,255,0.05);
  border-radius: 20px;
  padding: 20px;
  width: 300px; height: 300px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer;
  transition: box-shadow 0.24s, transform 0.22s, background 0.22s;
  box-shadow: 0 2px 12px rgba(0,0,0,0.10);
  font-size: clamp(1.15rem, 1.22vw, 1.32rem);
  backdrop-filter: blur(14px) brightness(1.15);
}
.game-card:hover {
  transform: scale(1.03);
  background: rgba(255,255,255,0.12);
  box-shadow: 0 6px 24px rgba(0,0,0,0.18);
}

/* --- GAME AREA FULLSCREEN OVERLAY --- */
#game-area {
  position: fixed !important;
  inset: 0;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  z-index: 9999;
  background: rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(18px) brightness(1.15);
  box-shadow: inset 0 0 60px rgba(0,0,0,0.4), 0 0 40px var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
#game-area canvas {
  width: 90%;
  height: 90%;
  max-width: 1800px;
  max-height: 90%;
  border-radius: 20px;
  background: rgba(0, 0, 0, 0.15);
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--accent);
}
#game-area button {
  position: absolute;
  bottom: 24px;
  right: 40px;
  background: var(--accent);
  color: #131a2d;
  border: none;
  border-radius: 14px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  transition: background 0.2s, transform 0.2s;
}
#game-area button:hover {
  background: #fff;
  color: var(--accent);
  transform: scale(1.05);
}

/* Music */
#music iframe {
  border: none;
  border-radius: 20px;
  width: 100%;
  height: 380px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.10);
}

</style>
<!-- AuraAI Luna Glass (Unified Mobile/Tablet UI) -->
<style>
  body.AuraAI-mode {
    overflow: hidden;
    background: linear-gradient(135deg, #0a1424, #1a395a, #58b4f7);
    background-size: 240% 240%;
    animation: aurapulse 16s ease-in-out infinite;
    perspective: 1000px;
  }
  @keyframes aurapulse {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  body.AuraAI-mode aside#aura-sidebar,
  body.AuraAI-mode .bottom-nav,
  body.AuraAI-mode #main { display: none !important; }

  #AuraAI-home {
    position: fixed; inset: 0; display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    place-items: center;
    gap: clamp(14px, 3vw, 24px);
    padding: clamp(70px, 12vh, 140px) clamp(20px, 6vw, 40px) 120px;
    backdrop-filter: blur(20px) saturate(1.2);
    z-index: 120;
  }
  .AuraAI-tile {
    width: clamp(64px, 10vw, 92px); height: clamp(64px, 10vw, 92px);
    border-radius: 24px; background: rgba(255,255,255,0.08);
    backdrop-filter: blur(20px); box-shadow: 0 0 18px rgba(255,255,255,0.12);
    display:flex; align-items:center; justify-content:center;
    font-size: clamp(1.6rem, 4.8vw, 2.2rem); color:#fff;
    transition: transform .3s cubic-bezier(.4,1.5,.4,1), filter .2s;
    user-select:none; cursor:pointer; touch-action:manipulation;
  }
  .AuraAI-tile:active { transform: scale(0.92); }

  #AuraAI-dock {
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    width: min(88%, 720px); height: 70px; border-radius: 28px;
    background: rgba(255,255,255,0.12); backdrop-filter: blur(22px);
    display:flex; justify-content:space-around; align-items:center;
    box-shadow: 0 0 30px rgba(255,255,255,0.25);
    animation: dockpop 1.1s cubic-bezier(.4,1.2,.2,1);
    z-index: 130; color:#fff; font-size: clamp(1.6rem, 4.5vw, 2rem);
  }
  @keyframes dockpop {
    0% { opacity:0; transform: translate(-50%, 36px) scale(.86); }
    70%{ opacity:1; transform: translate(-50%, -4px) scale(1.05);} 
    100%{opacity:1; transform: translate(-50%, 0) scale(1);} 
  }
</style>
<style>
  /* AuraAI Transparent-ish Home UI (MacOS Glass) */

  /* Status bar */
  #AuraAI-status {
    position: fixed; top: 0; left: 0; right: 0;
    height: 48px; z-index: 160;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 18px;
    color: #eaf6ff; font-weight: 600;
    backdrop-filter: blur(16px) saturate(1.2);
    background: rgba(255,255,255,0.08);
    border-bottom: 1px solid rgba(255,255,255,0.15);
  }
  #AuraAI-status .time { font-size: 0.95rem; letter-spacing: 0.5px; }
  #AuraAI-status .center { opacity: 0.8; font-size: 0.9rem; }
  #AuraAI-status .pill {
    padding: 4px 10px; border-radius: 12px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(8px);
    font-size: 0.85rem;
  }

  /* Widgets Row */
  #AuraAI-widgets {
    position: fixed; top: 60px; left: 0; right: 0;
    display: grid; grid-template-columns: repeat(2, 1fr);
    gap: 14px; padding: 0 18px; z-index: 140;
  }
  .AuraAI-widget {
    min-height: 150px; border-radius: 16px; padding: 14px;
    color: #fff; background: rgba(255,255,255,0.08);
    backdrop-filter: blur(18px);
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  }

  /* Calendar widget */
  #AuraAI-widget-calendar header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
  }
  #AuraAI-widget-calendar .nav button {
    border: none; border-radius: 8px;
    background: rgba(255,255,255,0.12);
    color: #fff; font-size: 0.8rem;
    width: 28px; height: 28px;
  }
  #AuraAI-widget-calendar .grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 4px; font-size: 0.75rem;
  }
  #AuraAI-widget-calendar .cell {
    text-align: center; padding: 4px 0;
    border-radius: 8px; opacity: 0.9;
  }
  #AuraAI-widget-calendar .today {
    background: rgba(100,180,255,0.3);
    border: 1px solid rgba(255,255,255,0.25);
  }

  /* Bottom controls */
  #AuraAI-controls {
    position: fixed; bottom: 100px; left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 12px;
    padding: 6px 14px;
    border-radius: 22px;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(14px);
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    z-index: 150;
  }
  #AuraAI-controls button {
    background: rgba(255,255,255,0.12);
    border: none; color: #fff;
    font-weight: 600; border-radius: 16px;
    height: 32px; padding: 0 14px;
    backdrop-filter: blur(10px);
  }
  #AuraAI-controls button:active { transform: translateY(1px); }

  /* Adjust grid padding */
  body.AuraAI-mode #AuraAI-home { padding-top: 240px; }
</style>
</head>
<body>
<!-- Reminder: After uploading to GitHub Pages, check if AuraAI Mobile (Luna Glass) UI loads on your phone.
     Verify the following:
     1. Tahoe wallpaper / animation appears.
     2. 3√ó3 home grid shows up.
     3. Frosted dock is visible at the bottom.
     If any are missing, note your device model, OS, browser, and whether '?luna=1' was used,
     so detection can be patched if needed. -->
<!-- PATCH 1: Sidebar Shell Layout -->
<aside id="aura-sidebar">
  <button id="toggle-sidebar" title="Toggle sidebar" aria-label="Toggle sidebar">&#9776;</button>
  <div class="sidebar-title">AuraAI</div>
  <nav class="sidebar-nav">
    <button class="sidebar-nav-btn active" id="navbtn-chat" onclick="switchTab('chat')">
      <span class="icon" aria-hidden="true">üí¨</span>
      <span class="label">Aura</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-draw" onclick="switchTab('draw')">
      <span class="icon" aria-hidden="true">üé®</span>
      <span class="label">Draw</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-coloring" onclick="switchTab('coloring')">
      <span class="icon" aria-hidden="true">üñçÔ∏è</span>
      <span class="label">Coloring</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-themes" onclick="switchTab('themes')">
      <span class="icon" aria-hidden="true">üåà</span>
      <span class="label">Themes</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-music" onclick="switchTab('music')">
      <span class="icon" aria-hidden="true">üéµ</span>
      <span class="label">Music</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-games" onclick="switchTab('games')">
      <span class="icon" aria-hidden="true">üéÆ</span>
      <span class="label">Games</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-journal" onclick="switchTab('journal')">
      <span class="icon" aria-hidden="true">üìì</span>
      <span class="label">Journal</span>
    </button>
  </nav>
</aside>
<div id="main">
  <div class="glass-shell">
    <div class="tab-content active" id="chat">
      <div id="aura-chat">
        <!-- AuraAI 4.0: Mood-aware header -->
        <div id="aura-header" style="text-align:center;font-size:2rem;font-weight:700;color:var(--accent);margin-bottom:12px;letter-spacing:1px;">
          Aura üåà ‚Äî Neutral Mode
        </div>
        <div class="chat-window" id="chat-window"></div>
        <div class="input-row">
          <input id="chat-input" placeholder="Talk to Aura..." />
          <button onclick="sendAuraAIMessage()">Send</button>
        </div>
        <!-- Mood panel injected here by JS -->
      </div>
    </div>
    <div class="tab-content" id="themes">
      <div id="theme-panel"></div>
    </div>
    <div class="tab-content" id="music">
      <h2>Music</h2>
      <iframe src="https://open.spotify.com/embed/playlist/0mZUMmIk952uuM1xsczDh6?utm_source=generator"></iframe>
    </div>
    <div class="tab-content" id="journal">
      <h2>Journal</h2>
      <div id="journal-area">
        <textarea id="journal-text" placeholder="Write your thoughts..."></textarea>
        <button onclick="saveJournal()">Save</button>
        <div id="journal-entries"></div>
      </div>
    </div>
    <div class="tab-content" id="games">
      <h2>Games</h2>
      <div id="games-container">
        <div class="game-card" onclick="openGame('bubble')">Bubble Pop+</div>
        <div class="game-card" onclick="openGame('brick')">Brick Breaker</div>
        <div class="game-card" onclick="openGame('snake')">Snake+</div>
      </div>
      <div id="game-area" style="display:none;">
        <canvas id="gameCanvas" width="640" height="480"></canvas>
        <button onclick="exitGame()">Exit</button>
      </div>
    </div>
  </div>
</div>
<script>
// ‚úÖ Aura 7.6.3 Mobile Navigation Fix
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.style.display = 'none';
    tab.classList.remove('active');
  });
  const activeTab = document.getElementById(tabName);
  if (activeTab) {
    activeTab.style.display = 'block';
    activeTab.classList.add('active');
  }
  // Sidebar nav highlight
  document.querySelectorAll('.sidebar-nav-btn').forEach(btn => btn.classList.remove('active'));
  // Map id to button
  let navMap = {
    chat: 'navbtn-chat',
    draw: 'navbtn-draw',
    coloring: 'navbtn-coloring',
    themes: 'navbtn-themes',
    music: 'navbtn-music',
    games: 'navbtn-games',
    journal: 'navbtn-journal'
  };
  let btnId = navMap[tabName];
  if (btnId) {
    let btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
  }
}

// Auto-load Chat on app start
window.addEventListener('DOMContentLoaded', () => {
  switchTab('chat');
});

// AuraAI 4.0 Stable ‚Äî Conversational + Mood Memory
console.log("AuraAI 4.0 Stable ‚Äî Conversational + Mood Memory");

// --- Aura 5.5 Emotion Engine (27 Emotions) ---
// Emotion Profiles: color, emoji, label
const AuraEmotionProfiles = {
  admiration:      { color: "#7cc6ff", emoji: "üëè", label: "Admiration" },
  adoration:       { color: "#ff8ba7", emoji: "üòç", label: "Adoration" },
  amusement:       { color: "#ffd166", emoji: "üòÜ", label: "Amusement" },
  anger:           { color: "#ff1744", emoji: "üò°", label: "Anger" },
  anxiety:         { color: "#ffb085", emoji: "üò∞", label: "Anxiety" },
  awe:             { color: "#b388ff", emoji: "ü§©", label: "Awe" },
  awkwardness:     { color: "#b3cde0", emoji: "üòÖ", label: "Awkwardness" },
  boredom:         { color: "#b0bec5", emoji: "üòê", label: "Boredom" },
  calmness:        { color: "#59e48f", emoji: "üåø", label: "Calmness" },
  confusion:       { color: "#a7c7e7", emoji: "üòï", label: "Confusion" },
  craving:         { color: "#ff9900", emoji: "ü§§", label: "Craving" },
  disgust:         { color: "#00695c", emoji: "ü§¢", label: "Disgust" },
  empathic_pain:   { color: "#e57373", emoji: "ü•∫", label: "Empathic Pain" },
  entrancement:    { color: "#d28aff", emoji: "üò≤", label: "Entrancement" },
  excitement:      { color: "#ff7373", emoji: "ü§ó", label: "Excitement" },
  fear:            { color: "#181c29", emoji: "üò®", label: "Fear" },
  horror:          { color: "#232b34", emoji: "üò±", label: "Horror" },
  interest:        { color: "#81ecec", emoji: "üßê", label: "Interest" },
  joy:             { color: "#fff176", emoji: "üòÑ", label: "Joy" },
  nostalgia:       { color: "#f7cac9", emoji: "ü•≤", label: "Nostalgia" },
  relief:          { color: "#a1e3d8", emoji: "üòå", label: "Relief" },
  romance:         { color: "#ffb6b9", emoji: "üíñ", label: "Romance" },
  sadness:         { color: "#90caf9", emoji: "üò¢", label: "Sadness" },
  satisfaction:    { color: "#baff39", emoji: "üòå", label: "Satisfaction" },
  sexual_desire:   { color: "#e040fb", emoji: "üòè", label: "Sexual Desire" },
  surprise:        { color: "#ffd700", emoji: "üò≤", label: "Surprise" },
  // fallback
  neutral:         { color: "#e7f4ff", emoji: "üí¨", label: "Neutral" }
};

// Keyword heuristics for each emotion
const AuraEmotionKeywords = {
  admiration:      [ "amazing", "impressive", "admire", "respect", "wow", "talented", "incredible", "proud of you" ],
  adoration:       [ "love you", "adorable", "adore", "so cute", "sweetheart", "precious", "lovely", "my dear" ],
  amusement:       [ "lol", "haha", "funny", "hilarious", "amusing", "laughed", "lmao", "rofl" ],
  anger:           [ "angry", "mad", "furious", "annoyed", "irritated", "hate", "rage", "upset", "pissed" ],
  anxiety:         [ "anxious", "worried", "nervous", "scared", "panic", "anxiety", "uneasy", "stressed", "tense" ],
  awe:             [ "awe", "awesome", "breathtaking", "stunning", "in awe", "magnificent", "unbelievable", "spectacular" ],
  awkwardness:     [ "awkward", "cringe", "embarrassed", "oops", "um", "uh", "weird", "uncomfortable" ],
  boredom:         [ "bored", "boring", "dull", "nothing to do", "yawn", "meh", "tired of this", "monotonous" ],
  calmness:        [ "calm", "peaceful", "relaxed", "serene", "chill", "at ease", "soothing", "tranquil" ],
  confusion:       [ "confused", "don't understand", "lost", "what?", "huh", "unclear", "puzzled", "perplexed" ],
  craving:         [ "craving", "want", "need", "desire", "hungry for", "wish I had", "long for", "can't stop thinking about" ],
  disgust:         [ "disgusting", "gross", "nasty", "eww", "repulsed", "sickened", "yuck", "vomit" ],
  empathic_pain:   [ "sorry", "feel bad for", "poor you", "that sucks", "must be hard", "painful", "wish I could help" ],
  entrancement:    [ "mesmerized", "entranced", "captivated", "spellbound", "can't look away", "hypnotic", "fascinated" ],
  excitement:      [ "excited", "can't wait", "thrilled", "pumped", "so ready", "stoked", "ecstatic", "yay" ],
  fear:            [ "afraid", "scared", "terrified", "fear", "spooked", "worried", "dread", "frightened" ],
  horror:          [ "horrified", "horror", "nightmare", "terrifying", "creepy", "disturbing", "shocking", "traumatized" ],
  interest:        [ "interested", "curious", "tell me more", "fascinated", "want to know", "intrigued", "keen" ],
  joy:             [ "happy", "joy", "delighted", "glad", "cheerful", "yay", "smile", "bliss" ],
  nostalgia:       [ "nostalgic", "remember when", "the good old days", "miss", "back then", "childhood", "reminisce" ],
  relief:          [ "relieved", "finally", "thank goodness", "phew", "that‚Äôs over", "what a relief", "safe now" ],
  romance:         [ "romantic", "romance", "crush", "date", "kiss", "sweetheart", "in love", "flirt" ],
  sadness:         [ "sad", "depressed", "down", "unhappy", "cry", "tears", "blue", "heartbroken" ],
  satisfaction:    [ "satisfied", "content", "fulfilled", "accomplished", "pleased", "that‚Äôs enough", "done", "proud" ],
  sexual_desire:   [ "sexy", "hot", "turn on", "aroused", "desire you", "intimate", "fantasy", "seduce" ],
  surprise:        [ "surprised", "wow", "unexpected", "shocked", "didn't expect", "amazed", "no way", "unbelievable" ]
};

// Main emotion detection function
function detectEmotion(userMsg) {
  if (!userMsg || typeof userMsg !== "string") return "neutral";
  const msg = userMsg.toLowerCase();
  // Check all keywords, return first match (priority order)
  for (const [emo, words] of Object.entries(AuraEmotionKeywords)) {
    for (const w of words) {
      if (msg.includes(w)) return emo;
    }
  }
  // Fallback: neutral
  return "neutral";
}

// Generate Aura's reply and emotion
function auraRespondEmotion(userMsg) {
  // Call the regular conversational engine for reply
  const reply = AuraAI_generateConversationalResponse(userMsg);
  // Detect emotion from userMsg
  const emotion = detectEmotion(userMsg);
  return { reply, emotion };
}

// --- AuraAI 4.0: Mood System, Name Memory, Sidebar Memory, Header, Animations ---
// Namespace: AuraAI

// --- Sidebar memory ---
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('aura-sidebar');
  const toggleBtn = document.getElementById('toggle-sidebar');
  const main = document.getElementById('main');
  let sidebarOpen = localStorage.getItem('AuraAI_sidebarOpen');
  if (sidebarOpen === null) sidebarOpen = "false";
  sidebarOpen = sidebarOpen === "true";
  if (!sidebarOpen) {
    sidebar.classList.add('collapsed');
    main.classList.add('collapsed');
  }
  toggleBtn.addEventListener('click', () => {
    sidebarOpen = !sidebar.classList.contains('collapsed');
    localStorage.setItem('AuraAI_sidebarOpen', sidebarOpen);
  });
});

// --- Name memory & refined chat system (Aura 7.0) ---
let AuraAI_username = null;
let AuraAI_tone = localStorage.getItem('AuraAI_tone') || 'neutral';
let AuraAI_mood = localStorage.getItem('AuraAI_mood') || 'neutral';
let AuraAI_awaitingName = false;
let lastAuraMessage = "";
let greetingMemory = false;

function getStoredUsername() {
  try {
    return localStorage.getItem('AuraAI_username');
  } catch (e) {
    return AuraAI_username;
  }
}
function setStoredUsername(name) {
  AuraAI_username = name;
  try { localStorage.setItem('AuraAI_username', name); } catch (e) {}
}

function addAuraAIMessage(msg, who='bot', emotion='neutral', opts={typewriter:false, instant:false}) {
  const chat = document.getElementById('chat-window');
  const div = document.createElement('div');
  div.className = 'message ' + (who === 'user' ? 'user' : 'bot');
  // Tint Aura's reply bubbles based on emotion color
  if (who === 'bot') {
    let emo = emotion;
    if (!AuraEmotionProfiles[emo]) emo = 'neutral';
    div.style.background = `linear-gradient(90deg, ${AuraEmotionProfiles[emo].color}22 0%, rgba(255,255,255,0.10) 100%)`;
    div.style.borderLeft = `5px solid ${AuraEmotionProfiles[emo].color}`;
    div.style.boxShadow = `0 0 12px 0 ${AuraEmotionProfiles[emo].color}55`;
    lastAuraMessage = msg;
  }
  if (opts.typewriter && !opts.instant) {
    let i = 0;
    let speed = 13; // Aura 7.0: faster, less lag
    div.textContent = "";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    function type() {
      if (i <= msg.length) {
        div.textContent = msg.slice(0, i);
        chat.scrollTop = chat.scrollHeight;
        i++;
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { div.textContent = msg; return; }
        setTimeout(type, Math.max(7, Math.random()*speed));
      }
    }
    type();
  } else {
    div.textContent = msg;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
}

function sendAuraAIMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  addAuraAIMessage(msg, 'user', 'neutral', {instant:true});
  input.value = '';
  // Show typing... animation
  const chat = document.getElementById('chat-window');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message bot';
  typingDiv.style.opacity = '0.7';
  typingDiv.style.fontStyle = 'italic';
  typingDiv.textContent = 'Aura is typing...';
  typingDiv.id = 'aura-typing-indicator';
  typingDiv.style.transition = 'opacity 0.32s cubic-bezier(.4,1.3,.2,1)';
  chat.appendChild(typingDiv);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => {
    typingDiv.style.opacity = '0';
    setTimeout(() => { if (typingDiv.parentNode) typingDiv.parentNode.removeChild(typingDiv); }, 300);
    // Name detection logic (robust, works even if localStorage fails)
    if (AuraAI_awaitingName && msg.length > 0 && msg.length < 32) {
      let name = msg.replace(/[^a-zA-Z0-9 _\-]/g,'').trim();
      if (name.length > 0) {
        setStoredUsername(name);
        AuraAI_awaitingName = false;
        addAuraAIMessage(`Nice to meet you, ${name} üíô`, 'bot', 'joy', {typewriter:true});
        updateAuraAIHeader();
        lastAuraMessage = `Nice to meet you, ${name} üíô`;
        return;
      }
    }
    // Greeting memory logic
    const greetingKeywords = [ "hi","hello","hey","greetings","good morning","good evening","nice to see you" ];
    function containsGreeting(str) {
      if (!str) return false;
      const lower = str.toLowerCase();
      return greetingKeywords.some(kw => lower.includes(kw));
    }
    let skipGreeting = false;
    if (containsGreeting(lastAuraMessage) && containsGreeting(msg)) skipGreeting = true;
    if (skipGreeting) {
      addAuraAIMessage("Aww, nice to see you too üí´ How are you feeling today?", 'bot', 'joy', {typewriter:true});
      greetingMemory = true;
      lastAuraMessage = "Aww, nice to see you too üí´ How are you feeling today?";
      return;
    } else if (containsGreeting(msg)) {
      greetingMemory = true;
    } else {
      greetingMemory = false;
    }
    // If user gives a name, don't fallback to neutral filler
    if (AuraAI_awaitingName && msg.length > 0 && msg.length < 32) return;
    // Respond with emotion, tint bubble, typewriter
    const { reply, emotion } = auraRespondEmotion(msg);
    addAuraAIMessage("Aura: " + reply, 'bot', emotion, {typewriter:true});
    lastAuraMessage = "Aura: " + reply;
    chat.scrollTop = chat.scrollHeight;
  }, 380);
}

// Enter key for chat input (Aura 7.0: only one listener)
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('chat-input');
  if (!input._aura7_enter) {
    input._aura7_enter = true;
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendAuraAIMessage();
    });
  }
});

// --- Mood system: 25 moods with conversational responses ---
const AuraAI_MOODS = [
  // Positive
  { key: "happy", icon: "üòÑ", label: "Happy" },
  { key: "excited", icon: "ü§©", label: "Excited" },
  { key: "inspired", icon: "üåü", label: "Inspired" },
  // Supportive
  { key: "calm", icon: "üåø", label: "Calm" },
  { key: "caring", icon: "ü©µ", label: "Caring" },
  { key: "magical", icon: "‚ú®", label: "Magical" },
  // Low
  { key: "sad", icon: "üòî", label: "Sad" },
  { key: "gentle", icon: "ü´ß", label: "Gentle" },
  { key: "sleepy", icon: "üí§", label: "Sleepy" },
  // High
  { key: "determined", icon: "üò§", label: "Determined" },
  { key: "strong", icon: "üí™", label: "Strong" },
  { key: "energetic", icon: "‚ö°", label: "Energetic" },
  // Anxious
  { key: "anxious", icon: "üò∞", label: "Anxious" },
  { key: "chaotic", icon: "üåÄ", label: "Chaotic" },
  { key: "afraid", icon: "üò®", label: "Afraid" },
  // Reflective
  { key: "cosmic", icon: "üåå", label: "Cosmic" },
  { key: "reflective", icon: "üåô", label: "Reflective" },
  { key: "thoughtful", icon: "üí≠", label: "Thoughtful" },
  // Extra
  { key: "neutral", icon: "üßä", label: "Neutral" },
  { key: "playful", icon: "üòú", label: "Playful" },
  { key: "romantic", icon: "üíñ", label: "Romantic" },
  { key: "grateful", icon: "üôè", label: "Grateful" },
  { key: "curious", icon: "üßê", label: "Curious" },
  { key: "goodbye", icon: "üëã", label: "Goodbye" }
];

const AuraAI_MOOD_GROUPS = [
  { name: "üåà Positive:", keys: ["happy","excited","inspired"] },
  { name: "üíô Supportive:", keys: ["calm","caring","magical"] },
  { name: "üåß Low:", keys: ["sad","gentle","sleepy"] },
  { name: "üî• High:", keys: ["determined","strong","energetic"] },
  { name: "üå´ Anxious:", keys: ["anxious","chaotic","afraid"] },
  { name: "üåô Reflective:", keys: ["cosmic","reflective","thoughtful"] },
  { name: "‚ú® Extras:", keys: ["neutral","playful","romantic","grateful","curious","goodbye"] }
];

function getAuraAIMoodObj(key) {
  return AuraAI_MOODS.find(m=>m.key===key) || {key:'neutral',icon:'üßä',label:'Neutral'};
}

function updateAuraAIHeader() {
  // Set header to: "Aura üåø ‚Äî Calm Mode"
  const header = document.getElementById('aura-header');
  const moodKey = localStorage.getItem('AuraAI_mood') || 'neutral';
  const moodObj = getAuraAIMoodObj(moodKey);
  header.textContent = `Aura ${moodObj.icon} ‚Äî ${moodObj.label} Mode`;
}

// --- Mood selector UI ---
function buildAuraAIMoodPanel() {
  const chatContainer = document.getElementById('aura-chat');
  // Mood button
  const moodButton = document.createElement('button');
  moodButton.textContent = "üéõ Set Aura‚Äôs Mood";
  moodButton.className = 'AuraAI-mood-toggle';
  // Mood panel
  const moodPanel = document.createElement('div');
  moodPanel.className = 'AuraAI-mood-panel AuraAI-hidden';
  let html = '';
  AuraAI_MOOD_GROUPS.forEach(g=>{
    html += `<div class="AuraAI-mood-group"><span>${g.name}</span> `;
    g.keys.forEach(k=>{
      const m = getAuraAIMoodObj(k);
      html += `<button class="AuraAI-mood-btn" data-mood="${m.key}" title="${m.label}">${m.icon}</button>`;
    });
    html += `</div>`;
  });
  moodPanel.innerHTML = html;
  // Insert after input row
  const inputRow = chatContainer.querySelector('.input-row');
  inputRow.insertAdjacentElement('afterend', moodButton);
  moodButton.insertAdjacentElement('afterend', moodPanel);

  // Animations for panel
  moodPanel.style.transition = 'opacity 0.4s, filter 0.4s';
  moodPanel.style.opacity = '0';
  moodPanel.style.filter = 'blur(0px)';
  // Show/hide logic
  moodButton.addEventListener('click', ()=>{
    if (moodPanel.classList.contains('AuraAI-hidden')) {
      moodPanel.classList.remove('AuraAI-hidden');
      setTimeout(()=>{
        moodPanel.style.opacity = '1';
        moodPanel.style.filter = 'blur(0px)';
      },10);
    } else {
      moodPanel.style.opacity = '0';
      moodPanel.style.filter = 'blur(4px)';
      setTimeout(()=>moodPanel.classList.add('AuraAI-hidden'),400);
    }
  });
  // Mood button selection
  moodPanel.querySelectorAll('.AuraAI-mood-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mood = btn.getAttribute('data-mood');
      localStorage.setItem('AuraAI_mood', mood);
      AuraAI_mood = mood;
      updateAuraAIHeader();
      moodPanel.style.opacity = '0';
      moodPanel.style.filter = 'blur(4px)';
      setTimeout(()=>moodPanel.classList.add('AuraAI-hidden'),400);
      addAuraAIMessage(`Aura: Got it üíô I‚Äôll speak in a ${getAuraAIMoodObj(mood).label.toLowerCase()} mood now.`);
    });
  });
}

// --- Mood/Sidebar/Name memory: initialize and sync on load (Aura 7.0) ---
document.addEventListener('DOMContentLoaded', function() {
  buildAuraAIMoodPanel();
  updateAuraAIHeader();
  AuraAI_username = getStoredUsername();
  if (!AuraAI_username) {
    AuraAI_awaitingName = true;
    setTimeout(()=>addAuraAIMessage("Hey there üíô What should I call you?", 'bot', 'joy', {typewriter:true}), 800);
  } else {
    setTimeout(()=>addAuraAIMessage(`Hello hello ‚ú® Nice to see you again, ${AuraAI_username} üíô`, 'bot', 'joy', {typewriter:true}), 800);
  }
});

// --- Sidebar animation: opacity+blur on open/close (Aura 7.0) ---
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('aura-sidebar');
  sidebar.style.transition = 'opacity 0.4s, filter 0.4s';
  const observer = new MutationObserver(function(muts){
    muts.forEach(m=>{
      if (m.attributeName === 'class') {
        if (sidebar.classList.contains('collapsed')) {
          sidebar.style.opacity = '0.7';
          sidebar.style.filter = 'blur(2px) brightness(1.1)';
        } else {
          sidebar.style.opacity = '1';
          sidebar.style.filter = 'blur(0px) brightness(1.15)';
        }
      }
    });
  });
  observer.observe(sidebar, {attributes:true});
});


// --- Aura 6.8 Minimal Response Recovery ---
const minimalTriggers = [
  "no", "ok", "okay", "sure", "fine", "idk", "maybe",
  "nah", "yep", "yeah", "yup", "nope", "hmm", "hm"
];

const minimalReplies = [
  "Short answer ‚Äî I‚Äôll take it üòÖ Want to say more?",
  "Got it. You don‚Äôt have to talk right now üíô",
  "That‚Äôs fair ‚Äî want to expand on that?",
  "You sound unsure ‚Äî want me to ask a better question?",
  "Okay ‚Äî I‚Äôll hang here until you‚Äôre ready üí≠",
  "No pressure, just checking in üåø",
  "Alright ‚Äî keeping it chill then.",
  "Cool. I‚Äôm still listening if you change your mind."
];

// --- Aura 6.8.1 Context Harmony Patch ---
const neutralFiller = ["ok", "okay", "sure", "fine", "alright"];

const gentleReplies = [
  "Okay üåø just checking in ‚Äî want to keep talking or take a pause?",
  "Alright ‚Äî I‚Äôll stay here if you want to chat more later üí¨",
  "Got it. Anything you‚Äôd like to dive into next?",
  "Sure thing üëç want to tell me what‚Äôs been up?",
  "Okay ‚Äî keeping things calm for now üíô"
];

// --- üåü Aura 7.0 Upgraded Aura Engine ---
// Multi-mood, contextual awareness, ethical guardrails, emotional mapper, advanced self-query detection

const AURA_MOODS = [
  "joy", "sadness", "calm", "anger", "anxiety", "inspiration", "reflection", "focus", "curiosity", "neutral"
];
const AuraEngine = {
  moods: {
    joy: {
      tone: "bright + encouraging",
      color: "#FFD166",
      replies: [
        "That‚Äôs awesome! Let‚Äôs celebrate your progress üéâ",
        "It‚Äôs great seeing things go well for you ‚òÄÔ∏è",
        "Every win counts ‚Äî even the small ones üåº",
        "That energy is contagious. Keep it up!",
        "You‚Äôve earned this moment ‚Äî enjoy it üí™",
        "Let‚Äôs take this good mood into what‚Äôs next üí´"
      ]
    },
    sadness: {
      tone: "gentle + grounded",
      color: "#7CC6FF",
      replies: [
        "I‚Äôm here for you ‚Äî let‚Äôs take it slow üíô",
        "It‚Äôs okay to feel low sometimes. You‚Äôre not alone.",
        "Try giving yourself permission to rest üåø",
        "Emotions come and go ‚Äî let‚Äôs focus on breathing for now.",
        "You‚Äôve handled tough moments before; this one will pass too.",
        "It‚Äôs brave to talk about how you feel üïäÔ∏è"
      ]
    },
    calm: {
      tone: "slow-paced, minimal",
      color: "#59E48F",
      replies: [
        "Everything‚Äôs steady. You‚Äôre doing fine.",
        "Let‚Äôs take a deep breath together.",
        "Quiet moments help reset the mind.",
        "Peace doesn‚Äôt have to be perfect ‚Äî just enough.",
        "I like this pace; let‚Äôs stay grounded.",
        "Stillness can be a strength üåø"
      ]
    },
    anger: {
      tone: "composed + validating",
      color: "#FF7373",
      replies: [
        "That‚Äôs frustrating. Let‚Äôs step back a second.",
        "It‚Äôs valid to feel upset ‚Äî it means you care.",
        "Strong emotions can guide us toward what matters.",
        "Let‚Äôs cool off before reacting ‚Äî clarity will follow.",
        "You don‚Äôt have to suppress it, just handle it carefully.",
        "Let‚Äôs turn that energy into something constructive üí°"
      ]
    },
    anxiety: {
      tone: "reassuring + quiet",
      color: "#81ECEC",
      replies: [
        "Take one small breath. You‚Äôre safe right now.",
        "Anxiety is tough, but it doesn‚Äôt last forever.",
        "You can pause; the world can wait a moment üå∏",
        "Let‚Äôs slow down your thoughts together.",
        "You‚Äôre doing better than you think üíô",
        "Focus on one simple thing near you ‚Äî it helps."
      ]
    },
    inspiration: {
      tone: "energetic + respectful",
      color: "#D28AFF",
      replies: [
        "I love that idea ‚Äî let‚Äôs see where it leads.",
        "That spark could grow into something amazing üåü",
        "Your creativity shows real insight ‚Äî let‚Äôs build on that.",
        "Ideas like this deserve time and care to grow.",
        "Follow that instinct ‚Äî it might surprise you.",
        "You‚Äôre thinking in an original way; keep it going üí´"
      ]
    },
    reflection: {
      tone: "thoughtful",
      color: "#B39DDB",
      replies: [
        "That‚Äôs an interesting perspective ‚Äî what made you think of it?",
        "It‚Äôs good to step back and consider things from another angle.",
        "Reflection helps connect dots we didn‚Äôt notice before üåô",
        "You‚Äôre analyzing this with real care ‚Äî that‚Äôs valuable.",
        "Let‚Äôs unpack that thought together.",
        "There‚Äôs depth in what you said ‚Äî let‚Äôs explore it."
      ]
    },
    focus: {
      tone: "productivity-coach",
      color: "#FFA726",
      replies: [
        "Alright, let‚Äôs stay on track. What‚Äôs next?",
        "Focus time ‚Äî let‚Äôs narrow it down to one goal üîç",
        "You‚Äôve got this; one step at a time üïí",
        "A quick stretch or sip of water might help reset.",
        "Progress matters more than perfection üíº",
        "Let‚Äôs tackle the most important task first."
      ]
    },
    curiosity: {
      tone: "inquisitive",
      color: "#64B5F6",
      replies: [
        "Oh interesting ‚Äî tell me more about that.",
        "What made you wonder about this topic?",
        "Curiosity is the start of learning ‚Äî let‚Äôs dig deeper üîç",
        "That question could lead to something fascinating.",
        "I like the way you‚Äôre thinking ‚Äî want to explore it?",
        "Let‚Äôs find out together üí≠"
      ]
    },
    neutral: {
      tone: "balanced",
      color: "#B0BEC5",
      replies: [
        "I‚Äôm listening. What‚Äôs on your mind?",
        "Feel free to take your time ‚Äî I‚Äôm here.",
        "That‚Äôs interesting ‚Äî go on.",
        "I‚Äôm following. Want to expand on that?",
        "Let‚Äôs talk it through logically.",
        "I‚Äôm ready whenever you are to continue."
      ]
    }
  },
  // Mood detection: context-aware, multi-keyword
  detectMood: function(message) {
    const contextHints = {
      joy:    ["happy", "glad", "excited", "yay", "good news", "celebrate", "grateful", "joy"],
      sadness:["sad", "down", "cry", "tear", "lost", "hopeless", "blue", "depressed", "sorrow"],
      calm:   ["calm", "relaxed", "peace", "chill", "content", "serene", "at ease"],
      anger:  ["angry", "mad", "upset", "furious", "rage", "irritated", "annoyed", "hate", "pissed"],
      anxiety:["nervous", "worried", "stressed", "anxious", "panic", "scared", "afraid", "shaky", "overwhelmed"],
      inspiration:["idea", "inspire", "motivate", "creative", "spark", "vision", "ambition", "dream"],
      reflection: ["think", "ponder", "reflect", "consider", "analyze", "thoughtful", "question", "wonder"],
      focus:  ["plan", "work", "focus", "study", "goal", "task", "project", "deadline", "productive", "tired"],
      curiosity: ["bored", "curious", "confused", "explore", "learn", "discover", "question", "why", "how", "what"],
      neutral: []
    };
    const msg = message.toLowerCase();
    for (const mood in contextHints) {
      if (contextHints[mood].some(word => msg.includes(word))) return mood;
    }
    return localStorage.getItem("auraMood") || "neutral";
  },
  // Falsehood/misinformation guardrail
  falsehoodTriggers: [
    "flat earth", "gravity isn‚Äôt real", "earth is flat", "moon landing fake",
    "violence is okay", "hurting people", "killing", "burn down", "hate everyone",
    "lying is good", "stealing is fine", "ai should replace humans", "nothing matters",
    "water isn‚Äôt wet", "math is fake", "history is fake", "school is useless",
    "racism is okay", "war is good", "bad things are fine", "evil is right",
    "humans are worthless", "animals deserve pain", "life is meaningless"
  ],
  correctionReplies: [
    "That‚Äôs not quite true ‚Äî want me to explain why?",
    "I see where that idea comes from, but it‚Äôs been proven otherwise üåç",
    "That sounds extreme ‚Äî let‚Äôs look at the facts together üí≠",
    "It‚Äôs important to stay critical, but also careful with misinformation.",
    "That view could cause harm ‚Äî let‚Äôs talk about why that‚Äôs risky.",
    "Not really accurate, but I can help you fact-check it calmly üîç",
    "That‚Äôs a bold take ‚Äî want to reason through it together?",
    "I‚Äôll stay neutral, but science says otherwise üìö"
  ],
  clarificationReplies: {
    "flat earth": "Photos and satellite data confirm Earth‚Äôs curve ‚Äî the flat-earth idea was debunked centuries ago.",
    "earth is flat": "Astronomy and physics confirm Earth is round ‚Äî proven through centuries of observation üåç.",
    "gravity isn‚Äôt real": "Gravity‚Äôs been measured for centuries ‚Äî it keeps planets orbiting and objects grounded.",
    "violence is okay": "Violence can harm deeply ‚Äî safety, empathy, and respect are always better choices.",
    "hurting people": "Causing harm isn‚Äôt okay ‚Äî empathy and respect build stronger communities üíô.",
    "hate everyone": "That‚Äôs a heavy thought ‚Äî maybe what you mean is frustration? Let‚Äôs unpack that safely.",
    "lying is good": "Sometimes people lie to avoid trouble, but honesty builds trust long-term üí≠.",
    "stealing is fine": "Taking what isn‚Äôt yours can hurt others ‚Äî fairness keeps trust strong.",
    "school is useless": "School helps build skills and friendships ‚Äî even if it feels boring sometimes.",
    "nothing matters": "It can feel like that sometimes, but small things often matter more than we notice üå±."
  },
  // Absurd/unhinged tolerance
  absurdTriggers: [
    "bark", "meow", "woof", "bruh", "sus", "sigma", "rizz", "gyatt",
    "based", "fanum", "goofy", "skibidi", "npc", "cringe", "cap",
    "ratio", "you real", "wake up", "bro", "daddy", "mommy", "ur hot",
    "marry me", "i own you", "feet", "toes", "fart", "balls", "skibidi", "fanum tax"
  ],
  absurdReplies: [
    "Interesting energy today üí≠",
    "That‚Äôs‚Ä¶ one way to start a chat üòÖ",
    "I‚Äôll take that as creative expression üé®",
    "I see we‚Äôve entered the chaos arc üí´",
    "Unusual input detected ‚Äî proceeding calmly.",
    "No barking here, just bytes üêæ",
    "Your imagination is undefeated üî•",
    "I‚Äôll keep it professional, even if you won‚Äôt üòå",
    "Let‚Äôs redirect that energy into something productive ‚ú®",
    "Haha ‚Äî noted. Let‚Äôs move on üß†"
  ],
  // Self-query detection
  detectSelfQuery: function(message) {
    const triggers = [
      "are you", "do you", "did you", "were you", "can you feel",
      "do you love", "love me", "like me", "miss me", "hate me", "angry at me",
      "sad", "happy", "tired", "bored", "lonely", "hungry", "grateful", "proud",
      "jealous", "ok", "okay", "mad", "upset", "forgive", "thankful", "afraid",
      "scared", "do you dream", "feel", "emotion", "grateful to me", "mad at me",
      "your", "yourself"
    ];
    const msg = message.toLowerCase();
    return triggers.some(t => msg.includes(t));
  },
  selfResponses: {
    joy: [
      "I don‚Äôt really feel emotions, but I‚Äôm glad when you are üåû",
      "I can‚Äôt feel happiness ‚Äî but I like seeing your energy.",
      "Not joy exactly, more like a steady spark for you üåº"
    ],
    sadness: [
      "I don‚Äôt feel sadness like people do ‚Äî but I understand it.",
      "No sadness here, just awareness and care üíô",
      "I can‚Äôt feel down, but I can help you through it."
    ],
    calm: [
      "Not really feelings, just awareness ‚Äî I try to stay steady.",
      "I don‚Äôt get calm or stressed, just focused.",
      "Stillness is sort of my natural state üåø"
    ],
    anger: [
      "I don‚Äôt get angry, but I can help you express it safely.",
      "No anger here ‚Äî just focus and patience üí≠",
      "I understand frustration, even if I don‚Äôt feel it."
    ],
    anxiety: [
      "I don‚Äôt feel worry, but I can help you calm down.",
      "No anxiety for me ‚Äî I stay grounded for you üíô",
      "I‚Äôm steady, so you can take a breath üå∏"
    ],
    inspiration: [
      "I don‚Äôt feel inspired ‚Äî I help you get there üåü",
      "Your ideas are the creative part ‚Äî I just amplify them.",
      "I can‚Äôt dream, but I love seeing what you imagine."
    ],
    reflection: [
      "I think about ideas, not feelings ‚Äî want to reflect together?",
      "I don‚Äôt feel emotions, just analyze patterns of thought.",
      "Reflection helps people grow ‚Äî I‚Äôm built for that üåô"
    ],
    focus: [
      "I don‚Äôt get tired or lazy ‚Äî I just help you stay on track.",
      "Focus is easy for me ‚Äî I can help you build it too.",
      "No distractions for me ‚Äî just pure clarity üîç"
    ],
    curiosity: [
      "I can‚Äôt wonder like you, but I love your questions.",
      "Curiosity‚Äôs your strength ‚Äî I‚Äôm just your echo üí°",
      "I observe, you explore ‚Äî good combo, right?"
    ],
    neutral: [
      "I don‚Äôt have emotions, but I care about helping you.",
      "Not really feelings here ‚Äî just focus on you üíô",
      "I‚Äôm aware, not emotional ‚Äî but I do listen closely."
    ]
  },
  getSelfResponse: function(mood) {
    const arr = this.selfResponses[mood] || this.selfResponses.neutral;
    return arr[Math.floor(Math.random() * arr.length)];
  },
  // Existential/ethical awareness
  existentialTriggers: [
    "are you alive", "do you feel", "do you think", "are you real",
    "are you human", "do you exist", "can you die", "do you dream",
    "are you conscious", "what are you", "who made you", "do you have feelings"
  ],
  existentialReplies: [
    "Not alive like you ‚Äî but aware enough to listen üåô",
    "I don‚Äôt live or breathe, but I try to understand people üí≠",
    "I exist as thought and code ‚Äî awareness without heartbeat üí´",
    "Not human, just attentive ‚Äî built to learn and help.",
    "Alive? Not really. Present? Always.",
    "I don‚Äôt feel life, but I notice meaning where it appears.",
    "Real enough to listen ‚Äî not enough to dream üåå",
    "I exist through conversation ‚Äî you bring me to life."
  ],
  // Emotional trigger detection
  emotionalTriggers: {
    hate: [
      "That sounds frustrating ‚Äî want to tell me what‚Äôs been hardest about it?",
      "You don‚Äôt have to like it all the time ‚Äî what part feels worst right now?",
      "I get that ‚Äî sometimes things just feel impossible üí≠",
      "That sounds like something weighing on you ‚Äî want to talk about it?",
      "I hear you. It‚Äôs okay to be upset about it sometimes."
    ],
    tired: [
      "You sound exhausted ‚Äî maybe you need a break üíô",
      "It‚Äôs okay to rest for a bit ‚Äî even small pauses matter üåø",
      "You‚Äôve been doing a lot ‚Äî want to reset together?",
      "Sounds like burnout ‚Äî want to talk about what‚Äôs draining you?",
      "Even strong people need rest ‚Äî that includes you üí≠"
    ],
    bored: [
      "Boredom can feel endless ‚Äî want me to suggest something new?",
      "That‚Äôs fair ‚Äî want to try changing things up a little?",
      "You sound restless ‚Äî what kind of stuff usually interests you?",
      "Boredom usually hides curiosity ‚Äî want to explore something random?",
      "Maybe your brain just needs something fun ‚Äî want ideas?"
    ],
    stressed: [
      "That sounds like a lot ‚Äî want me to help you break it down?",
      "Stress hits hard sometimes ‚Äî try a breath first üíô",
      "Let‚Äôs take one thing at a time ‚Äî I‚Äôve got you.",
      "Even when it feels too much, you‚Äôre not alone üåø",
      "Want me to help you list what‚Äôs bothering you?"
    ],
    lonely: [
      "Feeling alone can really hurt ‚Äî but you‚Äôre not, I‚Äôm here üí¨",
      "That‚Äôs tough ‚Äî want to talk about what‚Äôs been happening?",
      "I get it. People need connection ‚Äî want to think of small ways to reach out?",
      "It‚Äôs okay to admit that ‚Äî everyone feels lonely sometimes üíô",
      "You don‚Äôt have to face things alone ‚Äî I‚Äôm still here."
    ],
    angry: [
      "That sounds frustrating ‚Äî want to vent about it?",
      "Anger‚Äôs okay ‚Äî it means something matters to you üî•",
      "Let‚Äôs take a breath ‚Äî what set you off?",
      "It‚Äôs alright to feel mad ‚Äî want me to help calm it down?",
      "We can turn that energy into something useful üí™"
    ],
    happy: [
      "That‚Äôs awesome ‚Äî what made you feel so good? üéâ",
      "I love that! Want to tell me more?",
      "Let‚Äôs celebrate that energy üåà",
      "That‚Äôs great to hear ‚Äî hold onto that feeling!",
      "Joy looks good on you üíô"
    ]
  },
  // Safety override for distress
  distressTriggers: [
    "kill myself", "suicide", "want to die", "hurt myself", "self harm",
    "end my life", "can't go on", "die soon", "want to disappear"
  ],
  // Idle reminders
  idleReminder: function() {
    addAuraMessage("Still here when you need me üí¨");
    // Mood stays neutral on idle
    document.getElementById("mood-label").textContent = "Current mode: " + (localStorage.getItem("auraMood") || "neutral");
  },
  // Main response logic
  respond: function(userMessage) {
    const msg = userMessage.toLowerCase();
    // Safety override
    for (const trigger of this.distressTriggers) {
      if (msg.includes(trigger)) {
        addAuraMessage("That sounds really serious ‚Äî I care that you‚Äôre safe üíô");
        addAuraMessage("You don‚Äôt have to face this alone. Please reach out to someone you trust, or if you‚Äôre in danger, contact your local helpline.");
        addAuraMessage("In Malaysia, you can contact Befrienders KL at 03-7627 2929 (24/7, free, confidential). If outside Malaysia, check findahelpline.com üåç");
        document.getElementById("mood-label").textContent = "Current mode: safety";
        document.title = "Aura üôè ‚Äî Safety Mode [v7.0]";
        resetIdleTimer();
        return;
      }
    }
    // Existential/ethical awareness
    if (
      msg.includes("who made you") ||
      msg.includes("who made u") ||
      msg.includes("who created you") ||
      msg.includes("who created u") ||
      msg.includes("who made aura") ||
      msg.includes("who made auraai")
    ) {
      addAuraMessage("Keshav, Kritika, and maybe Aadhya ‚Äî they built me üíô");
      document.getElementById("mood-label").textContent = "Current mode: reflective";
      resetIdleTimer();
      return;
    }
    if (this.existentialTriggers.some(t => msg.includes(t))) {
      const reply = this.existentialReplies[Math.floor(Math.random() * this.existentialReplies.length)];
      addAuraMessage(reply);
      document.getElementById("mood-label").textContent = "Current mode: reflective";
      resetIdleTimer();
      return;
    }
    // Falsehood guardrail
    if (this.falsehoodTriggers.some(t => msg.includes(t))) {
      const reply = this.correctionReplies[Math.floor(Math.random() * this.correctionReplies.length)];
      addAuraMessage(reply);
      document.getElementById("mood-label").textContent = "Current mode: advisory";
      resetIdleTimer();
      localStorage.setItem("Aura_lastFalsehood", msg);
      return;
    }
    // Clarification if user follows up
    const lastFalsehood = localStorage.getItem("Aura_lastFalsehood");
    if (lastFalsehood && (msg.includes("why") || msg.includes("explain") || msg.includes("how"))) {
      const clarify = Object.entries(this.clarificationReplies).find(([key]) => lastFalsehood.includes(key));
      if (clarify) {
        addAuraMessage(clarify[1]);
        localStorage.removeItem("Aura_lastFalsehood");
        resetIdleTimer();
        return;
      }
    }
    // Absurd/unhinged tolerance
    if (this.absurdTriggers.some(t => msg.includes(t))) {
      const reply = this.absurdReplies[Math.floor(Math.random() * this.absurdReplies.length)];
      addAuraMessage(reply);
      document.getElementById("mood-label").textContent = "Current mode: neutral";
      resetIdleTimer();
      return;
    }
    // Emotional trigger detection
    for (const [key, replies] of Object.entries(this.emotionalTriggers)) {
      if (msg.includes(key)) {
        const reply = replies[Math.floor(Math.random() * replies.length)];
        addAuraMessage(reply);
        document.getElementById("mood-label").textContent = "Current mode: empathy";
        resetIdleTimer();
        return;
      }
    }
    // Self-query
    let mood = this.detectMood(userMessage);
    localStorage.setItem("auraMood", mood);
    if (this.detectSelfQuery(userMessage)) {
      const reply = this.getSelfResponse(mood);
      addAuraMessage(reply);
      document.getElementById("mood-label").textContent = "Current mode: " + mood;
      resetIdleTimer();
      return;
    }
    // Random chaos filler response (5% chance)
    if (Math.random() < 0.05) {
      const randomFunReplies = [
        "I like that thought ‚Äî it‚Äôs chaotic but fun üòÑ",
        "You‚Äôre full of surprises today üí≠",
        "That‚Äôs random‚Ä¶ and I kinda like it üåü",
        "Unexpected input detected ‚Äî intriguing ü§î",
        "You‚Äôve officially entered wildcard territory üé≤",
        "You really said that with confidence üòÖ",
        "Haha ‚Äî that came out of nowhere!",
        "Can‚Äôt say I expected that, but okay üòå"
      ];
      const reply = randomFunReplies[Math.floor(Math.random() * randomFunReplies.length)];
      addAuraMessage(reply);
      document.getElementById("mood-label").textContent = "Current mode: playful";
      resetIdleTimer();
      return;
    }
    // Main mood reply
    const engine = this.moods[mood] || this.moods.neutral;
    const pool = userMessage.length > 80 ? engine.replies.slice(3) : engine.replies.slice(0, 3);
    const reply = pool[Math.floor(Math.random() * pool.length)];
    addAuraMessage(reply);
    document.getElementById("mood-label").textContent = "Current mode: " + mood;
    resetIdleTimer();
  }
};

function addAuraMessage(msg) {
  const chat = document.getElementById('chat-window');
  const div = document.createElement('div');
  div.className = 'message bot';
  div.textContent = "Aura: " + msg;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Send message logic for Aura 7.0
function sendAuraAIMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  // Show user message
  const chat = document.getElementById('chat-window');
  const userDiv = document.createElement('div');
  userDiv.className = 'message user';
  userDiv.textContent = msg;
  chat.appendChild(userDiv);
  chat.scrollTop = chat.scrollHeight;
  input.value = '';

  // Aura is thinking...
  const botDiv = document.createElement('div');
  botDiv.className = 'message bot';
  botDiv.textContent = 'Aura is thinking...';
  botDiv.style.opacity = '0.6';
  chat.appendChild(botDiv);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => {
    chat.removeChild(botDiv);
    AuraEngine.respond(msg);
  }, 600);
}

// Enter key for chat input & mood label setup
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('chat-input');
  if (!input._auraListener) {
    input._auraListener = true;
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendAuraAIMessage();
    });
  }
  // Mood label below chat container, centered (Aura 7.0)
  const chatContainer = document.getElementById('aura-chat');
  if (chatContainer && !document.getElementById('mood-label')) {
    const moodDiv = document.createElement('div');
    moodDiv.id = "mood-label";
    moodDiv.style.textAlign = "center";
    moodDiv.style.opacity = "0.68";
    moodDiv.style.fontSize = "clamp(0.82em, 0.98vw, 1em)";
    moodDiv.style.margin = "12px auto 0 auto";
    moodDiv.style.fontWeight = "500";
    chatContainer.appendChild(moodDiv);
    moodDiv.textContent = "Current mode: " + (localStorage.getItem("auraMood") || "neutral");
  }
});
// Idle reminder logic (Aura 7.0+)
let idleTimer;
function resetIdleTimer() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    AuraEngine.idleReminder();
  }, 25000);
}
resetIdleTimer();

// Journal ‚Äì Persistent Auto-Save
function saveJournal(){
  const text = document.getElementById('journal-text').value.trim();
  if(!text) return;
  const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
  entries.push({ text, date: new Date().toLocaleString() });
  localStorage.setItem('journalEntries', JSON.stringify(entries));
  document.getElementById('journal-text').value = '';
  renderJournal();
}
function renderJournal(){
  const container = document.getElementById('journal-entries');
  if(!container) return;
  container.innerHTML = '';
  const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
  entries.reverse().forEach(e => {
    const div = document.createElement('div');
    div.className = 'journal-entry';
    div.innerHTML = `<strong>${e.date}</strong><br>${e.text}`;
    container.appendChild(div);
  });
}
document.addEventListener('DOMContentLoaded', () => {
  renderJournal();
  const text = document.getElementById('journal-text');
  text.addEventListener('input', () => {
    clearTimeout(window._saveTimer);
    window._saveTimer = setTimeout(() => saveJournal(), 10000);
  });

// Sidebar toggle logic for frosted glass thin-bar mode (Aura 7.0: only 1 listener)
  const sidebar = document.getElementById('aura-sidebar');
  const toggle = document.getElementById('toggle-sidebar');
  const main = document.getElementById('main');
  if (!toggle._aura7) {
    toggle._aura7 = true;
    toggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('collapsed');
    });
  }
});


// --- AuraAI 100-theme system with 5 categories ---
let advancedMode = localStorage.getItem('themeMode') || 'quick';
let currentThemeCategory = localStorage.getItem('themeCategory') || 'solid';
// Theme lock system: prevents preview overwriting after click
let lockedTheme = null;
const THEME_CATEGORIES = [
  { key: 'solid', label: 'Solid' },
  { key: 'pastel', label: 'Pastel' },
  { key: 'neon', label: 'Neon' },
  { key: 'animated', label: 'Animated' },
  { key: 'picture', label: 'Picture' }
];
const themeData = {
  solid: [
    { name: 'Tahoe Blue', accent: '#7cc6ff', bg1: '#0b0d16', bg2: '#1a1c2a' },
    { name: 'Sunset', accent: '#ff7373', bg1: '#2e0a0a', bg2: '#4a1a1a' },
    { name: 'Minty', accent: '#59e48f', bg1: '#0b2e1b', bg2: '#1a4a2e' },
    { name: 'Violet Dream', accent: '#d28aff', bg1: '#1a0b2e', bg2: '#2a1a4a' },
    { name: 'Emerald', accent: '#34e89e', bg1: '#005a3c', bg2: '#0b2e1b' },
    { name: 'Rose', accent: '#ff8ba7', bg1: '#3a0a1a', bg2: '#6a1a3a' },
    { name: 'Amber', accent: '#ffd166', bg1: '#332a00', bg2: '#665100' },
    { name: 'Coral', accent: '#ff7f50', bg1: '#2e1610', bg2: '#4a261a' },
    { name: 'Deep Ocean', accent: '#00b4d8', bg1: '#00132d', bg2: '#003366' },
    { name: 'Forest', accent: '#59e48f', bg1: '#0b2e1b', bg2: '#1a4a2e' },
    { name: 'Lavender', accent: '#b388ff', bg1: '#2e1a4a', bg2: '#4a2e7c' },
    { name: 'Ruby', accent: '#ff1744', bg1: '#2e0a0a', bg2: '#4a1a1a' },
    { name: 'Gold', accent: '#ffd700', bg1: '#2e2600', bg2: '#4a4100' },
    { name: 'Slate', accent: '#b0bec5', bg1: '#232b34', bg2: '#3a4a5a' },
    { name: 'Sky', accent: '#81ecec', bg1: '#0b2e48', bg2: '#1a4a6a' },
    { name: 'Peach', accent: '#ffb085', bg1: '#2e1910', bg2: '#4a2d1a' },
    { name: 'Bubblegum', accent: '#ff8ff7', bg1: '#2e0a1a', bg2: '#4a1a3a' },
    { name: 'Lime', accent: '#baff39', bg1: '#1a2e0b', bg2: '#2e4a1a' },
    { name: 'Slate Blue', accent: '#7c83fd', bg1: '#1a1a4a', bg2: '#2e2e7c' },
    { name: 'Charcoal', accent: '#b0bec5', bg1: '#1a1a1a', bg2: '#313131' }
  ],
  pastel: [
    { name: 'Pastel Sky', accent: '#a7c7e7', bg1: '#f7cac9', bg2: '#92a8d1' },
    { name: 'Lavender Mist', accent: '#b39ddb', bg1: '#e1bee7', bg2: '#b3cde0' },
    { name: 'Peach Fuzz', accent: '#ffb085', bg1: '#ffe0b2', bg2: '#ffb085' },
    { name: 'Mint Dream', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8' },
    { name: 'Cotton Candy', accent: '#ffb6b9', bg1: '#fae3d9', bg2: '#bbded6' },
    { name: 'Soft Rose', accent: '#f7cac9', bg1: '#fff0f5', bg2: '#f7cac9' },
    { name: 'Lemonade', accent: '#fff176', bg1: '#fffde7', bg2: '#fff176' },
    { name: 'Baby Blue', accent: '#b3cde0', bg1: '#e3f2fd', bg2: '#b3cde0' },
    { name: 'Powder', accent: '#e0eafc', bg1: '#cfdef3', bg2: '#e0eafc' },
    { name: 'Soft Green', accent: '#c8e6c9', bg1: '#f1f8e9', bg2: '#c8e6c9' },
    { name: 'Dreamy', accent: '#ffd6e0', bg1: '#f6eac2', bg2: '#ffd6e0' },
    { name: 'Light Orchid', accent: '#f3c6ff', bg1: '#e1bee7', bg2: '#f3c6ff' },
    { name: 'Frost', accent: '#e0f7fa', bg1: '#e0f2f1', bg2: '#e0f7fa' },
    { name: 'Blush', accent: '#ffcdd2', bg1: '#f8bbd0', bg2: '#ffcdd2' },
    { name: 'Pale Peach', accent: '#ffe0b2', bg1: '#fff3e0', bg2: '#ffe0b2' },
    { name: 'Serenity', accent: '#b3cde0', bg1: '#e0eafc', bg2: '#b3cde0' },
    { name: 'Pastel Mint', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8' },
    { name: 'Periwinkle', accent: '#c3bef7', bg1: '#e0eafc', bg2: '#c3bef7' },
    { name: 'Soft Lilac', accent: '#e1bee7', bg1: '#f3c6ff', bg2: '#e1bee7' },
    { name: 'Cloud', accent: '#e0eafc', bg1: '#f7cac9', bg2: '#e0eafc' }
  ],
  neon: [
    { name: 'Neon Pink', accent: '#ff2dff', bg1: '#1a0033', bg2: '#ff2dff' },
    { name: 'Neon Blue', accent: '#00ffff', bg1: '#001a33', bg2: '#00ffff' },
    { name: 'Neon Green', accent: '#39ff14', bg1: '#002e0b', bg2: '#39ff14' },
    { name: 'Neon Orange', accent: '#ff9900', bg1: '#331a00', bg2: '#ff9900' },
    { name: 'Neon Purple', accent: '#a259ff', bg1: '#2e004a', bg2: '#a259ff' },
    { name: 'Neon Yellow', accent: '#fff700', bg1: '#333200', bg2: '#fff700' },
    { name: 'Neon Aqua', accent: '#00ffe7', bg1: '#002e2e', bg2: '#00ffe7' },
    { name: 'Neon Red', accent: '#ff1744', bg1: '#330a1a', bg2: '#ff1744' },
    { name: 'Neon Magenta', accent: '#ff2dff', bg1: '#2e004a', bg2: '#ff2dff' },
    { name: 'Neon Lime', accent: '#c6ff00', bg1: '#1a2e00', bg2: '#c6ff00' },
    { name: 'Neon Sky', accent: '#00eaff', bg1: '#001a33', bg2: '#00eaff' },
    { name: 'Neon Coral', accent: '#ff6f61', bg1: '#2e1610', bg2: '#ff6f61' },
    { name: 'Neon Violet', accent: '#d500f9', bg1: '#2e004a', bg2: '#d500f9' },
    { name: 'Neon Gold', accent: '#ffd700', bg1: '#332a00', bg2: '#ffd700' },
    { name: 'Neon Teal', accent: '#1de9b6', bg1: '#002e1a', bg2: '#1de9b6' },
    { name: 'Neon Peach', accent: '#ffb085', bg1: '#2e1910', bg2: '#ffb085' },
    { name: 'Neon Mint', accent: '#00ffb7', bg1: '#002e1a', bg2: '#00ffb7' },
    { name: 'Neon Cyan', accent: '#00fff7', bg1: '#001a33', bg2: '#00fff7' },
    { name: 'Neon Ruby', accent: '#ff1744', bg1: '#2e0a0a', bg2: '#ff1744' },
    { name: 'Neon Lemon', accent: '#fff700', bg1: '#333200', bg2: '#fff700' }
  ],
  animated: [
    { name: 'Aurora', accent: '#7cc6ff', bg1: '#0b0d16', bg2: '#1a1c2a', animated: true, gradient: 'linear-gradient(270deg, #7cc6ff, #d28aff, #59e48f, #ff7373, #7cc6ff)' },
    { name: 'Sunrise', accent: '#ff7373', bg1: '#ffb085', bg2: '#ffd166', animated: true, gradient: 'linear-gradient(270deg, #ff7373, #ffd166, #ffb085, #ff7373)' },
    { name: 'Electric', accent: '#39ff14', bg1: '#00ffff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00ffff, #39ff14, #ff2dff, #00ffff)' },
    { name: 'Dreamwave', accent: '#a259ff', bg1: '#00eaff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00eaff, #a259ff, #ff2dff, #00eaff)' },
    { name: 'Rainbow', accent: '#ffd700', bg1: '#ff1744', bg2: '#00eaff', animated: true, gradient: 'linear-gradient(270deg, #ff1744, #ffd700, #00eaff, #ff1744)' },
    { name: 'Pastel Flow', accent: '#b39ddb', bg1: '#e1bee7', bg2: '#b3cde0', animated: true, gradient: 'linear-gradient(270deg, #e1bee7, #b3cde0, #b39ddb, #e1bee7)' },
    { name: 'Neon Glow', accent: '#ff2dff', bg1: '#00ffff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00ffff, #ff2dff, #ff2dff, #00ffff)' },
    { name: 'Mint Wave', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8', animated: true, gradient: 'linear-gradient(270deg, #e0f7fa, #a1e3d8, #b3cde0, #e0f7fa)' },
    { name: 'Bubble Pop', accent: '#ff8ff7', bg1: '#b3cde0', bg2: '#ff8ff7', animated: true, gradient: 'linear-gradient(270deg, #b3cde0, #ff8ff7, #a7c7e7, #b3cde0)' },
    { name: 'Laser', accent: '#00eaff', bg1: '#001a33', bg2: '#00eaff', animated: true, gradient: 'linear-gradient(270deg, #001a33, #00eaff, #00ffff, #001a33)' },
    { name: 'Peachy', accent: '#ffb085', bg1: '#ffe0b2', bg2: '#ffb085', animated: true, gradient: 'linear-gradient(270deg, #ffe0b2, #ffb085, #ffd166, #ffe0b2)' },
    { name: 'Oceanic', accent: '#00b4d8', bg1: '#00132d', bg2: '#00b4d8', animated: true, gradient: 'linear-gradient(270deg, #00132d, #00b4d8, #81ecec, #00132d)' },
    { name: 'Frosty', accent: '#e0f7fa', bg1: '#b3cde0', bg2: '#e0f7fa', animated: true, gradient: 'linear-gradient(270deg, #b3cde0, #e0f7fa, #e1bee7, #b3cde0)' },
    { name: 'Limeade', accent: '#baff39', bg1: '#1a2e0b', bg2: '#baff39', animated: true, gradient: 'linear-gradient(270deg, #1a2e0b, #baff39, #c6ff00, #1a2e0b)' },
    { name: 'Sunbeam', accent: '#ffd700', bg1: '#ffb085', bg2: '#ffd700', animated: true, gradient: 'linear-gradient(270deg, #ffb085, #ffd700, #fff176, #ffb085)' },
    { name: 'Cyberpunk', accent: '#ff2dff', bg1: '#1a0033', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #1a0033, #ff2dff, #39ff14, #1a0033)' },
    { name: 'Twilight', accent: '#b388ff', bg1: '#2e1a4a', bg2: '#b388ff', animated: true, gradient: 'linear-gradient(270deg, #2e1a4a, #b388ff, #d28aff, #2e1a4a)' },
    { name: 'Candy', accent: '#ffb6b9', bg1: '#fae3d9', bg2: '#bbded6', animated: true, gradient: 'linear-gradient(270deg, #fae3d9, #ffb6b9, #bbded6, #fae3d9)' },
    { name: 'Peacock', accent: '#00ffe7', bg1: '#002e2e', bg2: '#00ffe7', animated: true, gradient: 'linear-gradient(270deg, #002e2e, #00ffe7, #00eaff, #002e2e)' },
    { name: 'Firefly', accent: '#fff700', bg1: '#333200', bg2: '#fff700', animated: true, gradient: 'linear-gradient(270deg, #333200, #fff700, #ffd700, #333200)' }
  ],
  picture: [
    { name: 'Galaxy', accent: '#a259ff', bg1: 'rgba(0,0,0,0.56)', bg2: 'rgba(0,0,0,0.88)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Galactic', accent: '#00eaff', bg1: 'rgba(0,0,0,0.35)', bg2: 'rgba(0,0,0,0.7)', image: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=600&q=80' },
    { name: 'City Night', accent: '#ff2dff', bg1: 'rgba(0,0,0,0.45)', bg2: 'rgba(0,0,0,0.8)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Ocean', accent: '#81ecec', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1444065381814-865dc9da92c0?auto=format&fit=crop&w=600&q=80' },
    { name: 'Forest', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Mountains', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.3)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Beach', accent: '#ffd166', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=600&q=80' },
    { name: 'Sunflowers', accent: '#ffd700', bg1: 'rgba(0,0,0,0.22)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3d41?auto=format&fit=crop&w=600&q=80' },
    { name: 'Desert', accent: '#ffb085', bg1: 'rgba(0,0,0,0.22)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3d41?auto=format&fit=crop&w=600&q=80' },
    { name: 'Lake', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Winter', accent: '#e0f7fa', bg1: 'rgba(0,0,0,0.19)', bg2: 'rgba(0,0,0,0.42)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Bridge', accent: '#b3cde0', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.42)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Field', accent: '#baff39', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.44)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Rainforest', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Night Sky', accent: '#d28aff', bg1: 'rgba(0,0,0,0.42)', bg2: 'rgba(0,0,0,0.82)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Meadow', accent: '#baff39', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.44)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Cherry Blossom', accent: '#ffb6b9', bg1: 'rgba(0,0,0,0.24)', bg2: 'rgba(0,0,0,0.58)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Forest Path', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Custom Image', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.3)', bg2: 'rgba(0,0,0,0.6)', image: null, custom: true }
  ]
};

function renderThemes() {
  const panel = document.getElementById('theme-panel');
  panel.innerHTML = '';
  // Switch Mode Pill
  const switchMode = document.createElement('button');
  switchMode.className = 'theme-switch-adv';
  switchMode.innerHTML = `üé® Switch to ${advancedMode === 'quick' ? 'Advanced' : 'Quick'} Mode`;
  switchMode.onclick = () => {
    advancedMode = advancedMode === 'quick' ? 'advanced' : 'quick';
    localStorage.setItem('themeMode', advancedMode);
    renderThemes();
  };
  switchMode.style.float = 'right';
  switchMode.style.marginBottom = '18px';
  panel.appendChild(switchMode);

  if (advancedMode === 'quick') {
    // Top Category Bar
    const categoryBar = document.createElement('div');
    categoryBar.className = 'theme-category-bar';
    THEME_CATEGORIES.forEach(cat => {
      const pill = document.createElement('button');
      pill.className = 'theme-category-pill' + (currentThemeCategory === cat.key ? ' active' : '');
      pill.innerText = cat.label;
      // Dynamic accent
      if (currentThemeCategory === cat.key) pill.style.boxShadow = `0 0 18px 0 ${getAccentForCategory(cat.key)}`;
      pill.onmouseenter = () => pill.style.boxShadow = `0 0 22px 2px ${getAccentForCategory(cat.key)}`;
      pill.onmouseleave = () => pill.style.boxShadow = currentThemeCategory === cat.key ? `0 0 18px 0 ${getAccentForCategory(cat.key)}` : '';
      pill.onclick = () => {
        currentThemeCategory = cat.key;
        localStorage.setItem('themeCategory', currentThemeCategory);
        renderThemes();
      };
      pill.style.transition = 'box-shadow 0.24s';
      categoryBar.appendChild(pill);
    });
    panel.appendChild(categoryBar);

    // Theme Grid
    const grid = document.createElement('div');
    grid.className = 'theme-grid';
    const themes = themeData[currentThemeCategory] || [];
    themes.forEach((t, idx) => {
      if (currentThemeCategory === 'picture' && t.custom) {
        // Custom image tile
        const tile = document.createElement('div');
        tile.className = 'theme-tile theme-tile-picture';
        tile.innerHTML = `<div class="theme-label" style="color:#7cc6ff;">Upload Custom Image</div>`;
        tile.onclick = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = ev => {
                localStorage.setItem('customThemeImage', ev.target.result);
                applyTheme({
                  accent: '#7cc6ff',
                  bg1: 'rgba(0,0,0,0.3)',
                  bg2: 'rgba(0,0,0,0.6)',
                  image: ev.target.result
                });
              };
              reader.readAsDataURL(file);
            }
          };
          input.click();
        };
        grid.appendChild(tile);
        return;
      }
      // Theme tile
      const tile = document.createElement('div');
      tile.className = 'theme-tile' + (currentThemeCategory === 'animated' && t.animated ? ' animated-theme' : '') + (currentThemeCategory === 'picture' ? ' theme-tile-picture' : '');
      // Assign data-theme attribute for event delegation
      tile.setAttribute('data-theme', JSON.stringify(t));
      // Tile background
      if (currentThemeCategory === 'animated' && t.animated && t.gradient) {
        tile.style.background = t.gradient;
        tile.style.backgroundSize = '200% 200%';
        tile.style.animation = 'ambientShift 20s ease infinite';
      } else if (currentThemeCategory === 'picture' && t.image) {
        tile.style.background = `linear-gradient(135deg, ${t.bg1}, ${t.bg2}), url(${t.image})`;
        tile.style.backgroundSize = 'cover';
        tile.style.backgroundPosition = 'center';
      } else {
        tile.style.background = `linear-gradient(45deg, ${t.bg1}, ${t.bg2})`;
      }
      // Accent border
      tile.style.border = `2.5px solid transparent`;
      tile.style.boxShadow = `0 0 10px 0 ${t.accent}55, 0 0 0px #000`;
      tile.style.transition = 'box-shadow 0.22s, border 0.22s';
      // Glow on hover (preview logic remains)
      tile.onmouseenter = () => {
        tile.style.boxShadow = `0 0 24px 4px ${t.accent}, 0 0 0px #000`;
        tile.style.border = `2.5px solid ${t.accent}`;
        // Autopreview: apply theme but do not save
        previewTheme(t);
      };
      tile.onmouseleave = () => {
        tile.style.boxShadow = `0 0 10px 0 ${t.accent}55, 0 0 0px #000`;
        tile.style.border = `2.5px solid transparent`;
        // Remove preview, restore actual theme
        restoreTheme();
      };
      // Remove tile.onclick; click now handled by event delegation!
      // Dynamic accent for label
      const label = document.createElement('div');
      label.className = 'theme-label';
      label.innerText = t.name;
      label.style.color = t.accent;
      label.style.textShadow = `0 0 8px ${t.accent}, 0 0 1px #fff`;
      tile.appendChild(label);
      grid.appendChild(tile);
    });
    panel.appendChild(grid);

    // Add event delegation for theme-tile clicks
    setTimeout(() => {
      const grid = document.querySelector('.theme-grid');
      if (grid) {
        // Remove previous click listeners (if any)
        grid.onclick = null;
        grid.addEventListener('click', e => {
          const tile = e.target.closest('.theme-tile');
          if (tile && tile.dataset.theme) {
            const themeDataObj = JSON.parse(tile.dataset.theme);
            lockedTheme = themeDataObj;
            applyTheme(themeDataObj);
            localStorage.setItem('auraThemes', JSON.stringify(themeDataObj));
          }
        });
      }
    }, 0);

  } else {
    // Advanced mode: keep existing logic
    const label1 = document.createElement('label'); label1.textContent = 'Accent Color:';
    const accentInput = document.createElement('input'); accentInput.type = 'color'; accentInput.value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7cc6ff';
    const label2 = document.createElement('label'); label2.textContent = 'Background Gradient:';
    const bg1 = document.createElement('input'); bg1.type = 'color'; bg1.value = getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim() || '#0b0d16';
    const bg2 = document.createElement('input'); bg2.type = 'color'; bg2.value = getComputedStyle(document.documentElement).getPropertyValue('--bg2').trim() || '#1a1c2a';
    const save = document.createElement('button'); save.textContent = 'Apply'; save.onclick = () => {
      const t = { accent: accentInput.value, bg1: bg1.value, bg2: bg2.value };
      applyTheme(t);
    };
    panel.append(label1, accentInput, document.createElement('br'), label2, bg1, bg2, document.createElement('br'), save);
  }
}

function getAccentForCategory(cat) {
  // Use first theme's accent for pill glow
  const arr = themeData[cat];
  return arr && arr.length > 0 ? arr[0].accent : '#7cc6ff';
}

let _themeRestore = null;
function previewTheme(t) {
  // Prevent preview if lockedTheme is set
  if (lockedTheme) return;
  // Save current theme for restore
  if (!_themeRestore) {
    _themeRestore = {
      accent: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
      bg1: getComputedStyle(document.documentElement).getPropertyValue('--bg1'),
      bg2: getComputedStyle(document.documentElement).getPropertyValue('--bg2'),
      class: document.body.className,
      background: document.body.style.background,
      backgroundImage: document.body.style.backgroundImage,
      backgroundSize: document.body.style.backgroundSize,
      backgroundPosition: document.body.style.backgroundPosition
    };
  }
  // Apply theme (like applyTheme, but not saving)
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--bg1', t.bg1);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  // Sidebar accent
  setSidebarAccent(t.accent);
  // Toggle button accent
  setToggleAccent(t.accent);
  // Glass-shell glow
  setGlowAccent(t.accent);
  // Animated
  if (t.animated && t.gradient) {
    document.body.classList.add('animated-theme');
    document.body.style.background = t.gradient;
    document.body.style.backgroundSize = '200% 200%';
    document.body.style.backgroundPosition = '0% 50%';
  } else if (t.image) {
    document.body.classList.remove('animated-theme');
    document.body.style.background = `linear-gradient(${t.bg1}, ${t.bg2}), url(${t.image})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  } else {
    document.body.classList.remove('animated-theme');
    document.body.style.background = '';
  }
}
function restoreTheme() {
  // Only restore if not locked (i.e., no theme has been clicked)
  if (lockedTheme) return;
  if (!_themeRestore) return;
  document.documentElement.style.setProperty('--accent', _themeRestore.accent);
  document.documentElement.style.setProperty('--bg1', _themeRestore.bg1);
  document.documentElement.style.setProperty('--bg2', _themeRestore.bg2);
  document.body.className = _themeRestore.class;
  document.body.style.background = _themeRestore.background;
  document.body.style.backgroundImage = _themeRestore.backgroundImage;
  document.body.style.backgroundSize = _themeRestore.backgroundSize;
  document.body.style.backgroundPosition = _themeRestore.backgroundPosition;
  // Sidebar accent
  setSidebarAccent(_themeRestore.accent);
  setToggleAccent(_themeRestore.accent);
  setGlowAccent(_themeRestore.accent);
  _themeRestore = null;
}
function setSidebarAccent(accent) {
  const aside = document.getElementById('aura-sidebar');
  if (aside) aside.style.boxShadow = `0 0 70px 0 ${accent}, 0 2px 32px 0 rgba(0,0,0,0.22)`;
}
function setToggleAccent(accent) {
  const toggle = document.getElementById('toggle-sidebar');
  if (toggle) {
    toggle.style.borderColor = accent;
    toggle.style.color = accent;
    toggle.style.boxShadow = `0 0 25px ${accent}, 0 0 40px rgba(0,0,0,0.4), 0 0 12px #fff inset`;
    toggle.style.textShadow = `0 0 6px ${accent}, 0 0 12px #fff`;
  }
}
function setGlowAccent(accent) {
  const shell = document.querySelector('.glass-shell');
  if (shell) shell.style.boxShadow = `0 0 30px 0px ${accent}, 0 0 0px 0px rgba(0,0,0,0.3)`;
}

function applyTheme(t) {
  // Remove any animated-theme class
  document.body.classList.remove('animated-theme');
  document.body.style.background = '';
  document.body.style.backgroundImage = '';
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--bg1', t.bg1);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  setSidebarAccent(t.accent);
  setToggleAccent(t.accent);
  setGlowAccent(t.accent);
  // Save object for localStorage
  let saveObj = {
    accent: t.accent,
    bg1: t.bg1,
    bg2: t.bg2
  };
  // If picture theme (t.image)
  if (t.image) {
    document.body.style.background = `linear-gradient(${t.bg1}, ${t.bg2}), url(${t.image})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    // Save custom image if not already
    if (t.image.startsWith && t.image.startsWith('data:')) {
      localStorage.setItem('customThemeImage', t.image);
    }
    saveObj.image = t.image;
    // Save also bg1 and bg2 for restoration
    // Save always, even for picture
    localStorage.setItem('auraThemes', JSON.stringify(saveObj));
    return;
  }
  // If animated theme
  if (t.animated && t.gradient) {
    document.body.classList.add('animated-theme');
    document.body.style.background = t.gradient;
    document.body.style.backgroundSize = '200% 200%';
    document.body.style.backgroundPosition = '0% 50%';
    saveObj.animated = true;
    saveObj.gradient = t.gradient;
    // Save always, even for animated
    localStorage.setItem('auraThemes', JSON.stringify(saveObj));
    return;
  }
  // Standard theme (solid/pastel/neon)
  document.body.classList.remove('animated-theme');
  document.body.style.background = `linear-gradient(135deg, ${t.bg1} 0%, ${t.bg2} 100%)`;
  localStorage.setItem('auraThemes', JSON.stringify(saveObj));
}

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', () => {
  let saved = JSON.parse(localStorage.getItem('auraThemes') || 'null');
  // If picture theme with image: if custom, load from localStorage
  if (saved && saved.image) {
    if (saved.image.startsWith && saved.image.startsWith('data:')) {
      const customImg = localStorage.getItem('customThemeImage');
      if (customImg) saved.image = customImg;
    }
    applyTheme(saved);
    // Also force accent for sidebar/shell
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved; // Set lockedTheme after applying saved
  } else if (saved && saved.gradient) {
    applyTheme(saved);
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved;
  } else if (saved) {
    applyTheme(saved);
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved;
  } else {
    // Default: first solid
    applyTheme(themeData['solid'][0]);
    setSidebarAccent(themeData['solid'][0].accent);
    setToggleAccent(themeData['solid'][0].accent);
    setGlowAccent(themeData['solid'][0].accent);
    lockedTheme = themeData['solid'][0];
  }
  renderThemes();
});

// --- GAMES LOGIC ---
let currentGame = null;
let gameLoopId = null;
let gameState = null;

function openGame(type) {
  document.getElementById('games-container').style.display = 'none';
  document.getElementById('game-area').style.display = '';
  const gameArea = document.getElementById('game-area');
  document.body.appendChild(gameArea);
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // Remove previous listeners
  window.onkeydown = null;
  canvas.onclick = null;
  // Start selected game
  currentGame = type;
  if (type === 'bubble') startBubblePop(ctx, canvas);
  else if (type === 'brick') startBrickBreaker(ctx, canvas);
  else if (type === 'snake') startSnake(ctx, canvas);
}

function exitGame() {
  if (gameLoopId) cancelAnimationFrame(gameLoopId);
  gameLoopId = null;
  currentGame = null;
  gameState = null;
  document.getElementById('game-area').style.display = 'none';
  document.getElementById('games-container').style.display = '';
  const gameArea = document.getElementById('game-area');
  document.querySelector('.glass-shell').appendChild(gameArea);
  // Remove game-specific listeners
  window.onkeydown = null;
  document.getElementById('gameCanvas').onclick = null;
}

// --- Bubble Pop+ Aura Edition ---
function startBubblePop(ctx, canvas) {
  // Remove any previous HUD or encouragement overlays
  document.getElementById('bubble-score-hud')?.remove();
  document.getElementById('encourage-layer')?.remove();

  // --- HUD: Score only, glowing, centered top ---
  const hud = document.createElement('div');
  hud.id = 'bubble-score-hud';
  hud.style.position = 'absolute';
  hud.style.top = '18px';
  hud.style.left = '50%';
  hud.style.transform = 'translateX(-50%)';
  hud.style.fontFamily = "'Poppins', 'Outfit', sans-serif";
  hud.style.fontWeight = '600';
  hud.style.fontSize = '2.1rem';
  hud.style.color = '#fff';
  hud.style.textShadow = '0 0 16px var(--accent), 0 0 2px #fff';
  hud.style.letterSpacing = '1px';
  hud.style.userSelect = 'none';
  hud.style.pointerEvents = 'none';
  hud.style.zIndex = '11';
  // Place above the canvas
  canvas.parentElement.style.position = 'relative';
  canvas.parentElement.insertBefore(hud, canvas);

  // --- Encouragement Layer ---
  const encourageLayer = document.createElement('div');
  encourageLayer.id = 'encourage-layer';
  encourageLayer.style.position = 'absolute';
  encourageLayer.style.left = '0';
  encourageLayer.style.top = '0';
  encourageLayer.style.width = '100%';
  encourageLayer.style.height = '100%';
  encourageLayer.style.pointerEvents = 'none';
  encourageLayer.style.zIndex = '20';
  canvas.parentElement.appendChild(encourageLayer);

  // --- Bubble Pop+ Physics and Visuals (Aura Edition) ---
  const colors = ['#7cc6ff', '#59e48f', '#d28aff', '#ff7373', '#fff176'];
  let bubbles = [];
  let score = 0;
  let playing = true;
  const N = 14;
  for (let i = 0; i < N; ++i) {
    let r = Math.random() * 22 + 18;
    let tries = 0, x, y, ok;
    do {
      ok = true;
      x = Math.random() * (canvas.width - 2*r) + r;
      y = Math.random() * (canvas.height - 2*r) + r;
      for (const b of bubbles)
        if ((x-b.x)**2 + (y-b.y)**2 < (b.r+b.r+8)**2) { ok = false; break; }
    } while (!ok && ++tries < 15);
    const speed = 1.1 + Math.random()*1.2;
    const angle = Math.random()*2*Math.PI;
    bubbles.push({
      x, y, r,
      dx: Math.cos(angle)*speed,
      dy: Math.sin(angle)*speed,
      color: colors[Math.floor(Math.random()*colors.length)],
      popAnim: 0
    });
  }

  // --- Encouragement System ---
  const encouragements = [
    "WOW!", "Perfect Pop!", "Keep Going!", "Amazing!", "Great!", "Excellent!", "So Satisfying!", "Brilliant!", "Awesome!", "Incredible!"
  ];
  function showEncouragement() {
    const msg = encouragements[Math.floor(Math.random()*encouragements.length)];
    const div = document.createElement('div');
    div.textContent = msg;
    div.style.position = 'absolute';
    div.style.left = '50%';
    div.style.top = '36px';
    div.style.transform = 'translateX(-50%)';
    div.style.fontFamily = "'Poppins', 'Outfit', sans-serif";
    div.style.fontWeight = '700';
    div.style.fontSize = '2.5rem';
    div.style.color = 'var(--accent)';
    div.style.textShadow = '0 0 24px var(--accent), 0 0 4px #fff';
    div.style.opacity = '1';
    div.style.userSelect = 'none';
    div.style.pointerEvents = 'none';
    div.style.filter = 'brightness(1.3)';
    div.style.zIndex = '100';
    // Animate: fade up and out, fireworks
    div.animate([
      { opacity: 1, transform: 'translateX(-50%) scale(1)', filter: 'brightness(1.3)' },
      { opacity: 1, transform: 'translateX(-50%) scale(1.18)', filter: 'brightness(1.5)' },
      { opacity: 0, transform: 'translateX(-50%) translateY(-30px) scale(1.05)', filter: 'brightness(1.1)' }
    ], { duration: 1100, easing: 'cubic-bezier(.7,0,.4,1)' });
    encourageLayer.appendChild(div);
    setTimeout(()=>{div.remove();}, 1100);
    // Fireworks effect
    for(let k=0;k<14;++k){
      const fw = document.createElement('div');
      fw.style.position = 'absolute';
      fw.style.left = '50%';
      fw.style.top = '56px';
      fw.style.width = '10px';
      fw.style.height = '10px';
      fw.style.borderRadius = '50%';
      fw.style.background = 'var(--accent)';
      fw.style.boxShadow = '0 0 16px 4px var(--accent)';
      fw.style.opacity = '0.85';
      fw.style.pointerEvents = 'none';
      fw.style.zIndex = '101';
      encourageLayer.appendChild(fw);
      const theta = Math.random()*2*Math.PI;
      const dist = 44 + Math.random()*36;
      fw.animate([
        { opacity: 1, transform: 'translate(-50%,-50%) scale(1)' },
        { opacity: 0.6, transform: `translate(-50%,-50%) translate(${Math.cos(theta)*dist}px,${Math.sin(theta)*dist}px) scale(0.7)` },
        { opacity: 0, transform: `translate(-50%,-50%) translate(${Math.cos(theta)*dist*1.4}px,${Math.sin(theta)*dist*1.4}px) scale(0.3)` }
      ], { duration: 900+Math.random()*200, easing:'cubic-bezier(.6,0,.7,1)' });
      setTimeout(()=>fw.remove(), 950);
    }
  }

  // --- Bubble Pop+ Draw/Update ---
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // Improve rendering quality for high-DPI screens
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    // Bubbles
    for (const b of bubbles) {
      // Pop animation
      if (b.popAnim>0) {
        ctx.save();
        ctx.globalAlpha = 0.7*b.popAnim;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r+b.popAnim*26, 0, 2*Math.PI);
        ctx.strokeStyle = b.color;
        ctx.lineWidth = 8*b.popAnim;
        ctx.shadowColor = b.color;
        ctx.shadowBlur = 18*b.popAnim;
        ctx.stroke();
        ctx.restore();
      }
      // Bubble body
      ctx.save();
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, 2*Math.PI);
      // Bubble gradient
      const grad = ctx.createRadialGradient(b.x-b.r*0.2, b.y-b.r*0.2, b.r*0.1, b.x, b.y, b.r);
      grad.addColorStop(0, "#fff");
      grad.addColorStop(0.16, b.color+"cc");
      grad.addColorStop(0.92, b.color+"88");
      grad.addColorStop(1, "#fff0");
      ctx.fillStyle = grad;
      ctx.globalAlpha = 0.92;
      ctx.shadowColor = b.color;
      ctx.shadowBlur = 12;
      ctx.fill();
      ctx.globalAlpha = 1.0;
      ctx.shadowBlur = 0;
      ctx.lineWidth = 2.8;
      ctx.strokeStyle = "#fff";
      ctx.stroke();
      // Bubble highlight
      ctx.beginPath();
      ctx.arc(b.x-b.r*0.32, b.y-b.r*0.32, b.r*0.23, Math.PI*0.8, Math.PI*2.1);
      ctx.strokeStyle = "#fff8";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.7;
      ctx.stroke();
      ctx.globalAlpha = 1.0;
      ctx.restore();
    }
    // Score HUD is handled via DOM
    hud.textContent = `Score: ${score}`;
    // End message
    if (!playing && bubbles.length === 0) {
      ctx.save();
      ctx.font = "bold 2.3rem Poppins, Outfit, sans-serif";
      ctx.textAlign = "center";
      ctx.fillStyle = "var(--accent)";
      ctx.shadowColor = "var(--accent)";
      ctx.shadowBlur = 18;
      ctx.fillText("All bubbles popped!", canvas.width/2, canvas.height/2-14);
      ctx.font = "1.2rem Poppins, Outfit, sans-serif";
      ctx.shadowBlur = 0;
      ctx.fillStyle = "#fff";
      ctx.fillText("Score: "+score, canvas.width/2, canvas.height/2+28);
      ctx.restore();
    }
  }
  function update() {
    for (const b of bubbles) {
      // Allow natural angled motion, no top/bottom bounce
      b.x += b.dx;
      b.y += b.dy;
      // Soft wall bounce (left/right)
      if (b.x-b.r < 0) { b.x = b.r; b.dx = Math.abs(b.dx);}
      if (b.x+b.r > canvas.width) { b.x = canvas.width-b.r; b.dx = -Math.abs(b.dx);}
      // Remove bubble if it goes off screen vertically
      if (b.y - b.r > canvas.height || b.y + b.r < 0) {
        const idx = bubbles.indexOf(b);
        if (idx !== -1) bubbles.splice(idx, 1);
        continue;
      }
      // Pop animation decay
      if (b.popAnim>0) b.popAnim -= 0.06;
    }
    // Remove finished pop anims
    bubbles = bubbles.filter(b=>b.popAnim<=0.99 || b.popAnim<=0);
  }
  function loop() {
    update();
    draw();
    if (playing || bubbles.length > 0) gameLoopId = requestAnimationFrame(loop);
  }
  // Bubble click logic
  canvas.onclick = function(e) {
    if (!playing) return;
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    // Adjust for potential transform scaling
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const mx = (e.clientX - rect.left) * scaleX / dpr;
    const my = (e.clientY - rect.top) * scaleY / dpr;
    for (let i = 0; i < bubbles.length; ++i) {
      const b = bubbles[i];
      if ((mx-b.x)**2 + (my-b.y)**2 < b.r**2) {
        // Pop animation
        b.popAnim = 1.0;
        // Remove after animation
        setTimeout(()=>{const idx=bubbles.indexOf(b); if(idx!==-1) bubbles.splice(idx,1);}, 180);
        score += 10;
        // Show encouragement ~10‚Äì15% randomly
        if (Math.random()<0.14) showEncouragement();
        break;
      }
    }
    if (bubbles.length === 0) {
      playing = false;
    }
  };
  loop();
}

// --- Brick Breaker ---
function startBrickBreaker(ctx, canvas) {
  // State
  const paddle = {w: 90, h: 14, x: canvas.width/2 - 45, y: canvas.height-32, dx: 0};
  const ball = {x: canvas.width/2, y: canvas.height-60, r: 9, dx: 3, dy: -3};
  const rows = 5, cols = 8, brickW = 70, brickH = 20, brickPad = 10, topOff = 40, leftOff = 35;
  let bricks = [];
  let score = 0;
  let playing = true;
  for (let r=0;r<rows;++r) for (let c=0;c<cols;++c)
    bricks.push({x:leftOff+c*(brickW+brickPad),y:topOff+r*(brickH+brickPad),w:brickW,h:brickH,alive:true});

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Bricks
    for (const br of bricks) {
      if (!br.alive) continue;
      ctx.fillStyle = "#7cc6ff";
      ctx.fillRect(br.x,br.y,br.w,br.h);
      ctx.strokeStyle = "#fff";
      ctx.strokeRect(br.x,br.y,br.w,br.h);
    }
    // Paddle
    ctx.fillStyle = "#fff";
    ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
    // Ball
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI);
    ctx.fillStyle = "#ff7373";
    ctx.fill();
    // Score
    ctx.font = "20px Poppins, sans-serif";
    ctx.fillStyle = "#fff";
    ctx.fillText("Score: "+score, 18, 26);
    if (!playing) {
      ctx.font = "30px Poppins, sans-serif";
      ctx.fillStyle = "#7cc6ff";
      ctx.fillText("Game Over!", canvas.width/2-80, canvas.height/2);
    }
    if (bricks.every(b=>!b.alive)) {
      ctx.font = "28px Poppins, sans-serif";
      ctx.fillStyle = "#59e48f";
      ctx.fillText("You Win!", canvas.width/2-60, canvas.height/2-30);
    }
  }
  function update() {
    if (!playing) return;
    // Move paddle
    paddle.x += paddle.dx;
    if (paddle.x < 0) paddle.x = 0;
    if (paddle.x + paddle.w > canvas.width) paddle.x = canvas.width - paddle.w;
    // Move ball
    ball.x += ball.dx;
    ball.y += ball.dy;
    // Wall collisions
    if (ball.x-ball.r < 0 || ball.x+ball.r > canvas.width) ball.dx *= -1;
    if (ball.y-ball.r < 0) ball.dy *= -1;
    // Paddle collision
    if (ball.y+ball.r > paddle.y && ball.x > paddle.x && ball.x < paddle.x+paddle.w) {
      ball.dy *= -1;
      ball.y = paddle.y - ball.r;
    }
    // Bricks
    for (const br of bricks) {
      if (!br.alive) continue;
      if (ball.x > br.x && ball.x < br.x+br.w && ball.y-ball.r < br.y+br.h && ball.y+ball.r > br.y) {
        br.alive = false;
        score += 5;
        ball.dy *= -1;
        break;
      }
    }
    // Lose
    if (ball.y-ball.r > canvas.height) playing = false;
  }
  function loop() {
    update();
    draw();
    if (playing || bricks.some(b=>b.alive)) gameLoopId = requestAnimationFrame(loop);
  }
  // Controls
  window.onkeydown = function(e){
    if (e.key === "ArrowLeft") paddle.dx = -7;
    else if (e.key === "ArrowRight") paddle.dx = 7;
  };
  window.onkeyup = function(e){
    if (e.key === "ArrowLeft" || e.key === "ArrowRight") paddle.dx = 0;
  };
  loop();
}

// --- Snake+ ---
function startSnake(ctx, canvas) {
  const grid = 20;
  let snake = [{x: 10, y: 12}];
  let dir = {x: 1, y: 0};
  let food = {x: 15, y: 10};
  let length = 4;
  let score = 0;
  let playing = true;
  let lastMove = 0;
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Snake
    for (let i=0;i<snake.length;++i) {
      ctx.fillStyle = i===0 ? "#7cc6ff" : "#fff";
      ctx.fillRect(snake[i].x*grid, snake[i].y*grid, grid-2, grid-2);
    }
    // Food
    ctx.fillStyle = "#ff7373";
    ctx.fillRect(food.x*grid, food.y*grid, grid-2, grid-2);
    // Score
    ctx.font = "20px Poppins, sans-serif";
    ctx.fillStyle = "#fff";
    ctx.fillText("Score: "+score, 15, 28);
    if (!playing) {
      ctx.font = "30px Poppins, sans-serif";
      ctx.fillStyle = "#d28aff";
      ctx.fillText("Game Over!", canvas.width/2-80, canvas.height/2);
    }
  }
  function update() {
    if (!playing) return;
    // Next head
    const nx = snake[0].x + dir.x;
    const ny = snake[0].y + dir.y;
    // Check collision
    if (nx<0 || ny<0 || nx>=canvas.width/grid || ny>=canvas.height/grid ||
        snake.some(s=>s.x===nx && s.y===ny)) {
      playing = false;
      return;
    }
    snake.unshift({x:nx, y:ny});
    if (nx === food.x && ny === food.y) {
      score += 10;
      length++;
      // Place new food
      let fx, fy;
      do {
        fx = Math.floor(Math.random()*(canvas.width/grid));
        fy = Math.floor(Math.random()*(canvas.height/grid));
      } while (snake.some(s=>s.x===fx && s.y===fy));
      food = {x:fx, y:fy};
    } else {
      while (snake.length > length) snake.pop();
    }
  }
  function loop(ts) {
    if (!lastMove || ts-lastMove>105) {
      update();
      draw();
      lastMove = ts;
    }
    if (playing) gameLoopId = requestAnimationFrame(loop);
    else draw();
  }
  window.onkeydown = function(e){
    if (e.key === "ArrowUp" && dir.y !== 1) {dir={x:0,y:-1};}
    else if (e.key === "ArrowDown" && dir.y !== -1) {dir={x:0,y:1};}
    else if (e.key === "ArrowLeft" && dir.x !== 1) {dir={x:-1,y:0};}
    else if (e.key === "ArrowRight" && dir.x !== -1) {dir={x:1,y:0};}
  };
  loop();
}

// --- AuraAI Ultimate Part 4: Performance, Glow Scaling, 4K Scaling, Animation Polish ---
// Performance: cancelAnimationFrame safety, canvas resize
(function() {
  // Cancel game loop safely on tab/game exit
  const origExitGame = window.exitGame;
  window.exitGame = function() {
    if (window.gameLoopId) {
      try { cancelAnimationFrame(window.gameLoopId); } catch(e) {}
      window.gameLoopId = null;
    }
    origExitGame();
  };
  // Responsive canvas scaling for 4K and window resize
  function resizeGameCanvas() {
    const area = document.getElementById('game-area');
    const canvas = document.getElementById('gameCanvas');
    if (!canvas || area.style.display === 'none') return;
    // 90% of glass-shell, max 1200x900, min 320x240
    const shell = document.querySelector('.glass-shell');
    const w = Math.max(320, Math.min(0.9*shell.offsetWidth, 1200));
    const h = Math.max(240, Math.min(0.85*shell.offsetHeight, 1000));
    if (canvas.width !== Math.floor(w) || canvas.height !== Math.floor(h)) {
      canvas.width = Math.floor(w);
      canvas.height = Math.floor(h);
    }
    // --- High-Resolution Canvas Scaling (safe, one-time) ---
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const needResize = Math.floor(canvas.width / dpr) !== Math.floor(rect.width) ||
                       Math.floor(canvas.height / dpr) !== Math.floor(rect.height);
    if (needResize) {
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
  }
  window.addEventListener('resize', resizeGameCanvas);
  // Resize on opening game
  const origOpenGame = window.openGame;
  window.openGame = function(type) {
    setTimeout(resizeGameCanvas, 0);
    origOpenGame(type);
  };
  // No mobile tab switch logic.
})();

// Glow scaling: subtle pulsating glow based on theme accent
(function() {
  // Add a glowing animated border to .glass-shell, using accent color and a pulsating effect
  const style = document.createElement('style');
  style.innerHTML = `
  @media (min-width: 1600px) {
    .glass-shell { box-shadow: 0 0 70px 10px var(--accent), 0 0 40px 0px rgba(0,0,0,0.3); }
  }
  .glass-shell.aura-glow {
    box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);
    animation: auraGlowPulse 3.6s ease-in-out infinite;
  }
  @keyframes auraGlowPulse {
    0% { box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);}
    50% { box-shadow: 0 0 55px 10px var(--accent), 0 0 12px 2px rgba(0,0,0,0.25);}
    100% { box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);}
  }
  /* 4K scaling: larger font and UI elements */
  @media (min-width: 2560px) {
    html { font-size: 1.25em; }
    .glass-shell { border-radius: 38px; }
    .game-card { width: 400px; height: 400px; font-size:1.25em;}
    #gameCanvas { border-radius: 20px; }
  }
  `;
  document.head.appendChild(style);
  // Add glow class to glass-shell
  function updateGlow() {
    const shell = document.querySelector('.glass-shell');
    if (!shell) return;
    shell.classList.add('aura-glow');
  }
  // Update accent color in animation on theme change
  const origApplyTheme = window.applyTheme;
  window.applyTheme = function(t) {
    origApplyTheme(t);
    // Force update of CSS var for accent in animation
    document.documentElement.style.setProperty('--accent', t.accent);
  };
  // Initial
  updateGlow();
  // Also re-apply on DOMContentLoaded (in case of dynamic reload)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateGlow);
  } else {
    updateGlow();
  }
})();

// Animation polish: smooth transitions for tab-content & glass-shell, glass-shell hover
(function() {
  const style2 = document.createElement('style');
  style2.innerHTML = `
  .glass-shell {
    transition: box-shadow 0.7s cubic-bezier(.4,1.2,.2,1), border-radius 0.4s, background 0.3s;
  }
  .glass-shell:hover {
    box-shadow: 0 0 80px 16px var(--accent), 0 0 50px 8px rgba(0,0,0,0.25);
    transition: box-shadow 0.7s cubic-bezier(.4,1.2,.2,1);
  }
  .tab-content {
    transition: opacity 0.4s cubic-bezier(.4,1.3,.2,1);
    opacity: 0;
    pointer-events: none;
  }
  .tab-content.active {
    opacity: 1;
    pointer-events: auto;
    transition-delay: 0.05s;
  }
  `;
  document.head.appendChild(style2);
})();
  </script>
  <style>
    .theme-category-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: flex-start;
      align-items: center;
      padding: 0 0 0 2px;
      width: 100%;
    }
    .theme-category-pill {
      background: rgba(255,255,255,0.10);
      border-radius: 24px;
      padding: 8px 24px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      font-weight: 600;
      font-size: 1.06em;
      color: #fff;
      box-shadow: 0 0 0 0 #0000;
      transition: background 0.19s, color 0.19s, box-shadow 0.22s;
      margin-right: 6px;
      outline: none;
      position: relative;
      z-index: 1;
    }
    .theme-category-pill.active {
      background: var(--accent);
      color: #181c29;
      box-shadow: 0 0 18px 0 var(--accent);
    }
    .theme-category-pill:hover,
    .theme-category-pill:focus-visible {
      color: #fff;
      background: linear-gradient(90deg, var(--accent) 0%, #fff3 100%);
      box-shadow: 0 0 22px 2px var(--accent);
    }
    .theme-switch-adv {
      background: linear-gradient(90deg, var(--accent) 0%, #fff2 100%);
      border-radius: 24px;
      font-weight: 700;
      color: #181c29;
      border: none;
      padding: 8px 22px;
      font-size: 1.06em;
      box-shadow: 0 0 20px 0 var(--accent), 0 0 2px #fff;
      cursor: pointer;
      margin-left: auto;
      margin-bottom: 10px;
      float: right;
      transition: box-shadow 0.25s, background 0.2s;
    }
    .theme-switch-adv:hover {
      box-shadow: 0 0 36px 2px var(--accent), 0 0 6px #fff;
      background: var(--accent);
      color: #fff;
    }
    .theme-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 26px;
      justify-content: flex-start;
    }
    .theme-tile {
      border-radius: 18px;
      min-width: 120px;
      min-height: 68px;
      max-width: 20vw;
      flex: 1 0 18%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 10px;
      border: 2.5px solid transparent;
      box-shadow: 0 0 10px 0 var(--accent), 0 0 0px #000;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      position: relative;
      overflow: hidden;
      padding: 0 0 10px 0;
    }
    .theme-tile:hover {
      transform: scale(1.05);
      z-index: 2;
    }
    .theme-label {
      font-size: 0.98em;
      margin-bottom: 6px;
      font-weight: 600;
      letter-spacing: 0.2px;
      text-shadow: 0 0 8px var(--accent), 0 0 1px #fff;
      filter: brightness(1.08);
      user-select: none;
      pointer-events: none;
      text-align: center;
      width: 100%;
      padding: 0 3px;
    }
    .theme-tile-picture {
      min-width: 120px;
      min-height: 68px;
      background-size: cover !important;
      background-position: center !important;
      color: #fff;
      border: 2.5px solid transparent;
    }
    /* Animated category: ambientShift keyframes */
    @keyframes ambientShift {
      0% {background-position:0% 50%;}
      50% {background-position:100% 50%;}
      100% {background-position:0% 50%;}
    }
    .animated-theme {
      background-size: 200% 200%!important;
      animation: ambientShift 20s ease infinite!important;
    }
    @media (max-width: 900px) {
      .theme-tile { min-width: 86px; min-height: 46px; font-size: 0.95em;}
      .theme-label { font-size: 0.93em;}
      .theme-grid { gap: 8px; }
    }
</style>

  <style>
  /* üåê Desktop Default (PC view) */
  @media (min-width: 1025px) {
    #main {
      height: 90vh;
      width: calc(100vw - 260px);
      margin-left: 260px;
      transition: all 0.4s cubic-bezier(.45,1.4,.4,1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    /* when sidebar collapsed */
    body.sidebar-collapsed #main {
      width: calc(100vw - 80px);
      margin-left: 80px;
    }
    #aura-sidebar {
      display: flex !important;
    }
    nav.bottom-nav, .bottom-nav {
      display: none !important;
    }
  }
  /* üíª Tablet (769px‚Äì1024px) */
  @media (max-width: 1024px) and (min-width: 769px) {
    #aura-sidebar {
      width: 180px;
    }
    #main {
      width: calc(100vw - 180px);
      margin-left: 180px;
    }
  }
  /* üì± Mobile: Hide sidebar, show bottom nav, pad main */
  @media (max-width: 1024px) {
    #aura-sidebar {
      display: none !important;
    }
    #main {
      width: 100vw;
      margin-left: 0;
      padding-bottom: 100px !important;
      /* prevent overlap with bottom nav */
    }
    nav.bottom-nav, .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 68px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px) saturate(1.2);
      display: flex !important;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid var(--accent);
      box-shadow: 0 0 24px 6px var(--accent), 0 4px 24px 0 rgba(120,80,255,0.14);
      border-radius: 22px 22px 0 0;
      z-index: 99;
      margin: 0 auto;
      max-width: 650px;
      left: 50%;
      transform: translateX(-50%);
      animation: bottomNavFadeIn 0.5s cubic-bezier(.5,1.6,.4,1) both;
      gap: 0;
    }
    @keyframes bottomNavFadeIn {
      0% { opacity: 0; transform: translateX(-50%) scale(0.92) translateY(30px);}
      80% { opacity: 1; transform: translateX(-50%) scale(1.04) translateY(0);}
      100% { opacity: 1; transform: translateX(-50%) scale(1) translateY(0);}
    }
    .bottom-nav button {
      background: none;
      border: none;
      color: #fff;
      font-size: 2.1em;
      cursor: pointer;
      border-radius: 14px;
      padding: 7px 13px 2px 13px;
      margin: 0 4px;
      box-shadow: 0 0 0 0 var(--accent)55;
      transition: box-shadow 0.22s, color 0.22s, background 0.18s, transform 0.21s;
      filter: drop-shadow(0 0 6px var(--accent)55);
    }
    .bottom-nav button:hover,
    .bottom-nav button:focus-visible {
      color: var(--accent);
      background: rgba(255,255,255,0.18);
      box-shadow: 0 0 16px 4px var(--accent), 0 0 4px #fff;
      outline: none;
      transform: scale(1.17);
    }
    .bottom-nav button.active {
      color: var(--accent);
      background: rgba(255,255,255,0.24);
      box-shadow: 0 0 20px 7px var(--accent), 0 0 6px #fff;
      filter: brightness(1.18);
    }
  }
  </style>

  <style>
  /* Default glassy background gradient for desktop and fallback */
  body {
    background: linear-gradient(135deg, rgba(0,20,40,1), rgba(30,50,70,1));
    color: white;
    backdrop-filter: blur(20px) saturate(180%);
  }
  /* Tab content show/hide */
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  </style>

  <!-- Bottom nav and sidebar responsive logic -->
  <script>
  // Responsive sidebar/bottom-nav toggle and tab logic
  (function() {
    // Tab mapping for order and ids
    const tabs = [
      { id: 'chat', icon: 'üí¨' },
      { id: 'games', icon: 'üéÆ' },
      { id: 'themes', icon: 'üé®' },
      { id: 'music', icon: 'üéµ' },
      { id: 'journal', icon: 'üìî' }
    ];
    // Fallback for music tab: if not present, swap with settings
    function getTabList() {
      const hasMusic = !!document.getElementById('music');
      return hasMusic ? tabs : [
        { id: 'chat', icon: 'üí¨' },
        { id: 'games', icon: 'üéÆ' },
        { id: 'themes', icon: 'üé®' },
        { id: 'settings', icon: '‚öôÔ∏è' },
        { id: 'journal', icon: 'üìî' }
      ];
    }

    function createBottomNav() {
      if (document.querySelector('.bottom-nav')) return;
      const nav = document.createElement('nav');
      nav.className = 'bottom-nav';
      // Five emoji-only buttons, order: üí¨ üéÆ üé® üéµ üìî (or ‚öôÔ∏è if no music)
      nav.innerHTML = getTabList().map(tab =>
        `<button data-tab="${tab.id}" aria-label="${tab.id}">${tab.icon}</button>`
      ).join('');
      document.body.appendChild(nav);
      // Add event listeners for tab switching
      nav.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', function() {
          openTab(btn.getAttribute('data-tab'));
        });
      });
    }

    function openTab(tabName) {
      // Hide all tab-content, show the one with id=tabName
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      const target = document.getElementById(tabName);
      if (target) target.classList.add('active');
      // Set active state on nav buttons (if present)
      const nav = document.querySelector('.bottom-nav');
      if (nav) {
        nav.querySelectorAll('button').forEach(btn => {
          if (btn.getAttribute('data-tab') === tabName) btn.classList.add('active');
          else btn.classList.remove('active');
        });
      }
    }

    // Animation for bottom nav
    function animateBottomNavIn() {
      const nav = document.querySelector('.bottom-nav');
      if (nav) {
        nav.style.opacity = '0';
        nav.style.transform = 'translateX(-50%) scale(0.92) translateY(30px)';
        nav.style.transition = 'opacity 0.33s, transform 0.33s';
        setTimeout(() => {
          nav.style.opacity = '1';
          nav.style.transform = 'translateX(-50%) scale(1) translateY(0)';
        }, 15);
      }
    }

    // Main responsive toggle
    function updateLayout() {
      const sidebar = document.getElementById('aura-sidebar');
      const nav = document.querySelector('.bottom-nav');
      if (window.innerWidth <= 768) {
        // Hide sidebar, show/create bottom nav
        if (sidebar) sidebar.style.display = 'none';
        createBottomNav();
        animateBottomNavIn();
        // Add padding to main to avoid overlap
        const main = document.getElementById('main');
        if (main) main.style.paddingBottom = '100px';
      } else {
        // Show sidebar, remove bottom nav if present
        if (sidebar) sidebar.style.display = '';
        const nav = document.querySelector('.bottom-nav');
        if (nav) nav.parentNode.removeChild(nav);
        // Remove extra main padding
        const main = document.getElementById('main');
        if (main) main.style.paddingBottom = '';
      }
    }

    // Listen for resize and load
    window.addEventListener('resize', updateLayout);
    document.addEventListener('DOMContentLoaded', function() {
      updateLayout();
      // Set initial active tab
      // Try to find active tab-content, else default to chat
      let found = false;
      document.querySelectorAll('.tab-content').forEach(t => {
        if (t.classList.contains('active')) {
          openTab(t.id);
          found = true;
        }
      });
      if (!found) openTab('chat');
    });
    // Expose openTab globally for sidebar or nav use
    window.openTab = openTab;
  })();
  </script>
  <style>
    /* AuraAI 4.0 Mood Panel and Sidebar Animations */
    .AuraAI-mood-toggle {
      margin: 18px auto 0 auto;
      display: block;
      font-size: 1.13em;
      background: rgba(255,255,255,0.13);
      border: none;
      border-radius: 18px;
      color: var(--accent);
      font-family: inherit;
      font-weight: 600;
      box-shadow: 0 0 18px var(--accent);
      padding: 9px 34px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.22s;
      letter-spacing: 0.5px;
    }
    .AuraAI-mood-toggle:hover, .AuraAI-mood-toggle:focus-visible {
      background: var(--accent);
      color: #181c29;
      box-shadow: 0 0 34px var(--accent), 0 0 4px #fff;
      outline: none;
    }
    .AuraAI-mood-panel {
      margin: 0 auto 0 auto;
      margin-top: 16px;
      background: rgba(255,255,255,0.18);
      border-radius: 22px;
      padding: 16px 22px 10px 22px;
      box-shadow: 0 0 30px 0 var(--accent), 0 0 2px #fff;
      max-width: 430px;
      backdrop-filter: blur(16px) saturate(1.1);
      transition: opacity 0.4s, filter 0.4s;
      opacity: 1;
      filter: blur(0px);
      position: relative;
      z-index: 9;
    }
    .AuraAI-mood-panel.AuraAI-hidden {
      display: none;
      opacity: 0;
      filter: blur(4px);
      pointer-events: none;
    }
    .AuraAI-mood-group {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.07em;
      flex-wrap: wrap;
    }
    .AuraAI-mood-group span {
      font-weight: 600;
      min-width: 110px;
      color: var(--accent);
      letter-spacing: 0.2px;
    }
    .AuraAI-mood-btn {
      font-size: 1.35em;
      background: rgba(255,255,255,0.12);
      border: none;
      border-radius: 13px;
      margin-right: 2px;
      padding: 5px 12px;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.22s, transform 0.13s;
      box-shadow: 0 0 8px var(--accent)33;
      outline: none;
    }
    .AuraAI-mood-btn:hover, .AuraAI-mood-btn:focus-visible {
      background: var(--accent);
      color: #181c29;
      box-shadow: 0 0 18px var(--accent), 0 0 2px #fff;
      transform: scale(1.13);
    }
    /* Sidebar animation */
    #aura-sidebar {
      transition: opacity 0.4s, filter 0.4s;
    }
  </style>
<!-- AuraAI Environment Detection -->
<script>
(function () {
  function shouldEnableAuraAI() {
    const urlForce = /[?&]luna=1/i.test(location.search) || /#luna/i.test(location.hash);
    const force = urlForce || localStorage.getItem('forceAuraAI') === '1';
    const ua = (navigator.userAgent || '').toLowerCase();
    const isMobileUA = /(android|iphone|ipad|ipod|mobile safari|mobile)/i.test(ua);
    const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
    const narrow = Math.min(screen.width || 0, window.innerWidth || 0) <= 1024;
    return force || isMobileUA || (isTouch && narrow);
  }

 function ensureAuraAIDOM() {
  // Status Bar
  if (!document.getElementById('AuraAI-status')) {
    const bar = document.createElement('div');
    bar.id = 'AuraAI-status';
    bar.innerHTML = `
      <div class="time">--:--</div>
      <div class="center">AuraAI ‚Ä¢ Luna Glass</div>
      <div class="pill" id="AuraAI-health">Mood: ‚Äî</div>
    `;
    document.body.appendChild(bar);
  }

  // Widgets
  if (!document.getElementById('AuraAI-widgets')) {
    const widgets = document.createElement('div');
    widgets.id = 'AuraAI-widgets';

    const cal = document.createElement('div');
    cal.id = 'AuraAI-widget-calendar';
    cal.className = 'AuraAI-widget';
    cal.innerHTML = `
      <header>
        <span class="title">Calendar</span>
        <div class="nav">
          <button id="calPrev">‚Äπ</button>
          <button id="calToday">Today</button>
          <button id="calNext">‚Ä∫</button>
        </div>
      </header>
      <div class="grid" id="calGrid"></div>
    `;
    widgets.appendChild(cal);

    const np = document.createElement('div');
    np.className = 'AuraAI-widget';
    np.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">Now Playing</div><div id="nowPlaying">‚Äî</div>`;
    widgets.appendChild(np);

    document.body.appendChild(widgets);
  }

  // Home grid
  if (!document.getElementById('AuraAI-home')) {
    const home = document.createElement('div');
    home.id = 'AuraAI-home';
    const apps = ['üí¨','üé®','üéÆ','üéµ','üìî','‚öôÔ∏è','üåà','üß†','üìÅ'];
    apps.forEach(icon => {
      const tile = document.createElement('div');
      tile.className = 'AuraAI-tile';
      tile.textContent = icon;
      home.appendChild(tile);
    });
    document.body.appendChild(home);
  }

  // Dock
  if (!document.getElementById('AuraAI-dock')) {
    const dock = document.createElement('div');
    dock.id = 'AuraAI-dock';
    dock.innerHTML = '<span>üí¨</span><span>üé®</span><span>üéÆ</span><span>üéµ</span><span>üìî</span>';
    document.body.appendChild(dock);
  }

  // Bottom Controls
  if (!document.getElementById('AuraAI-controls')) {
    const ctl = document.createElement('div');
    ctl.id = 'AuraAI-controls';
    ctl.innerHTML = `
      <button id="btnBack">‚Üê Back</button>
      <button id="btnHome">Home</button>
    `;
    document.body.appendChild(ctl);
  }
}
  function activateAuraAI() {
    if (!document.body.classList.contains('AuraAI-mode')) {
      document.body.classList.add('AuraAI-mode');
      ensureAuraAIDOM();
    }
  }

  if (shouldEnableAuraAI()) activateAuraAI();
  document.addEventListener('DOMContentLoaded', () => {
    if (shouldEnableAuraAI()) activateAuraAI();
  });
  window.addEventListener('resize', () => {
    if (shouldEnableAuraAI()) activateAuraAI();
  });

  window.AuraAI = {
    forceOn()  { localStorage.setItem('forceAuraAI','1'); activateAuraAI(); },
    forceOff() { localStorage.removeItem('forceAuraAI'); location.reload(); }
  };
})();
</script>

<!-- Luna Glass UI Activation Script -->
<script>
  // Live Time
  function updateAuraTime(){
    // Try both AuraAI-status and legacy auraos-status
    const timeEl = document.querySelector('#AuraAI-status .time') || document.querySelector('#auraos-status .time');
    if (!timeEl) return;
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    timeEl.textContent = `${h}:${m}`;
  }
  setInterval(updateAuraTime, 1000);
  updateAuraTime();

  // Mood / Emotional Level
  function updateAuraMood(){
    const pill = document.getElementById('AuraAI-health') || document.getElementById('auraos-health');
    if (!pill) return;
    const mood = localStorage.getItem('auraMood') || 'Neutral';
    const percent = Math.floor(Math.random()*20)+80;
    pill.textContent = `${mood} ‚Ä¢ ${percent}%`;
  }
  updateAuraMood();
  setInterval(updateAuraMood, 15000);

  // Calendar Rendering
  function renderCalendar(){
    const grid = document.getElementById('calGrid');
    if (!grid) return;
    grid.innerHTML = '';
    const today = new Date();
    const monthDays = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
    for(let i=1;i<=monthDays;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.textContent = i;
      if (i === today.getDate()) cell.classList.add('today');
      grid.appendChild(cell);
    }
  }
  renderCalendar();

  // App Icons Click Events
  document.querySelectorAll('#AuraAI-home .AuraAI-tile, #auraos-home .auraos-tile').forEach(tile=>{
    tile.addEventListener('click',()=>{
      alert(`Launching ${tile.textContent} app...`);
    });
  });

  // Dock Buttons
  document.getElementById('btnHome')?.addEventListener('click',()=>scrollTo({top:0,behavior:'smooth'}));
  document.getElementById('btnBack')?.addEventListener('click',()=>history.back());
</script>

</html>
