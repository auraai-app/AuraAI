<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Untitled Autism Project ‚Ä¢ Aura (Demo)</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg: #0e1116;
    --glass: rgba(255,255,255,0.12);
    --glass-2: rgba(255,255,255,0.08);
    --stroke: rgba(255,255,255,0.18);
    --text: #eef2f6;
    --muted: #b8c0cc;
    --accent: #7cc6ff;
    --accent-2: #a8a6ff;
    --good: #59e48f;
    --bad: #ff7373;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial;
    color:var(--text);
    background: radial-gradient(1200px 1200px at 10% -10%, #31405644, transparent 60%),
                radial-gradient(1000px 1000px at 90% -20%, #6245ff33, transparent 60%),
                linear-gradient(180deg, #0b0f14, var(--bg));
    backdrop-filter: blur(0.5px);
  }
  .shell{
    max-width:1200px; margin:32px auto; padding:24px;
    border-radius:28px; background: var(--glass);
    border:1px solid var(--stroke); box-shadow: 0 30px 80px #0007, inset 0 1px 0 #fff1;
    backdrop-filter: blur(16px) saturate(120%);
    position:relative;
    min-height:760px;
  }
  .clock{
    position:absolute; top:14px; right:18px; padding:8px 12px;
    border-radius:14px; background: var(--glass-2); border:1px solid var(--stroke);
    font-variant-numeric: tabular-nums; letter-spacing:0.5px; box-shadow: inset 0 1px 0 #fff2;
  }
  .tabs{display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; align-items:center}
  .tab{
    padding:10px 14px; border-radius:16px;
    background:linear-gradient(180deg, #ffffff14, #ffffff08);
    border:1px solid var(--stroke); color:var(--text);
    cursor:pointer; user-select:none; transition:.2s transform, .2s background;
    box-shadow: 0 6px 16px #0005, inset 0 1px 0 #fff1;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(180deg, var(--accent)22, var(--accent-2)18); border-color:var(--accent)88}

  .bar{display:flex; align-items:center; gap:10px; margin:10px 0 18px; flex-wrap:wrap;}
  .chip{padding:6px 10px; border-radius:12px; background:var(--glass-2); border:1px solid var(--stroke); cursor:pointer}
  .chip[aria-pressed="true"]{outline:2px solid var(--accent); background:#7cc6ff1f}

  .dock{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .dock .chip{display:flex; align-items:center; gap:6px}

  .panel{display:none}
  .panel.active{display:block}

  .chat-wrap{display:grid; grid-template-columns: 300px 1fr; gap:16px;}
  @media (max-width: 920px){ .chat-wrap{grid-template-columns:1fr} }
  .side-card, .main-card{ background: var(--glass-2); border:1px solid var(--stroke); border-radius:20px; padding:14px; box-shadow: inset 0 1px 0 #fff2, 0 10px 30px #0005;}
  .side-card h3{margin:6px 0 10px; font-size:14px; color:var(--muted); font-weight:600}
  .bubble-list{display:flex; gap:8px; flex-wrap:wrap}
  .bubble{padding:10px 12px; border-radius:999px; background:#ffffff10; border:1px solid var(--stroke); cursor:pointer;}
  .bubble[aria-pressed="true"]{outline:2px solid #ffffff55}

  .chat{ height:480px; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:8px; scroll-behavior:smooth;}
  .msg{ max-width:80%; padding:10px 14px; border-radius:18px; position:relative; background:linear-gradient(180deg, #ffffff14, #ffffff0a); border:1px solid var(--stroke); box-shadow: 0 8px 24px #0005, inset 0 1px 0 #fff2; animation: fadeIn .25s ease;}
  .msg.me{margin-left:auto; background:linear-gradient(180deg, var(--accent)22, var(--accent-2)12);}
  .composer{ display:flex; align-items:center; gap:8px; margin-top:10px}
  .input{ flex:1; padding:12px 14px; border-radius:14px; background:#ffffff10; color:var(--text); border:1px solid var(--stroke); outline:none; }

  .btn{ padding:10px 12px; border-radius:12px; background:linear-gradient(180deg, #ffffff20, #ffffff0d); border:1px solid var(--stroke); color:var(--text); cursor:pointer; user-select:none; }
  .btn.primary{background:linear-gradient(180deg, var(--accent)3a, var(--accent-2)2d); border-color:var(--accent)66}
  .btn.good{background:linear-gradient(180deg, #59e48f33, #59e48f1a); border-color:#59e48f77}
  .btn.bad{background:linear-gradient(180deg, #ff737333, #ff73731a); border-color:#ff737377}

  .draw-grid{display:grid; grid-template-columns: 360px 1fr; gap:16px}
  @media (max-width: 980px){ .draw-grid{grid-template-columns:1fr}}
  canvas.doodle{ width:100%; aspect-ratio: 4/3; background:#111a22; border-radius:18px; border:1px solid var(--stroke); box-shadow: inset 0 1px 0 #fff2, 0 10px 30px #0005; touch-action:none; cursor:crosshair;}
  .prompt-card{ padding:14px; border-radius:18px; background:var(--glass-2); border:1px solid var(--stroke) }

  .game-wrap{display:grid; grid-template-columns: 320px 1fr; gap:16px}
  @media (max-width: 980px){ .game-wrap{grid-template-columns:1fr}}
  .game-canvas{ width:100%; aspect-ratio: 16/9; background:#0a0f14; border-radius:18px; border:1px solid var(--stroke); box-shadow: inset 0 1px 0 #fff2, 0 10px 30px #0005;}
  .lvl{display:flex; gap:6px; flex-wrap:wrap}
  .badge{padding:6px 8px; border-radius:10px; background:#ffffff12; border:1px solid var(--stroke); font-size:12px}
  .meter{height:10px; border-radius:999px; background:#ffffff10; border:1px solid var(--stroke); overflow:hidden}
  .meter > span{display:block; height:100%; width:0%; background: linear-gradient(90deg, #59e48f, var(--accent))}

  .themes-wrap{display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:10px}
  .swatch{ padding:10px; border-radius:16px; border:1px solid var(--stroke); background:#ffffff12; cursor:pointer; position:relative; overflow:hidden; min-height:72px;}
  .swatch .tag{position:absolute; bottom:8px; left:8px; font-size:11px; color:#fff9; background:#0006; padding:4px 6px; border-radius:8px}
  .swatch:hover{outline:2px solid #fff4}
  .group-title{margin:14px 2px 8px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:11px}

  .has-tt{position:relative}
  .has-tt:hover::after{
    content: attr(data-tt);
    position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%);
    background:#0a0f14; color:#fff; padding:6px 8px; border-radius:10px; border:1px solid var(--stroke);
    white-space:nowrap; box-shadow: 0 10px 20px #0007; font-size:12px;
  }

  .splash{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(6,8,10,0.6), rgba(6,8,10,0.7)); z-index:2000;}
  .splash-card{ width:min(720px,94vw); border-radius:20px; padding:28px; text-align:center; background:var(--glass); border:1px solid var(--stroke); box-shadow:0 40px 120px #0009; }
  .splash h1{margin:4px 0 8px; font-size:36px; letter-spacing:1px}
  .splash p{color:var(--muted); margin:8px 0 18px}
  .splash .choices{display:flex; gap:12px; justify-content:center; flex-wrap:wrap}

  .muted{color:var(--muted)} .spacer{flex:1}
  .small{font-size:12px}
  .profile{display:flex; gap:8px; align-items:center}
  .profile input{padding:8px;border-radius:8px;background:#ffffff0f;border:1px solid var(--stroke);color:var(--text)}
  .journal-list{max-height:160px; overflow:auto; display:flex; flex-direction:column; gap:8px}
  .guest-list{max-height:140px; overflow:auto; display:flex; flex-direction:column; gap:6px}
  .tictac{display:grid; grid-template-columns:repeat(3,1fr); gap:6px; width:240px}
  .tictac button{aspect-ratio:1; border-radius:8px; font-size:28px; cursor:pointer; background:#ffffff10; border:1px solid var(--stroke)}
</style>
</head>
<body>
<div class="shell" id="app">
  <div class="clock" id="clock">--:--:--</div>

  <!-- Top Tabs -->
  <div class="tabs" role="tablist" aria-label="Main sections">
    <div class="tab active" data-tab="aura" role="tab" aria-selected="true">ü´ß Aura</div>
    <div class="tab" data-tab="draw" role="tab">üé® Draw</div>
    <div class="tab" data-tab="bubble" role="tab">ü´ß Bubble Pop</div>
    <div class="tab" data-tab="tictac" role="tab">‚úñÔ∏è Tic-Tac-Toe</div>
    <div class="spacer"></div>
    <button class="btn" id="musicBtn" title="Play / Pause">‚èØÔ∏è Music</button>
    <button class="btn" id="profileBtn" title="Profile">üë§ Profile</button>
    <button class="btn" id="themesBtn" title="Themes">üé® Themes</button>
  </div>

  <!-- AURA (MAIN) -->
  <div class="panel active" id="panel-aura" role="tabpanel" aria-labelledby="aura-tab">
    <div class="bar">
      <div class="dock" id="emotionDock">
        <!-- expanded moods -->
        <div class="chip" data-emote="happy">üòä Happy</div>
        <div class="chip" data-emote="calm">üòå Calm</div>
        <div class="chip" data-emote="sad">üò¢ Sad</div>
        <div class="chip" data-emote="angry">üò† Angry</div>
        <div class="chip" data-emote="nervous">üò∞ Nervous</div>
        <div class="chip" data-emote="bored">üòê Bored</div>
        <div class="chip" data-emote="excited">ü§© Excited</div>
        <div class="chip" data-emote="sleepy">üò¥ Sleepy</div>
        <div class="chip" data-emote="weird">üåÄ Weird</div>
      </div>
      <div class="spacer"></div>
      <div class="chip has-tt" id="openThemes" data-tt="Change the look">üé® Themes</div>
      <div class="chip has-tt" id="guestBtn" data-tt="Guestbook / Wall">üí¨ Wall</div>
    </div>

    <div class="chat-wrap">
      <div class="side-card">
        <h3>Quick switches</h3>
        <div class="bubble-list">
          <div class="bubble" data-say="How was your day?">How was your day?</div>
          <div class="bubble" data-say="Want a quick breathing idea?">Breathing idea</div>
          <div class="bubble" data-say="Pick an activity together?">Pick an activity</div>
        </div>
        <h3 style="margin-top:14px">Tools</h3>
        <div class="bubble-list">
          <div class="bubble" data-action="openDraw">Open Draw</div>
          <div class="bubble" data-action="openBubble">Play Bubble Pop</div>
          <div class="bubble" data-action="openTic">Play TicTacToe</div>
          <div class="bubble" data-action="sendHug">Virtual hug ü§ó</div>
        </div>

        <h3 style="margin-top:14px">Journal</h3>
        <div class="row">
          <textarea id="miniJournal" placeholder="One-line journal..." style="width:100%;border-radius:8px;padding:8px;background:#ffffff08;border:1px solid var(--stroke);color:var(--text)"></textarea>
        </div>
        <div style="height:8px"></div>
        <div class="row"><button class="btn" id="saveMiniJournal">Save</button><div class="spacer"></div><button class="btn" id="openJournal">Open Journal</button></div>

        <h3 style="margin-top:14px">Memory</h3>
        <div id="facts" class="hint small">No saved facts yet.</div>

      </div>

      <div class="main-card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="composer">
          <input id="input" class="input" placeholder="Type here‚Ä¶ (e.g., I feel nervous)"/>
          <button id="send" class="btn primary">Send</button>
          <button id="voiceUploadBtn" class="btn">üéô Upload Trusted Voice</button>
          <input type="file" id="voiceFile" accept="audio/*" style="display:none">
        </div>
      </div>
    </div>
  </div>

  <!-- DRAW -->
  <div class="panel" id="panel-draw" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="drawAsk" data-tt="Get a drawing idea">üß† New idea</div>
      <div class="chip has-tt" id="autoCheck" data-tt="Auto-check with AI" aria-pressed="true">‚úÖ Auto-Check</div>
      <div class="chip has-tt" id="freeMode" data-tt="Free drawing">‚úçÔ∏è Freestyle</div>
      <div class="spacer"></div>
      <div class="chip has-tt" id="clearCanvas" data-tt="Clear the canvas">üßº Clear</div>
      <div class="chip has-tt" id="undoDraw" data-tt="Undo last stroke">‚Ü©Ô∏è Undo</div>
      <div class="chip has-tt" id="redoDraw" data-tt="Redo">‚Ü™Ô∏è Redo</div>
    </div>
    <div class="draw-grid">
      <div class="prompt-card">
        <div class="row" style="margin-bottom:6px">
          <div class="hint" id="ideaText">Want to try drawing something? (OK / No / Later)</div>
        </div>
        <div class="row okno">
          <button class="btn good" id="okIdea">OK</button>
          <button class="btn bad" id="noIdea">No</button>
          <button class="btn" id="laterIdea">Later</button>
        </div>
        <div style="height:10px"></div>
        <div class="hint">After you draw, Aura can check if it looks right and cheer you on. üíô</div>
        <hr style="margin:10px 0;border:none;border-top:1px solid var(--stroke)">
        <h3 class="small">Saved Drawings</h3>
        <div id="gallery" class="hint small">No saved drawings yet.</div>
      </div>
      <div>
        <canvas id="doodle" class="doodle" width="800" height="600"></canvas>
        <div class="row" style="margin-top:10px">
          <span class="hint" id="checkMsg">Auto-Check is on.</span>
          <div class="spacer"></div>
          <button class="btn" id="savePNG">Save PNG</button>
          <button class="btn" id="sharePNG">Share (copy)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BUBBLE POP -->
  <div class="panel" id="panel-bubble" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="startGame" data-tt="Start / Restart">‚ñ∂Ô∏è Start</div>
      <div class="chip has-tt" id="pauseGame" data-tt="Pause / Resume">‚è∏Ô∏è Pause</div>
      <div class="chip has-tt" id="levelDown" data-tt="Previous level">‚¨ÖÔ∏è</div>
      <div class="chip has-tt" id="levelUp" data-tt="Next level">‚û°Ô∏è</div>
      <div class="spacer"></div>
      <div class="badge" id="levelBadge">Level 1 / 30</div>
      <div class="badge" id="scoreBadge">Score 0</div>
    </div>
    <div class="game-wrap">
      <div class="side-card">
        <h3>Goals</h3>
        <p class="hint" id="goalText">Pop 10 bubbles to pass.</p>
        <div class="meter" style="margin-top:8px"><span id="goalMeter"></span></div>
        <h3 style="margin-top:14px">Milestones</h3>
        <div class="lvl" id="milestones"></div>
        <h3 style="margin-top:14px">Encouragement</h3>
        <div id="encBox" class="hint">You‚Äôve got this! üéØ</div>
      </div>
      <canvas id="game" class="game-canvas" width="1280" height="720"></canvas>
    </div>
  </div>

  <!-- TIC-TAC-TOE -->
  <div class="panel" id="panel-tictac" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="ttStart">New Game</div>
      <div class="spacer"></div>
      <div class="chip" id="ttMode">Mode: Easy</div>
    </div>
    <div class="side-card" style="display:flex; gap:12px; flex-wrap:wrap;">
      <div>
        <h3>Board</h3>
        <div class="tictac" id="tboard"></div>
        <div style="height:8px"></div>
        <div>
          <button class="btn" id="ttReset">Reset</button>
        </div>
      </div>
      <div style="min-width:220px">
        <h3>Score</h3>
        <div class="hint" id="ttScore">You: 0 ‚Ä¢ Bot: 0</div>
        <h3 style="margin-top:12px">Tips</h3>
        <p class="hint small">Click a square to play. Bot uses random moves (easy). Can replace with minimax later.</p>
      </div>
    </div>
  </div>

  <!-- THEMES PANEL -->
  <div class="panel" id="panel-themes" role="tabpanel" style="display:none">
    <div class="bar"><div class="chip" id="backToAura">‚¨Ö Back</div><div class="spacer"></div><div class="hint">Hover a tile to see its color name ‚Ä¢ Click to apply</div></div>
    <div id="themesRoot"></div>
  </div>

  <!-- PROFILE / JOURNAL MODAL (simple inline panel replacement) -->
  <div class="panel" id="panel-profile" role="tabpanel" style="display:none">
    <div class="bar">
      <div class="chip" id="profileBack">‚¨Ö Back</div>
      <div class="spacer"></div>
      <div class="hint small">Manage local profile & data</div>
    </div>
    <div class="side-card">
      <h3>Profile</h3>
      <div class="profile">
        <input id="displayName" placeholder="Your name (local only)" />
        <button class="btn" id="saveProfile">Save</button>
      </div>
      <div style="height:10px"></div>
      <h3>Trusted Voice</h3>
      <div class="row">
        <div class="hint small" id="voiceLabel">No voice uploaded</div>
        <div class="spacer"></div>
        <button class="btn" id="playTrusted">Play</button>
        <button class="btn" id="removeTrusted">Remove</button>
      </div>
      <div style="height:12px"></div>
      <h3>Journal</h3>
      <div class="journal-list" id="journalList"></div>
      <div style="height:8px"></div>
      <textarea id="journalText" placeholder="Write a new journal entry..." style="width:100%;border-radius:8px;padding:8px;background:#ffffff08;border:1px solid var(--stroke);color:var(--text)"></textarea>
      <div style="height:8px"></div>
      <div class="row"><button class="btn" id="saveJournal">Save Entry</button><div class="spacer"></div><button class="btn" id="clearData">Clear All Local Data</button></div>

      <div style="height:14px"></div>
      <h3>Guestbook</h3>
      <div class="guest-list" id="guestList"></div>
      <div style="height:8px"></div>
      <input id="guestInput" placeholder="Leave a kind note (max 140 chars)" style="width:100%;padding:8px;border-radius:8px;background:#ffffff08;border:1px solid var(--stroke);color:var(--text)"/>
      <div style="height:8px"></div>
      <div class="row"><button class="btn" id="postGuest">Post</button><div class="spacer"></div><button class="btn" id="clearGuest">Clear Wall</button></div>

    </div>
  </div>

</div>

<!-- Splash overlay (one-time per load) -->
<div class="splash" id="splash" role="dialog" aria-modal="true" style="display:flex">
  <div class="splash-card glass">
    <h1 id="brandTitle">Aura</h1>
    <p>Hi ‚Äî what would you like to do right now?</p>
    <div class="choices">
      <button class="btn primary" id="splashPlay">Play</button>
      <button class="btn" id="splashDraw">Draw</button>
      <button class="btn" id="splashTalk">Talk</button>
    </div>
    <div style="height:12px"></div>
    <div class="hint">This shows only when the page loads or when you reload ‚Äî like a friendly lock screen.</div>
  </div>
</div>

<!-- TFJS + MobileNet (free CDNs) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<script>
/* =========================
   Utilities & Storage Helpers
========================= */
const LS = window.localStorage;
function saveUserProfile(profile){
  LS.setItem('aura_profile', JSON.stringify(profile));
}
function loadUserProfile(){ try{return JSON.parse(LS.getItem('aura_profile')||'{}');}catch(e){return {};} }
function saveDrawings(arr){ LS.setItem('aura_drawings', JSON.stringify(arr||[])); }
function loadDrawings(){ try{return JSON.parse(LS.getItem('aura_drawings')||'[]');}catch(e){return [];} }
function saveJournal(arr){ LS.setItem('aura_journal', JSON.stringify(arr||[])); }
function loadJournal(){ try{return JSON.parse(LS.getItem('aura_journal')||'[]');}catch(e){return [];} }
function saveGuest(arr){ LS.setItem('aura_guest', JSON.stringify(arr||[])); }
function loadGuest(){ try{return JSON.parse(LS.getItem('aura_guest')||'[]');}catch(e){return [];} }
function saveFacts(obj){ LS.setItem('aura_facts', JSON.stringify(obj||{})); }
function loadFacts(){ try{return JSON.parse(LS.getItem('aura_facts')||'{}');}catch(e){return {});} }

/* =========================
   Live Clock
========================= */
const clockEl = document.getElementById('clock');
function pad(n){return String(n).padStart(2,'0')}
function tickClock(){ const d=new Date(); clockEl.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
tickClock(); setInterval(tickClock,1000);

/* =========================
   Tabs
========================= */
const tabs = [...document.querySelectorAll('.tab')];
const panels = {
  aura: document.getElementById('panel-aura'),
  draw: document.getElementById('panel-draw'),
  bubble: document.getElementById('panel-bubble'),
  tictac: document.getElementById('panel-tictac'),
  themes: document.getElementById('panel-themes'),
  profile: document.getElementById('panel-profile'),
};
function showTab(name){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  Object.values(panels).forEach(p=>p.style.display='none');
  const el = panels[name];
  el.style.display='block';
  setTimeout(()=>el.classList && el.classList.add('active'),10);
  if(name==='bubble'){ prepareGameCanvas(); }
}
tabs.forEach(t=>t.addEventListener('click', ()=>showTab(t.dataset.tab)));
document.getElementById('themesBtn').addEventListener('click', ()=>showTab('themes'));
document.getElementById('musicBtn').addEventListener('click', ()=>{
  // simple mood->playlist open (fallback if no music playing)
  const mood = currentMood || 'happy';
  const url = PLAYLISTS[mood] || PLAYLISTS['happy'];
  window.open(url,'_blank');
});
document.getElementById('profileBtn').addEventListener('click', ()=>showTab('profile'));
document.getElementById('backToAura').addEventListener('click', ()=>showTab('aura'));
document.getElementById('profileBack').addEventListener('click', ()=>showTab('aura'));

/* =========================
   Theming (render + apply)
========================= */
const THEME_GROUPS = {
  'Gradient': [
    { name:'Aurora',bg:'#a8cdf1',grad:'#f7b7b9',text:'#0b3c61'},
    { name:'Sunset',bg:'#fdbb2d',grad:'#22c1c3',text:'#3c3c3c'},
    { name:'Forest',bg:'#43ac62',grad:'#6a9d77',text:'#f0f0f0'},
    { name:'Ocean',bg:'#005bea',grad:'#00c6fb',text:'#ffffff'},
    { name:'Neon',bg:'#39ff14',grad:'#00ffc8',text:'#3c3c3c'},
    { name:'Liquid Fire', animated:true, grad:'#ff416c, #ff4b2b, #ff8c00, #ff416c', text:'#ffffff' },
  ],
  'Pastel': [
    { name:'Pastel Dreams',bg:'#ffb3ba',grad:'#ffdfba',text:'#3c3c3c'},
    { name:'Seafoam',bg:'#b5e3d7',grad:'#aed9cb',text:'#3c3c3c'},
    { name:'Cotton Candy',bg:'#ffb6c1',grad:'#ffa07a',text:'#3c3c3c'},
  ],
  'Poster': [
    { name:'Midnight',bg:'#0a0a23',text:'#ffffff'},
    { name:'Azure',bg:'#007fff',text:'#ffffff'},
    { name:'Burnt Orange',bg:'#cc5500',text:'#ffffff'},
  ]
};
const themesRoot = document.getElementById('themesRoot');
function renderThemes(){
  themesRoot.innerHTML='';
  for(const [group, items] of Object.entries(THEME_GROUPS)){
    const title = document.createElement('div'); title.className='group-title'; title.textContent=group; themesRoot.appendChild(title);
    const grid = document.createElement('div'); grid.className='themes-wrap'; themesRoot.appendChild(grid);
    items.forEach(theme=>{
      const tile = document.createElement('div'); tile.className='swatch has-tt'; tile.dataset.tt = theme.name;
      if(theme.animated){ tile.style.background = `linear-gradient(120deg, ${theme.grad})`; tile.style.backgroundSize='300% 300%'; tile.animate([{backgroundPosition:'0% 50%'},{backgroundPosition:'100% 50%'},{backgroundPosition:'0% 50%'}],{duration:5000,iterations:Infinity}); }
      else if(theme.grad){ tile.style.background = `linear-gradient(135deg, ${theme.bg}, ${theme.grad})`; }
      else tile.style.background = theme.bg;
      tile.innerHTML = `<span class="tag">${theme.name}</span>`;
      tile.addEventListener('click', ()=>{ applyTheme(theme); saveUserProfile({...profile, theme:theme.name}); });
      grid.appendChild(tile);
    });
  }
}
renderThemes();
function applyTheme(t){
  document.documentElement.style.setProperty('--bg', t.bg || '#0e1116');
  document.documentElement.style.setProperty('--text', t.text || '#eef2f6');
  document.documentElement.style.setProperty('--accent', '#7cc6ff');
  document.documentElement.style.setProperty('--accent-2', '#a8a6ff');
  if(t.animated){ document.body.style.background = `linear-gradient(120deg, ${t.grad})`; document.body.style.backgroundSize = '300% 300%'; document.body.animate([{backgroundPosition:'0% 50%'},{backgroundPosition:'100% 50%'},{backgroundPosition:'0% 50%'}],{duration:9000,iterations:Infinity}); }
  else if(t.grad){ document.body.style.background = `linear-gradient(180deg, ${t.bg}, ${t.grad})`; }
  else { document.body.style.background = t.bg; }
}

/* =========================
   Playlists (mood -> URL)
========================= */
const PLAYLISTS = {
  happy: 'https://music.youtube.com/playlist?list=PLw-VjHDlEOgvx0lq1aM0fZ7q6X2bq0qkQ',
  calm: 'https://music.youtube.com/playlist?list=PL0w2XcQq8a7sX0lq3X',
  sad: 'https://music.youtube.com/playlist?list=PL0w2XcQq8a7sX0lq3Y',
  angry: 'https://music.youtube.com/playlist?list=PL0w2XcQq8a7sX0lq3Z',
  bored: 'https://www.youtube.com/watch?v=fIm-l0etZ28',
  excited: 'https://music.youtube.com/playlist?list=PL8fVUTBmJhHJzmd6q1',
  sleepy: 'https://music.youtube.com/playlist?list=PL0w2XcQq8a7sX0lq3S',
  weird: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
  default: 'https://music.youtube.com'
};

/* =========================
   Chatbot + Memory + Voice
========================= */
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const voiceFile = document.getElementById('voiceFile');
const voiceUploadBtn = document.getElementById('voiceUploadBtn');
const playTrustedBtn = document.getElementById('playTrusted');
const removeTrustedBtn = document.getElementById('removeTrusted');

let profile = loadUserProfile(); // {name, theme, trustedVoiceDataUrl}
let facts = loadFacts();
let currentMood = profile.lastMood || 'happy';

function addMsg(text, mine){
  const div = document.createElement('div');
  div.className = 'msg' + (mine?' me':'');
  div.innerHTML = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function botSay(text, opts = {}){
  addMsg(text,false);
  if(opts.voice && profile.trustedVoiceDataUrl){
    const a = new Audio(profile.trustedVoiceDataUrl);
    a.play().catch(()=>{/* ignore */});
  } else {
    // fallback: Web Speech API
    if(window.speechSynthesis && opts.tts !== false){
      const u = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
  }
}

function meSay(text){ addMsg(text,true); }

function extractFactsFromText(text){
  // naive "I like X" extractor (works for many demo lines)
  const m = text.match(/i (?:like|love|enjoy) ([a-z0-9 ]{1,40})/i);
  if(m){
    const val = m[1].trim();
    facts[val.toLowerCase()] = val;
    saveFacts(facts);
    renderFacts();
    botSay(`Noted ‚Äî you like ${val}. I‚Äôll remember that.`);
  }
}

// basic mood-aware responses
const emotionPrompts = {
  happy: ["Hi! üëã How was your day? üòä","Love hearing the good stuff. Want to celebrate a small win?","Pick an activity: Draw, Bubble Pop, or music?"],
  calm: ["Nice choice ‚Äî calm feels soft. Want a soothing playlist?","We can draw quietly or try a breathing exercise."],
  sad: ["I hear you. üíô Want a small comfort idea?","We can draw, breathe together, or pop bubbles‚Äîyour pick."],
  angry: ["That‚Äôs tough. I‚Äôm with you. Want a quick vent game?","Try 5 breaths with me."],
  nervous: ["It‚Äôs okay to be nervous. You‚Äôre safe here.","Try a 4-4-6 breathing with me."],
  bored: ["Bored huh? Try Bubble Pop or a new prompt to draw.","Wanna play a quick Tic-Tac-Toe?"],
  excited: ["Yesss energy! Want to celebrate with a high-score run?","Try some fast music and a quick game!"],
  sleepy: ["Sleepy time? A soft lullaby might help.","We can switch to night theme if you like."],
  weird: ["Weird is a vibe. Want something unusual?","I can surprise you."]
};

function respond(msg){
  const clean = msg.toLowerCase();
  extractFactsFromText(clean);
  if(/(happy|great|good|yay)/.test(clean)) botSay("That‚Äôs awesome! üéâ Want to pick an activity or keep chatting?");
  else if(/(sad|down|blue|cry|upset)/.test(clean)) botSay("I‚Äôm here. üíô Want a comfort idea or an activity together?");
  else if(/(angry|mad|frustrated|annoyed)/.test(clean)) botSay("Makes sense. Want to pop bubbles to vent or try a calming breath?");
  else if(/(nervous|anxious|worry|scared)/.test(clean)) botSay("Thanks for sharing. Try a 4-4-6 breath with me, or we can draw gently.");
  else if(/(draw|sketch|paint)/.test(clean)){ botSay("Opening Draw for you. ‚ú®",{voice:true}); showTab('draw'); }
  else if(/(bubble|game|play)/.test(clean)){ botSay("Let‚Äôs play Bubble Pop! ü´ß"); showTab('bubble'); }
  else if(/(tic|tac|toe|tic tac)/.test(clean)){ botSay("Tic-Tac-Toe ready. Good luck!"); showTab('tictac'); }
  else if(/(hug)/.test(clean)){ botSay("Sending a big gentle hug ü§ó You‚Äôre cared for.",{voice:true}); }
  else if(/(aura)/.test(clean)){ botSay("Shh‚Ä¶ codename detected üëÄ"); }
  else botSay("Got it. Tell me more, or choose an activity: Draw ‚Ä¢ Bubble Pop ‚Ä¢ Music.");
}

sendBtn.addEventListener('click', ()=>{
  const v = input.value.trim(); if(!v) return;
  meSay(v); respond(v); input.value='';
});
input.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

// emotion buttons
const emotionDock = document.getElementById('emotionDock');
emotionDock.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    emotionDock.querySelectorAll('.chip').forEach(x=>x.setAttribute('aria-pressed','false'));
    ch.setAttribute('aria-pressed','true');
    const em = ch.dataset.emote;
    currentMood = em;
    profile.lastMood = em; saveUserProfile(profile);
    (emotionPrompts[em]||["I see."]).forEach(t=>botSay(t));
    // theme mapping quick
    if(em==='sleepy') applyTheme({bg:'#0b0f14',grad:'#1c1c2f',text:'#fff',animated:false});
    if(em==='calm') applyTheme({bg:'#dff3ee',grad:'#bfe8d9',text:'#0b3c61'});
    if(em==='weird') applyTheme({bg:'#201020',grad:'#5b2e8c',text:'#fff'});
  });
});

// quick bubbles
document.querySelectorAll('.bubble').forEach(b=>{
  const say = b.dataset.say; const act = b.dataset.action;
  b.addEventListener('click', ()=>{
    if(say){ meSay(say); respond(say); }
    if(act==='openDraw'){ showTab('draw'); }
    if(act==='openBubble'){ showTab('bubble'); }
    if(act==='openTic'){ showTab('tictac'); }
    if(act==='sendHug'){ botSay("ü§ó A warm hug, just for you.", {voice:true}); }
  });
});

// Trusted voice upload/play
const voiceLabel = document.getElementById('voiceLabel');
voiceUploadBtn.addEventListener('click', ()=>voiceFile.click());
voiceFile.addEventListener('change', async(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{ profile.trustedVoiceDataUrl = r.result; saveUserProfile(profile); voiceLabel.textContent = 'Trusted voice uploaded'; };
  r.readAsDataURL(file);
});
playTrustedBtn.addEventListener('click', ()=>{
  if(profile.trustedVoiceDataUrl){ const a = new Audio(profile.trustedVoiceDataUrl); a.play(); }
  else alert('No trusted voice uploaded yet.');
});
removeTrustedBtn.addEventListener('click', ()=>{ delete profile.trustedVoiceDataUrl; saveUserProfile(profile); voiceLabel.textContent='No voice uploaded'; });

/* =========================
   Mini journal
========================= */
document.getElementById('saveMiniJournal').addEventListener('click', ()=>{
  const t = document.getElementById('miniJournal').value.trim(); if(!t) return;
  const arr = loadJournal(); arr.unshift({text:t,date:Date.now(),mood:currentMood}); saveJournal(arr);
  document.getElementById('miniJournal').value=''; botSay('Saved your note. Nice one.'); renderJournal();
});
document.getElementById('openJournal').addEventListener('click', ()=>showTab('profile'));

/* =========================
   Full Journal UI
========================= */
function renderJournal(){
  const list = document.getElementById('journalList');
  const arr = loadJournal();
  list.innerHTML='';
  if(!arr.length) { list.innerHTML='<div class="hint small">No entries yet.</div>'; return; }
  arr.forEach((it,i)=>{
    const d = document.createElement('div'); d.className='hint small'; d.textContent = `${new Date(it.date).toLocaleString()}: ${it.text}`;
    const del = document.createElement('button'); del.className='btn'; del.textContent='Del'; del.style.marginLeft='8px';
    del.addEventListener('click', ()=>{ arr.splice(i,1); saveJournal(arr); renderJournal(); });
    d.appendChild(del);
    list.appendChild(d);
  });
}
document.getElementById('saveJournal').addEventListener('click', ()=>{
  const t = document.getElementById('journalText').value.trim(); if(!t) return;
  const arr = loadJournal(); arr.unshift({text:t,date:Date.now(),mood:currentMood}); saveJournal(arr); document.getElementById('journalText').value=''; renderJournal(); botSay('Journal saved ‚Äî nice reflection.');
});
renderJournal();

/* =========================
   Guestbook (moderated)
========================= */
const guestListEl = document.getElementById('guestList');
function profanityFilter(s){
  const bad = ['fuck','shit','bitch','asshole','f***']; // simple list ‚Äî expand as needed
  const lower = s.toLowerCase();
  return bad.some(b=>lower.includes(b));
}
function renderGuest(){
  const arr = loadGuest();
  guestListEl.innerHTML='';
  if(!arr.length) { guestListEl.innerHTML='<div class="hint small">No notes yet. Be kind :)</div>'; return; }
  arr.slice().reverse().forEach(it=>{
    const d = document.createElement('div'); d.className='hint small'; d.textContent = `${it.text} ‚Äî ${new Date(it.at).toLocaleString()}`;
    guestListEl.appendChild(d);
  });
}
document.getElementById('postGuest').addEventListener('click', ()=>{
  const txt = document.getElementById('guestInput').value.trim(); if(!txt) return;
  if(txt.length>140){ alert('Keep it short (140 chars)'); return; }
  if(profanityFilter(txt)){ alert('Please be kind.'); return; }
  const arr = loadGuest(); arr.push({text:txt,at:Date.now()}); saveGuest(arr); document.getElementById('guestInput').value=''; renderGuest(); botSay('Thanks for leaving a note. üíô');
});
document.getElementById('clearGuest').addEventListener('click', ()=>{ if(confirm('Clear guest wall?')){ saveGuest([]); renderGuest(); }});
renderGuest();

/* =========================
   Draw: free draw, save, share
========================= */
const doodle = document.getElementById('doodle');
const ctx = doodle.getContext('2d');
let drawing=false, last=null;
let stack=[], redo=[];
function resizeCanvas(){ /* keep internal size consistent - already set by markup */ }
function pushState(){ try{ stack.push(doodle.toDataURL()); redo.length=0; }catch(e){} }
function strokeStart(x,y){ drawing=true; last=[x,y]; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=14; ctx.strokeStyle='#e6f0ff'; ctx.shadowBlur=0; pushState(); }
function strokeMove(x,y){ if(!drawing) return; ctx.beginPath(); ctx.moveTo(last[0],last[1]); ctx.lineTo(x,y); ctx.stroke(); last=[x,y]; }
function strokeEnd(){ drawing=false; last=null; if(autoCheckOn) queuedCheck(); }
function getPos(e){
  const r = doodle.getBoundingClientRect();
  const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
  const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
  return [x * doodle.width / r.width, y * doodle.height / r.height];
}
doodle.addEventListener('pointerdown', e=>{ doodle.setPointerCapture(e.pointerId); const [x,y]=getPos(e); strokeStart(x,y); });
doodle.addEventListener('pointermove', e=>{ const [x,y]=getPos(e); strokeMove(x,y); });
doodle.addEventListener('pointerup', strokeEnd);
doodle.addEventListener('pointerleave', strokeEnd);

document.getElementById('undoDraw').onclick=()=>{ if(stack.length){ const last=stack.pop(); redo.push(last); const img=new Image(); img.onload=()=>{ctx.clearRect(0,0,doodle.width,doodle.height); ctx.drawImage(img,0,0)}; if(stack.length){img.src=stack[stack.length-1]} else {ctx.clearRect(0,0,doodle.width,doodle.height)} } };
document.getElementById('redoDraw').onclick=()=>{ if(redo.length){ const src=redo.pop(); stack.push(src); const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0); img.src=src; } };
document.getElementById('clearCanvas').onclick=()=>{ if(confirm('Clear canvas?')){ ctx.clearRect(0,0,doodle.width,doodle.height); setCheckMsg("Canvas cleared. Ready when you are."); } };

document.getElementById('savePNG').onclick=()=>{
  const data = doodle.toDataURL('image/png');
  const arr = loadDrawings(); arr.unshift({data, name:`doodle-${Date.now()}`, date:Date.now(), mood:currentMood});
  saveDrawings(arr); renderGallery();
  const a=document.createElement('a'); a.download='aura-doodle.png'; a.href=data; a.click();
};
document.getElementById('sharePNG').onclick=async()=>{
  const data = doodle.toDataURL('image/png');
  try{
    await navigator.clipboard.writeText(data);
    alert('Data-URL copied to clipboard (you can paste it in a doc).');
  }catch(e){ alert('Copy failed ‚Äî try saving then sharing the file.'); }
};
const gallery = document.getElementById('gallery');
function renderGallery(){
  const arr = loadDrawings();
  gallery.innerHTML='';
  if(!arr.length) { gallery.innerHTML='<div class="hint small">No saved drawings yet.</div>'; return; }
  arr.slice(0,8).forEach((it,idx)=>{
    const img = document.createElement('img'); img.src = it.data; img.style.width='80px'; img.style.borderRadius='8px'; img.style.border='1px solid var(--stroke)'; img.style.margin='4px';
    img.addEventListener('click', ()=>{ if(confirm('Load this drawing to canvas?')){ const imgObj=new Image(); imgObj.onload=()=>{ ctx.clearRect(0,0,doodle.width,doodle.height); ctx.drawImage(imgObj,0,0); }; imgObj.src=it.data; }});
    gallery.appendChild(img);
  });
}
renderGallery();

/* =========================
   Mobilenet Auto-check (use when idea set)
========================= */
let mobilenetModel = null;
(async()=>{ try{ mobilenetModel = await mobilenet.load({version:2, alpha:1.0}); }catch(e){ console.warn('Model failed to load', e); } })();
let currentIdea = null;
const IDEAS = [ "cat","dog","fish","bird","butterfly","flower","tree","leaf","house","car","bus","train","boat","rocket","star","moon","sun","rainbow","pizza","guitar","piano","drum","camera","clock","book","elephant","lion","tiger","bear","penguin","dragon","mountain","river" ];
function chooseIdea(){ currentIdea = IDEAS[Math.floor(Math.random()*IDEAS.length)]; ideaText.innerHTML = `Try drawing <strong>${currentIdea}</strong>. Choose OK for this one, No for a different one, or Later to freestyle.`; }
document.getElementById('drawAsk').onclick = ()=>{ chooseIdea(); };
document.getElementById('okIdea').onclick = ()=>{ if(!currentIdea) chooseIdea(); else ideaText.innerHTML = `You picked <strong>${currentIdea}</strong>. Go for it!`; };
document.getElementById('noIdea').onclick = ()=>{ chooseIdea(); };
document.getElementById('laterIdea').onclick = ()=>{ currentIdea = null; ideaText.textContent = "Freestyle is on. Draw anything you like."; };
let checkTimer=null; let autoCheckOn=true;
document.getElementById('autoCheck').onclick = ()=>{ autoCheckOn = !autoCheckOn; document.getElementById('autoCheck').setAttribute('aria-pressed', String(autoCheckOn)); setCheckMsg(autoCheckOn? "Auto-Check is on." : "Auto-Check is off."); };
function setCheckMsg(t){ document.getElementById('checkMsg').textContent = t; }

async function queuedCheck(){ if(!autoCheckOn || !mobilenetModel || !currentIdea) return; clearTimeout(checkTimer); checkTimer = setTimeout(runCheck, 650); }
async function runCheck(){
  if(!mobilenetModel || !currentIdea) return;
  try{
    const pred = await mobilenetModel.classify(doodle,5);
    const labels = pred.map(p=>p.className.toLowerCase());
    const idea = currentIdea.toLowerCase();
    const matched = labels.some(l => l.includes(idea) || idea.includes(l));
    if(matched) setCheckMsg(randomEncouragement(true));
    else setCheckMsg(randomEncouragement(false)+" Want to try again?");
  }catch(e){ console.warn(e); }
}
function randomEncouragement(ok){
  const good = ["Wow! That looks great! üåü","Nice job‚Äînailed it! ‚úÖ","Love the shapes you used. üíô","Beautiful lines! Keep going!","That‚Äôs it! You did it!"];
  const tryAgain = ["So close‚Äîwant to try once more?","I like your style! Maybe tweak a tiny bit?","Fun attempt! Wanna try again?","Great effort! Another go?","You‚Äôre learning fast‚Äîone more try?"];
  return ok ? good[Math.floor(Math.random()*good.length)] : tryAgain[Math.floor(Math.random()*tryAgain.length)];
}

/* =========================
   Bubble Pop Game (kept original logic)
========================= */
const game = document.getElementById('game');
const gtx = game.getContext('2d');
let bubbles=[], popped=0, goal=10, level=1, maxLevel=30, score=0, running=false, paused=false;
const levelBadge = document.getElementById('levelBadge');
const scoreBadge = document.getElementById('scoreBadge');
const goalText = document.getElementById('goalText');
const goalMeter = document.getElementById('goalMeter');
const milestones = document.getElementById('milestones');
const encBox = document.getElementById('encBox');

function prepareGameCanvas(){ const r = game.getBoundingClientRect(); game.width = Math.floor(r.width * devicePixelRatio); game.height = Math.floor(r.height * devicePixelRatio); gtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
window.addEventListener('resize', ()=>{ prepareGameCanvas(); });
function resetLevel(){ popped=0; goal = 8 + level*2; levelBadge.textContent = `Level ${level} / ${maxLevel}`; goalText.textContent = `Pop ${goal} bubbles to pass.`; goalMeter.style.width = '0%'; bubbles = []; spawnBubbles(); encBox.textContent = level===1 ? "You‚Äôve got this! üéØ" : randomGameEnc(); renderMilestones(); }
function randomGameEnc(){ const arr = ["Nice pop!","Great focus!","Clean hit!","Cruising!","You‚Äôre on fire!","Sweet aim!"]; return arr[Math.floor(Math.random()*arr.length)]; }
function renderMilestones(){ milestones.innerHTML=''; const marks=[25,50,100,150,200,300,400,500,600,700,800,900,1000]; marks.forEach(m=>{ const d=document.createElement('div'); d.className='badge'; d.textContent = m; if(score>=m) d.style.background='linear-gradient(180deg,#59e48f55,#59e48f22)'; milestones.appendChild(d); }); }
function spawnBubbles(){ const count = Math.min(10+level*2, 40); for(let i=0;i<count;i++){ bubbles.push({ x: Math.random()*game.clientWidth, y: game.clientHeight + Math.random()*200, r: 12 + Math.random()* (10 + level), v: (1.1 + Math.random()* (0.8 + level*0.15)) * 0.75, hue: 180 + Math.random()*120, alive: true }); } }
game.addEventListener('pointerdown', e=>{ if(!running || paused) return; const rect = game.getBoundingClientRect(); const x = (e.clientX - rect.left); const y = (e.clientY - rect.top); for(const b of bubbles){ const dx=b.x - x, dy=b.y - y; if(b.alive && Math.hypot(dx,dy) <= b.r){ b.alive=false; popped++; score+=5; scoreBadge.textContent=`Score ${score}`; const p = Math.min(100, Math.floor((popped/goal)*100)); goalMeter.style.width = p+'%'; encBox.textContent = randomGameEnc(); // Easter egg: score 69
        if(score===69){ botSay("Heh ‚Äî special score unlocked üòè"); }
        break; } } });
function step(){ if(!running || paused) return; gtx.clearRect(0,0,game.clientWidth,game.clientHeight); for(const b of bubbles){ if(!b.alive) continue; b.y -= b.v; gtx.beginPath(); gtx.arc(b.x,b.y,b.r,0,Math.PI*2); const grd = gtx.createRadialGradient(b.x- b.r/3, b.y- b.r/3, 2, b.x, b.y, b.r); grd.addColorStop(0, `hsla(${b.hue},80%,80%,0.95)`); grd.addColorStop(1, `hsla(${b.hue},70%,50%,0.35)`); gtx.fillStyle = grd; gtx.fill(); } bubbles = bubbles.filter(b=>b.alive && b.y + b.r > -10); if(bubbles.length < 8) spawnBubbles(); if(popped >= goal){ level = Math.min(maxLevel, level+1); resetLevel(); } requestAnimationFrame(step); }
document.getElementById('startGame').onclick=()=>{ running=true; paused=false; prepareGameCanvas(); resetLevel(); step(); };
document.getElementById('pauseGame').onclick=()=>{ if(!running) return; paused=!paused; if(!paused) step(); };
document.getElementById('levelUp').onclick=()=>{ level=Math.min(maxLevel, level+1); resetLevel(); };
document.getElementById('levelDown').onclick=()=>{ level=Math.max(1, level-1); resetLevel(); };

/* =========================
   Tic-Tac-Toe (simple)
========================= */
const tboard = document.getElementById('tboard');
const ttScore = document.getElementById('ttScore');
let boardState = Array(9).fill(null);
let myScore=0, botScore=0;
function renderBoard(){
  tboard.innerHTML='';
  boardState.forEach((v,i)=>{
    const b = document.createElement('button'); b.textContent = v||''; b.addEventListener('click', ()=>{ if(boardState[i]||checkWinner()) return; boardState[i]='X'; renderBoard(); if(!checkWinner()) botMove(); else endRound(); });
    tboard.appendChild(b);
  });
}
function botMove(){
  const empty = boardState.map((v,i)=>v?null:i).filter(x=>x!==null);
  const pick = empty[Math.floor(Math.random()*empty.length)];
  if(pick!==undefined){ boardState[pick]='O'; renderBoard(); }
  endRound();
}
function checkWinner(){
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const l of lines){ const [a,b,c]=l; if(boardState[a] && boardState[a]===boardState[b] && boardState[a]===boardState[c]) return boardState[a]; }
  if(boardState.every(x=>x)) return 'draw';
  return null;
}
function endRound(){
  const w = checkWinner();
  if(w==='X'){ myScore++; botSay('Nice win!'); }
  else if(w==='O'){ botScore++; botSay('Bot wins ‚Äî good try!'); }
  else if(w==='draw'){ botSay('It‚Äôs a draw. Try again?'); }
  ttScore.textContent = `You: ${myScore} ‚Ä¢ Bot: ${botScore}`;
}
document.getElementById('ttReset').addEventListener('click', ()=>{ boardState = Array(9).fill(null); renderBoard(); });
renderBoard();

/* =========================
   Simple Profile (local)
========================= */
const displayName = document.getElementById('displayName');
const saveProfileBtn = document.getElementById('saveProfile');
function renderProfile(){
  profile = loadUserProfile();
  displayName.value = profile.name || '';
  document.getElementById('brandTitle').textContent = profile.brand || 'Aura';
  if(profile.trustedVoiceDataUrl) voiceLabel.textContent = 'Trusted voice uploaded';
  renderFacts(); renderJournal(); renderGallery(); renderGuest();
}
saveProfileBtn.addEventListener('click', ()=>{ profile.name = displayName.value.trim(); profile.theme = profile.theme || THEME_GROUPS.Gradient[0].name; saveUserProfile(profile); botSay(`Profile saved. Hi ${profile.name||'there'}`); });
document.getElementById('clearData').addEventListener('click', ()=>{ if(confirm('Clear all local data for this app? This removes local drawings/journal/guestbook.')){ LS.removeItem('aura_drawings'); LS.removeItem('aura_journal'); LS.removeItem('aura_guest'); LS.removeItem('aura_facts'); LS.removeItem('aura_profile'); location.reload(); } });

/* =========================
   Facts (memory) render
========================= */
function renderFacts(){ const el = document.getElementById('facts'); facts = loadFacts(); const keys = Object.keys(facts); if(!keys.length) el.textContent='No saved facts yet.'; else el.textContent = 'Likes: ' + keys.slice(0,6).map(k=>facts[k]).join(', '); }

/* =========================
   Save/load calls on init
========================= */
renderProfile();
renderFacts();

/* =========================
   Splash helpers & small events
========================= */
const splash = document.getElementById('splash');
const splashPlay = document.getElementById('splashPlay');
const splashDraw = document.getElementById('splashDraw');
const splashTalk = document.getElementById('splashTalk');
function hideSplashAndGo(tab){
  splash.style.display='none';
  showTab(tab);
  if(tab==='bubble'){ prepareGameCanvas(); }
}
splashPlay.addEventListener('click', ()=>{ hideSplashAndGo('bubble'); });
splashDraw.addEventListener('click', ()=>{ hideSplashAndGo('draw'); });
splashTalk.addEventListener('click', ()=>{ hideSplashAndGo('aura'); });
window.addEventListener('load', ()=>{ splash.style.display='flex'; });

/* =========================
   Theme-easter egg: Konami
========================= */
let konami = [], konamiSeq = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
document.addEventListener('keydown',(e)=>{ konami.push(e.key); if(konami.slice(-konamiSeq.length).join(',')===konamiSeq.join(',')){ applyTheme({animated:true,grad:'#ff6b6b, #ffc87c, #d5a3ff, #8aff8a'}); botSay('Rainbow unlocked üåà'); } });

/* =========================
   Extra: save/load drawings/journal on unload so works across refresh
========================= */
window.addEventListener('beforeunload', ()=>{ saveDrawings(loadDrawings()); saveJournal(loadJournal()); saveGuest(loadGuest()); saveFacts(facts); saveUserProfile(profile); });

/* =========================
   Small UX / safety tweaks
========================= */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ if(splash.style.display!=='none'){ splash.style.display='none'; showTab('aura'); } } });

// profile init (ensure theme)
if(profile.theme){
  // try to find theme by name and apply simple mapping
  for(const g of Object.values(THEME_GROUPS)){
    for(const t of g) if(t.name===profile.theme){ applyTheme(t); break; }
  }
}
</script>
</body>
</html>
