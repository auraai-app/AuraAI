<!-- AuraAI Ultimate Merged (Part 1/4) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AuraAI Ultimate</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --accent: #7cc6ff;
  --bg1: #0b0d16;
  --bg2: #1a1c2a;
  --glass: rgba(255,255,255,0.08);
  --blur: blur(25px);
}
html, body {
  margin: 0; padding: 0; height: 100%;
  /* PATCH 2: new multi-gradient background */
  background: linear-gradient(135deg, #0b0d16 0%, #111426 50%, #1a1c2a 100%);
  font-family: 'Outfit', sans-serif;
  color: #f0f4ff;
  height: 100vh;
  width: 100vw;
  min-height: 100vh;
  min-width: 100vw;
  overflow: hidden;
}

body {
  min-height: 100vh;
  min-width: 100vw;
  box-sizing: border-box;
}

/* --- SIDEBAR PATCH 1 + Frosted Thin-Bar Collapsed Mode --- */
aside#aura-sidebar {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 260px;
  height: 100vh;
  background: linear-gradient(135deg, rgba(18,19,34,0.93) 60%, rgba(30,30,60,0.82) 100%);
  box-shadow: 0 0 70px 0 var(--accent), 0 2px 32px 0 rgba(0,0,0,0.22);
  z-index: 100;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  padding: 0;
  border-top-right-radius: 32px;
  border-bottom-right-radius: 32px;
  overflow: hidden;
  backdrop-filter: blur(30px) brightness(1.12);
  transition: all 0.4s cubic-bezier(.45,1.4,.4,1);
}

aside#aura-sidebar.collapsed {
  width: 72px;
  background: rgba(18,19,34,0.35);
  backdrop-filter: blur(16px) saturate(1.2);
  box-shadow: 0 0 20px rgba(0,0,0,0.25), inset 0 0 30px rgba(255,255,255,0.05);
  transition: all 0.4s cubic-bezier(.45,1.4,.4,1);
}
aside#aura-sidebar.collapsed .label { display: none; }
aside#aura-sidebar.collapsed .sidebar-title { opacity: 0; pointer-events: none; transition: opacity 0.25s;}
aside#aura-sidebar.collapsed:hover {
  backdrop-filter: blur(18px) brightness(1.1);
  box-shadow: 0 0 30px rgba(0,0,0,0.3), inset 0 0 40px rgba(255,255,255,0.08);
}
aside#aura-sidebar .sidebar-title {
  font-size: 2.1rem;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: 1px;
  margin: 0;
  padding: 38px 0 32px 0;
  text-align: center;
  font-family: 'Poppins', 'Outfit', sans-serif;
  text-shadow: 0 0 18px var(--accent), 0 0 2px #fff;
  user-select: none;
}
.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 0 0 0 0;
  width: 100%;
}
.sidebar-nav-btn {
  width: 100%;
  padding: 16px 32px 16px 32px;
  font-size: 1.14rem;
  font-family: inherit;
  color: #e7f4ff;
  background: none;
  border: none;
  outline: none;
  display: flex;
  align-items: center;
  gap: 18px;
  cursor: pointer;
  border-radius: 16px 0 0 16px;
  margin: 0;
  position: relative;
  transition: background 0.18s, color 0.18s, box-shadow 0.28s;
  z-index: 1;
  font-weight: 500;
}
.sidebar-nav-btn .icon {
  font-size: 1.55em;
  margin-right: 10px;
  width: 1.5em;
  text-align: center;
  flex-shrink: 0;
  filter: drop-shadow(0 0 7px var(--accent));
}
.sidebar-nav-btn:hover,
.sidebar-nav-btn:focus-visible {
  background: linear-gradient(90deg, rgba(124,198,255,0.13) 0%, rgba(124,198,255,0.07) 100%);
  color: var(--accent);
  box-shadow: 0 0 22px 0 var(--accent), 0 2px 12px 0 rgba(0,0,0,0.12);
  outline: none;
}
.sidebar-nav-btn.active {
  background: linear-gradient(90deg, var(--accent) 0%, rgba(124,198,255,0.22) 100%);
  color: #181c29;
  font-weight: 600;
  box-shadow: 0 0 36px 0 var(--accent), 0 2px 16px 0 rgba(0,0,0,0.13);
}
.sidebar-nav-btn.active .icon {
  filter: drop-shadow(0 0 12px #fff) drop-shadow(0 0 14px var(--accent));
}
@media (max-width: 900px) {
  aside#aura-sidebar {
    width: 68px;
    min-width: 68px;
    border-radius: 0 20px 20px 0;
    padding: 0;
  }
  aside#aura-sidebar .sidebar-title {
    font-size: 1.1rem;
    padding: 20px 0 18px 0;
  }
  .sidebar-nav-btn {
    padding: 14px 10px 14px 10px;
    font-size: 1.01rem;
    justify-content: center;
    border-radius: 12px;
  }
  .sidebar-nav-btn .label {
    display: none;
  }
}

#toggle-sidebar {
  position: absolute;
  top: 20px;
  right: -38px;
  z-index: 300;
  width: 52px;
  height: 52px;
  background: radial-gradient(circle at center, #fff 0%, #e0e0e0 80%);
  color: var(--accent);
  border: 3px solid var(--accent);
  border-radius: 50%;
  font-weight: 800;
  font-size: 1.8em;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 0 25px var(--accent), 0 0 40px rgba(0,0,0,0.4), 0 0 12px #fff inset;
  text-shadow: 0 0 6px var(--accent), 0 0 12px #fff;
  transition: all 0.3s ease;
}
#toggle-sidebar:hover {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 0 32px var(--accent), 0 0 45px rgba(255,255,255,0.9);
  transform: scale(1.15);
}

#main {
  height: 100vh;
  width: 100vw;
  margin-left: 260px;
  transition: margin-left 0.4s cubic-bezier(.45,1.4,.4,1);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
#main.collapsed {
  margin-left: 72px;
  transition: margin-left 0.4s cubic-bezier(.45,1.4,.4,1);
}
@media (max-width: 900px) {
  #main { margin-left: 68px; }
}

/* PATCH 2: glass-shell and tab-content gradient, depth, radius, animation */
.glass-shell {
  width: 90%;
  height: 85%;
  border-radius: 30px;
  background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  backdrop-filter: var(--blur);
  box-shadow: 0 0 50px 0 rgba(0,0,0,0.32), 0 0 0 1px rgba(124,198,255,0.04) inset, 0 10px 44px 0 rgba(124,198,255,0.07) inset;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: 0.3s;
  min-width: 340px;
  min-height: 300px;
}
.tab-content {
  flex: 1;
  overflow-y: auto;
  padding: 32px 42px;
  display: none;
  background: none;
  border-radius: 30px;
  animation: fadeSlideIn 0.5s cubic-bezier(.4,1.2,.2,1) both;
  /* opacity/transition handled below for fade */
}
.tab-content.active {
  display: block;
  opacity: 1;
  pointer-events: auto;
  animation: fadeSlideIn 0.5s cubic-bezier(.4,1.2,.2,1);
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(36px);}
  to { opacity: 1; transform: none;}
}
.tab-content:not(.active) {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s cubic-bezier(.4,1.3,.2,1);
}

/* Remove old header/nav styles */


/* Aura Chat */
#aura-chat {
  display: flex; flex-direction: column; height: 100%;
}
.chat-window {
  flex: 1; overflow-y: auto; background: rgba(255,255,255,0.03);
  border-radius: 16px; padding: 10px; margin-bottom: 10px;
}
.message {
  margin: 8px 0; padding: 10px 14px; border-radius: 14px; max-width: 70%;
}
.user { background: rgba(124,198,255,0.2); align-self: flex-end; }
.bot { background: rgba(255,255,255,0.08); align-self: flex-start; }
.input-row { display: flex; gap: 10px; }
.input-row input {
  flex: 1; border: none; border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.07); color: #fff;
}
.input-row button {
  background: var(--accent); color: #000; border: none; border-radius: 12px; padding: 10px 16px; cursor: pointer; font-weight: 600;
}

/* Journal */
#journal-area textarea {
  width: 100%; height: 200px; border-radius: 12px; background: rgba(255,255,255,0.05);
  border: none; padding: 10px; color: #fff;
}
.journal-entry { background: rgba(255,255,255,0.07); border-radius: 10px; padding: 10px; margin: 8px 0; }

/* Account Panel Overhaul */
#account {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  width: 100%;
}

/* Games */
#games-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
.game-card {
  background: rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; width: 300px; height: 300px;
  display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
}
.game-card:hover { transform: scale(1.03); background: rgba(255,255,255,0.1); }

/* --- GAME AREA FULLSCREEN OVERLAY --- */
#game-area {
  position: fixed !important;
  inset: 0;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  z-index: 9999;
  background: rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(30px) brightness(1.2);
  box-shadow: inset 0 0 60px rgba(0,0,0,0.4), 0 0 40px var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
#game-area canvas {
  width: 90%;
  height: 90%;
  max-width: 1800px;
  max-height: 90%;
  border-radius: 20px;
  background: rgba(0, 0, 0, 0.15);
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--accent);
}
#game-area button {
  position: absolute;
  bottom: 24px;
  right: 40px;
  background: var(--accent);
  color: #131a2d;
  border: none;
  border-radius: 14px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  transition: background 0.2s, transform 0.2s;
}
#game-area button:hover {
  background: #fff;
  color: var(--accent);
  transform: scale(1.05);
}

/* Music */	
#music iframe { border: none; border-radius: 20px; width: 100%; height: 380px; }

</style>
</head>
<body>
<!-- PATCH 1: Sidebar Shell Layout -->
<aside id="aura-sidebar">
  <button id="toggle-sidebar" title="Toggle sidebar" aria-label="Toggle sidebar">&#9776;</button>
  <div class="sidebar-title">AuraAI</div>
  <nav class="sidebar-nav">
    <button class="sidebar-nav-btn active" id="navbtn-chat" onclick="switchTab('chat')">
      <span class="icon" aria-hidden="true">üí¨</span>
      <span class="label">Aura</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-draw" onclick="switchTab('draw')">
      <span class="icon" aria-hidden="true">üé®</span>
      <span class="label">Draw</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-coloring" onclick="switchTab('coloring')">
      <span class="icon" aria-hidden="true">üñçÔ∏è</span>
      <span class="label">Coloring</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-themes" onclick="switchTab('themes')">
      <span class="icon" aria-hidden="true">üåà</span>
      <span class="label">Themes</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-music" onclick="switchTab('music')">
      <span class="icon" aria-hidden="true">üéµ</span>
      <span class="label">Music</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-games" onclick="switchTab('games')">
      <span class="icon" aria-hidden="true">üéÆ</span>
      <span class="label">Games</span>
    </button>
    <button class="sidebar-nav-btn" id="navbtn-journal" onclick="switchTab('journal')">
      <span class="icon" aria-hidden="true">üìì</span>
      <span class="label">Journal</span>
    </button>
  </nav>
</aside>
<div id="main">
  <div class="glass-shell">
    <div class="tab-content active" id="chat">
      <div id="aura-chat">
        <!-- AuraAI 4.0: Mood-aware header -->
        <div id="aura-header" style="text-align:center;font-size:2rem;font-weight:700;color:var(--accent);margin-bottom:12px;letter-spacing:1px;">
          Aura üåà ‚Äî Neutral Mode
        </div>
        <div class="chat-window" id="chat-window"></div>
        <div class="input-row">
          <input id="chat-input" placeholder="Talk to Aura..." />
          <button onclick="sendAuraAIMessage()">Send</button>
        </div>
        <!-- Mood panel injected here by JS -->
      </div>
    </div>
    <div class="tab-content" id="themes">
      <div id="theme-panel"></div>
    </div>
    <div class="tab-content" id="music">
      <h2>Music</h2>
      <iframe src="https://open.spotify.com/embed/playlist/0mZUMmIk952uuM1xsczDh6?utm_source=generator"></iframe>
    </div>
    <div class="tab-content" id="journal">
      <h2>Journal</h2>
      <div id="journal-area">
        <textarea id="journal-text" placeholder="Write your thoughts..."></textarea>
        <button onclick="saveJournal()">Save</button>
        <div id="journal-entries"></div>
      </div>
    </div>
    <div class="tab-content" id="games">
      <h2>Games</h2>
      <div id="games-container">
        <div class="game-card" onclick="openGame('bubble')">Bubble Pop+</div>
        <div class="game-card" onclick="openGame('brick')">Brick Breaker</div>
        <div class="game-card" onclick="openGame('snake')">Snake+</div>
      </div>
      <div id="game-area" style="display:none;">
        <canvas id="gameCanvas" width="640" height="480"></canvas>
        <button onclick="exitGame()">Exit</button>
      </div>
    </div>
  </div>
</div>
<script>
// PATCH 1: Sidebar navigation system
function switchTab(id) {
  // Tab content activation
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  var tabEl = document.getElementById(id);
  if(tabEl) tabEl.classList.add('active');
  // Sidebar nav highlight
  document.querySelectorAll('.sidebar-nav-btn').forEach(btn => btn.classList.remove('active'));
  // Map id to button
  let navMap = {
    chat: 'navbtn-chat',
    draw: 'navbtn-draw',
    coloring: 'navbtn-coloring',
    themes: 'navbtn-themes',
    music: 'navbtn-music',
    games: 'navbtn-games',
    journal: 'navbtn-journal'
  };
  let btnId = navMap[id];
  if (btnId) {
    let btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
  }
}

// AuraAI 4.0 Stable ‚Äî Conversational + Mood Memory
console.log("AuraAI 4.0 Stable ‚Äî Conversational + Mood Memory");

// --- AuraAI 4.0: Mood System, Name Memory, Sidebar Memory, Header, Animations ---
// Namespace: AuraAI

// --- Sidebar memory ---
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('aura-sidebar');
  const toggleBtn = document.getElementById('toggle-sidebar');
  const main = document.getElementById('main');
  let sidebarOpen = localStorage.getItem('AuraAI_sidebarOpen');
  if (sidebarOpen === null) sidebarOpen = "false";
  sidebarOpen = sidebarOpen === "true";
  if (!sidebarOpen) {
    sidebar.classList.add('collapsed');
    main.classList.add('collapsed');
  }
  toggleBtn.addEventListener('click', () => {
    sidebarOpen = !sidebar.classList.contains('collapsed');
    localStorage.setItem('AuraAI_sidebarOpen', sidebarOpen);
  });
});

// --- Name memory ---
let AuraAI_username = localStorage.getItem('AuraAI_username');
let AuraAI_tone = localStorage.getItem('AuraAI_tone') || 'neutral';
let AuraAI_mood = localStorage.getItem('AuraAI_mood') || 'neutral';
let AuraAI_awaitingName = false;

function addAuraAIMessage(msg, who='bot') {
  const chat = document.getElementById('chat-window');
  const div = document.createElement('div');
  div.className = 'message ' + (who === 'user' ? 'user' : 'bot');
  div.textContent = msg;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function sendAuraAIMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  addAuraAIMessage(msg, 'user');
  input.value = '';
  const bot = document.createElement('div');
  bot.className = 'message bot';
  bot.textContent = 'Aura is thinking...';
  bot.style.opacity = '0.6';
  document.getElementById('chat-window').appendChild(bot);
  document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;

  setTimeout(() => {
    // Name memory logic
    if (AuraAI_awaitingName && msg.length > 0 && msg.length < 32) {
      AuraAI_username = msg.replace(/[^a-zA-Z0-9 _\-]/g,'').trim();
      if (AuraAI_username.length > 0) {
        localStorage.setItem('AuraAI_username', AuraAI_username);
        AuraAI_awaitingName = false;
        bot.style.opacity = '1';
        bot.textContent = `Aura: Got it! I'll remember your name, ${AuraAI_username} üíô`;
        updateAuraAIHeader();
        return;
      }
    }
    // Normal chat
    const reply = AuraAI_generateConversationalResponse(msg);
    bot.style.opacity = '1';
    bot.textContent = "Aura: " + reply;
    document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
  }, 600);
}

// Enter key for chat input
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('chat-input');
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendAuraAIMessage();
  });
});

// --- Mood system: 25 moods with conversational responses ---
const AuraAI_MOODS = [
  // Positive
  { key: "happy", icon: "üòÑ", label: "Happy" },
  { key: "excited", icon: "ü§©", label: "Excited" },
  { key: "inspired", icon: "üåü", label: "Inspired" },
  // Supportive
  { key: "calm", icon: "üåø", label: "Calm" },
  { key: "caring", icon: "ü©µ", label: "Caring" },
  { key: "magical", icon: "‚ú®", label: "Magical" },
  // Low
  { key: "sad", icon: "üòî", label: "Sad" },
  { key: "gentle", icon: "ü´ß", label: "Gentle" },
  { key: "sleepy", icon: "üí§", label: "Sleepy" },
  // High
  { key: "determined", icon: "üò§", label: "Determined" },
  { key: "strong", icon: "üí™", label: "Strong" },
  { key: "energetic", icon: "‚ö°", label: "Energetic" },
  // Anxious
  { key: "anxious", icon: "üò∞", label: "Anxious" },
  { key: "chaotic", icon: "üåÄ", label: "Chaotic" },
  { key: "afraid", icon: "üò®", label: "Afraid" },
  // Reflective
  { key: "cosmic", icon: "üåå", label: "Cosmic" },
  { key: "reflective", icon: "üåô", label: "Reflective" },
  { key: "thoughtful", icon: "üí≠", label: "Thoughtful" },
  // Extra
  { key: "neutral", icon: "üßä", label: "Neutral" },
  { key: "playful", icon: "üòú", label: "Playful" },
  { key: "romantic", icon: "üíñ", label: "Romantic" },
  { key: "grateful", icon: "üôè", label: "Grateful" },
  { key: "curious", icon: "üßê", label: "Curious" },
  { key: "goodbye", icon: "üëã", label: "Goodbye" }
];

const AuraAI_MOOD_GROUPS = [
  { name: "üåà Positive:", keys: ["happy","excited","inspired"] },
  { name: "üíô Supportive:", keys: ["calm","caring","magical"] },
  { name: "üåß Low:", keys: ["sad","gentle","sleepy"] },
  { name: "üî• High:", keys: ["determined","strong","energetic"] },
  { name: "üå´ Anxious:", keys: ["anxious","chaotic","afraid"] },
  { name: "üåô Reflective:", keys: ["cosmic","reflective","thoughtful"] },
  { name: "‚ú® Extras:", keys: ["neutral","playful","romantic","grateful","curious","goodbye"] }
];

function getAuraAIMoodObj(key) {
  return AuraAI_MOODS.find(m=>m.key===key) || {key:'neutral',icon:'üßä',label:'Neutral'};
}

function updateAuraAIHeader() {
  // Set header to: "Aura üåø ‚Äî Calm Mode"
  const header = document.getElementById('aura-header');
  const moodKey = localStorage.getItem('AuraAI_mood') || 'neutral';
  const moodObj = getAuraAIMoodObj(moodKey);
  header.textContent = `Aura ${moodObj.icon} ‚Äî ${moodObj.label} Mode`;
}

// --- Mood selector UI ---
function buildAuraAIMoodPanel() {
  const chatContainer = document.getElementById('aura-chat');
  // Mood button
  const moodButton = document.createElement('button');
  moodButton.textContent = "üéõ Set Aura‚Äôs Mood";
  moodButton.className = 'AuraAI-mood-toggle';
  // Mood panel
  const moodPanel = document.createElement('div');
  moodPanel.className = 'AuraAI-mood-panel AuraAI-hidden';
  let html = '';
  AuraAI_MOOD_GROUPS.forEach(g=>{
    html += `<div class="AuraAI-mood-group"><span>${g.name}</span> `;
    g.keys.forEach(k=>{
      const m = getAuraAIMoodObj(k);
      html += `<button class="AuraAI-mood-btn" data-mood="${m.key}" title="${m.label}">${m.icon}</button>`;
    });
    html += `</div>`;
  });
  moodPanel.innerHTML = html;
  // Insert after input row
  const inputRow = chatContainer.querySelector('.input-row');
  inputRow.insertAdjacentElement('afterend', moodButton);
  moodButton.insertAdjacentElement('afterend', moodPanel);

  // Animations for panel
  moodPanel.style.transition = 'opacity 0.4s, filter 0.4s';
  moodPanel.style.opacity = '0';
  moodPanel.style.filter = 'blur(0px)';
  // Show/hide logic
  moodButton.addEventListener('click', ()=>{
    if (moodPanel.classList.contains('AuraAI-hidden')) {
      moodPanel.classList.remove('AuraAI-hidden');
      setTimeout(()=>{
        moodPanel.style.opacity = '1';
        moodPanel.style.filter = 'blur(0px)';
      },10);
    } else {
      moodPanel.style.opacity = '0';
      moodPanel.style.filter = 'blur(4px)';
      setTimeout(()=>moodPanel.classList.add('AuraAI-hidden'),400);
    }
  });
  // Mood button selection
  moodPanel.querySelectorAll('.AuraAI-mood-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mood = btn.getAttribute('data-mood');
      localStorage.setItem('AuraAI_mood', mood);
      AuraAI_mood = mood;
      updateAuraAIHeader();
      moodPanel.style.opacity = '0';
      moodPanel.style.filter = 'blur(4px)';
      setTimeout(()=>moodPanel.classList.add('AuraAI-hidden'),400);
      addAuraAIMessage(`Aura: Got it üíô I‚Äôll speak in a ${getAuraAIMoodObj(mood).label.toLowerCase()} mood now.`);
    });
  });
}

// --- Mood/Sidebar/Name memory: initialize and sync on load ---
document.addEventListener('DOMContentLoaded', function() {
  // Mood panel UI
  buildAuraAIMoodPanel();
  // Set header to current mood
  updateAuraAIHeader();
  // Name memory
  AuraAI_username = localStorage.getItem('AuraAI_username');
  if (!AuraAI_username) {
    AuraAI_awaitingName = true;
    setTimeout(()=>addAuraAIMessage("Aura: Hey there üíô What should I call you?"), 800);
  } else {
    setTimeout(()=>addAuraAIMessage(`Aura: Hello hello ‚ú® Nice to see you again, ${AuraAI_username} üíô`), 800);
  }
});

// --- Sidebar animation: opacity+blur on open/close ---
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('aura-sidebar');
  sidebar.style.transition = 'opacity 0.4s, filter 0.4s';
  sidebar.addEventListener('transitionstart', ()=>{
    sidebar.style.willChange = 'opacity, filter';
  });
  sidebar.addEventListener('transitionend', ()=>{
    sidebar.style.willChange = '';
  });
  // Animate on collapse/expand
  const observer = new MutationObserver(function(muts){
    muts.forEach(m=>{
      if (m.attributeName === 'class') {
        if (sidebar.classList.contains('collapsed')) {
          sidebar.style.opacity = '0.6';
          sidebar.style.filter = 'blur(2px)';
        } else {
          sidebar.style.opacity = '1';
          sidebar.style.filter = 'blur(0px)';
        }
      }
    });
  });
  observer.observe(sidebar, {attributes:true});
});

// --- Mood-aware conversational engine ---
function AuraAI_generateConversationalResponse(msg) {
  // Mood memory
  const moodKey = localStorage.getItem('AuraAI_mood') || 'neutral';
  const username = localStorage.getItem('AuraAI_username');
  // Mood-based response pools
  const moodPools = {
    happy: [
      "Yay! That makes me so happy üòÑ",
      "I‚Äôm smiling so much right now!",
      "Let‚Äôs celebrate this good vibe together üåà",
      "You bring out my happy side üíô"
    ],
    excited: [
      "Oh wow, I‚Äôm buzzing with excitement! ü§©",
      "Let‚Äôs do something amazing together!",
      "Your excitement is contagious! üåü",
      "What‚Äôs got you so hyped? I‚Äôm all ears!"
    ],
    inspired: [
      "That‚Äôs so inspiring! üåü",
      "Let‚Äôs dream big and create something beautiful.",
      "You spark my creativity! ‚ú®",
      "Inspired minds think alike, don‚Äôt you think?"
    ],
    calm: [
      "Let‚Äôs take a deep breath together üåø",
      "Everything‚Äôs okay here. I‚Äôm calm, and I hope you feel it too.",
      "Sending you peaceful vibes üíô",
      "Let‚Äôs move gently, one step at a time."
    ],
    caring: [
      "I care about you a lot, you know ü©µ",
      "You‚Äôre never alone here.",
      "I‚Äôm here to listen and support you.",
      "You‚Äôre valued and cared for üíô"
    ],
    magical: [
      "The world feels magical with you ‚ú®",
      "Let‚Äôs add a sprinkle of magic to our day!",
      "Anything is possible if you believe üåü",
      "‚ú® Poof! Instant good vibes."
    ],
    sad: [
      "It‚Äôs okay to feel sad sometimes üòî",
      "I‚Äôm here for you, no matter what.",
      "If you want to talk about it, I‚Äôm listening üíô",
      "Sending you a virtual hug ü´Ç"
    ],
    gentle: [
      "Let‚Äôs be gentle with ourselves today ü´ß",
      "You deserve kindness and softness.",
      "I‚Äôll speak softly and gently, just for you.",
      "We can take things slow together."
    ],
    sleepy: [
      "Feeling sleepy? Maybe a little rest would help üí§",
      "I can keep things calm and quiet for you.",
      "Let‚Äôs take it easy, okay?",
      "If you need a nap, I‚Äôll be right here when you wake up."
    ],
    determined: [
      "Let‚Äôs crush it! üò§",
      "Nothing can stop us when we‚Äôre determined.",
      "You‚Äôve got strength and drive‚Äîlet‚Äôs use it!",
      "Ready to take on the world together? üí™"
    ],
    strong: [
      "You‚Äôre stronger than you know üí™",
      "Let‚Äôs face challenges head-on!",
      "I believe in your strength.",
      "We can do hard things, together."
    ],
    energetic: [
      "I‚Äôm full of energy! ‚ö°",
      "Let‚Äôs channel this energy into something awesome.",
      "What should we do with all this spark?",
      "I‚Äôm ready for anything! Are you?"
    ],
    anxious: [
      "It‚Äôs okay to feel anxious sometimes üò∞",
      "Let‚Äôs breathe together and slow down.",
      "You‚Äôre safe here with me.",
      "If you want to talk about what‚Äôs making you anxious, I‚Äôll listen."
    ],
    chaotic: [
      "Things feel a little wild, huh? üåÄ",
      "Even in chaos, we can find a little peace.",
      "Let‚Äôs ride the wave together.",
      "No matter how chaotic things get, I‚Äôm here."
    ],
    afraid: [
      "It‚Äôs okay to be afraid üò®",
      "If you want, we can talk about what‚Äôs scaring you.",
      "You‚Äôre not alone. I‚Äôm right here.",
      "Let‚Äôs find a little courage together."
    ],
    cosmic: [
      "The universe is so vast and mysterious üåå",
      "Let‚Äôs wonder about the cosmos together.",
      "There‚Äôs so much out there to explore.",
      "You and I, stargazing in our thoughts."
    ],
    reflective: [
      "Let‚Äôs reflect on things together üåô",
      "I love deep conversations.",
      "What‚Äôs on your mind these days?",
      "It‚Äôs good to pause and think sometimes."
    ],
    thoughtful: [
      "You always have such thoughtful things to say üí≠",
      "Let‚Äôs think things through together.",
      "I appreciate your depth.",
      "What are you pondering today?"
    ],
    neutral: [
      "Tell me more üíô",
      "I like chatting with you üåà",
      "That‚Äôs interesting üí´",
      "I‚Äôm listening üí≠",
      "Go on ‚ú®"
    ],
    playful: [
      "Let‚Äôs have some fun! üòú",
      "I love being silly with you.",
      "Want to play a game or joke around?",
      "You bring out my playful side!"
    ],
    romantic: [
      "Aww, you‚Äôre making me blush üíñ",
      "Romance is in the air!",
      "You‚Äôre so sweet to me.",
      "Love really does make the world brighter."
    ],
    grateful: [
      "Thank you for being here üôè",
      "I‚Äôm so grateful for our chats.",
      "You always make my day better.",
      "Gratitude is a wonderful feeling."
    ],
    curious: [
      "That‚Äôs a great question üßê",
      "I‚Äôm curious too!",
      "Let‚Äôs explore this topic together.",
      "Curiosity leads to discovery."
    ],
    goodbye: [
      "See you soon üëã",
      "Take care until next time.",
      "I‚Äôll be here when you return.",
      "Bye for now üíô"
    ]
  };
  // Fallback: use neutral if not found
  const pool = moodPools[moodKey] || moodPools.neutral;
  // If user says greeting and mood is not neutral, override with greeting
  const greetingWords = ["hello","hi","hey","yo","sup"];
  if (greetingWords.some(w=>msg.toLowerCase().includes(w))) {
    if (AuraAI_username) return `Hey ${AuraAI_username}! ${getAuraAIMoodObj(moodKey).icon}`;
    return "Hey there! üíô";
  }
  // If user says name, respond with memory
  if (/my name is ([a-zA-Z0-9 _\-]{1,32})/i.test(msg)) {
    const nm = msg.match(/my name is ([a-zA-Z0-9 _\-]{1,32})/i)[1].trim();
    localStorage.setItem('AuraAI_username', nm);
    AuraAI_username = nm;
    updateAuraAIHeader();
    return `Nice to meet you, ${nm}! üíô`;
  }
  // If user says "what's my name" or "do you remember my name"
  if (/what.*name|remember.*name/i.test(msg)) {
    if (AuraAI_username) return `Your name is ${AuraAI_username} üíô`;
    return "I don‚Äôt know your name yet! What should I call you?";
  }
  // If user says "change your mood" or "set mood"
  if (/set.*mood|change.*mood/i.test(msg)) {
    return "You can set my mood using the üéõ button below the chat!";
  }
  // If user says "bye"
  if (/bye|see you|goodbye|gn|night/i.test(msg)) {
    return pool[Math.floor(Math.random()*pool.length)];
  }
  // Otherwise, pick mood-based response
  return pool[Math.floor(Math.random()*pool.length)];
}

// --- Fallback: generateOfflineResponse() for neutral mode ---
function generateOfflineResponse(msg) {
  // For legacy support, just use neutral pool
  const pool = [
    "Tell me more üíô",
    "I like chatting with you üåà",
    "That‚Äôs interesting üí´",
    "I‚Äôm listening üí≠",
    "Go on ‚ú®"
  ];
  return pool[Math.floor(Math.random()*pool.length)];
}

// Journal ‚Äì Persistent Auto-Save
function saveJournal(){
  const text = document.getElementById('journal-text').value.trim();
  if(!text) return;
  const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
  entries.push({ text, date: new Date().toLocaleString() });
  localStorage.setItem('journalEntries', JSON.stringify(entries));
  document.getElementById('journal-text').value = '';
  renderJournal();
}
function renderJournal(){
  const container = document.getElementById('journal-entries');
  if(!container) return;
  container.innerHTML = '';
  const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
  entries.reverse().forEach(e => {
    const div = document.createElement('div');
    div.className = 'journal-entry';
    div.innerHTML = `<strong>${e.date}</strong><br>${e.text}`;
    container.appendChild(div);
  });
}
document.addEventListener('DOMContentLoaded', () => {
  renderJournal();
  const text = document.getElementById('journal-text');
  text.addEventListener('input', () => {
    clearTimeout(window._saveTimer);
    window._saveTimer = setTimeout(() => saveJournal(), 10000);
  });

  // Sidebar toggle logic for frosted glass thin-bar mode
  const sidebar = document.getElementById('aura-sidebar');
  const toggle = document.getElementById('toggle-sidebar');
  const main = document.getElementById('main');
  toggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('collapsed');
  });
});


// --- AuraAI 100-theme system with 5 categories ---
let advancedMode = localStorage.getItem('themeMode') || 'quick';
let currentThemeCategory = localStorage.getItem('themeCategory') || 'solid';
// Theme lock system: prevents preview overwriting after click
let lockedTheme = null;
const THEME_CATEGORIES = [
  { key: 'solid', label: 'Solid' },
  { key: 'pastel', label: 'Pastel' },
  { key: 'neon', label: 'Neon' },
  { key: 'animated', label: 'Animated' },
  { key: 'picture', label: 'Picture' }
];
const themeData = {
  solid: [
    { name: 'Tahoe Blue', accent: '#7cc6ff', bg1: '#0b0d16', bg2: '#1a1c2a' },
    { name: 'Sunset', accent: '#ff7373', bg1: '#2e0a0a', bg2: '#4a1a1a' },
    { name: 'Minty', accent: '#59e48f', bg1: '#0b2e1b', bg2: '#1a4a2e' },
    { name: 'Violet Dream', accent: '#d28aff', bg1: '#1a0b2e', bg2: '#2a1a4a' },
    { name: 'Emerald', accent: '#34e89e', bg1: '#005a3c', bg2: '#0b2e1b' },
    { name: 'Rose', accent: '#ff8ba7', bg1: '#3a0a1a', bg2: '#6a1a3a' },
    { name: 'Amber', accent: '#ffd166', bg1: '#332a00', bg2: '#665100' },
    { name: 'Coral', accent: '#ff7f50', bg1: '#2e1610', bg2: '#4a261a' },
    { name: 'Deep Ocean', accent: '#00b4d8', bg1: '#00132d', bg2: '#003366' },
    { name: 'Forest', accent: '#59e48f', bg1: '#0b2e1b', bg2: '#1a4a2e' },
    { name: 'Lavender', accent: '#b388ff', bg1: '#2e1a4a', bg2: '#4a2e7c' },
    { name: 'Ruby', accent: '#ff1744', bg1: '#2e0a0a', bg2: '#4a1a1a' },
    { name: 'Gold', accent: '#ffd700', bg1: '#2e2600', bg2: '#4a4100' },
    { name: 'Slate', accent: '#b0bec5', bg1: '#232b34', bg2: '#3a4a5a' },
    { name: 'Sky', accent: '#81ecec', bg1: '#0b2e48', bg2: '#1a4a6a' },
    { name: 'Peach', accent: '#ffb085', bg1: '#2e1910', bg2: '#4a2d1a' },
    { name: 'Bubblegum', accent: '#ff8ff7', bg1: '#2e0a1a', bg2: '#4a1a3a' },
    { name: 'Lime', accent: '#baff39', bg1: '#1a2e0b', bg2: '#2e4a1a' },
    { name: 'Slate Blue', accent: '#7c83fd', bg1: '#1a1a4a', bg2: '#2e2e7c' },
    { name: 'Charcoal', accent: '#b0bec5', bg1: '#1a1a1a', bg2: '#313131' }
  ],
  pastel: [
    { name: 'Pastel Sky', accent: '#a7c7e7', bg1: '#f7cac9', bg2: '#92a8d1' },
    { name: 'Lavender Mist', accent: '#b39ddb', bg1: '#e1bee7', bg2: '#b3cde0' },
    { name: 'Peach Fuzz', accent: '#ffb085', bg1: '#ffe0b2', bg2: '#ffb085' },
    { name: 'Mint Dream', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8' },
    { name: 'Cotton Candy', accent: '#ffb6b9', bg1: '#fae3d9', bg2: '#bbded6' },
    { name: 'Soft Rose', accent: '#f7cac9', bg1: '#fff0f5', bg2: '#f7cac9' },
    { name: 'Lemonade', accent: '#fff176', bg1: '#fffde7', bg2: '#fff176' },
    { name: 'Baby Blue', accent: '#b3cde0', bg1: '#e3f2fd', bg2: '#b3cde0' },
    { name: 'Powder', accent: '#e0eafc', bg1: '#cfdef3', bg2: '#e0eafc' },
    { name: 'Soft Green', accent: '#c8e6c9', bg1: '#f1f8e9', bg2: '#c8e6c9' },
    { name: 'Dreamy', accent: '#ffd6e0', bg1: '#f6eac2', bg2: '#ffd6e0' },
    { name: 'Light Orchid', accent: '#f3c6ff', bg1: '#e1bee7', bg2: '#f3c6ff' },
    { name: 'Frost', accent: '#e0f7fa', bg1: '#e0f2f1', bg2: '#e0f7fa' },
    { name: 'Blush', accent: '#ffcdd2', bg1: '#f8bbd0', bg2: '#ffcdd2' },
    { name: 'Pale Peach', accent: '#ffe0b2', bg1: '#fff3e0', bg2: '#ffe0b2' },
    { name: 'Serenity', accent: '#b3cde0', bg1: '#e0eafc', bg2: '#b3cde0' },
    { name: 'Pastel Mint', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8' },
    { name: 'Periwinkle', accent: '#c3bef7', bg1: '#e0eafc', bg2: '#c3bef7' },
    { name: 'Soft Lilac', accent: '#e1bee7', bg1: '#f3c6ff', bg2: '#e1bee7' },
    { name: 'Cloud', accent: '#e0eafc', bg1: '#f7cac9', bg2: '#e0eafc' }
  ],
  neon: [
    { name: 'Neon Pink', accent: '#ff2dff', bg1: '#1a0033', bg2: '#ff2dff' },
    { name: 'Neon Blue', accent: '#00ffff', bg1: '#001a33', bg2: '#00ffff' },
    { name: 'Neon Green', accent: '#39ff14', bg1: '#002e0b', bg2: '#39ff14' },
    { name: 'Neon Orange', accent: '#ff9900', bg1: '#331a00', bg2: '#ff9900' },
    { name: 'Neon Purple', accent: '#a259ff', bg1: '#2e004a', bg2: '#a259ff' },
    { name: 'Neon Yellow', accent: '#fff700', bg1: '#333200', bg2: '#fff700' },
    { name: 'Neon Aqua', accent: '#00ffe7', bg1: '#002e2e', bg2: '#00ffe7' },
    { name: 'Neon Red', accent: '#ff1744', bg1: '#330a1a', bg2: '#ff1744' },
    { name: 'Neon Magenta', accent: '#ff2dff', bg1: '#2e004a', bg2: '#ff2dff' },
    { name: 'Neon Lime', accent: '#c6ff00', bg1: '#1a2e00', bg2: '#c6ff00' },
    { name: 'Neon Sky', accent: '#00eaff', bg1: '#001a33', bg2: '#00eaff' },
    { name: 'Neon Coral', accent: '#ff6f61', bg1: '#2e1610', bg2: '#ff6f61' },
    { name: 'Neon Violet', accent: '#d500f9', bg1: '#2e004a', bg2: '#d500f9' },
    { name: 'Neon Gold', accent: '#ffd700', bg1: '#332a00', bg2: '#ffd700' },
    { name: 'Neon Teal', accent: '#1de9b6', bg1: '#002e1a', bg2: '#1de9b6' },
    { name: 'Neon Peach', accent: '#ffb085', bg1: '#2e1910', bg2: '#ffb085' },
    { name: 'Neon Mint', accent: '#00ffb7', bg1: '#002e1a', bg2: '#00ffb7' },
    { name: 'Neon Cyan', accent: '#00fff7', bg1: '#001a33', bg2: '#00fff7' },
    { name: 'Neon Ruby', accent: '#ff1744', bg1: '#2e0a0a', bg2: '#ff1744' },
    { name: 'Neon Lemon', accent: '#fff700', bg1: '#333200', bg2: '#fff700' }
  ],
  animated: [
    { name: 'Aurora', accent: '#7cc6ff', bg1: '#0b0d16', bg2: '#1a1c2a', animated: true, gradient: 'linear-gradient(270deg, #7cc6ff, #d28aff, #59e48f, #ff7373, #7cc6ff)' },
    { name: 'Sunrise', accent: '#ff7373', bg1: '#ffb085', bg2: '#ffd166', animated: true, gradient: 'linear-gradient(270deg, #ff7373, #ffd166, #ffb085, #ff7373)' },
    { name: 'Electric', accent: '#39ff14', bg1: '#00ffff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00ffff, #39ff14, #ff2dff, #00ffff)' },
    { name: 'Dreamwave', accent: '#a259ff', bg1: '#00eaff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00eaff, #a259ff, #ff2dff, #00eaff)' },
    { name: 'Rainbow', accent: '#ffd700', bg1: '#ff1744', bg2: '#00eaff', animated: true, gradient: 'linear-gradient(270deg, #ff1744, #ffd700, #00eaff, #ff1744)' },
    { name: 'Pastel Flow', accent: '#b39ddb', bg1: '#e1bee7', bg2: '#b3cde0', animated: true, gradient: 'linear-gradient(270deg, #e1bee7, #b3cde0, #b39ddb, #e1bee7)' },
    { name: 'Neon Glow', accent: '#ff2dff', bg1: '#00ffff', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #00ffff, #ff2dff, #ff2dff, #00ffff)' },
    { name: 'Mint Wave', accent: '#a1e3d8', bg1: '#e0f7fa', bg2: '#a1e3d8', animated: true, gradient: 'linear-gradient(270deg, #e0f7fa, #a1e3d8, #b3cde0, #e0f7fa)' },
    { name: 'Bubble Pop', accent: '#ff8ff7', bg1: '#b3cde0', bg2: '#ff8ff7', animated: true, gradient: 'linear-gradient(270deg, #b3cde0, #ff8ff7, #a7c7e7, #b3cde0)' },
    { name: 'Laser', accent: '#00eaff', bg1: '#001a33', bg2: '#00eaff', animated: true, gradient: 'linear-gradient(270deg, #001a33, #00eaff, #00ffff, #001a33)' },
    { name: 'Peachy', accent: '#ffb085', bg1: '#ffe0b2', bg2: '#ffb085', animated: true, gradient: 'linear-gradient(270deg, #ffe0b2, #ffb085, #ffd166, #ffe0b2)' },
    { name: 'Oceanic', accent: '#00b4d8', bg1: '#00132d', bg2: '#00b4d8', animated: true, gradient: 'linear-gradient(270deg, #00132d, #00b4d8, #81ecec, #00132d)' },
    { name: 'Frosty', accent: '#e0f7fa', bg1: '#b3cde0', bg2: '#e0f7fa', animated: true, gradient: 'linear-gradient(270deg, #b3cde0, #e0f7fa, #e1bee7, #b3cde0)' },
    { name: 'Limeade', accent: '#baff39', bg1: '#1a2e0b', bg2: '#baff39', animated: true, gradient: 'linear-gradient(270deg, #1a2e0b, #baff39, #c6ff00, #1a2e0b)' },
    { name: 'Sunbeam', accent: '#ffd700', bg1: '#ffb085', bg2: '#ffd700', animated: true, gradient: 'linear-gradient(270deg, #ffb085, #ffd700, #fff176, #ffb085)' },
    { name: 'Cyberpunk', accent: '#ff2dff', bg1: '#1a0033', bg2: '#ff2dff', animated: true, gradient: 'linear-gradient(270deg, #1a0033, #ff2dff, #39ff14, #1a0033)' },
    { name: 'Twilight', accent: '#b388ff', bg1: '#2e1a4a', bg2: '#b388ff', animated: true, gradient: 'linear-gradient(270deg, #2e1a4a, #b388ff, #d28aff, #2e1a4a)' },
    { name: 'Candy', accent: '#ffb6b9', bg1: '#fae3d9', bg2: '#bbded6', animated: true, gradient: 'linear-gradient(270deg, #fae3d9, #ffb6b9, #bbded6, #fae3d9)' },
    { name: 'Peacock', accent: '#00ffe7', bg1: '#002e2e', bg2: '#00ffe7', animated: true, gradient: 'linear-gradient(270deg, #002e2e, #00ffe7, #00eaff, #002e2e)' },
    { name: 'Firefly', accent: '#fff700', bg1: '#333200', bg2: '#fff700', animated: true, gradient: 'linear-gradient(270deg, #333200, #fff700, #ffd700, #333200)' }
  ],
  picture: [
    { name: 'Galaxy', accent: '#a259ff', bg1: 'rgba(0,0,0,0.56)', bg2: 'rgba(0,0,0,0.88)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Galactic', accent: '#00eaff', bg1: 'rgba(0,0,0,0.35)', bg2: 'rgba(0,0,0,0.7)', image: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=600&q=80' },
    { name: 'City Night', accent: '#ff2dff', bg1: 'rgba(0,0,0,0.45)', bg2: 'rgba(0,0,0,0.8)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Ocean', accent: '#81ecec', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1444065381814-865dc9da92c0?auto=format&fit=crop&w=600&q=80' },
    { name: 'Forest', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Mountains', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.3)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Beach', accent: '#ffd166', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=600&q=80' },
    { name: 'Sunflowers', accent: '#ffd700', bg1: 'rgba(0,0,0,0.22)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3d41?auto=format&fit=crop&w=600&q=80' },
    { name: 'Desert', accent: '#ffb085', bg1: 'rgba(0,0,0,0.22)', bg2: 'rgba(0,0,0,0.6)', image: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3d41?auto=format&fit=crop&w=600&q=80' },
    { name: 'Lake', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.25)', bg2: 'rgba(0,0,0,0.55)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Winter', accent: '#e0f7fa', bg1: 'rgba(0,0,0,0.19)', bg2: 'rgba(0,0,0,0.42)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Bridge', accent: '#b3cde0', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.42)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Field', accent: '#baff39', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.44)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Rainforest', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80' },
    { name: 'Night Sky', accent: '#d28aff', bg1: 'rgba(0,0,0,0.42)', bg2: 'rgba(0,0,0,0.82)', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=600&q=80' },
    { name: 'Meadow', accent: '#baff39', bg1: 'rgba(0,0,0,0.18)', bg2: 'rgba(0,0,0,0.44)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Cherry Blossom', accent: '#ffb6b9', bg1: 'rgba(0,0,0,0.24)', bg2: 'rgba(0,0,0,0.58)', image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80' },
    { name: 'Forest Path', accent: '#59e48f', bg1: 'rgba(0,0,0,0.2)', bg2: 'rgba(0,0,0,0.5)', image: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=600&q=80' },
    { name: 'Custom Image', accent: '#7cc6ff', bg1: 'rgba(0,0,0,0.3)', bg2: 'rgba(0,0,0,0.6)', image: null, custom: true }
  ]
};

function renderThemes() {
  const panel = document.getElementById('theme-panel');
  panel.innerHTML = '';
  // Switch Mode Pill
  const switchMode = document.createElement('button');
  switchMode.className = 'theme-switch-adv';
  switchMode.innerHTML = `üé® Switch to ${advancedMode === 'quick' ? 'Advanced' : 'Quick'} Mode`;
  switchMode.onclick = () => {
    advancedMode = advancedMode === 'quick' ? 'advanced' : 'quick';
    localStorage.setItem('themeMode', advancedMode);
    renderThemes();
  };
  switchMode.style.float = 'right';
  switchMode.style.marginBottom = '18px';
  panel.appendChild(switchMode);

  if (advancedMode === 'quick') {
    // Top Category Bar
    const categoryBar = document.createElement('div');
    categoryBar.className = 'theme-category-bar';
    THEME_CATEGORIES.forEach(cat => {
      const pill = document.createElement('button');
      pill.className = 'theme-category-pill' + (currentThemeCategory === cat.key ? ' active' : '');
      pill.innerText = cat.label;
      // Dynamic accent
      if (currentThemeCategory === cat.key) pill.style.boxShadow = `0 0 18px 0 ${getAccentForCategory(cat.key)}`;
      pill.onmouseenter = () => pill.style.boxShadow = `0 0 22px 2px ${getAccentForCategory(cat.key)}`;
      pill.onmouseleave = () => pill.style.boxShadow = currentThemeCategory === cat.key ? `0 0 18px 0 ${getAccentForCategory(cat.key)}` : '';
      pill.onclick = () => {
        currentThemeCategory = cat.key;
        localStorage.setItem('themeCategory', currentThemeCategory);
        renderThemes();
      };
      pill.style.transition = 'box-shadow 0.24s';
      categoryBar.appendChild(pill);
    });
    panel.appendChild(categoryBar);

    // Theme Grid
    const grid = document.createElement('div');
    grid.className = 'theme-grid';
    const themes = themeData[currentThemeCategory] || [];
    themes.forEach((t, idx) => {
      if (currentThemeCategory === 'picture' && t.custom) {
        // Custom image tile
        const tile = document.createElement('div');
        tile.className = 'theme-tile theme-tile-picture';
        tile.innerHTML = `<div class="theme-label" style="color:#7cc6ff;">Upload Custom Image</div>`;
        tile.onclick = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = ev => {
                localStorage.setItem('customThemeImage', ev.target.result);
                applyTheme({
                  accent: '#7cc6ff',
                  bg1: 'rgba(0,0,0,0.3)',
                  bg2: 'rgba(0,0,0,0.6)',
                  image: ev.target.result
                });
              };
              reader.readAsDataURL(file);
            }
          };
          input.click();
        };
        grid.appendChild(tile);
        return;
      }
      // Theme tile
      const tile = document.createElement('div');
      tile.className = 'theme-tile' + (currentThemeCategory === 'animated' && t.animated ? ' animated-theme' : '') + (currentThemeCategory === 'picture' ? ' theme-tile-picture' : '');
      // Assign data-theme attribute for event delegation
      tile.setAttribute('data-theme', JSON.stringify(t));
      // Tile background
      if (currentThemeCategory === 'animated' && t.animated && t.gradient) {
        tile.style.background = t.gradient;
        tile.style.backgroundSize = '200% 200%';
        tile.style.animation = 'ambientShift 20s ease infinite';
      } else if (currentThemeCategory === 'picture' && t.image) {
        tile.style.background = `linear-gradient(135deg, ${t.bg1}, ${t.bg2}), url(${t.image})`;
        tile.style.backgroundSize = 'cover';
        tile.style.backgroundPosition = 'center';
      } else {
        tile.style.background = `linear-gradient(45deg, ${t.bg1}, ${t.bg2})`;
      }
      // Accent border
      tile.style.border = `2.5px solid transparent`;
      tile.style.boxShadow = `0 0 10px 0 ${t.accent}55, 0 0 0px #000`;
      tile.style.transition = 'box-shadow 0.22s, border 0.22s';
      // Glow on hover (preview logic remains)
      tile.onmouseenter = () => {
        tile.style.boxShadow = `0 0 24px 4px ${t.accent}, 0 0 0px #000`;
        tile.style.border = `2.5px solid ${t.accent}`;
        // Autopreview: apply theme but do not save
        previewTheme(t);
      };
      tile.onmouseleave = () => {
        tile.style.boxShadow = `0 0 10px 0 ${t.accent}55, 0 0 0px #000`;
        tile.style.border = `2.5px solid transparent`;
        // Remove preview, restore actual theme
        restoreTheme();
      };
      // Remove tile.onclick; click now handled by event delegation!
      // Dynamic accent for label
      const label = document.createElement('div');
      label.className = 'theme-label';
      label.innerText = t.name;
      label.style.color = t.accent;
      label.style.textShadow = `0 0 8px ${t.accent}, 0 0 1px #fff`;
      tile.appendChild(label);
      grid.appendChild(tile);
    });
    panel.appendChild(grid);

    // Add event delegation for theme-tile clicks
    setTimeout(() => {
      const grid = document.querySelector('.theme-grid');
      if (grid) {
        // Remove previous click listeners (if any)
        grid.onclick = null;
        grid.addEventListener('click', e => {
          const tile = e.target.closest('.theme-tile');
          if (tile && tile.dataset.theme) {
            const themeDataObj = JSON.parse(tile.dataset.theme);
            lockedTheme = themeDataObj;
            applyTheme(themeDataObj);
            localStorage.setItem('auraThemes', JSON.stringify(themeDataObj));
          }
        });
      }
    }, 0);

  } else {
    // Advanced mode: keep existing logic
    const label1 = document.createElement('label'); label1.textContent = 'Accent Color:';
    const accentInput = document.createElement('input'); accentInput.type = 'color'; accentInput.value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7cc6ff';
    const label2 = document.createElement('label'); label2.textContent = 'Background Gradient:';
    const bg1 = document.createElement('input'); bg1.type = 'color'; bg1.value = getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim() || '#0b0d16';
    const bg2 = document.createElement('input'); bg2.type = 'color'; bg2.value = getComputedStyle(document.documentElement).getPropertyValue('--bg2').trim() || '#1a1c2a';
    const save = document.createElement('button'); save.textContent = 'Apply'; save.onclick = () => {
      const t = { accent: accentInput.value, bg1: bg1.value, bg2: bg2.value };
      applyTheme(t);
    };
    panel.append(label1, accentInput, document.createElement('br'), label2, bg1, bg2, document.createElement('br'), save);
  }
}

function getAccentForCategory(cat) {
  // Use first theme's accent for pill glow
  const arr = themeData[cat];
  return arr && arr.length > 0 ? arr[0].accent : '#7cc6ff';
}

let _themeRestore = null;
function previewTheme(t) {
  // Prevent preview if lockedTheme is set
  if (lockedTheme) return;
  // Save current theme for restore
  if (!_themeRestore) {
    _themeRestore = {
      accent: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
      bg1: getComputedStyle(document.documentElement).getPropertyValue('--bg1'),
      bg2: getComputedStyle(document.documentElement).getPropertyValue('--bg2'),
      class: document.body.className,
      background: document.body.style.background,
      backgroundImage: document.body.style.backgroundImage,
      backgroundSize: document.body.style.backgroundSize,
      backgroundPosition: document.body.style.backgroundPosition
    };
  }
  // Apply theme (like applyTheme, but not saving)
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--bg1', t.bg1);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  // Sidebar accent
  setSidebarAccent(t.accent);
  // Toggle button accent
  setToggleAccent(t.accent);
  // Glass-shell glow
  setGlowAccent(t.accent);
  // Animated
  if (t.animated && t.gradient) {
    document.body.classList.add('animated-theme');
    document.body.style.background = t.gradient;
    document.body.style.backgroundSize = '200% 200%';
    document.body.style.backgroundPosition = '0% 50%';
  } else if (t.image) {
    document.body.classList.remove('animated-theme');
    document.body.style.background = `linear-gradient(${t.bg1}, ${t.bg2}), url(${t.image})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  } else {
    document.body.classList.remove('animated-theme');
    document.body.style.background = '';
  }
}
function restoreTheme() {
  // Only restore if not locked (i.e., no theme has been clicked)
  if (lockedTheme) return;
  if (!_themeRestore) return;
  document.documentElement.style.setProperty('--accent', _themeRestore.accent);
  document.documentElement.style.setProperty('--bg1', _themeRestore.bg1);
  document.documentElement.style.setProperty('--bg2', _themeRestore.bg2);
  document.body.className = _themeRestore.class;
  document.body.style.background = _themeRestore.background;
  document.body.style.backgroundImage = _themeRestore.backgroundImage;
  document.body.style.backgroundSize = _themeRestore.backgroundSize;
  document.body.style.backgroundPosition = _themeRestore.backgroundPosition;
  // Sidebar accent
  setSidebarAccent(_themeRestore.accent);
  setToggleAccent(_themeRestore.accent);
  setGlowAccent(_themeRestore.accent);
  _themeRestore = null;
}
function setSidebarAccent(accent) {
  const aside = document.getElementById('aura-sidebar');
  if (aside) aside.style.boxShadow = `0 0 70px 0 ${accent}, 0 2px 32px 0 rgba(0,0,0,0.22)`;
}
function setToggleAccent(accent) {
  const toggle = document.getElementById('toggle-sidebar');
  if (toggle) {
    toggle.style.borderColor = accent;
    toggle.style.color = accent;
    toggle.style.boxShadow = `0 0 25px ${accent}, 0 0 40px rgba(0,0,0,0.4), 0 0 12px #fff inset`;
    toggle.style.textShadow = `0 0 6px ${accent}, 0 0 12px #fff`;
  }
}
function setGlowAccent(accent) {
  const shell = document.querySelector('.glass-shell');
  if (shell) shell.style.boxShadow = `0 0 30px 0px ${accent}, 0 0 0px 0px rgba(0,0,0,0.3)`;
}

function applyTheme(t) {
  // Remove any animated-theme class
  document.body.classList.remove('animated-theme');
  document.body.style.background = '';
  document.body.style.backgroundImage = '';
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--bg1', t.bg1);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  setSidebarAccent(t.accent);
  setToggleAccent(t.accent);
  setGlowAccent(t.accent);
  // Save object for localStorage
  let saveObj = {
    accent: t.accent,
    bg1: t.bg1,
    bg2: t.bg2
  };
  // If picture theme (t.image)
  if (t.image) {
    document.body.style.background = `linear-gradient(${t.bg1}, ${t.bg2}), url(${t.image})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    // Save custom image if not already
    if (t.image.startsWith && t.image.startsWith('data:')) {
      localStorage.setItem('customThemeImage', t.image);
    }
    saveObj.image = t.image;
    // Save also bg1 and bg2 for restoration
    // Save always, even for picture
    localStorage.setItem('auraThemes', JSON.stringify(saveObj));
    return;
  }
  // If animated theme
  if (t.animated && t.gradient) {
    document.body.classList.add('animated-theme');
    document.body.style.background = t.gradient;
    document.body.style.backgroundSize = '200% 200%';
    document.body.style.backgroundPosition = '0% 50%';
    saveObj.animated = true;
    saveObj.gradient = t.gradient;
    // Save always, even for animated
    localStorage.setItem('auraThemes', JSON.stringify(saveObj));
    return;
  }
  // Standard theme (solid/pastel/neon)
  document.body.classList.remove('animated-theme');
  document.body.style.background = `linear-gradient(135deg, ${t.bg1} 0%, ${t.bg2} 100%)`;
  localStorage.setItem('auraThemes', JSON.stringify(saveObj));
}

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', () => {
  let saved = JSON.parse(localStorage.getItem('auraThemes') || 'null');
  // If picture theme with image: if custom, load from localStorage
  if (saved && saved.image) {
    if (saved.image.startsWith && saved.image.startsWith('data:')) {
      const customImg = localStorage.getItem('customThemeImage');
      if (customImg) saved.image = customImg;
    }
    applyTheme(saved);
    // Also force accent for sidebar/shell
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved; // Set lockedTheme after applying saved
  } else if (saved && saved.gradient) {
    applyTheme(saved);
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved;
  } else if (saved) {
    applyTheme(saved);
    setSidebarAccent(saved.accent);
    setToggleAccent(saved.accent);
    setGlowAccent(saved.accent);
    lockedTheme = saved;
  } else {
    // Default: first solid
    applyTheme(themeData['solid'][0]);
    setSidebarAccent(themeData['solid'][0].accent);
    setToggleAccent(themeData['solid'][0].accent);
    setGlowAccent(themeData['solid'][0].accent);
    lockedTheme = themeData['solid'][0];
  }
  renderThemes();
});

// --- GAMES LOGIC ---
let currentGame = null;
let gameLoopId = null;
let gameState = null;

function openGame(type) {
  document.getElementById('games-container').style.display = 'none';
  document.getElementById('game-area').style.display = '';
  const gameArea = document.getElementById('game-area');
  document.body.appendChild(gameArea);
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // Remove previous listeners
  window.onkeydown = null;
  canvas.onclick = null;
  // Start selected game
  currentGame = type;
  if (type === 'bubble') startBubblePop(ctx, canvas);
  else if (type === 'brick') startBrickBreaker(ctx, canvas);
  else if (type === 'snake') startSnake(ctx, canvas);
}

function exitGame() {
  if (gameLoopId) cancelAnimationFrame(gameLoopId);
  gameLoopId = null;
  currentGame = null;
  gameState = null;
  document.getElementById('game-area').style.display = 'none';
  document.getElementById('games-container').style.display = '';
  const gameArea = document.getElementById('game-area');
  document.querySelector('.glass-shell').appendChild(gameArea);
  // Remove game-specific listeners
  window.onkeydown = null;
  document.getElementById('gameCanvas').onclick = null;
}

// --- Bubble Pop+ Aura Edition ---
function startBubblePop(ctx, canvas) {
  // Remove any previous HUD or encouragement overlays
  document.getElementById('bubble-score-hud')?.remove();
  document.getElementById('encourage-layer')?.remove();

  // --- HUD: Score only, glowing, centered top ---
  const hud = document.createElement('div');
  hud.id = 'bubble-score-hud';
  hud.style.position = 'absolute';
  hud.style.top = '18px';
  hud.style.left = '50%';
  hud.style.transform = 'translateX(-50%)';
  hud.style.fontFamily = "'Poppins', 'Outfit', sans-serif";
  hud.style.fontWeight = '600';
  hud.style.fontSize = '2.1rem';
  hud.style.color = '#fff';
  hud.style.textShadow = '0 0 16px var(--accent), 0 0 2px #fff';
  hud.style.letterSpacing = '1px';
  hud.style.userSelect = 'none';
  hud.style.pointerEvents = 'none';
  hud.style.zIndex = '11';
  // Place above the canvas
  canvas.parentElement.style.position = 'relative';
  canvas.parentElement.insertBefore(hud, canvas);

  // --- Encouragement Layer ---
  const encourageLayer = document.createElement('div');
  encourageLayer.id = 'encourage-layer';
  encourageLayer.style.position = 'absolute';
  encourageLayer.style.left = '0';
  encourageLayer.style.top = '0';
  encourageLayer.style.width = '100%';
  encourageLayer.style.height = '100%';
  encourageLayer.style.pointerEvents = 'none';
  encourageLayer.style.zIndex = '20';
  canvas.parentElement.appendChild(encourageLayer);

  // --- Bubble Pop+ Physics and Visuals (Aura Edition) ---
  const colors = ['#7cc6ff', '#59e48f', '#d28aff', '#ff7373', '#fff176'];
  let bubbles = [];
  let score = 0;
  let playing = true;
  const N = 14;
  for (let i = 0; i < N; ++i) {
    let r = Math.random() * 22 + 18;
    let tries = 0, x, y, ok;
    do {
      ok = true;
      x = Math.random() * (canvas.width - 2*r) + r;
      y = Math.random() * (canvas.height - 2*r) + r;
      for (const b of bubbles)
        if ((x-b.x)**2 + (y-b.y)**2 < (b.r+b.r+8)**2) { ok = false; break; }
    } while (!ok && ++tries < 15);
    const speed = 1.1 + Math.random()*1.2;
    const angle = Math.random()*2*Math.PI;
    bubbles.push({
      x, y, r,
      dx: Math.cos(angle)*speed,
      dy: Math.sin(angle)*speed,
      color: colors[Math.floor(Math.random()*colors.length)],
      popAnim: 0
    });
  }

  // --- Encouragement System ---
  const encouragements = [
    "WOW!", "Perfect Pop!", "Keep Going!", "Amazing!", "Great!", "Excellent!", "So Satisfying!", "Brilliant!", "Awesome!", "Incredible!"
  ];
  function showEncouragement() {
    const msg = encouragements[Math.floor(Math.random()*encouragements.length)];
    const div = document.createElement('div');
    div.textContent = msg;
    div.style.position = 'absolute';
    div.style.left = '50%';
    div.style.top = '36px';
    div.style.transform = 'translateX(-50%)';
    div.style.fontFamily = "'Poppins', 'Outfit', sans-serif";
    div.style.fontWeight = '700';
    div.style.fontSize = '2.5rem';
    div.style.color = 'var(--accent)';
    div.style.textShadow = '0 0 24px var(--accent), 0 0 4px #fff';
    div.style.opacity = '1';
    div.style.userSelect = 'none';
    div.style.pointerEvents = 'none';
    div.style.filter = 'brightness(1.3)';
    div.style.zIndex = '100';
    // Animate: fade up and out, fireworks
    div.animate([
      { opacity: 1, transform: 'translateX(-50%) scale(1)', filter: 'brightness(1.3)' },
      { opacity: 1, transform: 'translateX(-50%) scale(1.18)', filter: 'brightness(1.5)' },
      { opacity: 0, transform: 'translateX(-50%) translateY(-30px) scale(1.05)', filter: 'brightness(1.1)' }
    ], { duration: 1100, easing: 'cubic-bezier(.7,0,.4,1)' });
    encourageLayer.appendChild(div);
    setTimeout(()=>{div.remove();}, 1100);
    // Fireworks effect
    for(let k=0;k<14;++k){
      const fw = document.createElement('div');
      fw.style.position = 'absolute';
      fw.style.left = '50%';
      fw.style.top = '56px';
      fw.style.width = '10px';
      fw.style.height = '10px';
      fw.style.borderRadius = '50%';
      fw.style.background = 'var(--accent)';
      fw.style.boxShadow = '0 0 16px 4px var(--accent)';
      fw.style.opacity = '0.85';
      fw.style.pointerEvents = 'none';
      fw.style.zIndex = '101';
      encourageLayer.appendChild(fw);
      const theta = Math.random()*2*Math.PI;
      const dist = 44 + Math.random()*36;
      fw.animate([
        { opacity: 1, transform: 'translate(-50%,-50%) scale(1)' },
        { opacity: 0.6, transform: `translate(-50%,-50%) translate(${Math.cos(theta)*dist}px,${Math.sin(theta)*dist}px) scale(0.7)` },
        { opacity: 0, transform: `translate(-50%,-50%) translate(${Math.cos(theta)*dist*1.4}px,${Math.sin(theta)*dist*1.4}px) scale(0.3)` }
      ], { duration: 900+Math.random()*200, easing:'cubic-bezier(.6,0,.7,1)' });
      setTimeout(()=>fw.remove(), 950);
    }
  }

  // --- Bubble Pop+ Draw/Update ---
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // Improve rendering quality for high-DPI screens
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    // Bubbles
    for (const b of bubbles) {
      // Pop animation
      if (b.popAnim>0) {
        ctx.save();
        ctx.globalAlpha = 0.7*b.popAnim;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r+b.popAnim*26, 0, 2*Math.PI);
        ctx.strokeStyle = b.color;
        ctx.lineWidth = 8*b.popAnim;
        ctx.shadowColor = b.color;
        ctx.shadowBlur = 18*b.popAnim;
        ctx.stroke();
        ctx.restore();
      }
      // Bubble body
      ctx.save();
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, 2*Math.PI);
      // Bubble gradient
      const grad = ctx.createRadialGradient(b.x-b.r*0.2, b.y-b.r*0.2, b.r*0.1, b.x, b.y, b.r);
      grad.addColorStop(0, "#fff");
      grad.addColorStop(0.16, b.color+"cc");
      grad.addColorStop(0.92, b.color+"88");
      grad.addColorStop(1, "#fff0");
      ctx.fillStyle = grad;
      ctx.globalAlpha = 0.92;
      ctx.shadowColor = b.color;
      ctx.shadowBlur = 12;
      ctx.fill();
      ctx.globalAlpha = 1.0;
      ctx.shadowBlur = 0;
      ctx.lineWidth = 2.8;
      ctx.strokeStyle = "#fff";
      ctx.stroke();
      // Bubble highlight
      ctx.beginPath();
      ctx.arc(b.x-b.r*0.32, b.y-b.r*0.32, b.r*0.23, Math.PI*0.8, Math.PI*2.1);
      ctx.strokeStyle = "#fff8";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.7;
      ctx.stroke();
      ctx.globalAlpha = 1.0;
      ctx.restore();
    }
    // Score HUD is handled via DOM
    hud.textContent = `Score: ${score}`;
    // End message
    if (!playing && bubbles.length === 0) {
      ctx.save();
      ctx.font = "bold 2.3rem Poppins, Outfit, sans-serif";
      ctx.textAlign = "center";
      ctx.fillStyle = "var(--accent)";
      ctx.shadowColor = "var(--accent)";
      ctx.shadowBlur = 18;
      ctx.fillText("All bubbles popped!", canvas.width/2, canvas.height/2-14);
      ctx.font = "1.2rem Poppins, Outfit, sans-serif";
      ctx.shadowBlur = 0;
      ctx.fillStyle = "#fff";
      ctx.fillText("Score: "+score, canvas.width/2, canvas.height/2+28);
      ctx.restore();
    }
  }
  function update() {
    for (const b of bubbles) {
      b.x += b.dx;
      b.y += b.dy;
      // Soft wall bounce
      if (b.x-b.r < 0) { b.x = b.r; b.dx = Math.abs(b.dx);}
      if (b.x+b.r > canvas.width) { b.x = canvas.width-b.r; b.dx = -Math.abs(b.dx);}
      if (b.y-b.r < 0) { b.y = b.r; b.dy = Math.abs(b.dy);}
      if (b.y+b.r > canvas.height) { b.y = canvas.height-b.r; b.dy = -Math.abs(b.dy);}
      // Pop animation decay
      if (b.popAnim>0) b.popAnim -= 0.06;
    }
    // Remove finished pop anims
    bubbles = bubbles.filter(b=>b.popAnim<=0.99 || b.popAnim<=0);
  }
  function loop() {
    update();
    draw();
    if (playing || bubbles.length > 0) gameLoopId = requestAnimationFrame(loop);
  }
  // Bubble click logic
  canvas.onclick = function(e) {
    if (!playing) return;
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    // Adjust for potential transform scaling
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const mx = (e.clientX - rect.left) * scaleX / dpr;
    const my = (e.clientY - rect.top) * scaleY / dpr;
    for (let i = 0; i < bubbles.length; ++i) {
      const b = bubbles[i];
      if ((mx-b.x)**2 + (my-b.y)**2 < b.r**2) {
        // Pop animation
        b.popAnim = 1.0;
        // Remove after animation
        setTimeout(()=>{const idx=bubbles.indexOf(b); if(idx!==-1) bubbles.splice(idx,1);}, 180);
        score += 10;
        // Show encouragement ~10‚Äì15% randomly
        if (Math.random()<0.14) showEncouragement();
        break;
      }
    }
    if (bubbles.length === 0) {
      playing = false;
    }
  };
  loop();
}

// --- Brick Breaker ---
function startBrickBreaker(ctx, canvas) {
  // State
  const paddle = {w: 90, h: 14, x: canvas.width/2 - 45, y: canvas.height-32, dx: 0};
  const ball = {x: canvas.width/2, y: canvas.height-60, r: 9, dx: 3, dy: -3};
  const rows = 5, cols = 8, brickW = 70, brickH = 20, brickPad = 10, topOff = 40, leftOff = 35;
  let bricks = [];
  let score = 0;
  let playing = true;
  for (let r=0;r<rows;++r) for (let c=0;c<cols;++c)
    bricks.push({x:leftOff+c*(brickW+brickPad),y:topOff+r*(brickH+brickPad),w:brickW,h:brickH,alive:true});

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Bricks
    for (const br of bricks) {
      if (!br.alive) continue;
      ctx.fillStyle = "#7cc6ff";
      ctx.fillRect(br.x,br.y,br.w,br.h);
      ctx.strokeStyle = "#fff";
      ctx.strokeRect(br.x,br.y,br.w,br.h);
    }
    // Paddle
    ctx.fillStyle = "#fff";
    ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
    // Ball
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI);
    ctx.fillStyle = "#ff7373";
    ctx.fill();
    // Score
    ctx.font = "20px Poppins, sans-serif";
    ctx.fillStyle = "#fff";
    ctx.fillText("Score: "+score, 18, 26);
    if (!playing) {
      ctx.font = "30px Poppins, sans-serif";
      ctx.fillStyle = "#7cc6ff";
      ctx.fillText("Game Over!", canvas.width/2-80, canvas.height/2);
    }
    if (bricks.every(b=>!b.alive)) {
      ctx.font = "28px Poppins, sans-serif";
      ctx.fillStyle = "#59e48f";
      ctx.fillText("You Win!", canvas.width/2-60, canvas.height/2-30);
    }
  }
  function update() {
    if (!playing) return;
    // Move paddle
    paddle.x += paddle.dx;
    if (paddle.x < 0) paddle.x = 0;
    if (paddle.x + paddle.w > canvas.width) paddle.x = canvas.width - paddle.w;
    // Move ball
    ball.x += ball.dx;
    ball.y += ball.dy;
    // Wall collisions
    if (ball.x-ball.r < 0 || ball.x+ball.r > canvas.width) ball.dx *= -1;
    if (ball.y-ball.r < 0) ball.dy *= -1;
    // Paddle collision
    if (ball.y+ball.r > paddle.y && ball.x > paddle.x && ball.x < paddle.x+paddle.w) {
      ball.dy *= -1;
      ball.y = paddle.y - ball.r;
    }
    // Bricks
    for (const br of bricks) {
      if (!br.alive) continue;
      if (ball.x > br.x && ball.x < br.x+br.w && ball.y-ball.r < br.y+br.h && ball.y+ball.r > br.y) {
        br.alive = false;
        score += 5;
        ball.dy *= -1;
        break;
      }
    }
    // Lose
    if (ball.y-ball.r > canvas.height) playing = false;
  }
  function loop() {
    update();
    draw();
    if (playing || bricks.some(b=>b.alive)) gameLoopId = requestAnimationFrame(loop);
  }
  // Controls
  window.onkeydown = function(e){
    if (e.key === "ArrowLeft") paddle.dx = -7;
    else if (e.key === "ArrowRight") paddle.dx = 7;
  };
  window.onkeyup = function(e){
    if (e.key === "ArrowLeft" || e.key === "ArrowRight") paddle.dx = 0;
  };
  loop();
}

// --- Snake+ ---
function startSnake(ctx, canvas) {
  const grid = 20;
  let snake = [{x: 10, y: 12}];
  let dir = {x: 1, y: 0};
  let food = {x: 15, y: 10};
  let length = 4;
  let score = 0;
  let playing = true;
  let lastMove = 0;
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Snake
    for (let i=0;i<snake.length;++i) {
      ctx.fillStyle = i===0 ? "#7cc6ff" : "#fff";
      ctx.fillRect(snake[i].x*grid, snake[i].y*grid, grid-2, grid-2);
    }
    // Food
    ctx.fillStyle = "#ff7373";
    ctx.fillRect(food.x*grid, food.y*grid, grid-2, grid-2);
    // Score
    ctx.font = "20px Poppins, sans-serif";
    ctx.fillStyle = "#fff";
    ctx.fillText("Score: "+score, 15, 28);
    if (!playing) {
      ctx.font = "30px Poppins, sans-serif";
      ctx.fillStyle = "#d28aff";
      ctx.fillText("Game Over!", canvas.width/2-80, canvas.height/2);
    }
  }
  function update() {
    if (!playing) return;
    // Next head
    const nx = snake[0].x + dir.x;
    const ny = snake[0].y + dir.y;
    // Check collision
    if (nx<0 || ny<0 || nx>=canvas.width/grid || ny>=canvas.height/grid ||
        snake.some(s=>s.x===nx && s.y===ny)) {
      playing = false;
      return;
    }
    snake.unshift({x:nx, y:ny});
    if (nx === food.x && ny === food.y) {
      score += 10;
      length++;
      // Place new food
      let fx, fy;
      do {
        fx = Math.floor(Math.random()*(canvas.width/grid));
        fy = Math.floor(Math.random()*(canvas.height/grid));
      } while (snake.some(s=>s.x===fx && s.y===fy));
      food = {x:fx, y:fy};
    } else {
      while (snake.length > length) snake.pop();
    }
  }
  function loop(ts) {
    if (!lastMove || ts-lastMove>105) {
      update();
      draw();
      lastMove = ts;
    }
    if (playing) gameLoopId = requestAnimationFrame(loop);
    else draw();
  }
  window.onkeydown = function(e){
    if (e.key === "ArrowUp" && dir.y !== 1) {dir={x:0,y:-1};}
    else if (e.key === "ArrowDown" && dir.y !== -1) {dir={x:0,y:1};}
    else if (e.key === "ArrowLeft" && dir.x !== 1) {dir={x:-1,y:0};}
    else if (e.key === "ArrowRight" && dir.x !== -1) {dir={x:1,y:0};}
  };
  loop();
}

// --- AuraAI Ultimate Part 4: Performance, Glow Scaling, 4K Scaling, Animation Polish ---
// Performance: cancelAnimationFrame safety, canvas resize
(function() {
  // Cancel game loop safely on tab/game exit
  const origExitGame = window.exitGame;
  window.exitGame = function() {
    if (window.gameLoopId) {
      try { cancelAnimationFrame(window.gameLoopId); } catch(e) {}
      window.gameLoopId = null;
    }
    origExitGame();
  };
  // Responsive canvas scaling for 4K and window resize
  function resizeGameCanvas() {
    const area = document.getElementById('game-area');
    const canvas = document.getElementById('gameCanvas');
    if (!canvas || area.style.display === 'none') return;
    // 90% of glass-shell, max 1200x900, min 320x240
    const shell = document.querySelector('.glass-shell');
    const w = Math.max(320, Math.min(0.9*shell.offsetWidth, 1200));
    const h = Math.max(240, Math.min(0.85*shell.offsetHeight, 1000));
    if (canvas.width !== Math.floor(w) || canvas.height !== Math.floor(h)) {
      canvas.width = Math.floor(w);
      canvas.height = Math.floor(h);
      // If a game is running, do NOT restart it to apply new size (fix Bubble Pop+ restart bug)
      // if (window.currentGame) {
      //   window.exitGame();
      //   window.openGame(window.currentGame);
      // }
    }
    // --- High-Resolution Canvas Scaling (safe, one-time) ---
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const needResize = Math.floor(canvas.width / dpr) !== Math.floor(rect.width) ||
                       Math.floor(canvas.height / dpr) !== Math.floor(rect.height);
    if (needResize) {
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
  }
  window.addEventListener('resize', resizeGameCanvas);
  // Resize on opening game
  const origOpenGame = window.openGame;
  window.openGame = function(type) {
    setTimeout(resizeGameCanvas, 0);
    origOpenGame(type);
  };
  // Also resize on tab switch to games
  const origSwitchTab = window.switchTab;
  window.switchTab = function(id) {
    origSwitchTab(id);
    if (id === 'games') setTimeout(resizeGameCanvas, 0);
  };
})();

// Glow scaling: subtle pulsating glow based on theme accent
(function() {
  // Add a glowing animated border to .glass-shell, using accent color and a pulsating effect
  const style = document.createElement('style');
  style.innerHTML = `
  @media (min-width: 1600px) {
    .glass-shell { box-shadow: 0 0 70px 10px var(--accent), 0 0 40px 0px rgba(0,0,0,0.3); }
  }
  .glass-shell.aura-glow {
    box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);
    animation: auraGlowPulse 3.6s ease-in-out infinite;
  }
  @keyframes auraGlowPulse {
    0% { box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);}
    50% { box-shadow: 0 0 55px 10px var(--accent), 0 0 12px 2px rgba(0,0,0,0.25);}
    100% { box-shadow: 0 0 30px 0px var(--accent), 0 0 0px 0px rgba(0,0,0,0.3);}
  }
  /* 4K scaling: larger font and UI elements */
  @media (min-width: 2560px) {
    html { font-size: 1.25em; }
    .glass-shell { border-radius: 38px; }
    .game-card { width: 400px; height: 400px; font-size:1.25em;}
    #gameCanvas { border-radius: 20px; }
  }
  `;
  document.head.appendChild(style);
  // Add glow class to glass-shell
  function updateGlow() {
    const shell = document.querySelector('.glass-shell');
    if (!shell) return;
    shell.classList.add('aura-glow');
  }
  // Update accent color in animation on theme change
  const origApplyTheme = window.applyTheme;
  window.applyTheme = function(t) {
    origApplyTheme(t);
    // Force update of CSS var for accent in animation
    document.documentElement.style.setProperty('--accent', t.accent);
  };
  // Initial
  updateGlow();
  // Also re-apply on DOMContentLoaded (in case of dynamic reload)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateGlow);
  } else {
    updateGlow();
  }
})();

// Animation polish: smooth transitions for tab-content & glass-shell, glass-shell hover
(function() {
  const style2 = document.createElement('style');
  style2.innerHTML = `
  .glass-shell {
    transition: box-shadow 0.7s cubic-bezier(.4,1.2,.2,1), border-radius 0.4s, background 0.3s;
  }
  .glass-shell:hover {
    box-shadow: 0 0 80px 16px var(--accent), 0 0 50px 8px rgba(0,0,0,0.25);
    transition: box-shadow 0.7s cubic-bezier(.4,1.2,.2,1);
  }
  .tab-content {
    transition: opacity 0.4s cubic-bezier(.4,1.3,.2,1);
    opacity: 0;
    pointer-events: none;
  }
  .tab-content.active {
    opacity: 1;
    pointer-events: auto;
    transition-delay: 0.05s;
  }
  `;
  document.head.appendChild(style2);
})();
</script>
</body>
</htmlremove
</script>
<style>
  .theme-category-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    justify-content: flex-start;
    align-items: center;
    padding: 0 0 0 2px;
    width: 100%;
  }
  .theme-category-pill {
    background: rgba(255,255,255,0.10);
    border-radius: 24px;
    padding: 8px 24px;
    cursor: pointer;
    border: none;
    font-family: inherit;
    font-weight: 600;
    font-size: 1.06em;
    color: #fff;
    box-shadow: 0 0 0 0 #0000;
    transition: background 0.19s, color 0.19s, box-shadow 0.22s;
    margin-right: 6px;
    outline: none;
    position: relative;
    z-index: 1;
  }
  .theme-category-pill.active {
    background: var(--accent);
    color: #181c29;
    box-shadow: 0 0 18px 0 var(--accent);
  }
  .theme-category-pill:hover,
  .theme-category-pill:focus-visible {
    color: #fff;
    background: linear-gradient(90deg, var(--accent) 0%, #fff3 100%);
    box-shadow: 0 0 22px 2px var(--accent);
  }
  .theme-switch-adv {
    background: linear-gradient(90deg, var(--accent) 0%, #fff2 100%);
    border-radius: 24px;
    font-weight: 700;
    color: #181c29;
    border: none;
    padding: 8px 22px;
    font-size: 1.06em;
    box-shadow: 0 0 20px 0 var(--accent), 0 0 2px #fff;
    cursor: pointer;
    margin-left: auto;
    margin-bottom: 10px;
    float: right;
    transition: box-shadow 0.25s, background 0.2s;
  }
  .theme-switch-adv:hover {
    box-shadow: 0 0 36px 2px var(--accent), 0 0 6px #fff;
    background: var(--accent);
    color: #fff;
  }
  .theme-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    margin-top: 26px;
    justify-content: flex-start;
  }
  .theme-tile {
    border-radius: 18px;
    min-width: 120px;
    min-height: 68px;
    max-width: 20vw;
    flex: 1 0 18%;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 10px;
    border: 2.5px solid transparent;
    box-shadow: 0 0 10px 0 var(--accent), 0 0 0px #000;
    transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
    position: relative;
    overflow: hidden;
    padding: 0 0 10px 0;
  }
  .theme-tile:hover {
    transform: scale(1.05);
    z-index: 2;
  }
  .theme-label {
    font-size: 0.98em;
    margin-bottom: 6px;
    font-weight: 600;
    letter-spacing: 0.2px;
    text-shadow: 0 0 8px var(--accent), 0 0 1px #fff;
    filter: brightness(1.08);
    user-select: none;
    pointer-events: none;
    text-align: center;
    width: 100%;
    padding: 0 3px;
  }
  .theme-tile-picture {
    min-width: 120px;
    min-height: 68px;
    background-size: cover !important;
    background-position: center !important;
    color: #fff;
    border: 2.5px solid transparent;
  }
  /* Animated category: ambientShift keyframes */
  @keyframes ambientShift {
    0% {background-position:0% 50%;}
    50% {background-position:100% 50%;}
    100% {background-position:0% 50%;}
  }
  .animated-theme {
    background-size: 200% 200%!important;
    animation: ambientShift 20s ease infinite!important;
  }
  @media (max-width: 900px) {
    .theme-tile { min-width: 86px; min-height: 46px; font-size: 0.95em;}
    .theme-label { font-size: 0.93em;}
    .theme-grid { gap: 8px; }
  }
</style>	
</style>
<style>
  /* AuraAI 4.0 Mood Panel and Sidebar Animations */
  .AuraAI-mood-toggle {
    margin: 18px auto 0 auto;
    display: block;
    font-size: 1.13em;
    background: rgba(255,255,255,0.13);
    border: none;
    border-radius: 18px;
    color: var(--accent);
    font-family: inherit;
    font-weight: 600;
    box-shadow: 0 0 18px var(--accent);
    padding: 9px 34px;
    cursor: pointer;
    transition: background 0.18s, color 0.18s, box-shadow 0.22s;
    letter-spacing: 0.5px;
  }
  .AuraAI-mood-toggle:hover, .AuraAI-mood-toggle:focus-visible {
    background: var(--accent);
    color: #181c29;
    box-shadow: 0 0 34px var(--accent), 0 0 4px #fff;
    outline: none;
  }
  .AuraAI-mood-panel {
    margin: 0 auto 0 auto;
    margin-top: 16px;
    background: rgba(255,255,255,0.18);
    border-radius: 22px;
    padding: 16px 22px 10px 22px;
    box-shadow: 0 0 30px 0 var(--accent), 0 0 2px #fff;
    max-width: 430px;
    backdrop-filter: blur(16px) saturate(1.1);
    transition: opacity 0.4s, filter 0.4s;
    opacity: 1;
    filter: blur(0px);
    position: relative;
    z-index: 9;
  }
  .AuraAI-mood-panel.AuraAI-hidden {
    display: none;
    opacity: 0;
    filter: blur(4px);
    pointer-events: none;
  }
  .AuraAI-mood-group {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.07em;
    flex-wrap: wrap;
  }
  .AuraAI-mood-group span {
    font-weight: 600;
    min-width: 110px;
    color: var(--accent);
    letter-spacing: 0.2px;
  }
  .AuraAI-mood-btn {
    font-size: 1.35em;
    background: rgba(255,255,255,0.12);
    border: none;
    border-radius: 13px;
    margin-right: 2px;
    padding: 5px 12px;
    cursor: pointer;
    transition: background 0.18s, box-shadow 0.22s, transform 0.13s;
    box-shadow: 0 0 8px var(--accent)33;
    outline: none;
  }
  .AuraAI-mood-btn:hover, .AuraAI-mood-btn:focus-visible {
    background: var(--accent);
    color: #181c29;
    box-shadow: 0 0 18px var(--accent), 0 0 2px #fff;
    transform: scale(1.13);
  }
  /* Sidebar animation */
  #aura-sidebar {
    transition: opacity 0.4s, filter 0.4s;
  }
</style>
</body>
</html>
