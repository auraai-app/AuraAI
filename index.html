<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AuraAI • Play • Create</title>
<link rel="icon" href="data:,">
<style>
  /* =========================
     Visual style (inex look)
     ========================= */
  :root{
    --bg: #0e1116;
    --glass: rgba(255,255,255,0.12);
    --glass-2: rgba(255,255,255,0.08);
    --stroke: rgba(255,255,255,0.18);
    --text: #eef2f6;
    --muted: #b8c0cc;
    --accent: #7cc6ff;
    --accent-2: #a8a6ff;
    --good: #59e48f;
    --bad: #ff7373;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial;
    color:var(--text);
    background: radial-gradient(1200px 1200px at 10% -10%, #31405644, transparent 60%),
                radial-gradient(1000px 1000px at 90% -20%, #6245ff33, transparent 60%),
                linear-gradient(180deg, #0b0f14, #0e1116);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    backdrop-filter: blur(0.5px);
  }
  .shell{
    max-width:1200px; margin:24px auto; padding:20px;
    border-radius:24px; background: var(--glass);
    border:1px solid var(--stroke); box-shadow: 0 30px 80px #0007, inset 0 1px 0 #fff1;
    min-height:900px; position:relative;
  }
  .clock{
    position:absolute; top:12px; right:16px; padding:8px 12px;
    border-radius:14px; background: var(--glass-2); border:1px solid var(--stroke);
    font-variant-numeric: tabular-nums; letter-spacing:0.5px; box-shadow: inset 0 1px 0 #fff2;
    z-index:120;
  }
  .tabs{display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; align-items:center}
  .tab{
    padding:10px 14px; border-radius:14px;
    background:linear-gradient(180deg, #ffffff14, #ffffff08);
    border:1px solid var(--stroke); color:var(--text); cursor:pointer;
    user-select:none; transition:.18s transform, .18s background; box-shadow: 0 6px 16px #0005, inset 0 1px 0 #fff1;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(180deg, #7cc6ff33, #a8a6ff26); border-color:#7cc6ff66}
  .bar{display:flex; align-items:center; gap:10px; margin:8px 0 18px; flex-wrap:wrap;}
  .chip{padding:6px 10px; border-radius:12px; background:var(--glass-2); border:1px solid var(--stroke); cursor:pointer}
  .chip[aria-pressed="true"]{outline:2px solid var(--accent); background:#7cc6ff1f}
  .dock{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .panel{display:none}
  .panel.active{display:block}
  .side-card, .main-card{background: var(--glass-2); border:1px solid var(--stroke); border-radius:18px; padding:14px; box-shadow: inset 0 1px 0 #fff2, 0 10px 30px #0005;}
  .side-card h3{margin:6px 0 10px; font-size:14px; color:var(--muted); font-weight:600}
  .bubble-list{display:flex; gap:8px; flex-wrap:wrap}
  .bubble{padding:10px 12px; border-radius:999px; background:#ffffff10; border:1px solid var(--stroke); cursor:pointer}
  .chat{height:420px; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:8px; scroll-behavior:smooth;}
  .msg{max-width:80%; padding:10px 14px; border-radius:16px; position:relative; background:linear-gradient(180deg,#ffffff14,#ffffff0a); border:1px solid var(--stroke); box-shadow: 0 8px 24px #0005, inset 0 1px 0 #fff2;}
  .msg.me{margin-left:auto; background:linear-gradient(180deg,#7cc6ff33,#a8a6ff26)}
  .composer{display:flex; gap:8px; margin-top:10px}
  .input{flex:1; padding:12px 14px; border-radius:12px; background:#ffffff10; color:var(--text); border:1px solid var(--stroke); outline:none}
  .btn{padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#ffffff20,#ffffff0d); border:1px solid var(--stroke); color:var(--text); cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#7cc6ff3a,#a8a6ff2d); border-color:#7cc6ff66}
  .btn.good{background:linear-gradient(180deg,#59e48f33,#59e48f1a); border-color:#59e48f77}
  .btn.bad{background:linear-gradient(180deg,#ff737333,#ff73731a); border-color:#ff737377}

  /* draw */
  .draw-grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
  canvas.doodle{width:100%; aspect-ratio:4/3; background:#111a22; border-radius:14px; border:1px solid var(--stroke); box-shadow: inset 0 1px 0 #fff2, 0 10px 30px #0005; touch-action:none; cursor:crosshair;}
  .prompt-card{padding:14px; border-radius:12px; background:var(--glass-2); border:1px solid var(--stroke)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hint{color:var(--muted); font-size:13px}

  /* game */
  .game-wrap{display:grid; grid-template-columns:320px 1fr; gap:16px}
  canvas.game-canvas{width:100%; aspect-ratio:16/9; background:#0a0f14; border-radius:14px; border:1px solid var(--stroke)}
  .meter{height:10px; border-radius:999px; background:#ffffff10; border:1px solid var(--stroke); overflow:hidden}
  .meter > span{display:block; height:100%; width:0%; background: linear-gradient(90deg,#59e48f,#7cc6ff)}

  /* themes */
  .themes-wrap{display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px}
  .swatch{padding:8px; border-radius:12px; border:1px solid var(--stroke); background:#ffffff12; cursor:pointer; position:relative; min-height:64px; overflow:hidden}
  .swatch .tag{position:absolute; bottom:8px; left:8px; font-size:11px; color:#fff9; background:#0006; padding:4px 6px; border-radius:8px}

  /* coloring pages */
  .color-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px}
  .thumb{background:#0b1116; border-radius:10px; padding:8px; border:1px solid var(--stroke); cursor:pointer; display:flex; align-items:center; justify-content:center; min-height:96px}
  .tool-row{display:flex; gap:8px; align-items:center; margin:8px 0}

  /* responsive */
  @media (max-width:980px){
    .draw-grid{grid-template-columns:1fr}
    .game-wrap{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="shell" id="app">
  <div class="clock" id="clock">--:--:--</div>

  <!-- Top tabs -->
  <div class="tabs" role="tablist" aria-label="Main sections">
    <div class="tab active" data-tab="aura">🫧 AuraAI</div>
    <div class="tab" data-tab="draw">🎨 Draw</div>
    <div class="tab" data-tab="bubble">🫧 Bubble Pop</div>
    <div class="tab" data-tab="color">🖍️ Coloring Pages</div>
    <div class="tab" data-tab="themes">🎨 Themes</div>
    <div class="spacer"></div>

    <!-- YouTube iframe (music only) -->
    <iframe id="ytmusic" width="320" height="64"
      src="https://www.youtube.com/embed/?listType=playlist&list=PLFgquLnL59alCl_2TQvOiD5Vgm1hCaGSI&autoplay=0&rel=0"
      title="YouTube Music" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
  </div>

  <!-- AURA panel -->
  <div class="panel active" id="panel-aura" role="tabpanel" aria-labelledby="aura-tab">
    <div class="bar">
      <div class="dock" id="emotionDock">
        <div class="chip" data-emote="happy">😊 Happy</div>
        <div class="chip" data-emote="sad">😢 Sad</div>
        <div class="chip" data-emote="angry">😠 Angry</div>
        <div class="chip" data-emote="nervous">😰 Nervous</div>
      </div>
      <div class="spacer"></div>
      <div class="chip has-tt" id="openThemes" data-tt="Change the look">🎨 Themes</div>
      <div class="chip has-tt" id="muteBtn" data-tt="Mute encouragement">🔇 Mute</div>
    </div>

    <div style="display:grid; grid-template-columns:300px 1fr; gap:14px">
      <div class="side-card">
        <h3>Quick switches</h3>
        <div class="bubble-list">
          <div class="bubble" data-say="How was your day?">How was your day?</div>
          <div class="bubble" data-say="Want a quick breathing idea?">Breathing idea</div>
          <div class="bubble" data-say="Pick an activity together?">Pick an activity</div>
        </div>

        <h3 style="margin-top:14px">Activities</h3>
        <div class="bubble-list">
          <div class="bubble" data-action="openDraw">Open Draw</div>
          <div class="bubble" data-action="openBubble">Play Bubble Pop</div>
          <div class="bubble" data-action="openColor">Coloring Book</div>
          <div class="bubble" data-action="breathing">4-4-6 breathing</div>
        </div>

        <h3 style="margin-top:14px">Tips</h3>
        <p class="hint">Use simple words. Try pick a theme from the Themes tab to change the mood.</p>
      </div>

      <div class="main-card">
        <div id="chat" class="chat" aria-live="polite"></div>
        <div class="composer">
          <input id="input" class="input" placeholder="Type here… (e.g., I feel nervous)"/>
          <button id="send" class="btn primary">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DRAW panel -->
  <div class="panel" id="panel-draw" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="drawAsk" data-tt="Get a drawing idea">🧠 New idea</div>
      <div class="chip has-tt" id="autoCheck" data-tt="Auto-check with AI" aria-pressed="true">✅ Auto-Check</div>
      <div class="chip has-tt" id="freeMode" data-tt="Free drawing">✍️ Freestyle</div>
      <div class="spacer"></div>
      <div class="chip has-tt" id="clearCanvas" data-tt="Clear the canvas">🧼 Clear</div>
      <div class="chip has-tt" id="undoDraw" data-tt="Undo last stroke">↩️ Undo</div>
      <div class="chip has-tt" id="redoDraw" data-tt="Redo">↪️ Redo</div>
    </div>

    <div class="draw-grid">
      <div class="prompt-card">
        <div class="row" style="margin-bottom:8px">
          <div class="hint" id="ideaText">Want to try drawing something? (OK / No / Later)</div>
        </div>
        <div class="row okno">
          <button class="btn good" id="okIdea">OK</button>
          <button class="btn bad" id="noIdea">No</button>
          <button class="btn" id="laterIdea">Later</button>
        </div>
        <div style="height:10px"></div>
        <div class="hint">After you draw, Aura can auto-check your drawing with MobileNet.</div>
        <div style="height:10px"></div>
        <div class="row" style="align-items:center">
          <label class="hint" style="margin-right:8px">Brush</label>
          <input id="brushSize" type="range" min="1" max="40" value="6"/>
          <div class="spacer"></div>
          <button class="btn" id="savePNG">Save PNG</button>
        </div>
      </div>

      <div>
        <canvas id="doodle" class="doodle" width="1200" height="900"></canvas>
      </div>
    </div>
  </div>

  <!-- BUBBLE POP -->
  <div class="panel" id="panel-bubble" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="startGame" data-tt="Start / Restart">▶️ Start</div>
      <div class="chip has-tt" id="pauseGame" data-tt="Pause / Resume">⏸️ Pause</div>
      <div class="chip has-tt" id="levelDown" data-tt="Previous level">⬅️</div>
      <div class="chip has-tt" id="levelUp" data-tt="Next level">➡️</div>
      <div class="spacer"></div>
      <div class="badge" id="levelBadge">Level 1 / 30</div>
      <div class="badge" id="scoreBadge">Score 0</div>
    </div>

    <div class="game-wrap">
      <div class="side-card">
        <h3>Goals</h3>
        <p class="hint" id="goalText">Pop 10 bubbles to pass.</p>
        <div class="meter" style="margin-top:8px"><span id="goalMeter"></span></div>

        <h3 style="margin-top:14px">Milestones</h3>
        <div class="lvl" id="milestones"></div>

        <h3 style="margin-top:14px">Encouragement</h3>
        <div id="encBox" class="hint">You’ve got this! 🎯</div>
      </div>

      <canvas id="game" class="game-canvas" width="1280" height="720"></canvas>
    </div>
  </div>

  <!-- COLORING PAGES -->
  <div class="panel" id="panel-color" role="tabpanel">
    <div class="bar">
      <div class="chip has-tt" id="newColoring" data-tt="Pick a new page">🖼️ New</div>
      <div class="chip has-tt" id="surpriseTheme" data-tt="Random theme">🎲 Surprise Me</div>
      <div class="spacer"></div>
      <div class="chip has-tt" id="colorBrush" aria-pressed="true">✏️ Brush</div>
      <div class="chip has-tt" id="colorFill">🪣 Bucket</div>
      <div class="chip has-tt" id="colorEraser">🧽 Eraser</div>
      <div class="chip has-tt" id="undoColor">↩️ Undo</div>
      <div class="chip has-tt" id="redoColor">↪️ Redo</div>
      <div class="spacer"></div>
      <label class="hint">Size</label>
      <input id="colorSize" type="range" min="1" max="60" value="14">
      <button class="btn" id="saveColorPNG">Save</button>
    </div>

    <div style="display:grid; grid-template-columns: 360px 1fr; gap:16px;">
      <div class="side-card">
        <h3>Gallery</h3>
        <div id="colorThumbs" class="color-grid"></div>
        <div style="height:12px"></div>
        <div class="hint">Built-in pages — click a thumbnail to open it in the coloring canvas.</div>
      </div>

      <div class="main-card">
        <canvas id="colorCanvas" width="1200" height="900" style="width:100%; background:#fff; border-radius:10px;"></canvas>
      </div>
    </div>
  </div>

  <!-- THEMES -->
  <div class="panel" id="panel-themes" role="tabpanel">
    <div class="bar">
      <div class="chip" id="backToAura">⬅ Back</div>
      <div class="spacer"></div>
      <div class="hint">100 themes — click to apply. Surprise Me picks one randomly.</div>
    </div>

    <div class="themes-wrap" id="themesRoot"></div>
  </div>

</div>

<!-- Splash -->
<div class="splash" id="splash" role="dialog" aria-modal="true" style="display:flex">
  <div class="splash-card" role="document">
    <h1>AuraAI</h1>
    <p>Hi — what would you like to do right now?</p>
    <div class="choices" style="display:flex; gap:12px; justify-content:center;">
      <button class="btn primary" id="splashPlay">Play</button>
      <button class="btn" id="splashDraw">Draw</button>
      <button class="btn" id="splashTalk">Talk</button>
      <button class="btn" id="splashColor">Color</button>
    </div>
    <div style="height:12px"></div>
    <div class="hint">This shows when the page loads (or reloads) — a friendly starter screen.</div>
  </div>
</div>

<!-- include TFJS and MobileNet for auto-check -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<script>
/* =========================
   Utilities and initial UI wiring
   ========================= */
function $(sel, ctx=document){ return ctx.querySelector(sel); }
function $all(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)); }

const clockEl = $('#clock');
function pad(n){return String(n).padStart(2,'0')}
function tick(){const d=new Date(); clockEl.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
tick(); setInterval(tick,1000);

/* Tabs */
const tabs = $all('.tab');
const panels = {
  aura: $('#panel-aura'),
  draw: $('#panel-draw'),
  bubble: $('#panel-bubble'),
  color: $('#panel-color'),
  themes: $('#panel-themes')
};
function showTab(name){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  Object.values(panels).forEach(p=>p&&(p.style.display='none', p.classList.remove('active')));
  const el = panels[name]; if(!el) return; el.style.display='block'; requestAnimationFrame(()=>el.classList.add('active'));
  if(name === 'bubble') prepareGameCanvas();
}
tabs.forEach(t=>t.addEventListener('click', ()=> showTab(t.dataset.tab)));
showTab('aura');

/* Chat */
const chatEl = $('#chat'), inputEl = $('#input'), sendBtn = $('#send');
function pushMsg(text, who='bot'){ const e=document.createElement('div'); e.className='msg' + (who==='me'?' me':''); e.innerHTML = text.replace(/\n/g,'<br>'); chatEl.appendChild(e); chatEl.scrollTop = chatEl.scrollHeight; }
sendBtn.addEventListener('click', ()=> { const v=inputEl.value.trim(); if(!v) return; pushMsg(v,'me'); inputEl.value=''; setTimeout(()=>{ const low=v.toLowerCase(); if(low.includes('how are you')) pushMsg("I'm Aura — ready to help!"); else if(low.includes('nerv')||low.includes('anxi')) pushMsg("Try 4-4-6 breathing: inhale 4, hold 4, exhale 6."); else pushMsg("Thanks for sharing — want to try an activity?"); },300); });

$all('.bubble-list .bubble[data-say]').forEach(b=> b.addEventListener('click', ()=> { inputEl.value = b.dataset.say; sendBtn.click(); }));
$all('.bubble-list .bubble[data-action]').forEach(b=> b.addEventListener('click', ()=> {
  const a = b.dataset.action;
  if(a === 'openDraw') showTab('draw');
  if(a === 'openBubble') showTab('bubble');
  if(a === 'openColor') showTab('color');
  if(a === 'breathing') pushMsg("Try a breathing exercise: inhale 4, hold 4, exhale 6.");
}));

$('#emotionDock').addEventListener('click', (ev)=> {
  const chip = ev.target.closest('.chip'); if(!chip) return;
  $all('#emotionDock .chip').forEach(c=>c.removeAttribute('aria-pressed')); chip.setAttribute('aria-pressed','true'); pushMsg(`You selected: ${chip.textContent.trim()}`);
});

/* Splash */
const splash = $('#splash');
$('#splashPlay').addEventListener('click', ()=>{ splash.style.display='none'; showTab('bubble'); });
$('#splashDraw').addEventListener('click', ()=>{ splash.style.display='none'; showTab('draw'); });
$('#splashTalk').addEventListener('click', ()=>{ splash.style.display='none'; showTab('aura'); });
$('#splashColor').addEventListener('click', ()=>{ splash.style.display='none'; showTab('color'); });
setTimeout(()=>{ if(splash) splash.style.display='none'; },9000);

/* Mute encouragement toggle */
let mutedEncouragement = false;
$('#muteBtn').addEventListener('click', ()=>{ mutedEncouragement = !mutedEncouragement; $('#muteBtn').textContent = mutedEncouragement ? '🔈 Muted' : '🔇 Mute'; $('#muteBtn').setAttribute('aria-pressed', mutedEncouragement ? 'true':'false'); });

/* Open themes btn */
$('#openThemes').addEventListener('click', ()=> showTab('themes'));
$('#backToAura').addEventListener('click', ()=> showTab('aura'));

/* =========================
   THEMES: 100 themes + render + Surprise Me
   ========================= */

/* We'll generate a 100-theme list programmatically combining palettes,
   ensuring names and properties for each theme. */
const THEME_POOL = (function build100(){
  // small curated lists to compose palettes
  const bases = [
    {name:'Aurora', bg:'#a8cdf1', grad:'#f7b7b9', text:'#0b3c61'},
    {name:'Sunset', bg:'#fdbb2d', grad:'#22c1c3', text:'#3c3c3c'},
    {name:'Forest', bg:'#43ac62', grad:'#6a9d77', text:'#ffffff'},
    {name:'Ocean', bg:'#005bea', grad:'#00c6fb', text:'#ffffff'},
    {name:'Lavender', bg:'#c495d4', grad:'#b669c6', text:'#ffffff'},
    {name:'Mint', bg:'#9de0ad', grad:'#45a247', text:'#ffffff'},
    {name:'Candy', bg:'#ff7e5f', grad:'#feb47b', text:'#ffffff'},
    {name:'Violet', bg:'#8c52ff', grad:'#5ce1e6', text:'#ffffff'},
    {name:'Neon', bg:'#39ff14', grad:'#00ffc8', text:'#3c3c3c'},
    {name:'Cosmic', bg:'#232c3f', grad:'#48587c', text:'#ffffff'}
  ];
  const accents = ['#7cc6ff','#ffa07a','#59e48f','#ff7373','#ffd166','#c084fc','#00ffc8','#ff6b6b','#00a8ff','#ffd1dc'];
  const extras = ['#f7f7f7','#ffe8d6','#e6f7ff','#fef3c7','#e6ffe6','#fff0f5','#f0fff0','#f3f0ff','#fff7ed','#f0f7ff'];

  const pool = [];
  // add base themes first
  bases.forEach(b=> pool.push(Object.assign({}, b)));
  // generate variations to reach ~100
  for(let i=0;i<90;i++){
    const a = bases[i % bases.length];
    const accent = accents[i % accents.length];
    const extra = extras[i % extras.length];
    const name = `${a.name} ${i+1}`;
    // alternate between gradient and solid
    if(i % 3 === 0){
      pool.push({ name, bg: a.bg, grad: a.grad, text: a.text });
    } else if(i % 3 === 1){
      pool.push({ name, bg: extra, grad: a.grad, text: '#3c3c3c' });
    } else {
      pool.push({ name, bg: accent, grad: a.grad, text: '#ffffff' });
    }
  }
  // ensure length >= 100
  while(pool.length < 100){
    pool.push({ name: `Theme ${pool.length+1}`, bg: '#'+Math.floor(Math.random()*16777215).toString(16), text:'#ffffff' });
  }
  return pool.slice(0,100);
})();

/* render themes */
const themesRoot = $('#themesRoot');
function renderThemesGrid(){
  themesRoot.innerHTML = '';
  THEME_POOL.forEach(t=>{
    const sw = document.createElement('div'); sw.className='swatch';
    sw.title = t.name;
    const preview = document.createElement('div'); preview.style.height='56px'; preview.style.borderRadius='10px';
    if(t.grad) preview.style.background = `linear-gradient(90deg, ${t.bg}, ${t.grad})`;
    else preview.style.background = t.bg || '#111';
    sw.appendChild(preview);
    const tag = document.createElement('div'); tag.className='tag'; tag.textContent = t.name; sw.appendChild(tag);
    sw.addEventListener('click', ()=> applyThemeAndSave(t));
    themesRoot.appendChild(sw);
  });
}
renderThemesGrid();

/* Surprise me */
$('#surpriseTheme').addEventListener('click', ()=> {
  const t = THEME_POOL[Math.floor(Math.random()*THEME_POOL.length)];
  applyThemeAndSave(t);
  pushMsg(`Surprise theme: ${t.name}`);
});

/* apply & save */
const THEME_KEY = 'aura_theme_v1';
function applyTheme(t){
  if(!t) return;
  if(t.grad){
    document.body.style.background = `radial-gradient(1200px 1200px at 10% -10%, #31405644, transparent 60%),
      radial-gradient(1000px 1000px at 90% -20%, #6245ff33, transparent 60%),
      linear-gradient(180deg, ${t.bg}, ${t.grad})`;
  } else {
    document.body.style.background = `linear-gradient(180deg, ${t.bg}, #0e1116)`;
  }
  if(t.text) document.documentElement.style.setProperty('--text', t.text);
  document.title = `AuraAI • ${t.name}`;
}
function applyThemeAndSave(t){ applyTheme(t); try{ localStorage.setItem(THEME_KEY, JSON.stringify(t)); }catch(e){} }
(function restoreTheme(){ try{ const t = JSON.parse(localStorage.getItem(THEME_KEY)); if(t) applyTheme(t); }catch(e){} })();

/* =========================
   DRAW canvas with undo/redo and MobileNet auto-check
   ========================= */
const doodle = $('#doodle');
const dctx = doodle.getContext('2d', {alpha:true});
let drawing=false, lastPos=null;
let drawUndo = [], drawRedo = [];
let brushSize = 6, brushColor = '#ffffff';

function setCanvasSize(canvas){
  const ratio = window.devicePixelRatio || 1;
  const w = canvas.clientWidth * ratio;
  const h = canvas.clientHeight * ratio;
  if(canvas.width !== w || canvas.height !== h){
    // backup
    try {
      const img = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').putImageData(img,0,0);
    } catch(e){
      canvas.width = w; canvas.height = h;
    }
  }
}
setCanvasSize(doodle);
window.addEventListener('resize', ()=> setCanvasSize(doodle));

function saveDrawState(){
  try {
    drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.height));
    if(drawUndo.length > 50) drawUndo.shift();
    drawRedo = [];
  } catch(e){}
}
function restoreDrawState(imgData){
  if(!imgData) { dctx.clearRect(0,0,doodle.width,doodle.height); return; }
  dctx.putImageData(imgData,0,0);
}

doodle.addEventListener('pointerdown', (e)=>{
  drawing = true;
  lastPos = pointer(e, doodle);
  dctx.lineCap = 'round'; dctx.lineJoin='round';
  dctx.strokeStyle = brushColor;
  dctx.lineWidth = brushSize * (doodle.width / doodle.clientWidth);
  saveDrawState();
});
doodle.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  const p = pointer(e, doodle);
  dctx.beginPath(); dctx.moveTo(lastPos.x, lastPos.y); dctx.lineTo(p.x, p.y); dctx.stroke();
  lastPos = p;
});
window.addEventListener('pointerup', ()=> { if(drawing) { drawing=false; if(autoCheckEnabled) runAutoCheckDraw(); } });

function pointer(e, canvas){
  const rect = canvas.getBoundingClientRect();
  const ratio = canvas.width / rect.width;
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (clientX - rect.left) * ratio, y: (clientY - rect.top) * ratio };
}

$('#undoDraw').addEventListener('click', ()=> {
  if(drawUndo.length>0){
    const prev = drawUndo.pop();
    drawRedo.push(dctx.getImageData(0,0,doodle.width,doodle.height));
    restoreDrawState(prev);
  }
});
$('#redoDraw').addEventListener('click', ()=> {
  if(drawRedo.length>0){
    const next = drawRedo.pop();
    drawUndo.push(dctx.getImageData(0,0,doodle.width,doodle.height));
    restoreDrawState(next);
  }
});
$('#clearCanvas').addEventListener('click', ()=> { saveDrawState(); dctx.clearRect(0,0,doodle.width,doodle.height); });

$('#brushSize').addEventListener('input', (e)=> { brushSize = Number(e.target.value); });

$('#savePNG').addEventListener('click', ()=> {
  const url = doodle.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = `aura-draw-${Date.now()}.png`; a.click();
});

/* MobileNet for Draw auto-check */
let mobilenetModel = null;
let autoCheckEnabled = true;
$('#autoCheck').addEventListener('click', (e)=> { autoCheckEnabled = !autoCheckEnabled; e.currentTarget.setAttribute('aria-pressed', autoCheckEnabled ? 'true':'false'); $('#autoCheck').textContent = autoCheckEnabled ? '✅ Auto-Check' : '✅ Auto-Check'; $('#checkMsg') && ($('#checkMsg').textContent = autoCheckEnabled ? 'Auto-Check is on.' : 'Auto-Check is off.'); });

async function loadMobileNet(){
  try {
    mobilenetModel = await mobilenet.load();
    console.log('MobileNet ready');
  } catch(e){ console.warn('mobilenet failed', e); mobilenetModel = null; }
}
loadMobileNet();

async function runAutoCheckDraw(){
  if(!autoCheckEnabled || !mobilenetModel) return;
  try {
    const temp = document.createElement('canvas'); temp.width = 224; temp.height = 224;
    const tctx = temp.getContext('2d');
    tctx.fillStyle = '#0b0f14'; tctx.fillRect(0,0,temp.width,temp.height);
    tctx.drawImage(doodle, 0, 0, temp.width, temp.height);
    const preds = await mobilenetModel.classify(temp);
    if(preds && preds.length){
      const top = preds[0];
      pushMsg(`Auto-check: looks a bit like **${top.className}** (${(top.probability*100).toFixed(0)}%)`);
    } else pushMsg('Auto-check: hmm I\'m not sure what that is — nice creativity!');
  } catch(e){ console.warn('auto-check error', e); }
}

/* =========================
   BUBBLE POP (same simple engine, tweaked)
   ========================= */
const game = $('#game'); const gctx = game.getContext('2d'); let gw=game.width, gh=game.height;
let bubbles = [], gameRunning=false, gamePaused=false, popCount=0, score=0, level=1, levelGoal=10, gameLoop=null;

function prepareGameCanvas(){
  const ratio = window.devicePixelRatio || 1;
  const w = game.clientWidth * ratio;
  const h = game.clientHeight * ratio;
  if(game.width !== w || game.height !== h){ game.width = w; game.height = h; }
  gw = game.width; gh = game.height; drawGame();
}
function spawnBubble(){
  const r = 18 + Math.random()*44;
  const x = r + Math.random()*(gw - r*2);
  const y = -r;
  const vx = (Math.random()-0.5)*1.6;
  const vy = 0.6 + Math.random()*1.6;
  const color = `hsl(${Math.floor(Math.random()*360)} 80% 60%)`;
  return {x,y,r,vx,vy,color,id:Date.now()+Math.random()};
}
function gameStep(){
  if(!gameRunning || gamePaused) return;
  if(Math.random() < 0.04 + level*0.002) bubbles.push(spawnBubble());
  bubbles.forEach(b=>{ b.x += b.vx * (1 + level*0.02); b.y += b.vy * (1 + level*0.02); if(b.x < b.r){ b.x=b.r; b.vx *= -0.6;} if(b.x > gw-b.r){ b.x = gw-b.r; b.vx *= -0.6; } });
  bubbles = bubbles.filter(b=> b.y < gh + 200);
  drawGame();
  if(popCount >= levelGoal){
    gameRunning=false; clearInterval(gameLoop); pushMsg(`Level ${level} complete! You popped ${popCount} bubbles.`);
    level++; levelGoal = 10 + level*2; popCount=0; score += 100; $('#levelBadge').textContent = `Level ${level} / 30`; $('#scoreBadge').textContent = `Score ${score}`;
    const m = document.createElement('div'); m.className='badge'; m.textContent = `Reached L${level-1}`; $('#milestones').appendChild(m);
  }
}
function drawGame(){
  gctx.clearRect(0,0,gw,gh);
  const grad = gctx.createLinearGradient(0,0,0,gh);
  grad.addColorStop(0,'#071018'); grad.addColorStop(1,'#031218');
  gctx.fillStyle = grad; gctx.fillRect(0,0,gw,gh);
  bubbles.forEach(b=>{
    gctx.beginPath(); gctx.arc(b.x,b.y,b.r,0,Math.PI*2); gctx.fillStyle = b.color; gctx.globalAlpha = 0.14; gctx.fill();
    gctx.globalAlpha = 1; gctx.beginPath(); gctx.arc(b.x - b.r*0.25, b.y - b.r*0.25, b.r*0.5, 0, Math.PI*2); gctx.fillStyle = 'rgba(255,255,255,0.2)'; gctx.fill();
    gctx.beginPath(); gctx.arc(b.x,b.y,b.r,0,Math.PI*2); gctx.lineWidth = Math.max(1,b.r*0.06); gctx.strokeStyle = 'rgba(255,255,255,0.06)'; gctx.stroke();
  });
}
game.addEventListener('click', (ev)=>{
  if(!gameRunning) return;
  const rect = game.getBoundingClientRect(); const ratio = game.width / rect.width;
  const x = (ev.clientX - rect.left) * ratio; const y = (ev.clientY - rect.top) * ratio;
  for(let i=bubbles.length-1;i>=0;i--){
    const b = bubbles[i]; const dx=b.x-x, dy=b.y-y;
    if(dx*dx + dy*dy <= b.r*b.r){
      popCount++; score += 10; bubbles.splice(i,1); $('#scoreBadge').textContent = `Score ${score}`;
      const meter = $('#goalMeter'); const pct = Math.min(100, Math.round((popCount/levelGoal)*100)); meter.style.width = `${pct}%`;
      $('#goalText').textContent = `Pop ${levelGoal} bubbles to pass. (${popCount}/${levelGoal})`;
      if(!mutedEncouragement) $('#encBox').textContent = ['Nice!', 'Great pop!', 'Amazing!','You got this!'][Math.floor(Math.random()*4)];
      break;
    }
  }
});
$('#startGame').addEventListener('click', ()=> {
  bubbles=[]; popCount=0; score=0; level=1; levelGoal=10; gameRunning=true; gamePaused=false; $('#levelBadge').textContent=`Level ${level} / 30`; $('#scoreBadge').textContent=`Score ${score}`;
  if(gameLoop) clearInterval(gameLoop); gameLoop = setInterval(gameStep, 1000/30);
});
$('#pauseGame').addEventListener('click', ()=> { gamePaused = !gamePaused; $('#pauseGame').textContent = gamePaused ? '▶️ Resume' : '⏸️ Pause'; });
$('#levelUp').addEventListener('click', ()=> { level++; levelGoal = 10 + level*2; $('#levelBadge').textContent = `Level ${level} / 30`; });
$('#levelDown').addEventListener('click', ()=> { if(level>1) level--; levelGoal = 10 + level*2; $('#levelBadge').textContent = `Level ${level} / 30`; });

prepareGameCanvas();
window.addEventListener('resize', ()=> { prepareGameCanvas(); setCanvasSize(doodle); setTimeout(()=> setColorCanvasSize(),50); });

/* =========================
   COLORING PAGES: built-in SVGs, thumbnails, paint & bucket tools
   ========================= */

/* 20 built-in SVG outlines as data URLs */
const SVG_PAGES = (function buildSVGs(){
  const svgs = [];
  // We'll add 20 simple SVG outlines (animals, shapes, mandala-like, vehicles, plants).
  // Keep them simple so flood-fill works nicely.
  function svgWrap(innerPath, w=800, h=600){ return `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'><rect width='100%' height='100%' fill='white'/><g stroke='black' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'>${innerPath}</g></svg>`; }

  // 1. Smiling cat
  svgs.push(svgWrap(`<path d='M200 300 q-60 -180 200 -160 q260 -20 200 160 q-40 100 -200 120 q-160 -20 -200 -120z' />
    <path d='M320 260 q20 -30 40 0' />
    <path d='M520 260 q-20 -30 -40 0' />
    <path d='M400 320 q0 30 40 30 q-40 0 -40 -30z' />
    <path d='M260 220 q-40 -40 -80 0' /><path d='M640 220 q40 -40 80 0' />`));

  // 2. Little car
  svgs.push(svgWrap(`<path d='M120 380 h560 v-120 q0 -40 -40 -40 h-120 q-40 0 -60 -40 h-160 q-20 40 -60 40 h-120 q-40 0 -40 40z'/>
    <circle cx='260' cy='420' r='40'/><circle cx='540' cy='420' r='40'/>`));

  // 3. Simple house
  svgs.push(svgWrap(`<path d='M120 380 h560 v-200 h-560z' /><path d='M120 380 l280 -220 l280 220' /><rect x='320' y='300' width='160' height='80'/>`));

  // 4. Tree
  svgs.push(svgWrap(`<path d='M400 360 v-160' stroke-width='12'/> <path d='M400 200 m-140 0 a140 140 0 1 0 280 0 a140 140 0 1 0 -280 0'/>`));

  // 5. Balloon bunch
  svgs.push(svgWrap(`<ellipse cx='260' cy='220' rx='80' ry='100'/><ellipse cx='420' cy='180' rx='70' ry='90'/><ellipse cx='560' cy='220' rx='60' ry='80'/><path d='M260 300 q60 60 120 0'/>`));

  // 6. Fish
  svgs.push(svgWrap(`<path d='M120 300 q120 -180 560 0 q-120 80 -560 0z' /><path d='M360 260 q20 -40 60 0' /><path d='M460 340 q20 40 60 0' />`));

  // 7. Rocket
  svgs.push(svgWrap(`<path d='M400 140 q80 0 160 80 q-80 40 -160 180 q-80 -140 -160 -180 q80 -80 160 -80z' /><circle cx='400' cy='260' r='40'/>`));

  // 8. Smiley face mandala
  svgs.push(svgWrap(`<circle cx='400' cy='300' r='160' /><circle cx='330' cy='260' r='14' /><circle cx='470' cy='260' r='14' /><path d='M340 350 q60 40 120 0' /><g transform='translate(400 300)'><path d='M-220 0 a220 220 0 0 0 440 0'/></g>`));

  // 9. Dinosaur
  svgs.push(svgWrap(`<path d='M120 360 q60 -120 200 -120 q140 0 220 120 q20 40 -20 40 h-420 q-40 0 -40 -40z' /><path d='M360 240 q10 -40 60 -40' />`));

  // 10. Cupcake
  svgs.push(svgWrap(`<path d='M520 220 q-80 -120 -240 0 q-40 40 10 80 h460 q50 -40 10 -80 q-80 -120 -240 0z' /><rect x='240' y='300' width='320' height='140' rx='18'/>`));

  // 11. Butterfly
  svgs.push(svgWrap(`<path d='M400 300 m-160 -60 q-80 -80 -120 0 q60 60 120 60 q40 0 40 -60z' /><path d='M400 300 m160 -60 q80 -80 120 0 q-60 60 -120 60 q-40 0 -40 -60z' /><path d='M400 340 v-160'/>`));

  // 12. Train
  svgs.push(svgWrap(`<path d='M120 260 h520 v80 h-520z' /><rect x='380' y='200' width='120' height='60'/><circle cx='200' cy='360' r='30'/><circle cx='420' cy='360' r='30'/>`));

  // 13. Spaceship circling planet
  svgs.push(svgWrap(`<circle cx='400' cy='300' r='120' /><path d='M200 220 q220 -120 400 20' stroke-width='8' /><path d='M560 200 q40 -40 80 0'/>`));

  // 14. Flower
  svgs.push(svgWrap(`<path d='M400 300 m0 -40 a40 40 0 1 1 0 80 a40 40 0 1 1 0 -80' /><path d='M300 240 q-80 -80 -120 -40 q80 40 120 40z' /><path d='M500 240 q80 -80 120 -40 q-80 40 -120 40z' /><path d='M400 360 v120' stroke-width='10'/>`));

  // 15. Simple dinosaur 2
  svgs.push(svgWrap(`<path d='M120 340 q120 -200 420 -140 q0 60 -40 80 q-40 20 -40 48 q0 28 -80 16 q-40 -6 -60 12' />`));

  // 16. Lighthouse
  svgs.push(svgWrap(`<path d='M360 140 h80 v240 h-80z' /><path d='M320 380 h160' /><path d='M360 140 q40 -40 80 0' stroke-width='8'/>`));

  // 17. Cute dog
  svgs.push(svgWrap(`<path d='M200 320 q40 -120 200 -80 q160 40 160 80 q0 40 -120 60 q-80 20 -240 -60z' /><circle cx='320' cy='260' r='12' /><circle cx='520' cy='260' r='12'/>`));

  // 18. Airplane
  svgs.push(svgWrap(`<path d='M120 300 h400 l80 -40 l-40 40 l40 40 l-80 -40 h-400z' /><path d='M320 260 v-40'/>`));

  // 19. Boat
  svgs.push(svgWrap(`<path d='M140 320 h520 v20 q-60 60 -260 60 q-200 0 -260 -60z' /><path d='M400 180 v160' /><path d='M400 180 l80 -60 l0 60'/>`));

  // 20. Cute robot
  svgs.push(svgWrap(`<rect x='260' y='220' width='280' height='240' rx='28' /><circle cx='370' cy='300' r='14' /><circle cx='530' cy='300' r='14' /><rect x='340' y='360' width='120' height='60' rx='12'/>`));

  svgs.forEach(s=> {
    const encoded = 'data:image/svg+xml;utf8,' + encodeURIComponent(s);
    // name placeholder
    // store object with small name
  });
  return svgs.map((s, idx)=> ({id: idx+1, name: ['Cat','Car','House','Tree','Balloons','Fish','Rocket','Mandala','Dino','Cupcake','Butterfly','Train','Space','Flower','Dino2','Lighthouse','Dog','Plane','Boat','Robot'][idx], svg: s}));
})();

/* render thumbnails */
const thumbsRoot = $('#colorThumbs');
function renderColorThumbs(){
  thumbsRoot.innerHTML = '';
  SVG_PAGES.forEach((p, i)=>{
    const div = document.createElement('div'); div.className='thumb';
    div.title = p.name;
    const img = new Image(); img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(p.svg);
    img.style.maxWidth = '100%'; img.style.maxHeight = '96px';
    div.appendChild(img);
    div.addEventListener('click', ()=> loadColoringPage(i));
    thumbsRoot.appendChild(div);
  });
}
renderColorThumbs();

/* Coloring canvas */
const colorCanvas = $('#colorCanvas'), cctx = colorCanvas.getContext('2d');
let colorTool = 'brush'; // 'brush' | 'fill' | 'eraser'
let colorBrushSize = 14, colorBrushColor = '#ff0055';
let colorUndo = [], colorRedo = [];
let currentSVGIndex = null;

function setColorCanvasSize(){
  const ratio = window.devicePixelRatio || 1;
  const w = colorCanvas.clientWidth * ratio;
  const h = colorCanvas.clientHeight * ratio;
  if(colorCanvas.width !== w || colorCanvas.height !== h){
    try {
      const img = cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height);
      colorCanvas.width = w; colorCanvas.height = h;
      cctx.putImageData(img,0,0);
    } catch(e){
      colorCanvas.width = w; colorCanvas.height = h;
    }
  }
}
setColorCanvasSize(); window.addEventListener('resize', ()=> setColorCanvasSize());

function loadColoringPage(idx){
  currentSVGIndex = idx;
  const svg = SVG_PAGES[idx].svg;
  const img = new Image();
  img.onload = ()=>{
    // draw white background then image
    cctx.clearRect(0,0,colorCanvas.width,colorCanvas.height);
    // fit image into canvas with padding
    const ratio = Math.min(colorCanvas.width / img.width, colorCanvas.height / img.height) * 0.96;
    const tw = img.width * ratio, th = img.height * ratio;
    const dx = (colorCanvas.width - tw)/2, dy = (colorCanvas.height - th)/2;
    cctx.fillStyle = '#ffffff'; cctx.fillRect(0,0,colorCanvas.width,colorCanvas.height);
    cctx.drawImage(img, 0, 0, img.width, img.height, dx, dy, tw, th);
    // Save initial state
    try{ colorUndo.push(cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height)); }catch(e){}
  };
  img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* color tools */
$('#colorBrush').addEventListener('click', ()=> { colorTool='brush'; $('#colorBrush').setAttribute('aria-pressed','true'); $('#colorFill').removeAttribute('aria-pressed'); $('#colorEraser').removeAttribute('aria-pressed'); });
$('#colorFill').addEventListener('click', ()=> { colorTool='fill'; $('#colorFill').setAttribute('aria-pressed','true'); $('#colorBrush').removeAttribute('aria-pressed'); $('#colorEraser').removeAttribute('aria-pressed'); });
$('#colorEraser').addEventListener('click', ()=> { colorTool='eraser'; $('#colorEraser').setAttribute('aria-pressed','true'); $('#colorBrush').removeAttribute('aria-pressed'); $('#colorFill').removeAttribute('aria-pressed'); });
$('#colorSize').addEventListener('input', (e)=> colorBrushSize = Number(e.target.value));
$('#saveColorPNG').addEventListener('click', ()=> { const url = colorCanvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = `coloring-${SVG_PAGES[currentSVGIndex].name || 'page'}-${Date.now()}.png`; a.click(); });

/* paint brush & eraser drawing on colorCanvas */
let painting = false;
colorCanvas.addEventListener('pointerdown', (e)=>{
  if(colorTool === 'fill'){
    // bucket fill
    const p = pointer(e, colorCanvas);
    saveColorState();
    bucketFill(Math.round(p.x), Math.round(p.y), hexToRgba(colorBrushColor));
  } else {
    painting = true;
    saveColorState();
    const pos = pointer(e, colorCanvas);
    cctx.lineCap = 'round'; cctx.lineJoin = 'round';
    cctx.strokeStyle = colorTool === 'eraser' ? '#ffffff' : colorBrushColor;
    cctx.lineWidth = colorBrushSize * (colorCanvas.width / colorCanvas.clientWidth);
    cctx.beginPath(); cctx.moveTo(pos.x, pos.y);
  }
});
colorCanvas.addEventListener('pointermove', (e)=>{
  if(!painting) return;
  const pos = pointer(e, colorCanvas);
  cctx.lineTo(pos.x, pos.y); cctx.stroke();
});
window.addEventListener('pointerup', ()=> { if(painting) painting=false; });

function saveColorState(){
  try { colorUndo.push(cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height)); if(colorUndo.length>60) colorUndo.shift(); colorRedo=[]; } catch(e){}
}
$('#undoColor').addEventListener('click', ()=> { if(colorUndo.length>0){ const prev = colorUndo.pop(); colorRedo.push(cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height)); cctx.putImageData(prev,0,0); }});
$('#redoColor').addEventListener('click', ()=> { if(colorRedo.length>0){ const next = colorRedo.pop(); colorUndo.push(cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height)); cctx.putImageData(next,0,0); }});

/* bucket fill (flood fill) implementation */
function bucketFill(startX, startY, fillColorRGBA){
  try{
    const imgData = cctx.getImageData(0,0,colorCanvas.width,colorCanvas.height);
    const w = imgData.width, h = imgData.height;
    const data = imgData.data;
    const idx = (startY * w + startX) * 4;
    const targetR = data[idx], targetG = data[idx+1], targetB = data[idx+2], targetA = data[idx+3];
    const fillR = fillColorRGBA.r, fillG = fillColorRGBA.g, fillB = fillColorRGBA.b, fillA = Math.round(fillColorRGBA.a*255);
    if(targetR===fillR && targetG===fillG && targetB===fillB && targetA===fillA) return;
    const stack = [[startX,startY]];
    while(stack.length){
      const [x,y] = stack.pop();
      if(x<0||x>=w||y<0||y>=h) continue;
      const i = (y*w + x) * 4;
      if(data[i]===targetR && data[i+1]===targetG && data[i+2]===targetB && data[i+3]===targetA){
        data[i]=fillR; data[i+1]=fillG; data[i+2]=fillB; data[i+3]=fillA;
        stack.push([x+1,y]); stack.push([x-1,y]); stack.push([x,y+1]); stack.push([x,y-1]);
      }
    }
    cctx.putImageData(imgData,0,0);
  }catch(e){
    console.warn('bucket fill error', e);
  }
}
function hexToRgba(hex){
  // support #rrggbb or #rgb
  if(hex[0]==='#') hex = hex.slice(1);
  if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  const num = parseInt(hex,16);
  return { r:(num>>16)&255, g:(num>>8)&255, b:num&255, a:1 };
}

/* load first coloring page by default */
loadColoringPage(0);

/* =========================
   Keyboard shortcuts
   ========================= */
document.addEventListener('keydown', (e)=> {
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){ e.preventDefault(); showTab('draw'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){ e.preventDefault(); showTab('bubble'); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='c'){ e.preventDefault(); showTab('color'); }
});

/* =========================
   Misc helpers and ensure themes rendered
   ========================= */
renderThemesGrid();
renderColorThumbs();

/* small helper: pointer for canvases already defined earlier */

</script>
</body>
</html>
